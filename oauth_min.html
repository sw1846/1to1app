<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>OAuth 最小テスト（config.js 使用）</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;max-width:880px;margin:40px auto;padding:0 16px}
    pre{background:#f6f8fa;border:1px solid #ddd;padding:12px;border-radius:8px;white-space:pre-wrap;word-break:break-word}
    button{padding:10px 14px;border-radius:8px;border:1px solid #0a66c2;background:#0a66c2;color:#fff;cursor:pointer}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    code{background:#f1f1f1;padding:2px 6px;border-radius:4px}
  </style>
</head>
<body>
  <h1>OAuth 最小テスト（Token Client 単体 / config.js 使用）</h1>
  <p>このページは <code>APP_CONFIG.GOOGLE_CLIENT_ID</code> と <code>APP_CONFIG.SCOPES</code> を使って、<b>GIS の Token Client だけ</b>でトークン取得を試す最小テストです。</p>
  <div class="row">
    <button id="btn">Google でログイン</button>
    <span id="status"></span>
  </div>
  <h3>実際に使う設定値</h3>
  <pre id="cfg"></pre>
  <h3>最終結果</h3>
  <pre id="out"></pre>

  <!-- あなたのサイトの設定をそのまま利用 -->
  <script src="js/config.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    const out = (msg, obj) => {
      const pre = document.getElementById('out');
      pre.textContent = (pre.textContent + '\n' + msg + (obj ? ('\n' + JSON.stringify(obj, null, 2)) : '')).trim();
      console.log('[oauth_min]', msg, obj||'');
    };
    function showCfg(){
      const cfg = {
        origin: location.origin,
        client_id: (window.APP_CONFIG && APP_CONFIG.GOOGLE_CLIENT_ID) || '(missing)',
        scopes: (window.APP_CONFIG && APP_CONFIG.SCOPES) || '(missing)'
      };
      document.getElementById('cfg').textContent = JSON.stringify(cfg, null, 2);
    }
    document.addEventListener('DOMContentLoaded', showCfg);

    document.getElementById('btn').addEventListener('click', function(){
      try{
        if(!(window.google && google.accounts && google.accounts.oauth2)){
          out('GIS ライブラリ未ロード'); return;
        }
        const cid = (window.APP_CONFIG && APP_CONFIG.GOOGLE_CLIENT_ID) || '';
        const scopes = (window.APP_CONFIG && APP_CONFIG.SCOPES) || '';
        if(!cid){ out('client_id 未設定'); return; }
        const tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: cid.trim(),
          scope: (scopes||'').replace(/\u3000/g,' ').replace(/\s+/g,' ').trim() || 'https://www.googleapis.com/auth/drive.metadata.readonly',
          use_fedcm_for_prompt: true,
          callback: (resp) => { out('SUCCESS token resp', resp); },
          error_callback: (err) => { out('ERROR', err); alert('[GIS ERROR] ' + (err && (err.error || err.type || err.message) || 'unknown')); },
          prompt: 'consent'
        });
        tokenClient.requestAccessToken({ prompt: 'consent' });
      }catch(e){
        out('EXCEPTION', {message:e.message, stack:e.stack});
      }
    });
  </script>
</body>
</html>
