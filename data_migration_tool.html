<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1to1Meeting データ移行ツール（簡易版）</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .step-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #667eea;
        }

        .step-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-drop-zone {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: rgba(102, 126, 234, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-drop-zone:hover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.1);
        }

        .file-drop-zone.drag-over {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
            transform: scale(1.02);
        }

        .file-input {
            display: none;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .btn-download {
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .progress-container {
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            height: 20px;
            margin: 15px 0;
        }

        .progress-bar {
            background: linear-gradient(45deg, #28a745, #20c997);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .log-container {
            background: #1e1e1e;
            color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .file-list {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
        }

        .file-item {
            padding: 8px 0;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-icon {
            font-size: 1.2em;
        }

        .status {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-processing {
            background: #d1ecf1;
            color: #0c5460;
        }

        .setup-section {
            background: #e7f3ff;
            border: 1px solid #bee5eb;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .migration-results {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #721c24;
        }

        .info-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #856404;
        }

        .folder-structure {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            margin: 15px 0;
        }

        .download-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        .zip-preview {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔄 1to1Meeting データ移行ツール（簡易版）</h1>

        <div class="info-box">
            <strong>📝 使用方法：</strong> Google認証の代わりに、既存データを分析してZIPファイルを生成し、手動でGoogle Driveにアップロードします。
        </div>

        <!-- Step 1: データ読み込み -->
        <div class="step-container" id="step1">
            <div class="step-title">
                <span>1️⃣</span>
                <span>既存データの読み込み</span>
            </div>
            <p>既存の分散構造データをアップロードしてください</p>
            
            <div class="file-drop-zone" id="fileDropZone" onclick="document.getElementById('fileInput').click()">
                <div style="font-size: 3em; margin-bottom: 10px;">📁</div>
                <div>フォルダをドラッグ&ドロップするか、クリックして選択</div>
                <div style="margin-top: 10px; font-size: 14px; color: #666;">
                    index/, contacts/, meetings/, attachments/ フォルダとoptions.jsonを選択
                </div>
            </div>
            
            <input type="file" id="fileInput" class="file-input" multiple webkitdirectory>
            
            <div id="fileList" class="file-list hidden"></div>
            
            <button class="btn btn-primary hidden" id="analyzeBtn" onclick="analyzeExistingData()">
                🔍 データ構造を分析
            </button>
        </div>

        <!-- Step 2: データ分析結果 -->
        <div class="step-container" id="step2">
            <div class="step-title">
                <span>2️⃣</span>
                <span>データ分析結果</span>
            </div>
            <div id="analysisResults" class="hidden">
                <div class="folder-structure" id="detectedStructure"></div>
                <div id="migrationPlan" class="file-list"></div>
                <button class="btn btn-success" id="prepareZipBtn" onclick="prepareZipDownload()">
                    📦 移行用ZIPファイルを準備
                </button>
            </div>
        </div>

        <!-- Step 3: ZIP生成進捗 -->
        <div class="step-container" id="step3">
            <div class="step-title">
                <span>3️⃣</span>
                <span>移行ファイル生成</span>
            </div>
            <div id="zipProgress" class="hidden">
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
                <div id="currentTask" style="margin: 10px 0; font-weight: bold;"></div>
                <div class="log-container" id="processingLog"></div>
            </div>
        </div>

        <!-- Step 4: ダウンロード -->
        <div class="step-container" id="step4">
            <div class="step-title">
                <span>4️⃣</span>
                <span>ダウンロード</span>
            </div>
            <div id="downloadSection" class="download-section hidden">
                <h3>✅ 移行ファイルの準備が完了しました！</h3>
                <div id="zipPreview" class="zip-preview"></div>
                <button class="btn btn-download" id="downloadBtn" onclick="downloadZip()">
                    📥 移行用ZIPファイルをダウンロード
                </button>
            </div>
        </div>

        <!-- Step 5: 手動アップロード手順 -->
        <div class="step-container" id="step5">
            <div class="step-title">
                <span>5️⃣</span>
                <span>Google Driveへの手動アップロード</span>
            </div>
            <div id="uploadInstructions" class="hidden">
                <div class="setup-section">
                    <h4>📋 アップロード手順：</h4>
                    <ol style="line-height: 2;">
                        <li><strong>ZIPファイルをダウンロード</strong>して、任意の場所に展開</li>
                        <li><strong>Google Drive</strong>を開く (https://drive.google.com)</li>
                        <li><strong>「1to1meeting」フォルダ</strong>を作成（既存があれば削除推奨）</li>
                        <li>展開したフォルダの<strong>中身をすべて</strong>Google Driveの1to1meetingフォルダにアップロード：
                            <ul style="margin: 10px 0;">
                                <li>📁 <strong>index/</strong> フォルダ</li>
                                <li>📁 <strong>contacts/</strong> フォルダ</li>
                                <li>📁 <strong>meetings/</strong> フォルダ</li>
                                <li>📁 <strong>attachments/</strong> フォルダ</li>
                                <li>📄 <strong>options.json</strong> ファイル</li>
                            </ul>
                        </li>
                        <li><strong>アップロード完了後</strong>、1to1meetingアプリで新しいフォルダを認識させる</li>
                    </ol>
                </div>
                
                <div class="migration-results">
                    <h4>🎯 移行完了予定の構造：</h4>
                    <div class="folder-structure">
/1to1meeting/  (Google Drive上)
  ├─ index/
  │   ├─ contacts-index.json
  │   ├─ search-index.json  
  │   ├─ meetings-index.json
  │   └─ metadata.json
  ├─ contacts/
  │   ├─ contact-000001.json
  │   └─ ... (個別ファイル)
  ├─ meetings/
  │   ├─ contact-000001-meetings.json
  │   └─ ... (個別ファイル)
  ├─ attachments/
  │   ├─ contacts/
  │   └─ meetings/
  └─ options.json
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let existingData = {};
        let zipData = {};
        let analysisResult = {};

        // ファイルドロップゾーンの設定
        const fileDropZone = document.getElementById('fileDropZone');
        const fileInput = document.getElementById('fileInput');

        fileDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropZone.classList.add('drag-over');
        });

        fileDropZone.addEventListener('dragleave', () => {
            fileDropZone.classList.remove('drag-over');
        });

        fileDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // ファイル処理
        function handleFiles(files) {
            const fileList = document.getElementById('fileList');
            const analyzeBtn = document.getElementById('analyzeBtn');
            
            fileList.innerHTML = '';
            fileList.classList.remove('hidden');
            
            let validFiles = 0;
            const expectedPaths = [
                'index/contacts-index.json',
                'index/search-index.json',
                'index/meetings-index.json',
                'index/metadata.json',
                'options.json'
            ];

            Array.from(files).forEach(file => {
                const path = file.webkitRelativePath || file.name;
                const isExpected = expectedPaths.some(p => path.endsWith(p)) || 
                                 path.includes('/contacts/') || 
                                 path.includes('/meetings/') || 
                                 path.includes('/attachments/');
                
                if (isExpected) validFiles++;

                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const icon = getFileIcon(file.name);
                const status = isExpected ? 
                    '<span class="status status-success">認識</span>' :
                    '<span class="status status-error">不明</span>';
                
                fileItem.innerHTML = `
                    <span class="file-icon">${icon}</span>
                    <span style="flex: 1;">${path}</span>
                    <span style="color: #666;">${formatFileSize(file.size)}</span>
                    ${status}
                `;
                
                fileList.appendChild(fileItem);
            });

            if (validFiles > 0) {
                analyzeBtn.classList.remove('hidden');
                log(`${validFiles}個の有効なファイルを検出しました`);
            } else {
                log('有効なファイルが見つかりませんでした');
                showError('適切な1to1meetingフォルダ構造が見つかりません');
            }
        }

        // データ分析
        async function analyzeExistingData() {
            try {
                log('データ構造を分析中...');
                const files = document.getElementById('fileInput').files;
                
                // ファイルを読み込んで分析
                for (let file of files) {
                    const path = file.webkitRelativePath || file.name;
                    
                    if (path.endsWith('.json')) {
                        const content = await readFileAsText(file);
                        try {
                            const data = JSON.parse(content);
                            existingData[path] = data;
                            log(`${path} を読み込みました`);
                        } catch (e) {
                            log(`${path} のJSONパースに失敗: ${e.message}`);
                        }
                    } else {
                        // 添付ファイル等
                        existingData[path] = file;
                    }
                }

                // 構造分析
                analysisResult = analyzeDataStructure();
                displayAnalysisResults(analysisResult);
                
                document.getElementById('analysisResults').classList.remove('hidden');
                document.getElementById('step2').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                log('分析エラー: ' + error.message);
                showError('データ分析に失敗しました: ' + error.message);
            }
        }

        function analyzeDataStructure() {
            const structure = {
                contacts: 0,
                meetings: 0,
                attachments: 0,
                indexes: [],
                issues: []
            };

            // インデックスファイルの確認
            const indexFiles = ['contacts-index.json', 'search-index.json', 'meetings-index.json', 'metadata.json'];
            indexFiles.forEach(file => {
                const path = `index/${file}`;
                if (existingData[path]) {
                    structure.indexes.push(file);
                } else {
                    structure.issues.push(`${file} が見つかりません`);
                }
            });

            // contacts数をカウント
            Object.keys(existingData).forEach(path => {
                if (path.includes('/contacts/') && path.endsWith('.json')) {
                    structure.contacts++;
                } else if (path.includes('/meetings/') && path.endsWith('.json')) {
                    structure.meetings++;
                } else if (path.includes('/attachments/')) {
                    structure.attachments++;
                }
            });

            return structure;
        }

        function displayAnalysisResults(analysis) {
            const structureEl = document.getElementById('detectedStructure');
            const planEl = document.getElementById('migrationPlan');

            structureEl.innerHTML = `
検出されたデータ構造:
├─ 連絡先: ${analysis.contacts}件
├─ ミーティング: ${analysis.meetings}件  
├─ 添付ファイル: ${analysis.attachments}件
├─ インデックス: ${analysis.indexes.length}/4個
└─ 問題: ${analysis.issues.length}件
            `;

            let planHtml = '<h4>移行計画:</h4>';
            if (analysis.issues.length === 0) {
                planHtml += `
                    <div class="file-item">
                        <span class="file-icon">📁</span>
                        <span>Google Drive用フォルダ構造を生成</span>
                        <span class="status status-success">準備完了</span>
                    </div>
                    <div class="file-item">
                        <span class="file-icon">📝</span>
                        <span>インデックスファイルのZIP化 (${analysis.indexes.length}件)</span>
                        <span class="status status-success">準備完了</span>
                    </div>
                    <div class="file-item">
                        <span class="file-icon">👥</span>
                        <span>連絡先データのZIP化 (${analysis.contacts}件)</span>
                        <span class="status status-success">準備完了</span>
                    </div>
                    <div class="file-item">
                        <span class="file-icon">📅</span>
                        <span>ミーティングデータのZIP化 (${analysis.meetings}件)</span>
                        <span class="status status-success">準備完了</span>
                    </div>
                    <div class="file-item">
                        <span class="file-icon">📎</span>
                        <span>添付ファイルのZIP化 (${analysis.attachments}件)</span>
                        <span class="status status-success">準備完了</span>
                    </div>
                `;
            } else {
                analysis.issues.forEach(issue => {
                    planHtml += `
                        <div class="file-item">
                            <span class="file-icon">⚠️</span>
                            <span>${issue}</span>
                            <span class="status status-error">要確認</span>
                        </div>
                    `;
                });
            }

            planEl.innerHTML = planHtml;

            if (analysis.issues.length === 0) {
                document.getElementById('prepareZipBtn').classList.remove('hidden');
            }
        }

        // ZIP準備
        async function prepareZipDownload() {
            try {
                document.getElementById('zipProgress').classList.remove('hidden');
                document.getElementById('step3').scrollIntoView({ behavior: 'smooth' });
                
                log('ZIPファイルを準備中...');
                updateProgress(0, 'フォルダ構造を準備中...');

                // JSZipライブラリを動的に読み込み
                if (typeof JSZip === 'undefined') {
                    await loadJSZip();
                }

                const zip = new JSZip();

                // 1. インデックスフォルダ
                updateProgress(20, 'インデックスファイルを処理中...');
                await addIndexFiles(zip);

                // 2. 連絡先フォルダ  
                updateProgress(40, '連絡先データを処理中...');
                await addContactsFiles(zip);

                // 3. ミーティングフォルダ
                updateProgress(60, 'ミーティングデータを処理中...');
                await addMeetingsFiles(zip);

                // 4. 添付ファイルフォルダ
                updateProgress(80, '添付ファイルを処理中...');
                await addAttachmentFiles(zip);

                // 5. options.json
                if (existingData['options.json']) {
                    zip.file('options.json', JSON.stringify(existingData['options.json'], null, 2));
                    log('options.jsonを追加しました');
                }

                updateProgress(100, 'ZIP生成完了！');

                // ZIPファイル生成
                zipData.blob = await zip.generateAsync({type: 'blob'});
                zipData.filename = `1to1meeting-migration-${new Date().toISOString().split('T')[0]}.zip`;

                showDownloadSection();

            } catch (error) {
                log('ZIP準備エラー: ' + error.message);
                showError('ZIPファイル準備に失敗しました: ' + error.message);
            }
        }

        async function loadJSZip() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function addIndexFiles(zip) {
            const indexFolder = zip.folder('index');
            const indexFiles = ['contacts-index.json', 'search-index.json', 'meetings-index.json', 'metadata.json'];
            
            for (let fileName of indexFiles) {
                const path = `index/${fileName}`;
                if (existingData[path]) {
                    indexFolder.file(fileName, JSON.stringify(existingData[path], null, 2));
                    log(`${fileName}をZIPに追加しました`);
                }
            }
        }

        async function addContactsFiles(zip) {
            const contactsFolder = zip.folder('contacts');
            const contactFiles = Object.keys(existingData).filter(path => 
                path.includes('/contacts/') && path.endsWith('.json')
            );

            for (let path of contactFiles) {
                const fileName = path.split('/').pop();
                contactsFolder.file(fileName, JSON.stringify(existingData[path], null, 2));
                
                if (contactFiles.indexOf(path) % 10 === 0) {
                    log(`連絡先データを処理中... (${contactFiles.indexOf(path) + 1}/${contactFiles.length})`);
                }
            }
            
            log(`${contactFiles.length}件の連絡先データをZIPに追加しました`);
        }

        async function addMeetingsFiles(zip) {
            const meetingsFolder = zip.folder('meetings');
            const meetingFiles = Object.keys(existingData).filter(path => 
                path.includes('/meetings/') && path.endsWith('.json')
            );

            for (let path of meetingFiles) {
                const fileName = path.split('/').pop();
                meetingsFolder.file(fileName, JSON.stringify(existingData[path], null, 2));
                
                if (meetingFiles.indexOf(path) % 10 === 0) {
                    log(`ミーティングデータを処理中... (${meetingFiles.indexOf(path) + 1}/${meetingFiles.length})`);
                }
            }
            
            log(`${meetingFiles.length}件のミーティングデータをZIPに追加しました`);
        }

        async function addAttachmentFiles(zip) {
            const attachmentsFolder = zip.folder('attachments');
            const attachmentFiles = Object.keys(existingData).filter(path => 
                path.includes('/attachments/') && !path.endsWith('/')
            );

            for (let path of attachmentFiles) {
                const file = existingData[path];
                const relativePath = path.replace(/^[^/]+\/attachments\//, '');
                
                if (file instanceof File) {
                    attachmentsFolder.file(relativePath, file);
                }
                
                if (attachmentFiles.indexOf(path) % 20 === 0) {
                    log(`添付ファイルを処理中... (${attachmentFiles.indexOf(path) + 1}/${attachmentFiles.length})`);
                }
            }
            
            log(`${attachmentFiles.length}件の添付ファイルをZIPに追加しました`);
        }

        function showDownloadSection() {
            const downloadSection = document.getElementById('downloadSection');
            const zipPreview = document.getElementById('zipPreview');
            
            let previewHtml = '<h4>📦 ZIP内容プレビュー:</h4>';
            previewHtml += `
                <div class="file-item">
                    <span class="file-icon">👥</span>
                    <span>連絡先データ: ${analysisResult.contacts}件</span>
                    <span class="status status-success">追加済み</span>
                </div>
                <div class="file-item">
                    <span class="file-icon">📅</span>
                    <span>ミーティングデータ: ${analysisResult.meetings}件</span>
                    <span class="status status-success">追加済み</span>
                </div>
                <div class="file-item">
                    <span class="file-icon">📎</span>
                    <span>添付ファイル: ${analysisResult.attachments}件</span>
                    <span class="status status-success">追加済み</span>
                </div>
                <div class="file-item">
                    <span class="file-icon">📄</span>
                    <span>ファイルサイズ: ${formatFileSize(zipData.blob.size)}</span>
                    <span class="status status-success">生成完了</span>
                </div>
            `;
            
            zipPreview.innerHTML = previewHtml;
            downloadSection.classList.remove('hidden');
            document.getElementById('uploadInstructions').classList.remove('hidden');
            document.getElementById('step4').scrollIntoView({ behavior: 'smooth' });
            
            log('ZIPファイルの準備が完了しました！');
        }

        function downloadZip() {
            if (!zipData.blob) {
                showError('ZIPファイルが準備されていません');
                return;
            }

            const url = URL.createObjectURL(zipData.blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = zipData.filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('ZIPファイルをダウンロードしました');
            
            // 手順を表示
            setTimeout(() => {
                document.getElementById('step5').scrollIntoView({ behavior: 'smooth' });
            }, 1000);
        }

        // ユーティリティ関数
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        function getFileIcon(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            const icons = {
                'json': '📄',
                'jpg': '🖼️',
                'jpeg': '🖼️', 
                'png': '🖼️',
                'pdf': '📕',
                'docx': '📝',
                'xlsx': '📊'
            };
            return icons[ext] || '📄';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateProgress(percent, task) {
            const progressBar = document.getElementById('progressBar');
            const currentTask = document.getElementById('currentTask');
            
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            currentTask.textContent = task;
        }

        function log(message) {
            const logContainer = document.getElementById('processingLog');
            if (logContainer) {
                const timestamp = new Date().toLocaleTimeString();
                logContainer.innerHTML += `<div>[${timestamp}] ${message}</div>`;
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            console.log(message);
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.body.insertBefore(errorDiv, document.querySelector('.container'));
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 8000);
        }
    </script>
</body>
</html>