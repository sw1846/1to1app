<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1to1Meeting データ移行ツール</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .step-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #667eea;
        }

        .step-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-drop-zone {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: rgba(102, 126, 234, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-drop-zone:hover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.1);
        }

        .file-drop-zone.drag-over {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
            transform: scale(1.02);
        }

        .file-input {
            display: none;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            color: #333;
        }

        .progress-container {
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            height: 20px;
            margin: 15px 0;
        }

        .progress-bar {
            background: linear-gradient(45deg, #28a745, #20c997);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .log-container {
            background: #1e1e1e;
            color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .file-list {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
        }

        .file-item {
            padding: 8px 0;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-icon {
            font-size: 1.2em;
        }

        .status {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-processing {
            background: #d1ecf1;
            color: #0c5460;
        }

        .google-auth-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .migration-results {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #721c24;
        }

        .folder-structure {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            margin: 15px 0;
        }

        .hidden {
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔄 1to1Meeting データ移行ツール</h1>

        <!-- Step 1: Google認証 -->
        <div class="step-container" id="step1">
            <div class="step-title">
                <span>1️⃣</span>
                <span>Google Drive認証</span>
            </div>
            <div class="google-auth-section">
                <p>新しいGoogle Drive環境に接続します</p>
                <button class="btn btn-primary" onclick="initializeGoogleAuth()">
                    🔐 Google認証を開始
                </button>
                <div id="auth-status" class="status hidden"></div>
            </div>
        </div>

        <!-- Step 2: 既存データの読み込み -->
        <div class="step-container" id="step2">
            <div class="step-title">
                <span>2️⃣</span>
                <span>既存データの読み込み</span>
            </div>
            <p>既存の分散構造データをアップロードしてください</p>
            
            <div class="file-drop-zone" id="fileDropZone" onclick="document.getElementById('fileInput').click()">
                <div style="font-size: 3em; margin-bottom: 10px;">📁</div>
                <div>フォルダをドラッグ&ドロップするか、クリックして選択</div>
                <div style="margin-top: 10px; font-size: 14px; color: #666;">
                    index/, contacts/, meetings/, attachments/ フォルダとoptions.jsonを選択
                </div>
            </div>
            
            <input type="file" id="fileInput" class="file-input" multiple webkitdirectory>
            
            <div id="fileList" class="file-list hidden"></div>
            
            <button class="btn btn-primary hidden" id="analyzeBtn" onclick="analyzeExistingData()">
                🔍 データ構造を分析
            </button>
        </div>

        <!-- Step 3: データ分析結果 -->
        <div class="step-container" id="step3">
            <div class="step-title">
                <span>3️⃣</span>
                <span>データ分析結果</span>
            </div>
            <div id="analysisResults" class="hidden">
                <div class="folder-structure" id="detectedStructure"></div>
                <div id="migrationPlan" class="file-list"></div>
                <button class="btn btn-success" id="startMigrationBtn" onclick="startMigration()">
                    🚀 データ移行を開始
                </button>
            </div>
        </div>

        <!-- Step 4: 移行進捗 -->
        <div class="step-container" id="step4">
            <div class="step-title">
                <span>4️⃣</span>
                <span>データ移行実行</span>
            </div>
            <div id="migrationProgress" class="hidden">
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
                <div id="currentTask" style="margin: 10px 0; font-weight: bold;"></div>
                <div class="log-container" id="migrationLog"></div>
            </div>
        </div>

        <!-- Step 5: 完了 -->
        <div class="step-container" id="step5">
            <div class="step-title">
                <span>5️⃣</span>
                <span>移行完了</span>
            </div>
            <div id="migrationResults" class="migration-results hidden">
                <h3>✅ データ移行が完了しました！</h3>
                <div id="resultsDetails"></div>
                <button class="btn btn-primary" onclick="downloadMigrationReport()">
                    📋 移行レポートをダウンロード
                </button>
            </div>
        </div>
    </div>

    <!-- Google APIs -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script>
        // グローバル変数
        let isGoogleAuthInitialized = false;
        let googleAccessToken = null;
        let existingData = {};
        let migrationPlan = {};
        let newFolderId = null;

        // Google Drive設定
        const GOOGLE_CONFIG = {
            CLIENT_ID: '938239904261-vt7rego8tmo4vhhcjp3fadca25asuh73.apps.googleusercontent.com',
            SCOPES: 'https://www.googleapis.com/auth/drive.file',
            DISCOVERY_DOCS: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
        };

        // ファイルドロップゾーンの設定
        const fileDropZone = document.getElementById('fileDropZone');
        const fileInput = document.getElementById('fileInput');

        fileDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropZone.classList.add('drag-over');
        });

        fileDropZone.addEventListener('dragleave', () => {
            fileDropZone.classList.remove('drag-over');
        });

        fileDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // Google認証初期化
        async function initializeGoogleAuth() {
            try {
                log('Google認証を初期化中...');
                updateAuthStatus('processing', 'Google APIを読み込み中...');

                await loadGoogleAPIs();
                
                // OAuth2設定
                window.gapi.load('auth2', async () => {
                    try {
                        const authInstance = await window.gapi.auth2.init({
                            client_id: GOOGLE_CONFIG.CLIENT_ID,
                            scope: GOOGLE_CONFIG.SCOPES
                        });

                        const user = await authInstance.signIn();
                        googleAccessToken = user.getAuthResponse().access_token;
                        
                        updateAuthStatus('success', '認証成功！');
                        log('Google認証完了');
                        isGoogleAuthInitialized = true;
                        
                        // 次のステップを有効化
                        document.getElementById('step2').style.opacity = '1';
                        
                    } catch (error) {
                        console.error('認証エラー:', error);
                        updateAuthStatus('error', '認証に失敗しました');
                        log('認証エラー: ' + error.message);
                    }
                });

            } catch (error) {
                console.error('初期化エラー:', error);
                updateAuthStatus('error', '初期化に失敗しました');
                log('初期化エラー: ' + error.message);
            }
        }

        async function loadGoogleAPIs() {
            return new Promise((resolve, reject) => {
                if (window.gapi) {
                    window.gapi.load('client', async () => {
                        try {
                            await window.gapi.client.init({
                                discoveryDocs: GOOGLE_CONFIG.DISCOVERY_DOCS
                            });
                            resolve();
                        } catch (error) {
                            reject(error);
                        }
                    });
                } else {
                    reject(new Error('Google APIが読み込まれていません'));
                }
            });
        }

        function updateAuthStatus(type, message) {
            const statusEl = document.getElementById('auth-status');
            statusEl.className = `status status-${type}`;
            statusEl.textContent = message;
            statusEl.classList.remove('hidden');
        }

        // ファイル処理
        function handleFiles(files) {
            const fileList = document.getElementById('fileList');
            const analyzeBtn = document.getElementById('analyzeBtn');
            
            fileList.innerHTML = '';
            fileList.classList.remove('hidden');
            
            let validFiles = 0;
            const expectedPaths = [
                'index/contacts-index.json',
                'index/search-index.json',
                'index/meetings-index.json',
                'index/metadata.json',
                'options.json'
            ];

            Array.from(files).forEach(file => {
                const path = file.webkitRelativePath || file.name;
                const isExpected = expectedPaths.some(p => path.endsWith(p)) || 
                                 path.includes('/contacts/') || 
                                 path.includes('/meetings/') || 
                                 path.includes('/attachments/');
                
                if (isExpected) validFiles++;

                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const icon = getFileIcon(file.name);
                const status = isExpected ? 
                    '<span class="status status-success">認識</span>' :
                    '<span class="status status-error">不明</span>';
                
                fileItem.innerHTML = `
                    <span class="file-icon">${icon}</span>
                    <span style="flex: 1;">${path}</span>
                    <span style="color: #666;">${formatFileSize(file.size)}</span>
                    ${status}
                `;
                
                fileList.appendChild(fileItem);
            });

            if (validFiles > 0) {
                analyzeBtn.classList.remove('hidden');
                log(`${validFiles}個の有効なファイルを検出しました`);
            } else {
                log('有効なファイルが見つかりませんでした');
                showError('適切な1to1meetingフォルダ構造が見つかりません');
            }
        }

        // データ分析
        async function analyzeExistingData() {
            try {
                log('データ構造を分析中...');
                const files = document.getElementById('fileInput').files;
                
                // ファイルを読み込んで分析
                for (let file of files) {
                    const path = file.webkitRelativePath || file.name;
                    
                    if (path.endsWith('.json')) {
                        const content = await readFileAsText(file);
                        try {
                            const data = JSON.parse(content);
                            existingData[path] = data;
                            log(`${path} を読み込みました`);
                        } catch (e) {
                            log(`${path} のJSONパースに失敗: ${e.message}`);
                        }
                    } else {
                        // 添付ファイル等
                        existingData[path] = file;
                    }
                }

                // 構造分析
                const analysis = analyzeDataStructure();
                displayAnalysisResults(analysis);
                
                document.getElementById('analysisResults').classList.remove('hidden');
                document.getElementById('step3').style.opacity = '1';
                
            } catch (error) {
                log('分析エラー: ' + error.message);
                showError('データ分析に失敗しました: ' + error.message);
            }
        }

        function analyzeDataStructure() {
            const structure = {
                contacts: 0,
                meetings: 0,
                attachments: 0,
                indexes: [],
                issues: []
            };

            // インデックスファイルの確認
            const indexFiles = ['contacts-index.json', 'search-index.json', 'meetings-index.json', 'metadata.json'];
            indexFiles.forEach(file => {
                const path = `index/${file}`;
                if (existingData[path]) {
                    structure.indexes.push(file);
                } else {
                    structure.issues.push(`${file} が見つかりません`);
                }
            });

            // contacts数をカウント
            Object.keys(existingData).forEach(path => {
                if (path.includes('/contacts/') && path.endsWith('.json')) {
                    structure.contacts++;
                } else if (path.includes('/meetings/') && path.endsWith('.json')) {
                    structure.meetings++;
                } else if (path.includes('/attachments/')) {
                    structure.attachments++;
                }
            });

            return structure;
        }

        function displayAnalysisResults(analysis) {
            const structureEl = document.getElementById('detectedStructure');
            const planEl = document.getElementById('migrationPlan');

            structureEl.innerHTML = `
検出されたデータ構造:
├─ 連絡先: ${analysis.contacts}件
├─ ミーティング: ${analysis.meetings}件  
├─ 添付ファイル: ${analysis.attachments}件
├─ インデックス: ${analysis.indexes.length}/4個
└─ 問題: ${analysis.issues.length}件
            `;

            let planHtml = '<h4>移行計画:</h4>';
            if (analysis.issues.length === 0) {
                planHtml += `
                    <div class="file-item">
                        <span class="file-icon">📁</span>
                        <span>新しいGoogle Driveフォルダ構造を作成</span>
                        <span class="status status-success">準備完了</span>
                    </div>
                    <div class="file-item">
                        <span class="file-icon">📝</span>
                        <span>インデックスファイルの移行 (${analysis.indexes.length}件)</span>
                        <span class="status status-success">準備完了</span>
                    </div>
                    <div class="file-item">
                        <span class="file-icon">👥</span>
                        <span>連絡先データの移行 (${analysis.contacts}件)</span>
                        <span class="status status-success">準備完了</span>
                    </div>
                    <div class="file-item">
                        <span class="file-icon">📅</span>
                        <span>ミーティングデータの移行 (${analysis.meetings}件)</span>
                        <span class="status status-success">準備完了</span>
                    </div>
                    <div class="file-item">
                        <span class="file-icon">📎</span>
                        <span>添付ファイルの移行 (${analysis.attachments}件)</span>
                        <span class="status status-success">準備完了</span>
                    </div>
                `;
            } else {
                analysis.issues.forEach(issue => {
                    planHtml += `
                        <div class="file-item">
                            <span class="file-icon">⚠️</span>
                            <span>${issue}</span>
                            <span class="status status-error">要確認</span>
                        </div>
                    `;
                });
            }

            planEl.innerHTML = planHtml;

            if (analysis.issues.length === 0) {
                document.getElementById('startMigrationBtn').classList.remove('hidden');
            }
        }

        // データ移行実行
        async function startMigration() {
            if (!isGoogleAuthInitialized || !googleAccessToken) {
                showError('Google認証が必要です');
                return;
            }

            try {
                document.getElementById('migrationProgress').classList.remove('hidden');
                document.getElementById('step4').style.opacity = '1';
                
                log('データ移行を開始します...');
                updateProgress(0, 'フォルダ構造を作成中...');

                // 1. メインフォルダ作成
                newFolderId = await createMainFolder();
                updateProgress(10, 'サブフォルダを作成中...');

                // 2. サブフォルダ作成
                const folderIds = await createSubFolders(newFolderId);
                updateProgress(30, 'インデックスファイルを移行中...');

                // 3. インデックスファイル移行
                await migrateIndexFiles(folderIds.index);
                updateProgress(50, '連絡先データを移行中...');

                // 4. 連絡先データ移行
                await migrateContactsData(folderIds.contacts);
                updateProgress(70, 'ミーティングデータを移行中...');

                // 5. ミーティングデータ移行  
                await migrateMeetingsData(folderIds.meetings);
                updateProgress(90, '添付ファイルを移行中...');

                // 6. 添付ファイル移行
                await migrateAttachments(folderIds.attachments);
                
                // 7. options.jsonを移行
                if (existingData['options.json']) {
                    await uploadJsonFile(newFolderId, 'options.json', existingData['options.json']);
                }

                updateProgress(100, '移行完了！');
                showMigrationResults();

            } catch (error) {
                log('移行エラー: ' + error.message);
                showError('データ移行に失敗しました: ' + error.message);
            }
        }

        // Google Drive API関数
        async function createMainFolder() {
            const metadata = {
                name: '1to1meeting',
                mimeType: 'application/vnd.google-apps.folder'
            };

            const response = await fetch('https://www.googleapis.com/drive/v3/files', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${googleAccessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(metadata)
            });

            if (!response.ok) {
                throw new Error('メインフォルダ作成に失敗しました');
            }

            const result = await response.json();
            log(`メインフォルダを作成しました: ${result.id}`);
            return result.id;
        }

        async function createSubFolders(parentId) {
            const folders = ['index', 'contacts', 'meetings', 'attachments'];
            const folderIds = {};

            for (let folderName of folders) {
                const metadata = {
                    name: folderName,
                    parents: [parentId],
                    mimeType: 'application/vnd.google-apps.folder'
                };

                const response = await fetch('https://www.googleapis.com/drive/v3/files', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(metadata)
                });

                if (!response.ok) {
                    throw new Error(`${folderName}フォルダ作成に失敗しました`);
                }

                const result = await response.json();
                folderIds[folderName] = result.id;
                log(`${folderName}フォルダを作成しました: ${result.id}`);
            }

            // attachmentsサブフォルダ作成
            const attachmentSubFolders = ['contacts', 'meetings'];
            folderIds.attachmentSub = {};
            
            for (let subFolder of attachmentSubFolders) {
                const metadata = {
                    name: subFolder,
                    parents: [folderIds.attachments],
                    mimeType: 'application/vnd.google-apps.folder'
                };

                const response = await fetch('https://www.googleapis.com/drive/v3/files', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(metadata)
                });

                if (response.ok) {
                    const result = await response.json();
                    folderIds.attachmentSub[subFolder] = result.id;
                    log(`attachments/${subFolder}フォルダを作成しました`);
                }
            }

            return folderIds;
        }

        async function uploadJsonFile(parentId, fileName, data) {
            const blob = new Blob([JSON.stringify(data, null, 2)], {
                type: 'application/json'
            });

            const formData = new FormData();
            formData.append('metadata', JSON.stringify({
                name: fileName,
                parents: [parentId]
            }));
            formData.append('file', blob);

            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${googleAccessToken}`
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error(`${fileName}のアップロードに失敗しました`);
            }

            const result = await response.json();
            log(`${fileName}をアップロードしました`);
            return result.id;
        }

        async function uploadFile(parentId, fileName, file) {
            const formData = new FormData();
            formData.append('metadata', JSON.stringify({
                name: fileName,
                parents: [parentId]
            }));
            formData.append('file', file);

            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${googleAccessToken}`
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error(`${fileName}のアップロードに失敗しました`);
            }

            const result = await response.json();
            return result.id;
        }

        // データ移行関数
        async function migrateIndexFiles(indexFolderId) {
            const indexFiles = ['contacts-index.json', 'search-index.json', 'meetings-index.json', 'metadata.json'];
            
            for (let fileName of indexFiles) {
                const path = `index/${fileName}`;
                if (existingData[path]) {
                    await uploadJsonFile(indexFolderId, fileName, existingData[path]);
                    log(`${fileName}を移行しました`);
                }
            }
        }

        async function migrateContactsData(contactsFolderId) {
            const contactFiles = Object.keys(existingData).filter(path => 
                path.includes('/contacts/') && path.endsWith('.json')
            );

            for (let i = 0; i < contactFiles.length; i++) {
                const path = contactFiles[i];
                const fileName = path.split('/').pop();
                await uploadJsonFile(contactsFolderId, fileName, existingData[path]);
                
                if (i % 10 === 0) {
                    const progress = 50 + Math.floor((i / contactFiles.length) * 20);
                    updateProgress(progress, `連絡先データを移行中... (${i + 1}/${contactFiles.length})`);
                }
            }
            
            log(`${contactFiles.length}件の連絡先データを移行しました`);
        }

        async function migrateMeetingsData(meetingsFolderId) {
            const meetingFiles = Object.keys(existingData).filter(path => 
                path.includes('/meetings/') && path.endsWith('.json')
            );

            for (let i = 0; i < meetingFiles.length; i++) {
                const path = meetingFiles[i];
                const fileName = path.split('/').pop();
                await uploadJsonFile(meetingsFolderId, fileName, existingData[path]);
                
                if (i % 10 === 0) {
                    const progress = 70 + Math.floor((i / meetingFiles.length) * 20);
                    updateProgress(progress, `ミーティングデータを移行中... (${i + 1}/${meetingFiles.length})`);
                }
            }
            
            log(`${meetingFiles.length}件のミーティングデータを移行しました`);
        }

        async function migrateAttachments(attachmentsFolderId) {
            const attachmentFiles = Object.keys(existingData).filter(path => 
                path.includes('/attachments/') && !path.endsWith('/')
            );

            for (let i = 0; i < attachmentFiles.length; i++) {
                const path = attachmentFiles[i];
                const file = existingData[path];
                const pathParts = path.split('/');
                const fileName = pathParts.pop();
                
                // フォルダ構造を再現
                let parentId = attachmentsFolderId;
                // 必要に応じて追加のフォルダ作成ロジック
                
                if (file instanceof File) {
                    await uploadFile(parentId, fileName, file);
                }
                
                if (i % 20 === 0) {
                    const progress = 90 + Math.floor((i / attachmentFiles.length) * 10);
                    updateProgress(progress, `添付ファイルを移行中... (${i + 1}/${attachmentFiles.length})`);
                }
            }
            
            log(`${attachmentFiles.length}件の添付ファイルを移行しました`);
        }

        function showMigrationResults() {
            const resultsEl = document.getElementById('migrationResults');
            const detailsEl = document.getElementById('resultsDetails');
            
            const analysis = analyzeDataStructure();
            
            detailsEl.innerHTML = `
                <h4>移行結果:</h4>
                <div class="file-item">
                    <span class="file-icon">👥</span>
                    <span>連絡先: ${analysis.contacts}件</span>
                    <span class="status status-success">完了</span>
                </div>
                <div class="file-item">
                    <span class="file-icon">📅</span>
                    <span>ミーティング: ${analysis.meetings}件</span>
                    <span class="status status-success">完了</span>
                </div>
                <div class="file-item">
                    <span class="file-icon">📎</span>
                    <span>添付ファイル: ${analysis.attachments}件</span>
                    <span class="status status-success">完了</span>
                </div>
                <div class="file-item">
                    <span class="file-icon">🆔</span>
                    <span>新しいフォルダID: ${newFolderId}</span>
                    <span class="status status-success">作成済み</span>
                </div>
            `;
            
            resultsEl.classList.remove('hidden');
            document.getElementById('step5').style.opacity = '1';
            
            log('データ移行が正常に完了しました！');
        }

        // ユーティリティ関数
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        function getFileIcon(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            const icons = {
                'json': '📄',
                'jpg': '🖼️',
                'jpeg': '🖼️', 
                'png': '🖼️',
                'pdf': '📕',
                'docx': '📝',
                'xlsx': '📊'
            };
            return icons[ext] || '📄';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateProgress(percent, task) {
            const progressBar = document.getElementById('progressBar');
            const currentTask = document.getElementById('currentTask');
            
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            currentTask.textContent = task;
        }

        function log(message) {
            const logContainer = document.getElementById('migrationLog');
            const timestamp = new Date().toLocaleTimeString();
            logContainer.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.body.insertBefore(errorDiv, document.querySelector('.container'));
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        function downloadMigrationReport() {
            const analysis = analyzeDataStructure();
            const report = {
                timestamp: new Date().toISOString(),
                newFolderId: newFolderId,
                migration: {
                    contacts: analysis.contacts,
                    meetings: analysis.meetings,
                    attachments: analysis.attachments,
                    indexes: analysis.indexes.length
                },
                status: 'completed'
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'migration-report.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // 初期化時に一部のステップを無効化
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('step2').style.opacity = '0.5';
            document.getElementById('step3').style.opacity = '0.5';
            document.getElementById('step4').style.opacity = '0.5';
            document.getElementById('step5').style.opacity = '0.5';
        });
    </script>
</body>
</html>