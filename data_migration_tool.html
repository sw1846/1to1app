<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1to1Meeting ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ„ãƒ¼ãƒ«ï¼ˆç°¡æ˜“ç‰ˆï¼‰</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .step-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #667eea;
        }

        .step-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-drop-zone {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: rgba(102, 126, 234, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-drop-zone:hover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.1);
        }

        .file-drop-zone.drag-over {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
            transform: scale(1.02);
        }

        .file-input {
            display: none;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .btn-download {
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .progress-container {
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            height: 20px;
            margin: 15px 0;
        }

        .progress-bar {
            background: linear-gradient(45deg, #28a745, #20c997);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .log-container {
            background: #1e1e1e;
            color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .file-list {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
        }

        .file-item {
            padding: 8px 0;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-icon {
            font-size: 1.2em;
        }

        .status {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-processing {
            background: #d1ecf1;
            color: #0c5460;
        }

        .setup-section {
            background: #e7f3ff;
            border: 1px solid #bee5eb;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .migration-results {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #721c24;
        }

        .info-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #856404;
        }

        .folder-structure {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            margin: 15px 0;
        }

        .download-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        .zip-preview {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ 1to1Meeting ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ„ãƒ¼ãƒ«ï¼ˆç°¡æ˜“ç‰ˆï¼‰</h1>

        <div class="info-box">
            <strong>ğŸ“ ä½¿ç”¨æ–¹æ³•ï¼š</strong> Googleèªè¨¼ã®ä»£ã‚ã‚Šã«ã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã€æ‰‹å‹•ã§Google Driveã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
        </div>

        <!-- Step 1: ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ -->
        <div class="step-container" id="step1">
            <div class="step-title">
                <span>1ï¸âƒ£</span>
                <span>æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿</span>
            </div>
            <p>æ—¢å­˜ã®åˆ†æ•£æ§‹é€ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>
            
            <div class="file-drop-zone" id="fileDropZone" onclick="document.getElementById('fileInput').click()">
                <div style="font-size: 3em; margin-bottom: 10px;">ğŸ“</div>
                <div>ãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</div>
                <div style="margin-top: 10px; font-size: 14px; color: #666;">
                    index/, contacts/, meetings/, attachments/ ãƒ•ã‚©ãƒ«ãƒ€ã¨options.jsonã‚’é¸æŠ
                </div>
            </div>
            
            <input type="file" id="fileInput" class="file-input" multiple webkitdirectory>
            
            <div id="fileList" class="file-list hidden"></div>
            
            <button class="btn btn-primary hidden" id="analyzeBtn" onclick="analyzeExistingData()">
                ğŸ” ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’åˆ†æ
            </button>
        </div>

        <!-- Step 2: ãƒ‡ãƒ¼ã‚¿åˆ†æçµæœ -->
        <div class="step-container" id="step2">
            <div class="step-title">
                <span>2ï¸âƒ£</span>
                <span>ãƒ‡ãƒ¼ã‚¿åˆ†æçµæœ</span>
            </div>
            <div id="analysisResults" class="hidden">
                <div class="folder-structure" id="detectedStructure"></div>
                <div id="migrationPlan" class="file-list"></div>
                <button class="btn btn-success" id="prepareZipBtn" onclick="prepareZipDownload()">
                    ğŸ“¦ ç§»è¡Œç”¨ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™
                </button>
            </div>
        </div>

        <!-- Step 3: ZIPç”Ÿæˆé€²æ— -->
        <div class="step-container" id="step3">
            <div class="step-title">
                <span>3ï¸âƒ£</span>
                <span>ç§»è¡Œãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ</span>
            </div>
            <div id="zipProgress" class="hidden">
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
                <div id="currentTask" style="margin: 10px 0; font-weight: bold;"></div>
                <div class="log-container" id="processingLog"></div>
            </div>
        </div>

        <!-- Step 4: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ -->
        <div class="step-container" id="step4">
            <div class="step-title">
                <span>4ï¸âƒ£</span>
                <span>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</span>
            </div>
            <div id="downloadSection" class="download-section hidden">
                <h3>âœ… ç§»è¡Œãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸï¼</h3>
                <div id="zipPreview" class="zip-preview"></div>
                <button class="btn btn-download" id="downloadBtn" onclick="downloadZip()">
                    ğŸ“¥ ç§»è¡Œç”¨ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
            </div>
        </div>

        <!-- Step 5: æ‰‹å‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ‰‹é † -->
        <div class="step-container" id="step5">
            <div class="step-title">
                <span>5ï¸âƒ£</span>
                <span>Google Driveã¸ã®æ‰‹å‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</span>
            </div>
            <div id="uploadInstructions" class="hidden">
                <div class="setup-section">
                    <h4>ğŸ“‹ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ‰‹é †ï¼š</h4>
                    <ol style="line-height: 2;">
                        <li><strong>ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</strong>ã—ã¦ã€ä»»æ„ã®å ´æ‰€ã«å±•é–‹</li>
                        <li><strong>Google Drive</strong>ã‚’é–‹ã (https://drive.google.com)</li>
                        <li><strong>ã€Œ1to1meetingã€ãƒ•ã‚©ãƒ«ãƒ€</strong>ã‚’ä½œæˆï¼ˆæ—¢å­˜ãŒã‚ã‚Œã°å‰Šé™¤æ¨å¥¨ï¼‰</li>
                        <li>å±•é–‹ã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã®<strong>ä¸­èº«ã‚’ã™ã¹ã¦</strong>Google Driveã®1to1meetingãƒ•ã‚©ãƒ«ãƒ€ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼š
                            <ul style="margin: 10px 0;">
                                <li>ğŸ“ <strong>index/</strong> ãƒ•ã‚©ãƒ«ãƒ€</li>
                                <li>ğŸ“ <strong>contacts/</strong> ãƒ•ã‚©ãƒ«ãƒ€</li>
                                <li>ğŸ“ <strong>meetings/</strong> ãƒ•ã‚©ãƒ«ãƒ€</li>
                                <li>ğŸ“ <strong>attachments/</strong> ãƒ•ã‚©ãƒ«ãƒ€</li>
                                <li>ğŸ“„ <strong>options.json</strong> ãƒ•ã‚¡ã‚¤ãƒ«</li>
                            </ul>
                        </li>
                        <li><strong>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œ</strong>ã€1to1meetingã‚¢ãƒ—ãƒªã§æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€ã‚’èªè­˜ã•ã›ã‚‹</li>
                    </ol>
                </div>
                
                <div class="migration-results">
                    <h4>ğŸ¯ ç§»è¡Œå®Œäº†äºˆå®šã®æ§‹é€ ï¼š</h4>
                    <div class="folder-structure">
/1to1meeting/  (Google Driveä¸Š)
  â”œâ”€ index/
  â”‚   â”œâ”€ contacts-index.json
  â”‚   â”œâ”€ search-index.json  
  â”‚   â”œâ”€ meetings-index.json
  â”‚   â””â”€ metadata.json
  â”œâ”€ contacts/
  â”‚   â”œâ”€ contact-000001.json
  â”‚   â””â”€ ... (å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«)
  â”œâ”€ meetings/
  â”‚   â”œâ”€ contact-000001-meetings.json
  â”‚   â””â”€ ... (å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«)
  â”œâ”€ attachments/
  â”‚   â”œâ”€ contacts/
  â”‚   â””â”€ meetings/
  â””â”€ options.json
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let existingData = {};
        let zipData = {};
        let analysisResult = {};

        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã®è¨­å®š
        const fileDropZone = document.getElementById('fileDropZone');
        const fileInput = document.getElementById('fileInput');

        fileDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropZone.classList.add('drag-over');
        });

        fileDropZone.addEventListener('dragleave', () => {
            fileDropZone.classList.remove('drag-over');
        });

        fileDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        function handleFiles(files) {
            const fileList = document.getElementById('fileList');
            const analyzeBtn = document.getElementById('analyzeBtn');
            
            fileList.innerHTML = '';
            fileList.classList.remove('hidden');
            
            let validFiles = 0;
            const expectedPaths = [
                'index/contacts-index.json',
                'index/search-index.json',
                'index/meetings-index.json',
                'index/metadata.json',
                'options.json'
            ];

            Array.from(files).forEach(file => {
                const path = file.webkitRelativePath || file.name;
                const isExpected = expectedPaths.some(p => path.endsWith(p)) || 
                                 path.includes('/contacts/') || 
                                 path.includes('/meetings/') || 
                                 path.includes('/attachments/');
                
                if (isExpected) validFiles++;

                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const icon = getFileIcon(file.name);
                const status = isExpected ? 
                    '<span class="status status-success">èªè­˜</span>' :
                    '<span class="status status-error">ä¸æ˜</span>';
                
                fileItem.innerHTML = `
                    <span class="file-icon">${icon}</span>
                    <span style="flex: 1;">${path}</span>
                    <span style="color: #666;">${formatFileSize(file.size)}</span>
                    ${status}
                `;
                
                fileList.appendChild(fileItem);
            });

            if (validFiles > 0) {
                analyzeBtn.classList.remove('hidden');
                log(`${validFiles}å€‹ã®æœ‰åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡ºã—ã¾ã—ãŸ`);
            } else {
                log('æœ‰åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                showError('é©åˆ‡ãª1to1meetingãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        }

        // ãƒ‡ãƒ¼ã‚¿åˆ†æ
        async function analyzeExistingData() {
            try {
                log('ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’åˆ†æä¸­...');
                const files = document.getElementById('fileInput').files;
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§åˆ†æ
                for (let file of files) {
                    const path = file.webkitRelativePath || file.name;
                    
                    if (path.endsWith('.json')) {
                        const content = await readFileAsText(file);
                        try {
                            const data = JSON.parse(content);
                            existingData[path] = data;
                            log(`${path} ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
                        } catch (e) {
                            log(`${path} ã®JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—: ${e.message}`);
                        }
                    } else {
                        // æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ç­‰
                        existingData[path] = file;
                    }
                }

                // æ§‹é€ åˆ†æ
                analysisResult = analyzeDataStructure();
                displayAnalysisResults(analysisResult);
                
                document.getElementById('analysisResults').classList.remove('hidden');
                document.getElementById('step2').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                log('åˆ†æã‚¨ãƒ©ãƒ¼: ' + error.message);
                showError('ãƒ‡ãƒ¼ã‚¿åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function analyzeDataStructure() {
            const structure = {
                contacts: 0,
                meetings: 0,
                attachments: 0,
                indexes: [],
                issues: []
            };

            // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
            const indexFiles = ['contacts-index.json', 'search-index.json', 'meetings-index.json', 'metadata.json'];
            indexFiles.forEach(file => {
                const path = `index/${file}`;
                if (existingData[path]) {
                    structure.indexes.push(file);
                } else {
                    structure.issues.push(`${file} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                }
            });

            // contactsæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            Object.keys(existingData).forEach(path => {
                if (path.includes('/contacts/') && path.endsWith('.json')) {
                    structure.contacts++;
                } else if (path.includes('/meetings/') && path.endsWith('.json')) {
                    structure.meetings++;
                } else if (path.includes('/attachments/')) {
                    structure.attachments++;
                }
            });

            return structure;
        }

        function displayAnalysisResults(analysis) {
            const structureEl = document.getElementById('detectedStructure');
            const planEl = document.getElementById('migrationPlan');

            structureEl.innerHTML = `
æ¤œå‡ºã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿æ§‹é€ :
â”œâ”€ é€£çµ¡å…ˆ: ${analysis.contacts}ä»¶
â”œâ”€ ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°: ${analysis.meetings}ä»¶  
â”œâ”€ æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«: ${analysis.attachments}ä»¶
â”œâ”€ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ${analysis.indexes.length}/4å€‹
â””â”€ å•é¡Œ: ${analysis.issues.length}ä»¶
            `;

            let planHtml = '<h4>ç§»è¡Œè¨ˆç”»:</h4>';
            if (analysis.issues.length === 0) {
                planHtml += `
                    <div class="file-item">
                        <span class="file-icon">ğŸ“</span>
                        <span>Google Driveç”¨ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã‚’ç”Ÿæˆ</span>
                        <span class="status status-success">æº–å‚™å®Œäº†</span>
                    </div>
                    <div class="file-item">
                        <span class="file-icon">ğŸ“</span>
                        <span>ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®ZIPåŒ– (${analysis.indexes.length}ä»¶)</span>
                        <span class="status status-success">æº–å‚™å®Œäº†</span>
                    </div>
                    <div class="file-item">
                        <span class="file-icon">ğŸ‘¥</span>
                        <span>é€£çµ¡å…ˆãƒ‡ãƒ¼ã‚¿ã®ZIPåŒ– (${analysis.contacts}ä»¶)</span>
                        <span class="status status-success">æº–å‚™å®Œäº†</span>
                    </div>
                    <div class="file-item">
                        <span class="file-icon">ğŸ“…</span>
                        <span>ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®ZIPåŒ– (${analysis.meetings}ä»¶)</span>
                        <span class="status status-success">æº–å‚™å®Œäº†</span>
                    </div>
                    <div class="file-item">
                        <span class="file-icon">ğŸ“</span>
                        <span>æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ZIPåŒ– (${analysis.attachments}ä»¶)</span>
                        <span class="status status-success">æº–å‚™å®Œäº†</span>
                    </div>
                `;
            } else {
                analysis.issues.forEach(issue => {
                    planHtml += `
                        <div class="file-item">
                            <span class="file-icon">âš ï¸</span>
                            <span>${issue}</span>
                            <span class="status status-error">è¦ç¢ºèª</span>
                        </div>
                    `;
                });
            }

            planEl.innerHTML = planHtml;

            if (analysis.issues.length === 0) {
                document.getElementById('prepareZipBtn').classList.remove('hidden');
            }
        }

        // ZIPæº–å‚™
        async function prepareZipDownload() {
            try {
                document.getElementById('zipProgress').classList.remove('hidden');
                document.getElementById('step3').scrollIntoView({ behavior: 'smooth' });
                
                log('ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™ä¸­...');
                updateProgress(0, 'ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã‚’æº–å‚™ä¸­...');

                // JSZipãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿
                if (typeof JSZip === 'undefined') {
                    await loadJSZip();
                }

                const zip = new JSZip();

                // 1. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚©ãƒ«ãƒ€
                updateProgress(20, 'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ä¸­...');
                await addIndexFiles(zip);

                // 2. é€£çµ¡å…ˆãƒ•ã‚©ãƒ«ãƒ€  
                updateProgress(40, 'é€£çµ¡å…ˆãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ä¸­...');
                await addContactsFiles(zip);

                // 3. ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ•ã‚©ãƒ«ãƒ€
                updateProgress(60, 'ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ä¸­...');
                await addMeetingsFiles(zip);

                // 4. æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ãƒ•ã‚©ãƒ«ãƒ€
                updateProgress(80, 'æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ä¸­...');
                await addAttachmentFiles(zip);

                // 5. options.json
                if (existingData['options.json']) {
                    zip.file('options.json', JSON.stringify(existingData['options.json'], null, 2));
                    log('options.jsonã‚’è¿½åŠ ã—ã¾ã—ãŸ');
                }

                updateProgress(100, 'ZIPç”Ÿæˆå®Œäº†ï¼');

                // ZIPãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
                zipData.blob = await zip.generateAsync({type: 'blob'});
                zipData.filename = `1to1meeting-migration-${new Date().toISOString().split('T')[0]}.zip`;

                showDownloadSection();

            } catch (error) {
                log('ZIPæº–å‚™ã‚¨ãƒ©ãƒ¼: ' + error.message);
                showError('ZIPãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        async function loadJSZip() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function addIndexFiles(zip) {
            const indexFolder = zip.folder('index');
            const indexFiles = ['contacts-index.json', 'search-index.json', 'meetings-index.json', 'metadata.json'];
            
            for (let fileName of indexFiles) {
                const path = `index/${fileName}`;
                if (existingData[path]) {
                    indexFolder.file(fileName, JSON.stringify(existingData[path], null, 2));
                    log(`${fileName}ã‚’ZIPã«è¿½åŠ ã—ã¾ã—ãŸ`);
                }
            }
        }

        async function addContactsFiles(zip) {
            const contactsFolder = zip.folder('contacts');
            const contactFiles = Object.keys(existingData).filter(path => 
                path.includes('/contacts/') && path.endsWith('.json')
            );

            for (let path of contactFiles) {
                const fileName = path.split('/').pop();
                contactsFolder.file(fileName, JSON.stringify(existingData[path], null, 2));
                
                if (contactFiles.indexOf(path) % 10 === 0) {
                    log(`é€£çµ¡å…ˆãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ä¸­... (${contactFiles.indexOf(path) + 1}/${contactFiles.length})`);
                }
            }
            
            log(`${contactFiles.length}ä»¶ã®é€£çµ¡å…ˆãƒ‡ãƒ¼ã‚¿ã‚’ZIPã«è¿½åŠ ã—ã¾ã—ãŸ`);
        }

        async function addMeetingsFiles(zip) {
            const meetingsFolder = zip.folder('meetings');
            const meetingFiles = Object.keys(existingData).filter(path => 
                path.includes('/meetings/') && path.endsWith('.json')
            );

            for (let path of meetingFiles) {
                const fileName = path.split('/').pop();
                meetingsFolder.file(fileName, JSON.stringify(existingData[path], null, 2));
                
                if (meetingFiles.indexOf(path) % 10 === 0) {
                    log(`ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ä¸­... (${meetingFiles.indexOf(path) + 1}/${meetingFiles.length})`);
                }
            }
            
            log(`${meetingFiles.length}ä»¶ã®ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ZIPã«è¿½åŠ ã—ã¾ã—ãŸ`);
        }

        async function addAttachmentFiles(zip) {
            const attachmentsFolder = zip.folder('attachments');
            const attachmentFiles = Object.keys(existingData).filter(path => 
                path.includes('/attachments/') && !path.endsWith('/')
            );

            for (let path of attachmentFiles) {
                const file = existingData[path];
                const relativePath = path.replace(/^[^/]+\/attachments\//, '');
                
                if (file instanceof File) {
                    attachmentsFolder.file(relativePath, file);
                }
                
                if (attachmentFiles.indexOf(path) % 20 === 0) {
                    log(`æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ä¸­... (${attachmentFiles.indexOf(path) + 1}/${attachmentFiles.length})`);
                }
            }
            
            log(`${attachmentFiles.length}ä»¶ã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ZIPã«è¿½åŠ ã—ã¾ã—ãŸ`);
        }

        function showDownloadSection() {
            const downloadSection = document.getElementById('downloadSection');
            const zipPreview = document.getElementById('zipPreview');
            
            let previewHtml = '<h4>ğŸ“¦ ZIPå†…å®¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</h4>';
            previewHtml += `
                <div class="file-item">
                    <span class="file-icon">ğŸ‘¥</span>
                    <span>é€£çµ¡å…ˆãƒ‡ãƒ¼ã‚¿: ${analysisResult.contacts}ä»¶</span>
                    <span class="status status-success">è¿½åŠ æ¸ˆã¿</span>
                </div>
                <div class="file-item">
                    <span class="file-icon">ğŸ“…</span>
                    <span>ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿: ${analysisResult.meetings}ä»¶</span>
                    <span class="status status-success">è¿½åŠ æ¸ˆã¿</span>
                </div>
                <div class="file-item">
                    <span class="file-icon">ğŸ“</span>
                    <span>æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«: ${analysisResult.attachments}ä»¶</span>
                    <span class="status status-success">è¿½åŠ æ¸ˆã¿</span>
                </div>
                <div class="file-item">
                    <span class="file-icon">ğŸ“„</span>
                    <span>ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${formatFileSize(zipData.blob.size)}</span>
                    <span class="status status-success">ç”Ÿæˆå®Œäº†</span>
                </div>
            `;
            
            zipPreview.innerHTML = previewHtml;
            downloadSection.classList.remove('hidden');
            document.getElementById('uploadInstructions').classList.remove('hidden');
            document.getElementById('step4').scrollIntoView({ behavior: 'smooth' });
            
            log('ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        }

        function downloadZip() {
            if (!zipData.blob) {
                showError('ZIPãƒ•ã‚¡ã‚¤ãƒ«ãŒæº–å‚™ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }

            const url = URL.createObjectURL(zipData.blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = zipData.filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
            
            // æ‰‹é †ã‚’è¡¨ç¤º
            setTimeout(() => {
                document.getElementById('step5').scrollIntoView({ behavior: 'smooth' });
            }, 1000);
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        function getFileIcon(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            const icons = {
                'json': 'ğŸ“„',
                'jpg': 'ğŸ–¼ï¸',
                'jpeg': 'ğŸ–¼ï¸', 
                'png': 'ğŸ–¼ï¸',
                'pdf': 'ğŸ“•',
                'docx': 'ğŸ“',
                'xlsx': 'ğŸ“Š'
            };
            return icons[ext] || 'ğŸ“„';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateProgress(percent, task) {
            const progressBar = document.getElementById('progressBar');
            const currentTask = document.getElementById('currentTask');
            
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            currentTask.textContent = task;
        }

        function log(message) {
            const logContainer = document.getElementById('processingLog');
            if (logContainer) {
                const timestamp = new Date().toLocaleTimeString();
                logContainer.innerHTML += `<div>[${timestamp}] ${message}</div>`;
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            console.log(message);
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.body.insertBefore(errorDiv, document.querySelector('.container'));
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 8000);
        }
    </script>
</body>
</html>