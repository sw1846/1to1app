<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1to1Meeting ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .step-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #667eea;
        }

        .step-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-drop-zone {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: rgba(102, 126, 234, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-drop-zone:hover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.1);
        }

        .file-drop-zone.drag-over {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
            transform: scale(1.02);
        }

        .file-input {
            display: none;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            color: #333;
        }

        .progress-container {
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            height: 20px;
            margin: 15px 0;
        }

        .progress-bar {
            background: linear-gradient(45deg, #28a745, #20c997);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .log-container {
            background: #1e1e1e;
            color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .file-list {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
        }

        .file-item {
            padding: 8px 0;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-icon {
            font-size: 1.2em;
        }

        .status {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-processing {
            background: #d1ecf1;
            color: #0c5460;
        }

        .google-auth-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .migration-results {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #721c24;
        }

        .folder-structure {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            margin: 15px 0;
        }

        .hidden {
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ 1to1Meeting ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ„ãƒ¼ãƒ«</h1>

        <!-- Step 1: Googleèªè¨¼ -->
        <div class="step-container" id="step1">
            <div class="step-title">
                <span>1ï¸âƒ£</span>
                <span>Google Driveèªè¨¼</span>
            </div>
            <div class="google-auth-section">
                <p>æ–°ã—ã„Google Driveç’°å¢ƒã«æ¥ç¶šã—ã¾ã™</p>
                <button class="btn btn-primary" onclick="initializeGoogleAuth()">
                    ğŸ” Googleèªè¨¼ã‚’é–‹å§‹
                </button>
                <div id="auth-status" class="status hidden"></div>
            </div>
        </div>

        <!-- Step 2: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ -->
        <div class="step-container" id="step2">
            <div class="step-title">
                <span>2ï¸âƒ£</span>
                <span>æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿</span>
            </div>
            <p>æ—¢å­˜ã®åˆ†æ•£æ§‹é€ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>
            
            <div class="file-drop-zone" id="fileDropZone" onclick="document.getElementById('fileInput').click()">
                <div style="font-size: 3em; margin-bottom: 10px;">ğŸ“</div>
                <div>ãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</div>
                <div style="margin-top: 10px; font-size: 14px; color: #666;">
                    index/, contacts/, meetings/, attachments/ ãƒ•ã‚©ãƒ«ãƒ€ã¨options.jsonã‚’é¸æŠ
                </div>
            </div>
            
            <input type="file" id="fileInput" class="file-input" multiple webkitdirectory>
            
            <div id="fileList" class="file-list hidden"></div>
            
            <button class="btn btn-primary hidden" id="analyzeBtn" onclick="analyzeExistingData()">
                ğŸ” ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’åˆ†æ
            </button>
        </div>

        <!-- Step 3: ãƒ‡ãƒ¼ã‚¿åˆ†æçµæœ -->
        <div class="step-container" id="step3">
            <div class="step-title">
                <span>3ï¸âƒ£</span>
                <span>ãƒ‡ãƒ¼ã‚¿åˆ†æçµæœ</span>
            </div>
            <div id="analysisResults" class="hidden">
                <div class="folder-structure" id="detectedStructure"></div>
                <div id="migrationPlan" class="file-list"></div>
                <button class="btn btn-success" id="startMigrationBtn" onclick="startMigration()">
                    ğŸš€ ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚’é–‹å§‹
                </button>
            </div>
        </div>

        <!-- Step 4: ç§»è¡Œé€²æ— -->
        <div class="step-container" id="step4">
            <div class="step-title">
                <span>4ï¸âƒ£</span>
                <span>ãƒ‡ãƒ¼ã‚¿ç§»è¡Œå®Ÿè¡Œ</span>
            </div>
            <div id="migrationProgress" class="hidden">
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
                <div id="currentTask" style="margin: 10px 0; font-weight: bold;"></div>
                <div class="log-container" id="migrationLog"></div>
            </div>
        </div>

        <!-- Step 5: å®Œäº† -->
        <div class="step-container" id="step5">
            <div class="step-title">
                <span>5ï¸âƒ£</span>
                <span>ç§»è¡Œå®Œäº†</span>
            </div>
            <div id="migrationResults" class="migration-results hidden">
                <h3>âœ… ãƒ‡ãƒ¼ã‚¿ç§»è¡ŒãŒå®Œäº†ã—ã¾ã—ãŸï¼</h3>
                <div id="resultsDetails"></div>
                <button class="btn btn-primary" onclick="downloadMigrationReport()">
                    ğŸ“‹ ç§»è¡Œãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
            </div>
        </div>
    </div>

    <!-- Google APIs -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let isGoogleAuthInitialized = false;
        let googleAccessToken = null;
        let existingData = {};
        let migrationPlan = {};
        let newFolderId = null;

        // Google Driveè¨­å®š
        const GOOGLE_CONFIG = {
            CLIENT_ID: '938239904261-vt7rego8tmo4vhhcjp3fadca25asuh73.apps.googleusercontent.com',
            SCOPES: 'https://www.googleapis.com/auth/drive.file',
            DISCOVERY_DOCS: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
        };

        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã®è¨­å®š
        const fileDropZone = document.getElementById('fileDropZone');
        const fileInput = document.getElementById('fileInput');

        fileDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileDropZone.classList.add('drag-over');
        });

        fileDropZone.addEventListener('dragleave', () => {
            fileDropZone.classList.remove('drag-over');
        });

        fileDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // Googleèªè¨¼åˆæœŸåŒ–
        async function initializeGoogleAuth() {
            try {
                log('Googleèªè¨¼ã‚’åˆæœŸåŒ–ä¸­...');
                updateAuthStatus('processing', 'Google APIã‚’èª­ã¿è¾¼ã¿ä¸­...');

                await loadGoogleAPIs();
                
                // OAuth2è¨­å®š
                window.gapi.load('auth2', async () => {
                    try {
                        const authInstance = await window.gapi.auth2.init({
                            client_id: GOOGLE_CONFIG.CLIENT_ID,
                            scope: GOOGLE_CONFIG.SCOPES
                        });

                        const user = await authInstance.signIn();
                        googleAccessToken = user.getAuthResponse().access_token;
                        
                        updateAuthStatus('success', 'èªè¨¼æˆåŠŸï¼');
                        log('Googleèªè¨¼å®Œäº†');
                        isGoogleAuthInitialized = true;
                        
                        // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’æœ‰åŠ¹åŒ–
                        document.getElementById('step2').style.opacity = '1';
                        
                    } catch (error) {
                        console.error('èªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
                        updateAuthStatus('error', 'èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        log('èªè¨¼ã‚¨ãƒ©ãƒ¼: ' + error.message);
                    }
                });

            } catch (error) {
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                updateAuthStatus('error', 'åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
                log('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        async function loadGoogleAPIs() {
            return new Promise((resolve, reject) => {
                if (window.gapi) {
                    window.gapi.load('client', async () => {
                        try {
                            await window.gapi.client.init({
                                discoveryDocs: GOOGLE_CONFIG.DISCOVERY_DOCS
                            });
                            resolve();
                        } catch (error) {
                            reject(error);
                        }
                    });
                } else {
                    reject(new Error('Google APIãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“'));
                }
            });
        }

        function updateAuthStatus(type, message) {
            const statusEl = document.getElementById('auth-status');
            statusEl.className = `status status-${type}`;
            statusEl.textContent = message;
            statusEl.classList.remove('hidden');
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        function handleFiles(files) {
            const fileList = document.getElementById('fileList');
            const analyzeBtn = document.getElementById('analyzeBtn');
            
            fileList.innerHTML = '';
            fileList.classList.remove('hidden');
            
            let validFiles = 0;
            const expectedPaths = [
                'index/contacts-index.json',
                'index/search-index.json',
                'index/meetings-index.json',
                'index/metadata.json',
                'options.json'
            ];

            Array.from(files).forEach(file => {
                const path = file.webkitRelativePath || file.name;
                const isExpected = expectedPaths.some(p => path.endsWith(p)) || 
                                 path.includes('/contacts/') || 
                                 path.includes('/meetings/') || 
                                 path.includes('/attachments/');
                
                if (isExpected) validFiles++;

                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                const icon = getFileIcon(file.name);
                const status = isExpected ? 
                    '<span class="status status-success">èªè­˜</span>' :
                    '<span class="status status-error">ä¸æ˜</span>';
                
                fileItem.innerHTML = `
                    <span class="file-icon">${icon}</span>
                    <span style="flex: 1;">${path}</span>
                    <span style="color: #666;">${formatFileSize(file.size)}</span>
                    ${status}
                `;
                
                fileList.appendChild(fileItem);
            });

            if (validFiles > 0) {
                analyzeBtn.classList.remove('hidden');
                log(`${validFiles}å€‹ã®æœ‰åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡ºã—ã¾ã—ãŸ`);
            } else {
                log('æœ‰åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                showError('é©åˆ‡ãª1to1meetingãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        }

        // ãƒ‡ãƒ¼ã‚¿åˆ†æ
        async function analyzeExistingData() {
            try {
                log('ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’åˆ†æä¸­...');
                const files = document.getElementById('fileInput').files;
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§åˆ†æ
                for (let file of files) {
                    const path = file.webkitRelativePath || file.name;
                    
                    if (path.endsWith('.json')) {
                        const content = await readFileAsText(file);
                        try {
                            const data = JSON.parse(content);
                            existingData[path] = data;
                            log(`${path} ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
                        } catch (e) {
                            log(`${path} ã®JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—: ${e.message}`);
                        }
                    } else {
                        // æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ç­‰
                        existingData[path] = file;
                    }
                }

                // æ§‹é€ åˆ†æ
                const analysis = analyzeDataStructure();
                displayAnalysisResults(analysis);
                
                document.getElementById('analysisResults').classList.remove('hidden');
                document.getElementById('step3').style.opacity = '1';
                
            } catch (error) {
                log('åˆ†æã‚¨ãƒ©ãƒ¼: ' + error.message);
                showError('ãƒ‡ãƒ¼ã‚¿åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        function analyzeDataStructure() {
            const structure = {
                contacts: 0,
                meetings: 0,
                attachments: 0,
                indexes: [],
                issues: []
            };

            // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
            const indexFiles = ['contacts-index.json', 'search-index.json', 'meetings-index.json', 'metadata.json'];
            indexFiles.forEach(file => {
                const path = `index/${file}`;
                if (existingData[path]) {
                    structure.indexes.push(file);
                } else {
                    structure.issues.push(`${file} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                }
            });

            // contactsæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            Object.keys(existingData).forEach(path => {
                if (path.includes('/contacts/') && path.endsWith('.json')) {
                    structure.contacts++;
                } else if (path.includes('/meetings/') && path.endsWith('.json')) {
                    structure.meetings++;
                } else if (path.includes('/attachments/')) {
                    structure.attachments++;
                }
            });

            return structure;
        }

        function displayAnalysisResults(analysis) {
            const structureEl = document.getElementById('detectedStructure');
            const planEl = document.getElementById('migrationPlan');

            structureEl.innerHTML = `
æ¤œå‡ºã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿æ§‹é€ :
â”œâ”€ é€£çµ¡å…ˆ: ${analysis.contacts}ä»¶
â”œâ”€ ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°: ${analysis.meetings}ä»¶  
â”œâ”€ æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«: ${analysis.attachments}ä»¶
â”œâ”€ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ${analysis.indexes.length}/4å€‹
â””â”€ å•é¡Œ: ${analysis.issues.length}ä»¶
            `;

            let planHtml = '<h4>ç§»è¡Œè¨ˆç”»:</h4>';
            if (analysis.issues.length === 0) {
                planHtml += `
                    <div class="file-item">
                        <span class="file-icon">ğŸ“</span>
                        <span>æ–°ã—ã„Google Driveãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã‚’ä½œæˆ</span>
                        <span class="status status-success">æº–å‚™å®Œäº†</span>
                    </div>
                    <div class="file-item">
                        <span class="file-icon">ğŸ“</span>
                        <span>ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®ç§»è¡Œ (${analysis.indexes.length}ä»¶)</span>
                        <span class="status status-success">æº–å‚™å®Œäº†</span>
                    </div>
                    <div class="file-item">
                        <span class="file-icon">ğŸ‘¥</span>
                        <span>é€£çµ¡å…ˆãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œ (${analysis.contacts}ä»¶)</span>
                        <span class="status status-success">æº–å‚™å®Œäº†</span>
                    </div>
                    <div class="file-item">
                        <span class="file-icon">ğŸ“…</span>
                        <span>ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œ (${analysis.meetings}ä»¶)</span>
                        <span class="status status-success">æº–å‚™å®Œäº†</span>
                    </div>
                    <div class="file-item">
                        <span class="file-icon">ğŸ“</span>
                        <span>æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ç§»è¡Œ (${analysis.attachments}ä»¶)</span>
                        <span class="status status-success">æº–å‚™å®Œäº†</span>
                    </div>
                `;
            } else {
                analysis.issues.forEach(issue => {
                    planHtml += `
                        <div class="file-item">
                            <span class="file-icon">âš ï¸</span>
                            <span>${issue}</span>
                            <span class="status status-error">è¦ç¢ºèª</span>
                        </div>
                    `;
                });
            }

            planEl.innerHTML = planHtml;

            if (analysis.issues.length === 0) {
                document.getElementById('startMigrationBtn').classList.remove('hidden');
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ç§»è¡Œå®Ÿè¡Œ
        async function startMigration() {
            if (!isGoogleAuthInitialized || !googleAccessToken) {
                showError('Googleèªè¨¼ãŒå¿…è¦ã§ã™');
                return;
            }

            try {
                document.getElementById('migrationProgress').classList.remove('hidden');
                document.getElementById('step4').style.opacity = '1';
                
                log('ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚’é–‹å§‹ã—ã¾ã™...');
                updateProgress(0, 'ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã‚’ä½œæˆä¸­...');

                // 1. ãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ
                newFolderId = await createMainFolder();
                updateProgress(10, 'ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆä¸­...');

                // 2. ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ
                const folderIds = await createSubFolders(newFolderId);
                updateProgress(30, 'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»è¡Œä¸­...');

                // 3. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ç§»è¡Œ
                await migrateIndexFiles(folderIds.index);
                updateProgress(50, 'é€£çµ¡å…ˆãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œä¸­...');

                // 4. é€£çµ¡å…ˆãƒ‡ãƒ¼ã‚¿ç§»è¡Œ
                await migrateContactsData(folderIds.contacts);
                updateProgress(70, 'ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œä¸­...');

                // 5. ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ  
                await migrateMeetingsData(folderIds.meetings);
                updateProgress(90, 'æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»è¡Œä¸­...');

                // 6. æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ç§»è¡Œ
                await migrateAttachments(folderIds.attachments);
                
                // 7. options.jsonã‚’ç§»è¡Œ
                if (existingData['options.json']) {
                    await uploadJsonFile(newFolderId, 'options.json', existingData['options.json']);
                }

                updateProgress(100, 'ç§»è¡Œå®Œäº†ï¼');
                showMigrationResults();

            } catch (error) {
                log('ç§»è¡Œã‚¨ãƒ©ãƒ¼: ' + error.message);
                showError('ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // Google Drive APIé–¢æ•°
        async function createMainFolder() {
            const metadata = {
                name: '1to1meeting',
                mimeType: 'application/vnd.google-apps.folder'
            };

            const response = await fetch('https://www.googleapis.com/drive/v3/files', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${googleAccessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(metadata)
            });

            if (!response.ok) {
                throw new Error('ãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }

            const result = await response.json();
            log(`ãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã—ãŸ: ${result.id}`);
            return result.id;
        }

        async function createSubFolders(parentId) {
            const folders = ['index', 'contacts', 'meetings', 'attachments'];
            const folderIds = {};

            for (let folderName of folders) {
                const metadata = {
                    name: folderName,
                    parents: [parentId],
                    mimeType: 'application/vnd.google-apps.folder'
                };

                const response = await fetch('https://www.googleapis.com/drive/v3/files', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(metadata)
                });

                if (!response.ok) {
                    throw new Error(`${folderName}ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ`);
                }

                const result = await response.json();
                folderIds[folderName] = result.id;
                log(`${folderName}ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã—ãŸ: ${result.id}`);
            }

            // attachmentsã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ
            const attachmentSubFolders = ['contacts', 'meetings'];
            folderIds.attachmentSub = {};
            
            for (let subFolder of attachmentSubFolders) {
                const metadata = {
                    name: subFolder,
                    parents: [folderIds.attachments],
                    mimeType: 'application/vnd.google-apps.folder'
                };

                const response = await fetch('https://www.googleapis.com/drive/v3/files', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(metadata)
                });

                if (response.ok) {
                    const result = await response.json();
                    folderIds.attachmentSub[subFolder] = result.id;
                    log(`attachments/${subFolder}ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã—ãŸ`);
                }
            }

            return folderIds;
        }

        async function uploadJsonFile(parentId, fileName, data) {
            const blob = new Blob([JSON.stringify(data, null, 2)], {
                type: 'application/json'
            });

            const formData = new FormData();
            formData.append('metadata', JSON.stringify({
                name: fileName,
                parents: [parentId]
            }));
            formData.append('file', blob);

            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${googleAccessToken}`
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error(`${fileName}ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ`);
            }

            const result = await response.json();
            log(`${fileName}ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`);
            return result.id;
        }

        async function uploadFile(parentId, fileName, file) {
            const formData = new FormData();
            formData.append('metadata', JSON.stringify({
                name: fileName,
                parents: [parentId]
            }));
            formData.append('file', file);

            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${googleAccessToken}`
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error(`${fileName}ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ`);
            }

            const result = await response.json();
            return result.id;
        }

        // ãƒ‡ãƒ¼ã‚¿ç§»è¡Œé–¢æ•°
        async function migrateIndexFiles(indexFolderId) {
            const indexFiles = ['contacts-index.json', 'search-index.json', 'meetings-index.json', 'metadata.json'];
            
            for (let fileName of indexFiles) {
                const path = `index/${fileName}`;
                if (existingData[path]) {
                    await uploadJsonFile(indexFolderId, fileName, existingData[path]);
                    log(`${fileName}ã‚’ç§»è¡Œã—ã¾ã—ãŸ`);
                }
            }
        }

        async function migrateContactsData(contactsFolderId) {
            const contactFiles = Object.keys(existingData).filter(path => 
                path.includes('/contacts/') && path.endsWith('.json')
            );

            for (let i = 0; i < contactFiles.length; i++) {
                const path = contactFiles[i];
                const fileName = path.split('/').pop();
                await uploadJsonFile(contactsFolderId, fileName, existingData[path]);
                
                if (i % 10 === 0) {
                    const progress = 50 + Math.floor((i / contactFiles.length) * 20);
                    updateProgress(progress, `é€£çµ¡å…ˆãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œä¸­... (${i + 1}/${contactFiles.length})`);
                }
            }
            
            log(`${contactFiles.length}ä»¶ã®é€£çµ¡å…ˆãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œã—ã¾ã—ãŸ`);
        }

        async function migrateMeetingsData(meetingsFolderId) {
            const meetingFiles = Object.keys(existingData).filter(path => 
                path.includes('/meetings/') && path.endsWith('.json')
            );

            for (let i = 0; i < meetingFiles.length; i++) {
                const path = meetingFiles[i];
                const fileName = path.split('/').pop();
                await uploadJsonFile(meetingsFolderId, fileName, existingData[path]);
                
                if (i % 10 === 0) {
                    const progress = 70 + Math.floor((i / meetingFiles.length) * 20);
                    updateProgress(progress, `ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œä¸­... (${i + 1}/${meetingFiles.length})`);
                }
            }
            
            log(`${meetingFiles.length}ä»¶ã®ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œã—ã¾ã—ãŸ`);
        }

        async function migrateAttachments(attachmentsFolderId) {
            const attachmentFiles = Object.keys(existingData).filter(path => 
                path.includes('/attachments/') && !path.endsWith('/')
            );

            for (let i = 0; i < attachmentFiles.length; i++) {
                const path = attachmentFiles[i];
                const file = existingData[path];
                const pathParts = path.split('/');
                const fileName = pathParts.pop();
                
                // ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã‚’å†ç¾
                let parentId = attachmentsFolderId;
                // å¿…è¦ã«å¿œã˜ã¦è¿½åŠ ã®ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆãƒ­ã‚¸ãƒƒã‚¯
                
                if (file instanceof File) {
                    await uploadFile(parentId, fileName, file);
                }
                
                if (i % 20 === 0) {
                    const progress = 90 + Math.floor((i / attachmentFiles.length) * 10);
                    updateProgress(progress, `æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»è¡Œä¸­... (${i + 1}/${attachmentFiles.length})`);
                }
            }
            
            log(`${attachmentFiles.length}ä»¶ã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»è¡Œã—ã¾ã—ãŸ`);
        }

        function showMigrationResults() {
            const resultsEl = document.getElementById('migrationResults');
            const detailsEl = document.getElementById('resultsDetails');
            
            const analysis = analyzeDataStructure();
            
            detailsEl.innerHTML = `
                <h4>ç§»è¡Œçµæœ:</h4>
                <div class="file-item">
                    <span class="file-icon">ğŸ‘¥</span>
                    <span>é€£çµ¡å…ˆ: ${analysis.contacts}ä»¶</span>
                    <span class="status status-success">å®Œäº†</span>
                </div>
                <div class="file-item">
                    <span class="file-icon">ğŸ“…</span>
                    <span>ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°: ${analysis.meetings}ä»¶</span>
                    <span class="status status-success">å®Œäº†</span>
                </div>
                <div class="file-item">
                    <span class="file-icon">ğŸ“</span>
                    <span>æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«: ${analysis.attachments}ä»¶</span>
                    <span class="status status-success">å®Œäº†</span>
                </div>
                <div class="file-item">
                    <span class="file-icon">ğŸ†”</span>
                    <span>æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€ID: ${newFolderId}</span>
                    <span class="status status-success">ä½œæˆæ¸ˆã¿</span>
                </div>
            `;
            
            resultsEl.classList.remove('hidden');
            document.getElementById('step5').style.opacity = '1';
            
            log('ãƒ‡ãƒ¼ã‚¿ç§»è¡ŒãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼');
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        function getFileIcon(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            const icons = {
                'json': 'ğŸ“„',
                'jpg': 'ğŸ–¼ï¸',
                'jpeg': 'ğŸ–¼ï¸', 
                'png': 'ğŸ–¼ï¸',
                'pdf': 'ğŸ“•',
                'docx': 'ğŸ“',
                'xlsx': 'ğŸ“Š'
            };
            return icons[ext] || 'ğŸ“„';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateProgress(percent, task) {
            const progressBar = document.getElementById('progressBar');
            const currentTask = document.getElementById('currentTask');
            
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            currentTask.textContent = task;
        }

        function log(message) {
            const logContainer = document.getElementById('migrationLog');
            const timestamp = new Date().toLocaleTimeString();
            logContainer.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.body.insertBefore(errorDiv, document.querySelector('.container'));
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        function downloadMigrationReport() {
            const analysis = analyzeDataStructure();
            const report = {
                timestamp: new Date().toISOString(),
                newFolderId: newFolderId,
                migration: {
                    contacts: analysis.contacts,
                    meetings: analysis.meetings,
                    attachments: analysis.attachments,
                    indexes: analysis.indexes.length
                },
                status: 'completed'
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'migration-report.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // åˆæœŸåŒ–æ™‚ã«ä¸€éƒ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ç„¡åŠ¹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('step2').style.opacity = '0.5';
            document.getElementById('step3').style.opacity = '0.5';
            document.getElementById('step4').style.opacity = '0.5';
            document.getElementById('step5').style.opacity = '0.5';
        });
    </script>
</body>
</html>