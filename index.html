<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>1to1ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - PlaceOn</title>
    
    <!-- 
    ===== IMPORTANT: Dropbox App Configuration =====
    
    âœ… Dropbox App Key: 6u9kud7ntmkaicg
    
    âš ï¸ REQUIRED PERMISSIONS (Must be enabled in Dropbox App Console):
    
    1. Go to: https://www.dropbox.com/developers/apps
    2. Select your app
    3. Go to "Permissions" tab
    4. Enable ALL of the following scopes:
    
       âœ… files.metadata.read    - Read file and folder metadata
       âœ… files.metadata.write   - Create folders
       âœ… files.content.read     - Read file content
       âœ… files.content.write    - Upload and modify files
       âœ… sharing.write          - Create shared links
       âœ… sharing.read           - Read shared links (è¿½åŠ )
    
    5. Click "Submit" to save changes
    
    âš ï¸ Without these permissions, you will get 401 errors!
    
    ===== ä¿®æ­£å†…å®¹ =====
    
    1. ã‚¹ã‚³ãƒ¼ãƒ—ã« sharing.read ã‚’è¿½åŠ 
    2. å…±æœ‰ãƒªãƒ³ã‚¯ä½œæˆæ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’æ”¹å–„
    3. æ—¢å­˜ãƒªãƒ³ã‚¯ã®å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£
    4. ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 
    
    -->
    
    <script src="https://unpkg.com/dropbox@10.34.0/dist/Dropbox-sdk.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, "Helvetica Neue", "Roboto", sans-serif;
            background-color: #1e1e1e;
            color: #f0f0f0;
            line-height: 1.6;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header {
            background: #2a2a2a;
            padding: 24px;
            margin-bottom: 24px;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: stretch;
            }
        }

        h1 {
            font-size: 26px;
            color: #f0f0f0;
            font-weight: 300;
            margin: 0;
            letter-spacing: 0.5px;
        }

        .header-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* ãƒœã‚¿ãƒ³ */
        button {
            padding: 10px 18px;
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 400;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #333333;
            color: #f0f0f0;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        button:hover {
            border-color: #4c8bf5;
            box-shadow: 0 0 0 1px #4c8bf5;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #4c8bf5;
            color: white;
            border-color: #4c8bf5;
        }

        .btn-primary:hover {
            background: #5a96f7;
            box-shadow: 0 0 10px rgba(76, 139, 245, 0.3);
        }

        .btn-secondary {
            background: #333333;
            color: #f0f0f0;
            border: 1px solid #444444;
        }

        .btn-secondary:hover {
            background: #3a3a3a;
            border-color: #4c8bf5;
        }

        .btn-danger {
            background: #d93025;
            color: white;
            border-color: #d93025;
        }

        .btn-danger:hover {
            background: #e74c3c;
            box-shadow: 0 0 10px rgba(217, 48, 37, 0.3);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
        .search-filters {
            background: #2a2a2a;
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 24px;
            border: 1px solid #3a3a3a;
        }

        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .search-header h3 {
            font-weight: 300;
            font-size: 18px;
            color: #f0f0f0;
        }

        .sort-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sort-controls label {
            font-size: 14px;
            color: #aaaaaa;
            margin: 0;
        }

        .sort-controls select {
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid #444444;
            background: #333333;
            color: #f0f0f0;
        }

        .filter-row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group.search-group {
            flex: 2;
            min-width: 300px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 400;
            font-size: 14px;
            color: #aaaaaa;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #444444;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: #333333;
            color: #f0f0f0;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4c8bf5;
            box-shadow: 0 0 0 1px #4c8bf5;
        }

        input::placeholder {
            color: #666666;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* é€£çµ¡å…ˆã‚°ãƒªãƒƒãƒ‰ */
        .contact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        @media (max-width: 768px) {
            .contact-grid {
                grid-template-columns: 1fr;
            }
        }

        .contact-card {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #3a3a3a;
        }

        .contact-card:hover {
            border-color: #4c8bf5;
            box-shadow: 0 0 20px rgba(76, 139, 245, 0.1);
        }

        .contact-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #333333;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            overflow: hidden;
            font-weight: 300;
            color: #aaaaaa;
            border: 1px solid #444444;
        }

        .contact-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .contact-name {
            font-size: 18px;
            font-weight: 400;
            margin-bottom: 8px;
            color: #f0f0f0;
        }

        .contact-info {
            font-size: 14px;
            color: #aaaaaa;
            margin-bottom: 4px;
        }

        .last-meeting-info {
            font-size: 13px;
            color: #4c8bf5;
            margin-top: 8px;
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
        }

        .tag {
            background: #333333;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
            color: #aaaaaa;
            font-weight: 400;
            border: 1px solid #444444;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: #2a2a2a;
            margin: 50px auto;
            max-width: 800px;
            border-radius: 8px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #3a3a3a;
        }

        @media (max-width: 768px) {
            .modal-content {
                margin: 20px;
                max-height: calc(100vh - 40px);
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-weight: 300;
            color: #f0f0f0;
        }

        .modal-body {
            padding: 20px;
        }

        .close-modal {
            font-size: 24px;
            cursor: pointer;
            color: #aaaaaa;
            transition: color 0.2s ease;
        }

        .close-modal:hover {
            color: #f0f0f0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        /* ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */
        .file-drop-zone {
            border: 2px dashed #444444;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #333333;
            color: #aaaaaa;
        }

        .file-drop-zone:hover,
        .file-drop-zone.dragover {
            border-color: #4c8bf5;
            background: #2a2a2a;
            color: #f0f0f0;
        }

        .file-list {
            margin-top: 10px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #333333;
            border-radius: 4px;
            margin-bottom: 5px;
            border: 1px solid #444444;
        }

        .file-item-actions {
            display: flex;
            gap: 5px;
        }

        /* ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ */
        .meeting-timeline {
            margin-top: 30px;
        }

        .meeting-item {
            border-left: 3px solid #4c8bf5;
            padding-left: 20px;
            margin-bottom: 30px;
            position: relative;
        }

        .meeting-item::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 0;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4c8bf5;
            border: 2px solid #2a2a2a;
        }

        .meeting-date {
            font-weight: 400;
            color: #4c8bf5;
            margin-bottom: 10px;
        }

        /* Markdown ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .markdown {
            font-family: 'system-ui', sans-serif;
            color: #f0f0f0;
            background-color: transparent;
            line-height: 1.6;
            font-size: 15px;
        }

        .markdown h1 {
            font-size: 1.8em;
            font-weight: bold;
            margin: 1em 0 0.5em;
            border-bottom: 1px solid #444;
            padding-bottom: 0.3em;
        }

        .markdown h2 {
            font-size: 1.4em;
            font-weight: bold;
            margin: 0.8em 0 0.4em;
            color: #e0e0e0;
        }

        .markdown h3 {
            font-size: 1.2em;
            font-weight: bold;
            margin: 0.6em 0 0.3em;
            color: #cccccc;
        }

        .markdown p {
            margin: 0.5em 0;
        }

        .markdown ul, .markdown ol {
            padding-left: 1.6em;
            margin: 0.5em 0;
        }

        .markdown li {
            margin-bottom: 0.4em;
        }

        .markdown strong {
            font-weight: bold;
            color: #ffffff;
        }

        .markdown a {
            color: #4c8bf5;
            text-decoration: underline;
        }

        .markdown code {
            background-color: #333;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.95em;
            color: #f9f9f9;
        }

        .markdown pre {
            background-color: #333;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 0.5em 0;
        }

        .markdown pre code {
            background-color: transparent;
            padding: 0;
            font-size: 0.9em;
        }

        .markdown blockquote {
            border-left: 3px solid #4c8bf5;
            padding-left: 1em;
            margin: 0.5em 0;
            color: #cccccc;
        }

        .markdown-content {
            line-height: 1.6;
            overflow: hidden;
            color: #f0f0f0;
        }

        .markdown-content.truncated {
            max-height: calc(1.6em * 7);
        }

        /* ãã®ä»– */
        .read-more {
            color: #4c8bf5;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            transition: opacity 0.2s ease;
        }

        .read-more:hover {
            opacity: 0.8;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4c8bf5;
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .error-notification {
            background: #d93025;
        }

        .multi-select {
            position: relative;
        }

        .multi-select-display {
            padding: 8px;
            border: 1px solid #444444;
            border-radius: 6px;
            cursor: pointer;
            min-height: 38px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            background: #333333;
            transition: border-color 0.2s ease;
        }

        .multi-select-display:hover {
            border-color: #4c8bf5;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #333333;
            border: 1px solid #444444;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .multi-select-dropdown.show {
            display: block;
        }

        .multi-select-option {
            padding: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background 0.2s ease;
        }

        .multi-select-option:hover {
            background: #3a3a3a;
        }

        .multi-select-option input {
            margin-right: 8px;
            width: auto;
        }

        .selected-tag {
            background: #4c8bf5;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
        }

        .selected-tag .remove {
            margin-left: 5px;
            cursor: pointer;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .referrer-selector {
            background: #333333;
            border: 1px solid #444444;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .referrer-option {
            padding: 8px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s ease;
        }

        .referrer-option:hover {
            background: #3a3a3a;
        }

        .referrer-option .info {
            font-size: 12px;
            color: #aaaaaa;
        }

        /* ãƒªãƒ³ã‚¯ */
        a {
            color: #4c8bf5;
            text-decoration: none;
            transition: opacity 0.2s ease;
        }

        a:hover {
            opacity: 0.8;
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f0f0f0;
            border-radius: 50%;
            border-top-color: #4c8bf5;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .loading-content {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
        }

        /* èªè¨¼ç”»é¢ */
        .auth-container {
            max-width: 500px;
            margin: 100px auto;
            text-align: center;
            padding: 40px;
            background: #2a2a2a;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
        }

        .auth-container h2 {
            font-size: 24px;
            margin-bottom: 20px;
            font-weight: 300;
        }

        .auth-container p {
            color: #aaaaaa;
            margin-bottom: 30px;
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #444444;
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555555;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- èªè¨¼ç”»é¢ -->
        <div id="authContainer" class="auth-container" style="display: none;">
            <h2>1to1ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h2>
            <p>Dropboxã¨é€£æºã—ã¦ã€é€£çµ¡å…ˆã¨ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨˜éŒ²ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã™ã€‚</p>
            <button class="btn-primary" onclick="authenticateDropbox()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                Dropboxã¨é€£æº
            </button>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div id="mainContainer" class="container" style="display: none;">
            <header>
                <div class="header-content">
                    <h1>1to1ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                    <div class="header-buttons">
                        <span id="connection-status" style="color: #4c8bf5; margin-right: 16px; font-size: 14px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle;">
                                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                            </svg>
                            Dropboxæ¥ç¶šæ¸ˆã¿
                        </span>
                        <button class="btn-secondary" onclick="syncData()">
                            <span id="sync-status">ğŸ”„ åŒæœŸ</span>
                        </button>
                        <button class="btn-secondary" onclick="exportData()">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                        <button class="btn-secondary" onclick="document.getElementById('importInput').click()">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                        <input type="file" id="importInput" accept=".json" style="display: none;" onchange="importData(event)">
                        <button class="btn-primary" onclick="showContactForm()">æ–°è¦é€£çµ¡å…ˆç™»éŒ²</button>
                        <button class="btn-secondary" onclick="logout()" style="margin-left: auto;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    </div>
                </div>
            </header>

            <div class="search-filters">
                <div class="search-header">
                    <h3>æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h3>
                    <div class="sort-controls">
                        <label>ä¸¦ã³æ›¿ãˆ:</label>
                        <select id="sortOrder" onchange="applySorting()">
                            <option value="meeting-desc">æœ€çµ‚æ‰“åˆã›æ—¥ (æ–°ã—ã„é †)</option>
                            <option value="meeting-asc">æœ€çµ‚æ‰“åˆã›æ—¥ (å¤ã„é †)</option>
                            <option value="name-asc">åå‰ (Aâ†’Z)</option>
                            <option value="name-desc">åå‰ (Zâ†’A)</option>
                        </select>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group search-group">
                        <label>ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</label>
                        <input type="text" id="searchName" placeholder="åå‰ã€ä¼šç¤¾ã€ãƒ¡ãƒ¼ãƒ«ã€ã‚¿ã‚°ã€å†…å®¹ãªã©ã‚’æ¤œç´¢..." onkeyup="filterContacts()">
                    </div>
                    <div class="filter-group">
                        <label>ç¨®åˆ¥</label>
                        <select id="filterType" onchange="filterContacts()">
                            <option value="">ã™ã¹ã¦</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>æ‰€å±ãƒ»ãƒãƒ£ãƒ—ã‚¿ãƒ¼</label>
                        <select id="filterAffiliation" onchange="filterContacts()">
                            <option value="">ã™ã¹ã¦</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>ç¹‹ãŒã‚ŠãŸã„äººãƒ»æ¥­ç¨®</label>
                        <select id="filterWantToConnect" onchange="filterContacts()">
                            <option value="">ã™ã¹ã¦</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>é‡‘ã®åµ</label>
                        <select id="filterGoldenEgg" onchange="filterContacts()">
                            <option value="">ã™ã¹ã¦</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>ç´¹ä»‹å…ƒ</label>
                        <select id="filterReferredBy" onchange="filterContacts()">
                            <option value="">ã™ã¹ã¦</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="contactGrid" class="contact-grid">
                <!-- é€£çµ¡å…ˆã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
        </div>
    </div>

    <!-- é€£çµ¡å…ˆç™»éŒ²/ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="contactFormModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="contactFormTitle">æ–°è¦é€£çµ¡å…ˆç™»éŒ²</h2>
                <span class="close-modal" onclick="closeModal('contactFormModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="contactForm" onsubmit="saveContactForm(event)">
                    <div class="form-group">
                        <label>æ°å <span style="color: #d93025;">*</span></label>
                        <input type="text" name="name" required>
                    </div>

                    <div class="form-group">
                        <label>é¡”å†™çœŸ</label>
                        <div class="file-drop-zone" onclick="document.getElementById('photoUpload').click()">
                            å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ï¼‰
                        </div>
                        <input type="file" id="photoUpload" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
                        <div id="photoPreview"></div>
                    </div>

                    <div class="form-group">
                        <label>ä¼šç¤¾å</label>
                        <input type="text" name="company">
                    </div>

                    <div class="form-group">
                        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" name="email">
                    </div>

                    <div class="form-group">
                        <label>é›»è©±ç•ªå·</label>
                        <input type="tel" name="phone">
                    </div>

                    <div class="form-group">
                        <label>ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸</label>
                        <input type="url" name="homepage">
                    </div>

                    <div class="form-group">
                        <label>ç¨®åˆ¥</label>
                        <div class="multi-select">
                            <div class="multi-select-display" onclick="toggleMultiSelect('types')">
                                <span style="color: #aaaaaa;">é¸æŠã—ã¦ãã ã•ã„</span>
                            </div>
                            <div id="types-dropdown" class="multi-select-dropdown"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æ‰€å±ãƒ»ãƒãƒ£ãƒ—ã‚¿ãƒ¼</label>
                        <div class="multi-select">
                            <div class="multi-select-display" onclick="toggleMultiSelect('affiliations')">
                                <span style="color: #aaaaaa;">é¸æŠã—ã¦ãã ã•ã„</span>
                            </div>
                            <div id="affiliations-dropdown" class="multi-select-dropdown"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ç¹‹ãŒã‚ŠãŸã„äººãƒ»æ¥­ç¨®</label>
                        <div class="multi-select">
                            <div class="multi-select-display" onclick="toggleMultiSelect('wantToConnect')">
                                <span style="color: #aaaaaa;">é¸æŠã—ã¦ãã ã•ã„</span>
                            </div>
                            <div id="wantToConnect-dropdown" class="multi-select-dropdown"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>é‡‘ã®åµ</label>
                        <div class="multi-select">
                            <div class="multi-select-display" onclick="toggleMultiSelect('goldenEgg')">
                                <span style="color: #aaaaaa;">é¸æŠã—ã¦ãã ã•ã„</span>
                            </div>
                            <div id="goldenEgg-dropdown" class="multi-select-dropdown"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ç´¹ä»‹å…ƒ</label>
                        <input type="text" name="referredBy" placeholder="ç´¹ä»‹è€…ã®åå‰ã‚’å…¥åŠ›">
                    </div>

                    <div class="form-group">
                        <label>å¼·ã¿</label>
                        <textarea name="strengths" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label>éå»ã®çµŒæ­´</label>
                        <textarea name="careerHistory" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label>æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«</label>
                        <div class="file-drop-zone" id="attachmentDropZone">
                            ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ
                        </div>
                        <input type="file" id="attachmentUpload" multiple style="display: none;">
                        <div id="existingAttachments" class="file-list"></div>
                        <div id="newAttachments" class="file-list"></div>
                    </div>

                    <div class="action-buttons">
                        <button type="submit" class="btn-primary">ä¿å­˜</button>
                        <button type="button" class="btn-secondary" onclick="closeModal('contactFormModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- é€£çµ¡å…ˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="contactDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>é€£çµ¡å…ˆè©³ç´°</h2>
                <span class="close-modal" onclick="closeModal('contactDetailModal')">&times;</span>
            </div>
            <div id="contactDetailBody" class="modal-body">
                <!-- è©³ç´°æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
        </div>
    </div>

    <!-- ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="meetingFormModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="meetingFormTitle">ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨˜éŒ²</h2>
                <span class="close-modal" onclick="closeModal('meetingFormModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="meetingForm" onsubmit="saveMeetingForm(event)">
                    <div class="form-group">
                        <label>æ—¥æ™‚ <span style="color: #d93025;">*</span></label>
                        <input type="datetime-local" name="datetime" required>
                    </div>

                    <div class="form-group">
                        <label>æ‰“ã¡åˆã‚ã›å†…å®¹ <span style="color: #d93025;">*</span></label>
                        <textarea name="content" rows="5" required placeholder="Markdownè¨˜æ³•ãŒä½¿ãˆã¾ã™"></textarea>
                    </div>

                    <div class="form-group">
                        <label>æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</label>
                        <textarea name="nextAction" rows="3" placeholder="Markdownè¨˜æ³•ãŒä½¿ãˆã¾ã™"></textarea>
                    </div>

                    <div class="form-group">
                        <label>æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«</label>
                        <div class="file-drop-zone" id="meetingAttachmentDropZone">
                            ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ
                        </div>
                        <input type="file" id="meetingAttachmentUpload" multiple style="display: none;">
                        <div id="existingMeetingAttachments" class="file-list"></div>
                        <div id="newMeetingAttachments" class="file-list"></div>
                    </div>

                    <div class="action-buttons">
                        <button type="submit" class="btn-primary">ä¿å­˜</button>
                        <button type="button" class="btn-secondary" onclick="closeModal('meetingFormModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading"></div>
            <p style="margin-top: 20px;">å‡¦ç†ä¸­...</p>
        </div>
    </div>

    <script>
        // ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° =====
        const CLIENT_ID = '6u9kud7ntmkaicg'; // Dropbox App Key
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const DATA_PATH = '/1to1App'; // Dropboxãƒ«ãƒ¼ãƒˆã«1to1Appãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ
        
        // å¿…è¦ãªã‚¹ã‚³ãƒ¼ãƒ—ï¼ˆsharing.readã‚’è¿½åŠ ï¼‰
        const REQUIRED_SCOPES = [
            'files.metadata.read',
            'files.metadata.write', 
            'files.content.read',
            'files.content.write',
            'sharing.write',
            'sharing.read'  // è¿½åŠ 
        ];
        
        let dropbox = null;
        let contacts = [];
        let meetings = [];
        let dropdownOptions = {
            types: [],
            affiliations: [],
            goldenEgg: [],
            wantToConnect: [],
            referredBy: []
        };
        let currentEditingContactId = null;
        let currentEditingMeetingId = null;
        let selectedFiles = [];
        let selectedMeetingFiles = [];
        let currentPhotoFile = null;
        let deletedAttachments = [];
        let deletedMeetingAttachments = [];
        let currentSortOrder = 'meeting-desc'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æœ€çµ‚ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ—¥é †
        
        // ===== åˆæœŸåŒ– =====
        window.onload = async function() {
            try {
                // Prevent any Chrome extension interference
                if (typeof chrome !== 'undefined' && chrome.runtime) {
                    console.log('Chrome extension detected - ignoring');
                }
                
                // URLã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
                const accessToken = getAccessTokenFromUrl();
                if (accessToken) {
                    // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
                    localStorage.setItem('dropbox_access_token', accessToken);
                    sessionStorage.setItem('dropbox_access_token', accessToken);
                    
                    // URLã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                    window.history.replaceState({}, document.title, REDIRECT_URI);
                }
                
                // ä¿å­˜ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
                const savedToken = localStorage.getItem('dropbox_access_token') || 
                                  sessionStorage.getItem('dropbox_access_token');
                
                if (savedToken) {
                    await initializeDropbox(savedToken);
                } else {
                    showAuthScreen();
                }
            } catch (error) {
                console.error('åˆæœŸåŒ–ä¸­ã®ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                showAuthScreen();
            }
        };
        
        // ===== Dropboxèªè¨¼ =====
        function authenticateDropbox() {
            // å¤ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¯ãƒªã‚¢
            localStorage.removeItem('dropbox_access_token');
            sessionStorage.removeItem('dropbox_access_token');
            
            // ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§çµåˆ
            const scopeString = REQUIRED_SCOPES.join(' ');
            
            const authUrl = `https://www.dropbox.com/oauth2/authorize?` +
                `client_id=${CLIENT_ID}&` +
                `response_type=token&` +
                `redirect_uri=${encodeURIComponent(REDIRECT_URI)}&` +
                `scope=${encodeURIComponent(scopeString)}&` +
                `force_reapprove=true`;  // å¸¸ã«æ–°ã—ã„èªè¨¼ã‚’è¦æ±‚
                
            window.location.href = authUrl;
        }
        
        function getAccessTokenFromUrl() {
            const hash = window.location.hash;
            if (hash) {
                const params = new URLSearchParams(hash.substring(1));
                
                // Check for errors in OAuth response
                const error = params.get('error');
                if (error) {
                    console.error('OAuth error:', error);
                    const errorDescription = params.get('error_description');
                    if (errorDescription) {
                        showNotification(`èªè¨¼ã‚¨ãƒ©ãƒ¼: ${decodeURIComponent(errorDescription)}`, 'error');
                    } else {
                        showNotification('èªè¨¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ', 'error');
                    }
                    window.history.replaceState({}, document.title, REDIRECT_URI);
                    return null;
                }
                
                return params.get('access_token');
            }
            return null;
        }
        
        async function initializeDropbox(accessToken) {
            try {
                showLoading();
                
                // Dropbox SDKã‚’åˆæœŸåŒ–
                dropbox = new Dropbox.Dropbox({ accessToken });
                
                // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ã‚’ãƒã‚§ãƒƒã‚¯
                const isValid = await validateAccessToken();
                if (!isValid) {
                    throw new Error('INVALID_TOKEN');
                }
                
                // ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã‚’ä½œæˆ
                await createFolderStructure();
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
                await loadData();
                
                // UIåˆæœŸåŒ–
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                
                // ã‚½ãƒ¼ãƒˆé †ã‚’è¨­å®š
                document.getElementById('sortOrder').value = currentSortOrder;
                
                updateDropdownOptions();
                renderContactList();
                
                hideLoading();
                console.log('âœ… DropboxåˆæœŸåŒ–å®Œäº†');
                
            } catch (error) {
                console.error('DropboxåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                hideLoading();
                
                if (error.message === 'INVALID_TOKEN' || error.status === 401) {
                    // èªè¨¼ã‚¨ãƒ©ãƒ¼
                    localStorage.removeItem('dropbox_access_token');
                    sessionStorage.removeItem('dropbox_access_token');
                    showAuthScreen();
                    showNotification('èªè¨¼ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'error');
                } else if (error.message === 'MISSING_SCOPES' || (error.status === 400 && error.error?.error?.['.tag'] === 'missing_scope')) {
                    // ã‚¹ã‚³ãƒ¼ãƒ—ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
                    showScopeErrorMessage();
                    localStorage.removeItem('dropbox_access_token');
                    sessionStorage.removeItem('dropbox_access_token');
                    showAuthScreen();
                } else {
                    // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
                    showNotification('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'error');
                    console.error('è©³ç´°ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
        }
        
        // ===== ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯ =====
        async function validateAccessToken() {
            try {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ã‚’ç¢ºèª
                await dropbox.usersGetCurrentAccount();
                return true;
            } catch (error) {
                if (error.status === 401) {
                    console.error('ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™');
                    return false;
                }
                // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãªã©ï¼‰
                return true;
            }
        }
        
        // ===== ã‚¹ã‚³ãƒ¼ãƒ—ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º =====
        function showScopeErrorMessage() {
            const message = `
                <div style="background: #fff3cd; border: 1px solid #ffeeba; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3 style="color: #856404; margin-top: 0;">âš ï¸ Dropboxã‚¢ãƒ—ãƒªã®è¨­å®šãŒå¿…è¦ã§ã™</h3>
                    <p style="color: #856404;">ã“ã®ã‚¢ãƒ—ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€Dropboxã‚¢ãƒ—ãƒªã«ä»¥ä¸‹ã®æ¨©é™ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š</p>
                    <ol style="color: #856404;">
                        <li><strong>files.metadata.read</strong> - ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã®èª­ã¿å–ã‚Š</li>
                        <li><strong>files.metadata.write</strong> - ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã®æ›¸ãè¾¼ã¿</li>
                        <li><strong>files.content.read</strong> - ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã®èª­ã¿å–ã‚Š</li>
                        <li><strong>files.content.write</strong> - ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã®æ›¸ãè¾¼ã¿</li>
                        <li><strong>sharing.write</strong> - å…±æœ‰ãƒªãƒ³ã‚¯ã®ä½œæˆ</li>
                        <li><strong>sharing.read</strong> - å…±æœ‰ãƒªãƒ³ã‚¯ã®èª­ã¿å–ã‚Š</li>
                    </ol>
                    <p style="color: #856404;">
                        <a href="https://www.dropbox.com/developers/apps" target="_blank" style="color: #0366d6;">
                            Dropbox App Console
                        </a>
                        ã§ã‚¢ãƒ—ãƒªã®è¨­å®šã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚
                    </p>
                    <p style="color: #856404; margin-bottom: 0;">
                        è¨­å®šå®Œäº†å¾Œã€ã‚‚ã†ä¸€åº¦ã€ŒDropboxã¨é€£æºã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
                    </p>
                </div>
            `;
            
            // èªè¨¼ç”»é¢ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
            const authContainer = document.getElementById('authContainer');
            const existingAlert = authContainer.querySelector('.scope-alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            const alertDiv = document.createElement('div');
            alertDiv.className = 'scope-alert';
            alertDiv.innerHTML = message;
            authContainer.insertBefore(alertDiv, authContainer.querySelector('button'));
        }
        
        function showAuthScreen() {
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('mainContainer').style.display = 'none';
        }
        
        function logout() {
            // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å‰Šé™¤
            localStorage.removeItem('dropbox_access_token');
            sessionStorage.removeItem('dropbox_access_token');
            
            // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
            window.location.reload();
        }
        
        // ===== ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ä½œæˆ =====
        async function createFolderStructure() {
            const folders = [
                '/1to1App',
                '/1to1App/attachments'
            ];
            
            for (const folder of folders) {
                try {
                    // ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆã‚’è©¦ã¿ã‚‹ï¼ˆå­˜åœ¨ç¢ºèªãªã—ã§ç›´æ¥ä½œæˆï¼‰
                    await dropbox.filesCreateFolderV2({ 
                        path: folder,
                        autorename: false
                    });
                    console.log(`âœ… ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆæˆåŠŸ: ${folder}`);
                } catch (error) {
                    // 409ã‚¨ãƒ©ãƒ¼ï¼ˆæ—¢å­˜ï¼‰ã¯æ­£å¸¸
                    if (error.status === 409) {
                        console.log(`âœ“ ãƒ•ã‚©ãƒ«ãƒ€ã¯æ—¢ã«å­˜åœ¨: ${folder}`);
                    } 
                    // 400ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¹ã‚³ãƒ¼ãƒ—ä¸è¶³ï¼‰
                    else if (error.status === 400 && error.error?.error?.['.tag'] === 'missing_scope') {
                        console.error('ã‚¹ã‚³ãƒ¼ãƒ—ã‚¨ãƒ©ãƒ¼:', error.error);
                        throw new Error('MISSING_SCOPES');
                    }
                    // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
                    else {
                        console.error(`ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆã‚¨ãƒ©ãƒ¼: ${folder}`, error);
                        throw error;
                    }
                }
            }
        }
        
        // ===== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ =====
        async function loadData() {
            try {
                // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãƒã‚§ãƒƒã‚¯
                if (!navigator.onLine) {
                    throw new Error('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒã‚ã‚Šã¾ã›ã‚“');
                }
                
                // é€£çµ¡å…ˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
                const contactsData = await loadJsonFile('/1to1App/contacts.json');
                contacts = contactsData || [];
                
                // ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
                const meetingsData = await loadJsonFile('/1to1App/meetings.json');
                meetings = meetingsData || [];
                
                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿
                const optionsData = await loadJsonFile('/1to1App/options.json');
                if (optionsData) {
                    dropdownOptions = optionsData;
                }
                
                // ç´¹ä»‹å…ƒãƒªãƒ³ã‚¯ã‚’æ›´æ–°
                updateAllReferrerLinks();
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                if (error.message === 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒã‚ã‚Šã¾ã›ã‚“') {
                    showNotification('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'error');
                } else {
                    showNotification('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            }
        }
        
        async function loadJsonFile(path) {
            try {
                const response = await dropbox.filesDownload({ path });
                const blob = response.result.fileBlob;
                const text = await blob.text();
                return JSON.parse(text);
            } catch (error) {
                if (error.status === 409) {
                    // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆ
                    console.log(`ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“: ${path}`);
                    return null;
                }
                throw error;
            }
        }
        
        // ===== ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãï¼‰ =====
        async function saveData(retryCount = 0) {
            const maxRetries = 1; // ãƒªãƒˆãƒ©ã‚¤ã¯1å›ã®ã¿
            
            try {
                showLoading();
                
                console.log('ğŸ“Š ãƒ‡ãƒ¼ã‚¿ä¿å­˜é–‹å§‹...');
                
                // é€£çµ¡å…ˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                await saveJsonFile('/1to1App/contacts.json', contacts);
                console.log('   âœ… contacts.json ä¿å­˜å®Œäº†');
                
                // ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                await saveJsonFile('/1to1App/meetings.json', meetings);
                console.log('   âœ… meetings.json ä¿å­˜å®Œäº†');
                
                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä¿å­˜
                await saveJsonFile('/1to1App/options.json', dropdownOptions);
                console.log('   âœ… options.json ä¿å­˜å®Œäº†');
                
                hideLoading();
                console.log('ğŸ“Š ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†');
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                hideLoading();
                
                // ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã«å¿œã˜ãŸå‡¦ç†
                if (error.status === 401) {
                    // èªè¨¼ã‚¨ãƒ©ãƒ¼
                    showNotification('èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'error');
                    logout();
                } else if (error.status === 507) {
                    // å®¹é‡ä¸è¶³
                    showNotification('Dropboxã®å®¹é‡ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚', 'error');
                } else if (error.status === 400) {
                    // 400ã‚¨ãƒ©ãƒ¼ã¯ãƒªãƒˆãƒ©ã‚¤ã—ãªã„
                    showNotification('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Dropboxã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
                } else if (error.status === 429) {
                    // ãƒ¬ãƒ¼ãƒˆåˆ¶é™
                    showNotification('APIåˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚', 'error');
                } else if (!navigator.onLine) {
                    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³
                    showNotification('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
                } else if (retryCount < maxRetries) {
                    // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã§ãƒªãƒˆãƒ©ã‚¤
                    console.log(`ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚’ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™ (${retryCount + 1}/${maxRetries})`);
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    return saveData(retryCount + 1);
                } else {
                    showNotification('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
                }
                
                throw error;
            }
        }
        
        async function saveJsonFile(path, data) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            await dropbox.filesUpload({
                path,
                contents: blob,
                mode: { '.tag': 'overwrite' }
            });
        }
        
        // ===== åŒæœŸæ©Ÿèƒ½ =====
        async function syncData() {
            try {
                document.getElementById('sync-status').textContent = 'ğŸ”„ åŒæœŸä¸­...';
                await loadData();
                renderContactList();
                updateDropdownOptions();
                document.getElementById('sync-status').textContent = 'âœ… åŒæœŸå®Œäº†';
                setTimeout(() => {
                    document.getElementById('sync-status').textContent = 'ğŸ”„ åŒæœŸ';
                }, 2000);
            } catch (error) {
                console.error('åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                showNotification('åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                document.getElementById('sync-status').textContent = 'âŒ åŒæœŸå¤±æ•—';
            }
        }
        
        // ===== ãƒ•ã‚¡ã‚¤ãƒ«åã®ã‚µãƒ‹ã‚¿ã‚¤ã‚º =====
        function sanitizeFileName(fileName) {
            // Dropboxã§ä½¿ç”¨ã§ããªã„æ–‡å­—ã‚’ç½®æ›
            return fileName.replace(/[\/\\:?*<>|"]/g, '_');
        }
        
        // ===== ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆä¿®æ­£ç‰ˆï¼‰ =====
        async function uploadFile(file, customName = null, retryCount = 0) {
            const maxRetries = 1;
            const fileName = sanitizeFileName(customName || file.name);
            const path = `/1to1App/attachments/${fileName}`;
            
            console.log(`ğŸ“¤ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹: ${fileName}`);
            console.log(`   - ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
            console.log(`   - ãƒ‘ã‚¹: ${path}`);
            
            try {
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ150MBä»¥ä¸‹ï¼‰
                if (file.size > 150 * 1024 * 1024) {
                    throw new Error('FILE_TOO_LARGE');
                }
                
                // ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                console.log('   ğŸ“ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');
                const uploadResponse = await dropbox.filesUpload({
                    path,
                    contents: file,
                    mode: { '.tag': 'overwrite' },
                    autorename: true,
                    mute: false
                });
                
                console.log('   âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ:', uploadResponse.result.path_display);
                
                // ã‚¹ãƒ†ãƒƒãƒ—2: å…±æœ‰ãƒªãƒ³ã‚¯ã®ä½œæˆã¾ãŸã¯å–å¾—
                let shareUrl;
                
                // å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªæ–¹æ³•ï¼‰
                try {
                    console.log('   ğŸ”— å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆä¸­...');
                    const linkResponse = await dropbox.sharingCreateSharedLinkWithSettings({
                        path: uploadResponse.result.path_lower
                    });
                    shareUrl = linkResponse.result.url.replace('?dl=0', '?raw=1');
                    console.log('   âœ… å…±æœ‰ãƒªãƒ³ã‚¯ä½œæˆæˆåŠŸ');
                } catch (linkError) {
                    // æ—¢å­˜ã®ãƒªãƒ³ã‚¯ãŒã‚ã‚‹å ´åˆã¯å–å¾—
                    if (linkError.status === 409) {
                        console.log('   ğŸ”— æ—¢å­˜ã®å…±æœ‰ãƒªãƒ³ã‚¯ã‚’å–å¾—ä¸­...');
                        try {
                            const existingLinks = await dropbox.sharingListSharedLinks({ 
                                path: uploadResponse.result.path_lower 
                            });
                            if (existingLinks.result.links && existingLinks.result.links.length > 0) {
                                shareUrl = existingLinks.result.links[0].url.replace('?dl=0', '?raw=1');
                                console.log('   âœ… æ—¢å­˜ã®å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ä½¿ç”¨');
                            } else {
                                throw new Error('å…±æœ‰ãƒªãƒ³ã‚¯ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                            }
                        } catch (listError) {
                            console.error('   âŒ æ—¢å­˜ãƒªãƒ³ã‚¯ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', listError);
                            throw listError;
                        }
                    } else {
                        throw linkError;
                    }
                }
                
                console.log(`   âœ… å®Œäº†: ${fileName}`);
                return { 
                    path: uploadResponse.result.path_display, 
                    url: shareUrl 
                };
                
            } catch (error) {
                console.error('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                console.error('   - ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—:', error.status || error.message);
                console.error('   - è©³ç´°:', error.error || error);
                
                // ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã«å¿œã˜ãŸå‡¦ç†
                if (error.message === 'FILE_TOO_LARGE') {
                    showNotification('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆæœ€å¤§150MBï¼‰', 'error');
                    throw error;
                } else if (error.status === 401) {
                    showNotification('èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'error');
                    // å†èªè¨¼ã‚’ä¿ƒã™
                    setTimeout(() => {
                        logout();
                    }, 2000);
                    throw error;
                } else if (error.status === 507) {
                    showNotification('Dropboxã®å®¹é‡ãŒä¸è¶³ã—ã¦ã„ã¾ã™', 'error');
                    throw error;
                } else if (error.status === 400) {
                    // 400ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’ç¢ºèª
                    const errorDetail = error.error?.error_summary || 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼';
                    showNotification(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${errorDetail}`, 'error');
                    throw error;
                } else if (error.status === 429) {
                    showNotification('APIåˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚', 'error');
                    throw error;
                } else {
                    // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
                    showNotification('ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
                    
                    if (retryCount < maxRetries) {
                        console.log(`   ğŸ”„ ãƒªãƒˆãƒ©ã‚¤ã‚’å®Ÿè¡Œã—ã¾ã™ (${retryCount + 1}/${maxRetries})`);
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        return uploadFile(file, customName, retryCount + 1);
                    }
                    throw error;
                }
            }
        }
        
        // ===== é¡”å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ =====
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                currentPhotoFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('photoPreview').innerHTML = 
                        `<img src="${e.target.result}" style="max-width: 200px; margin-top: 10px; border-radius: 8px;">`;
                };
                reader.readAsDataURL(file);
            }
        }
        
        // ===== é€£çµ¡å…ˆä¿å­˜ =====
        async function saveContactForm(event) {
            event.preventDefault();
            showLoading();
            
            const formData = new FormData(event.target);
            const contact = {
                id: currentEditingContactId || generateId(),
                name: formData.get('name'),
                company: formData.get('company'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                homepage: formData.get('homepage'),
                referredBy: formData.get('referredBy'),
                strengths: formData.get('strengths'),
                careerHistory: formData.get('careerHistory'),
                types: getSelectedValues('types'),
                affiliations: getSelectedValues('affiliations'),
                wantToConnect: getSelectedValues('wantToConnect'),
                goldenEgg: getSelectedValues('goldenEgg'),
                attachments: [],
                createdAt: currentEditingContactId ? 
                    contacts.find(c => c.id === currentEditingContactId)?.createdAt : 
                    new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // æ—¢å­˜ã®é€£çµ¡å…ˆã®å ´åˆã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
            if (currentEditingContactId) {
                const existing = contacts.find(c => c.id === currentEditingContactId);
                if (existing) {
                    contact.photo = existing.photo;
                    contact.photoUrl = existing.photoUrl;
                    contact.attachments = existing.attachments || [];
                }
            }
            
            try {
                // é¡”å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                if (currentPhotoFile) {
                    const timestamp = new Date().getTime();
                    const photoName = `${sanitizeFileName(contact.name)}_${timestamp}_photo.jpg`;
                    const photoResult = await uploadFile(currentPhotoFile, photoName);
                    contact.photo = photoResult.path;
                    contact.photoUrl = photoResult.url;
                }
                
                // æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                for (const file of selectedFiles) {
                    const timestamp = new Date().getTime();
                    const fileName = `${sanitizeFileName(contact.name)}_${timestamp}_${sanitizeFileName(file.name)}`;
                    const fileResult = await uploadFile(file, fileName);
                    contact.attachments.push({
                        name: file.name,
                        path: fileResult.path,
                        url: fileResult.url,
                        uploadedAt: new Date().toISOString()
                    });
                }
                
                // å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
                contact.attachments = contact.attachments.filter(att => 
                    !deletedAttachments.includes(att.path)
                );
                
                // é€£çµ¡å…ˆã‚’ä¿å­˜
                const index = contacts.findIndex(c => c.id === contact.id);
                if (index >= 0) {
                    contacts[index] = contact;
                } else {
                    contacts.push(contact);
                }
                
                // ç´¹ä»‹å…ƒãƒªãƒ³ã‚¯ã‚’æ›´æ–°
                updateAllReferrerLinks();
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                await saveData();
                
                // UIã‚’æ›´æ–°
                renderContactList();
                updateDropdownOptions();
                closeModal('contactFormModal');
                resetContactForm();
                
                hideLoading();
                showNotification('é€£çµ¡å…ˆã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('é€£çµ¡å…ˆä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('é€£çµ¡å…ˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                hideLoading();
            }
        }
        
        // ===== ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ä¿å­˜ =====
        async function saveMeetingForm(event) {
            event.preventDefault();
            showLoading();
            
            const formData = new FormData(event.target);
            const meeting = {
                id: currentEditingMeetingId || generateId(),
                contactId: currentEditingContactId,
                datetime: formData.get('datetime'),
                content: formData.get('content'),
                nextAction: formData.get('nextAction'),
                attachments: [],
                createdAt: currentEditingMeetingId ? 
                    meetings.find(m => m.id === currentEditingMeetingId)?.createdAt : 
                    new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // æ—¢å­˜ã®ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å ´åˆã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
            if (currentEditingMeetingId) {
                const existing = meetings.find(m => m.id === currentEditingMeetingId);
                if (existing) {
                    meeting.attachments = existing.attachments || [];
                }
            }
            
            try {
                // æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                const contact = contacts.find(c => c.id === currentEditingContactId);
                for (const file of selectedMeetingFiles) {
                    const timestamp = new Date().getTime();
                    const fileName = `${sanitizeFileName(contact.name)}_meeting_${timestamp}_${sanitizeFileName(file.name)}`;
                    const fileResult = await uploadFile(file, fileName);
                    meeting.attachments.push({
                        name: file.name,
                        path: fileResult.path,
                        url: fileResult.url,
                        uploadedAt: new Date().toISOString()
                    });
                }
                
                // å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
                meeting.attachments = meeting.attachments.filter(att => 
                    !deletedMeetingAttachments.includes(att.path)
                );
                
                // ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ä¿å­˜
                const index = meetings.findIndex(m => m.id === meeting.id);
                if (index >= 0) {
                    meetings[index] = meeting;
                } else {
                    meetings.push(meeting);
                }
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                await saveData();
                
                // UIã‚’æ›´æ–°
                closeModal('meetingFormModal');
                showContactDetail(currentEditingContactId);
                renderContactList(); // æœ€çµ‚ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ—¥ãŒæ›´æ–°ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚
                
                hideLoading();
                showNotification('ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨˜éŒ²ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                hideLoading();
            }
        }
        
        // ===== é€£çµ¡å…ˆå‰Šé™¤ =====
        async function deleteContact(contactId) {
            if (!confirm('ã“ã®é€£çµ¡å…ˆã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\né–¢é€£ã™ã‚‹ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨˜éŒ²ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
                return;
            }
            
            showLoading();
            
            try {
                // é–¢é€£ã™ã‚‹ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’å‰Šé™¤
                meetings = meetings.filter(m => m.contactId !== contactId);
                
                // é€£çµ¡å…ˆã‚’å‰Šé™¤
                contacts = contacts.filter(c => c.id !== contactId);
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                await saveData();
                
                // UIã‚’æ›´æ–°
                renderContactList();
                updateDropdownOptions();
                closeModal('contactDetailModal');
                
                hideLoading();
                showNotification('é€£çµ¡å…ˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('é€£çµ¡å…ˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('é€£çµ¡å…ˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                hideLoading();
            }
        }
        
        // ===== ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°å‰Šé™¤ =====
        async function deleteMeeting(meetingId) {
            if (!confirm('ã“ã®ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            showLoading();
            
            try {
                // ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’å‰Šé™¤
                meetings = meetings.filter(m => m.id !== meetingId);
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                await saveData();
                
                // UIã‚’æ›´æ–°
                showContactDetail(currentEditingContactId);
                renderContactList(); // æœ€çµ‚ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ—¥ãŒæ›´æ–°ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚
                
                hideLoading();
                showNotification('ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                showNotification('ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨˜éŒ²ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                hideLoading();
            }
        }
        
        // ===== UIé–¢æ•° =====
        function showContactForm(contactId = null) {
            currentEditingContactId = contactId;
            resetContactForm();
            
            if (contactId) {
                const contact = contacts.find(c => c.id === contactId);
                if (contact) {
                    document.getElementById('contactFormTitle').textContent = 'é€£çµ¡å…ˆç·¨é›†';
                    const form = document.getElementById('contactForm');
                    form.name.value = contact.name || '';
                    form.company.value = contact.company || '';
                    form.email.value = contact.email || '';
                    form.phone.value = contact.phone || '';
                    form.homepage.value = contact.homepage || '';
                    form.referredBy.value = contact.referredBy || '';
                    form.strengths.value = contact.strengths || '';
                    form.careerHistory.value = contact.careerHistory || '';
                    
                    // é¡”å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                    if (contact.photoUrl) {
                        document.getElementById('photoPreview').innerHTML = 
                            `<img src="${contact.photoUrl}" style="max-width: 200px; margin-top: 10px; border-radius: 8px;">`;
                    }
                    
                    // ãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆè¨­å®š
                    setSelectedValues('types', contact.types || []);
                    setSelectedValues('affiliations', contact.affiliations || []);
                    setSelectedValues('wantToConnect', contact.wantToConnect || []);
                    setSelectedValues('goldenEgg', contact.goldenEgg || []);
                    
                    // æ—¢å­˜ã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«
                    displayExistingAttachments(contact.attachments || []);
                }
            } else {
                document.getElementById('contactFormTitle').textContent = 'æ–°è¦é€£çµ¡å…ˆç™»éŒ²';
            }
            
            setupMultiSelect();
            document.getElementById('contactFormModal').style.display = 'block';
        }
        
        function showContactDetail(contactId) {
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            const contactMeetings = meetings.filter(m => m.contactId === contactId)
                .sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
            
            let html = `
                <div style="margin-bottom: 20px;">
                    ${contact.photoUrl ? 
                        `<div class="contact-photo" style="width: 120px; height: 120px; margin-bottom: 20px;">
                            <img src="${contact.photoUrl}" alt="${contact.name}">
                        </div>` : ''}
                    <h3 style="font-size: 24px; margin-bottom: 10px;">${escapeHtml(contact.name)}</h3>
                    ${contact.company ? `<p style="color: #aaaaaa; margin-bottom: 20px;">${escapeHtml(contact.company)}</p>` : ''}
                </div>
                
                <table style="width: 100%; margin-bottom: 20px;">
                    ${contact.email ? `<tr><td style="padding: 8px 0; color: #aaaaaa;">ãƒ¡ãƒ¼ãƒ«:</td><td style="padding: 8px 0;">${escapeHtml(contact.email)}</td></tr>` : ''}
                    ${contact.phone ? `<tr><td style="padding: 8px 0; color: #aaaaaa;">é›»è©±:</td><td style="padding: 8px 0;">${escapeHtml(contact.phone)}</td></tr>` : ''}
                    ${contact.homepage ? `<tr><td style="padding: 8px 0; color: #aaaaaa;">HP:</td><td style="padding: 8px 0;"><a href="${escapeHtml(contact.homepage)}" target="_blank">${escapeHtml(contact.homepage)}</a></td></tr>` : ''}
                    ${contact.referredBy ? `<tr><td style="padding: 8px 0; color: #aaaaaa;">ç´¹ä»‹å…ƒ:</td><td style="padding: 8px 0;">${getReferrerDisplay(contact)}</td></tr>` : ''}
                </table>
                
                ${contact.types && contact.types.length > 0 ? `
                    <div style="margin-bottom: 15px;">
                        <strong>ç¨®åˆ¥:</strong> ${contact.types.map(t => `<span class="tag">${escapeHtml(t)}</span>`).join(' ')}
                    </div>
                ` : ''}
                
                ${contact.affiliations && contact.affiliations.length > 0 ? `
                    <div style="margin-bottom: 15px;">
                        <strong>æ‰€å±ãƒ»ãƒãƒ£ãƒ—ã‚¿ãƒ¼:</strong> ${contact.affiliations.map(a => `<span class="tag">${escapeHtml(a)}</span>`).join(' ')}
                    </div>
                ` : ''}
                
                ${contact.wantToConnect && contact.wantToConnect.length > 0 ? `
                    <div style="margin-bottom: 15px;">
                        <strong>ç¹‹ãŒã‚ŠãŸã„äººãƒ»æ¥­ç¨®:</strong> ${contact.wantToConnect.map(w => `<span class="tag">${escapeHtml(w)}</span>`).join(' ')}
                    </div>
                ` : ''}
                
                ${contact.goldenEgg && contact.goldenEgg.length > 0 ? `
                    <div style="margin-bottom: 15px;">
                        <strong>é‡‘ã®åµ:</strong> ${contact.goldenEgg.map(g => `<span class="tag">${escapeHtml(g)}</span>`).join(' ')}
                    </div>
                ` : ''}
                
                ${contact.strengths ? `
                    <div style="margin-bottom: 15px;">
                        <strong>å¼·ã¿:</strong>
                        <div class="markdown">${renderMarkdown(contact.strengths)}</div>
                    </div>
                ` : ''}
                
                ${contact.careerHistory ? `
                    <div style="margin-bottom: 15px;">
                        <strong>éå»ã®çµŒæ­´:</strong>
                        <div class="markdown">${renderMarkdown(contact.careerHistory)}</div>
                    </div>
                ` : ''}
                
                ${contact.attachments && contact.attachments.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <strong>æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«:</strong>
                        <div class="file-list" style="margin-top: 10px;">
                            ${contact.attachments.map(att => `
                                <div class="file-item">
                                    <span>${escapeHtml(att.name)}</span>
                                    <a href="${att.url}" target="_blank" class="btn-small btn-secondary">é–‹ã</a>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div class="action-buttons">
                    <button class="btn-primary" onclick="showContactForm('${contact.id}')">ç·¨é›†</button>
                    <button class="btn-secondary" onclick="showMeetingForm('${contact.id}')">ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨˜éŒ²è¿½åŠ </button>
                    <button class="btn-danger" onclick="deleteContact('${contact.id}')">å‰Šé™¤</button>
                </div>
                
                <div class="meeting-timeline">
                    <h3 style="margin-bottom: 20px;">ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°å±¥æ­´</h3>
                    ${contactMeetings.length > 0 ? 
                        contactMeetings.map(meeting => `
                            <div class="meeting-item">
                                <div class="meeting-date">${formatDateTime(meeting.datetime)}</div>
                                <div class="markdown-content ${meeting.content.length > 500 ? 'truncated' : ''}" id="content-${meeting.id}">
                                    ${renderMarkdown(meeting.content)}
                                </div>
                                ${meeting.content.length > 500 ? `
                                    <a href="#" class="read-more" onclick="toggleContent('${meeting.id}'); return false;">ç¶šãã‚’èª­ã‚€</a>
                                ` : ''}
                                ${meeting.nextAction ? `
                                    <div style="margin-top: 10px;">
                                        <strong>æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</strong>
                                        <div class="markdown">${renderMarkdown(meeting.nextAction)}</div>
                                    </div>
                                ` : ''}
                                ${meeting.attachments && meeting.attachments.length > 0 ? `
                                    <div style="margin-top: 10px;">
                                        <strong>æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«:</strong>
                                        ${meeting.attachments.map(att => `
                                            <a href="${att.url}" target="_blank" style="margin-left: 10px;">${escapeHtml(att.name)}</a>
                                        `).join('')}
                                    </div>
                                ` : ''}
                                <div style="margin-top: 10px;">
                                    <button class="btn-small btn-secondary" onclick="editMeeting('${meeting.id}')">ç·¨é›†</button>
                                    <button class="btn-small btn-danger" onclick="deleteMeeting('${meeting.id}')">å‰Šé™¤</button>
                                </div>
                            </div>
                        `).join('') : 
                        '<p style="color: #aaaaaa;">ã¾ã ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>'
                    }
                </div>
            `;
            
            currentEditingContactId = contactId;
            document.getElementById('contactDetailBody').innerHTML = html;
            document.getElementById('contactDetailModal').style.display = 'block';
        }
        
        function showMeetingForm(contactId, meetingId = null) {
            currentEditingContactId = contactId;
            currentEditingMeetingId = meetingId;
            resetMeetingForm();
            
            const contact = contacts.find(c => c.id === contactId);
            document.getElementById('meetingFormTitle').textContent = 
                `${contact.name}ã•ã‚“ã¨ã®ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨˜éŒ²${meetingId ? 'ç·¨é›†' : ''}`;
            
            if (meetingId) {
                const meeting = meetings.find(m => m.id === meetingId);
                if (meeting) {
                    const form = document.getElementById('meetingForm');
                    form.datetime.value = meeting.datetime;
                    form.content.value = meeting.content || '';
                    form.nextAction.value = meeting.nextAction || '';
                    
                    // æ—¢å­˜ã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«
                    displayExistingMeetingAttachments(meeting.attachments || []);
                }
            } else {
                // æ–°è¦ã®å ´åˆã¯ç¾åœ¨æ™‚åˆ»ã‚’è¨­å®š
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('meetingForm').datetime.value = now.toISOString().slice(0, 16);
            }
            
            document.getElementById('meetingFormModal').style.display = 'block';
        }
        
        function editMeeting(meetingId) {
            const meeting = meetings.find(m => m.id === meetingId);
            if (meeting) {
                showMeetingForm(meeting.contactId, meetingId);
            }
        }
        
        // ===== æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»ã‚½ãƒ¼ãƒˆ =====
        function filterContacts() {
            const searchText = document.getElementById('searchName').value.toLowerCase();
            const typeFilter = document.getElementById('filterType').value;
            const affiliationFilter = document.getElementById('filterAffiliation').value;
            const wantToConnectFilter = document.getElementById('filterWantToConnect').value;
            const goldenEggFilter = document.getElementById('filterGoldenEgg').value;
            const referredByFilter = document.getElementById('filterReferredBy').value;

            renderContactList(contact => {
                // ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢
                if (searchText) {
                    const searchableText = [
                        contact.name,
                        contact.company,
                        contact.email,
                        contact.phone,
                        contact.homepage,
                        contact.strengths,
                        contact.referredBy,
                        contact.careerHistory,
                        ...(contact.types || []),
                        ...(contact.affiliations || []),
                        ...(contact.goldenEgg || []),
                        ...(contact.wantToConnect || [])
                    ].filter(Boolean).join(' ').toLowerCase();
                    
                    // é–¢é€£ã™ã‚‹ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å†…å®¹ã‚‚æ¤œç´¢å¯¾è±¡ã«å«ã‚ã‚‹
                    const contactMeetings = meetings.filter(m => m.contactId === contact.id);
                    const meetingText = contactMeetings.map(m => 
                        [m.content, m.nextAction].filter(Boolean).join(' ')
                    ).join(' ').toLowerCase();
                    
                    const fullText = searchableText + ' ' + meetingText;
                    
                    if (!fullText.includes(searchText)) return false;
                }
                
                // å€‹åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                if (typeFilter && !(contact.types || []).includes(typeFilter)) return false;
                if (affiliationFilter && !(contact.affiliations || []).includes(affiliationFilter)) return false;
                if (wantToConnectFilter && !(contact.wantToConnect || []).includes(wantToConnectFilter)) return false;
                if (goldenEggFilter && !(contact.goldenEgg || []).includes(goldenEggFilter)) return false;
                if (referredByFilter && contact.referredBy !== referredByFilter) return false;
                
                return true;
            });
        }
        
        function applySorting() {
            currentSortOrder = document.getElementById('sortOrder').value;
            renderContactList();
        }
        
        function getLastMeetingDate(contactId) {
            const contactMeetings = meetings.filter(m => m.contactId === contactId);
            if (contactMeetings.length === 0) return null;
            
            return contactMeetings
                .map(m => new Date(m.datetime))
                .sort((a, b) => b - a)[0];
        }
        
        function sortContacts(contactList) {
            const sorted = [...contactList];
            
            switch (currentSortOrder) {
                case 'meeting-desc':
                    sorted.sort((a, b) => {
                        const dateA = getLastMeetingDate(a.id);
                        const dateB = getLastMeetingDate(b.id);
                        if (!dateA && !dateB) return 0;
                        if (!dateA) return 1;
                        if (!dateB) return -1;
                        return dateB - dateA;
                    });
                    break;
                case 'meeting-asc':
                    sorted.sort((a, b) => {
                        const dateA = getLastMeetingDate(a.id);
                        const dateB = getLastMeetingDate(b.id);
                        if (!dateA && !dateB) return 0;
                        if (!dateA) return 1;
                        if (!dateB) return -1;
                        return dateA - dateB;
                    });
                    break;
                case 'name-asc':
                    sorted.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
                    break;
                case 'name-desc':
                    sorted.sort((a, b) => b.name.localeCompare(a.name, 'ja'));
                    break;
            }
            
            return sorted;
        }
        
        // ===== ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° =====
        function renderContactList(filterFunc = null) {
            const grid = document.getElementById('contactGrid');
            let filteredContacts = filterFunc ? contacts.filter(filterFunc) : contacts;
            
            // ã‚½ãƒ¼ãƒˆé©ç”¨
            filteredContacts = sortContacts(filteredContacts);
            
            grid.innerHTML = filteredContacts.map(contact => {
                const lastMeetingDate = getLastMeetingDate(contact.id);
                const lastMeetingText = lastMeetingDate ? 
                    `æœ€çµ‚æ‰“åˆã›: ${formatDate(lastMeetingDate)}` : 
                    'ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°æœªå®Ÿæ–½';
                
                return `
                    <div class="contact-card" onclick="showContactDetail('${contact.id}')">
                        <div class="contact-photo">
                            ${contact.photoUrl ? 
                                `<img src="${contact.photoUrl}" alt="${contact.name}">` : 
                                `<span style="font-size: 32px;">${contact.name.charAt(0)}</span>`
                            }
                        </div>
                        <div class="contact-name">${escapeHtml(contact.name)}</div>
                        ${contact.company ? `<div class="contact-info">ä¼šç¤¾: ${escapeHtml(contact.company)}</div>` : ''}
                        ${contact.email ? `<div class="contact-info">ğŸ“§ ${escapeHtml(contact.email)}</div>` : ''}
                        ${contact.phone ? `<div class="contact-info">ğŸ“± ${escapeHtml(contact.phone)}</div>` : ''}
                        ${contact.homepage ? `<div class="contact-info">ğŸŒ ${escapeHtml(contact.homepage)}</div>` : ''}
                        <div class="last-meeting-info">${lastMeetingText}</div>
                        <div class="tags">
                            ${(contact.types || []).map(type => `<span class="tag">${escapeHtml(type)}</span>`).join('')}
                            ${(contact.affiliations || []).map(aff => `<span class="tag">${escapeHtml(aff)}</span>`).join('')}
                            ${contact.referredBy ? `<span class="tag">ç´¹ä»‹: ${escapeHtml(contact.referredBy)}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ===== ç´¹ä»‹å…ƒãƒªãƒ³ã‚¯ =====
        function updateAllReferrerLinks() {
            for (const contact of contacts) {
                if (contact.referredBy) {
                    const referrers = contacts.filter(c => c.name === contact.referredBy && c.id !== contact.id);
                    
                    // ãƒªãƒ³ã‚¯æƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆ
                    delete contact.referredById;
                    delete contact.referredByIds;
                    
                    if (referrers.length === 1) {
                        contact.referredById = referrers[0].id;
                    } else if (referrers.length > 1) {
                        contact.referredByIds = referrers.map(r => r.id);
                    }
                }
            }
        }
        
        function getReferrerDisplay(contact) {
            if (contact.referredById) {
                const referrer = contacts.find(c => c.id === contact.referredById);
                if (referrer) {
                    return `<a href="#" onclick="showContactDetail('${referrer.id}'); return false;">${escapeHtml(referrer.name)}</a>`;
                }
            } else if (contact.referredByIds && contact.referredByIds.length > 0) {
                return `<span>${escapeHtml(contact.referredBy)} <small style="color: #d93025;">(ç´¹ä»‹å…ƒãŒè¤‡æ•°ã‚ã‚Šã¾ã™)</small></span>`;
            }
            return escapeHtml(contact.referredBy);
        }
        
        // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° =====
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDate(date) {
            const d = new Date(date);
            return `${d.getFullYear()}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')}`;
        }
        
        function formatDateTime(datetime) {
            const d = new Date(datetime);
            return `${formatDate(d)} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type === 'error' ? 'error-notification' : ''}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function toggleContent(meetingId) {
            const content = document.getElementById(`content-${meetingId}`);
            const link = event.target;
            
            if (content.classList.contains('truncated')) {
                content.classList.remove('truncated');
                link.textContent = 'æŠ˜ã‚ŠãŸãŸã‚€';
            } else {
                content.classList.add('truncated');
                link.textContent = 'ç¶šãã‚’èª­ã‚€';
            }
        }
        
        // ===== Markdownãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° =====
        function renderMarkdown(text) {
            if (!text) return '';
            
            // HTML ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†
            const escapeHtml = (str) => {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            };
            
            // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä¸€æ™‚çš„ã«ç½®æ›
            const codeBlocks = [];
            let processedText = text.replace(/```([\s\S]*?)```/g, (match, code) => {
                codeBlocks.push(`<pre><code>${escapeHtml(code.trim())}</code></pre>`);
                return `__CODEBLOCK_${codeBlocks.length - 1}__`;
            });
            
            // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’å‡¦ç†
            processedText = processedText.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // è¦‹å‡ºã—
            processedText = processedText.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            processedText = processedText.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            processedText = processedText.replace(/^# (.+)$/gm, '<h1>$1</h1>');
            
            // å¤ªå­—
            processedText = processedText.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            
            // ãƒªãƒ³ã‚¯
            processedText = processedText.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            // ãƒªã‚¹ãƒˆï¼ˆé †åºãªã—ï¼‰
            processedText = processedText.replace(/^- (.+)$/gm, '<li>$1</li>');
            processedText = processedText.replace(/(<li>.*<\/li>)/s, (match) => {
                const items = match.split('\n').filter(item => item.trim());
                return '<ul>' + items.join('\n') + '</ul>';
            });
            
            // ãƒªã‚¹ãƒˆï¼ˆé †åºã‚ã‚Šï¼‰
            processedText = processedText.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
            
            // å¼•ç”¨
            processedText = processedText.replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>');
            
            // æ°´å¹³ç·š
            processedText = processedText.replace(/^---$/gm, '<hr>');
            
            // æ®µè½
            processedText = processedText.split('\n\n').map(para => {
                if (para.trim() && !para.startsWith('<')) {
                    return `<p>${para.trim()}</p>`;
                }
                return para;
            }).join('\n');
            
            // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’å¾©å…ƒ
            codeBlocks.forEach((code, index) => {
                processedText = processedText.replace(`__CODEBLOCK_${index}__`, code);
            });
            
            return processedText;
        }
        
        // ===== ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç† =====
        function updateDropdownOptions() {
            updateSelectOptions('filterType', dropdownOptions.types);
            updateSelectOptions('filterAffiliation', dropdownOptions.affiliations);
            updateSelectOptions('filterWantToConnect', dropdownOptions.wantToConnect);
            updateSelectOptions('filterGoldenEgg', dropdownOptions.goldenEgg);
            
            // ç´¹ä»‹å…ƒãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            const referrers = [...new Set(contacts.map(c => c.referredBy).filter(Boolean))];
            updateSelectOptions('filterReferredBy', referrers);
        }
        
        function updateSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            select.innerHTML = '<option value="">ã™ã¹ã¦</option>';
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
            select.value = currentValue;
        }
        
        // ===== ãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆ =====
        function setupMultiSelect() {
            ['types', 'affiliations', 'wantToConnect', 'goldenEgg'].forEach(field => {
                updateMultiSelectOptions(field, dropdownOptions[field]);
            });
        }
        
        function updateMultiSelectOptions(field, options) {
            const dropdown = document.getElementById(`${field}-dropdown`);
            const selectedValues = getSelectedValues(field);
            
            dropdown.innerHTML = options.map(option => `
                <div class="multi-select-option" onclick="toggleOption('${field}', '${escapeHtml(option)}')">
                    <input type="checkbox" ${selectedValues.includes(option) ? 'checked' : ''}>
                    <span>${escapeHtml(option)}</span>
                </div>
            `).join('') + `
                <div class="multi-select-option" onclick="addNewOption('${field}')">
                    <span style="color: #4c8bf5;">+ æ–°ã—ã„é …ç›®ã‚’è¿½åŠ </span>
                </div>
            `;
        }
        
        function toggleMultiSelect(field) {
            const dropdown = document.getElementById(`${field}-dropdown`);
            const allDropdowns = document.querySelectorAll('.multi-select-dropdown');
            
            allDropdowns.forEach(d => {
                if (d !== dropdown) d.classList.remove('show');
            });
            
            dropdown.classList.toggle('show');
        }
        
        function toggleOption(field, value) {
            const display = event.target.closest('.multi-select').querySelector('.multi-select-display');
            const checkbox = event.target.querySelector('input[type="checkbox"]');
            
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
            }
            
            updateMultiSelectDisplay(field);
        }
        
        function getSelectedValues(field) {
            const checkboxes = document.querySelectorAll(`#${field}-dropdown input[type="checkbox"]:checked`);
            return Array.from(checkboxes).map(cb => cb.parentElement.querySelector('span').textContent);
        }
        
        function setSelectedValues(field, values) {
            const checkboxes = document.querySelectorAll(`#${field}-dropdown input[type="checkbox"]`);
            checkboxes.forEach(cb => {
                const value = cb.parentElement.querySelector('span').textContent;
                cb.checked = values.includes(value);
            });
            updateMultiSelectDisplay(field);
        }
        
        function updateMultiSelectDisplay(field) {
            const display = document.querySelector(`#${field}-dropdown`).previousElementSibling;
            const selected = getSelectedValues(field);
            
            if (selected.length === 0) {
                display.innerHTML = '<span style="color: #aaaaaa;">é¸æŠã—ã¦ãã ã•ã„</span>';
            } else {
                display.innerHTML = selected.map(value => 
                    `<span class="selected-tag">${escapeHtml(value)}<span class="remove" onclick="removeSelectedValue('${field}', '${escapeHtml(value)}')">&times;</span></span>`
                ).join('');
            }
        }
        
        function removeSelectedValue(field, value) {
            event.stopPropagation();
            const checkbox = Array.from(document.querySelectorAll(`#${field}-dropdown input[type="checkbox"]`))
                .find(cb => cb.parentElement.querySelector('span').textContent === value);
            if (checkbox) {
                checkbox.checked = false;
                updateMultiSelectDisplay(field);
            }
        }
        
        async function addNewOption(field) {
            event.stopPropagation();
            const newValue = prompt('æ–°ã—ã„é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (newValue && newValue.trim()) {
                const trimmedValue = newValue.trim();
                if (!dropdownOptions[field].includes(trimmedValue)) {
                    dropdownOptions[field].push(trimmedValue);
                    dropdownOptions[field].sort();
                    updateMultiSelectOptions(field, dropdownOptions[field]);
                    updateDropdownOptions();
                    await saveData();
                }
            }
        }
        
        // ===== ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ— =====
        function setupFileDragDrop() {
            // é€£çµ¡å…ˆã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«
            const attachmentZone = document.getElementById('attachmentDropZone');
            const attachmentInput = document.getElementById('attachmentUpload');
            
            attachmentZone.addEventListener('click', () => attachmentInput.click());
            attachmentZone.addEventListener('dragover', handleDragOver);
            attachmentZone.addEventListener('dragleave', handleDragLeave);
            attachmentZone.addEventListener('drop', (e) => handleDrop(e, 'contact'));
            attachmentInput.addEventListener('change', (e) => handleFileSelect(e, 'contact'));
            
            // ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«
            const meetingZone = document.getElementById('meetingAttachmentDropZone');
            const meetingInput = document.getElementById('meetingAttachmentUpload');
            
            meetingZone.addEventListener('click', () => meetingInput.click());
            meetingZone.addEventListener('dragover', handleDragOver);
            meetingZone.addEventListener('dragleave', handleDragLeave);
            meetingZone.addEventListener('drop', (e) => handleDrop(e, 'meeting'));
            meetingInput.addEventListener('change', (e) => handleFileSelect(e, 'meeting'));
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }
        
        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }
        
        function handleDrop(e, type) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files);
            if (type === 'contact') {
                selectedFiles.push(...files);
                displayNewAttachments();
            } else {
                selectedMeetingFiles.push(...files);
                displayNewMeetingAttachments();
            }
        }
        
        function handleFileSelect(e, type) {
            const files = Array.from(e.target.files);
            if (type === 'contact') {
                selectedFiles.push(...files);
                displayNewAttachments();
            } else {
                selectedMeetingFiles.push(...files);
                displayNewMeetingAttachments();
            }
        }
        
        function displayExistingAttachments(attachments) {
            const container = document.getElementById('existingAttachments');
            container.innerHTML = attachments.map(att => `
                <div class="file-item">
                    <span>${escapeHtml(att.name)}</span>
                    <div class="file-item-actions">
                        <a href="${att.url}" target="_blank" class="btn-small btn-secondary">é–‹ã</a>
                        <button type="button" class="btn-small btn-danger" onclick="markAttachmentForDeletion('${att.path}')">å‰Šé™¤</button>
                    </div>
                </div>
            `).join('');
        }
        
        function displayExistingMeetingAttachments(attachments) {
            const container = document.getElementById('existingMeetingAttachments');
            container.innerHTML = attachments.map(att => `
                <div class="file-item">
                    <span>${escapeHtml(att.name)}</span>
                    <div class="file-item-actions">
                        <a href="${att.url}" target="_blank" class="btn-small btn-secondary">é–‹ã</a>
                        <button type="button" class="btn-small btn-danger" onclick="markMeetingAttachmentForDeletion('${att.path}')">å‰Šé™¤</button>
                    </div>
                </div>
            `).join('');
        }
        
        function displayNewAttachments() {
            const container = document.getElementById('newAttachments');
            container.innerHTML = selectedFiles.map((file, index) => `
                <div class="file-item">
                    <span>${escapeHtml(file.name)}</span>
                    <button type="button" class="btn-small btn-danger" onclick="removeNewAttachment(${index})">å‰Šé™¤</button>
                </div>
            `).join('');
        }
        
        function displayNewMeetingAttachments() {
            const container = document.getElementById('newMeetingAttachments');
            container.innerHTML = selectedMeetingFiles.map((file, index) => `
                <div class="file-item">
                    <span>${escapeHtml(file.name)}</span>
                    <button type="button" class="btn-small btn-danger" onclick="removeNewMeetingAttachment(${index})">å‰Šé™¤</button>
                </div>
            `).join('');
        }
        
        function markAttachmentForDeletion(path) {
            deletedAttachments.push(path);
            event.target.closest('.file-item').style.display = 'none';
        }
        
        function markMeetingAttachmentForDeletion(path) {
            deletedMeetingAttachments.push(path);
            event.target.closest('.file-item').style.display = 'none';
        }
        
        function removeNewAttachment(index) {
            selectedFiles.splice(index, 1);
            displayNewAttachments();
        }
        
        function removeNewMeetingAttachment(index) {
            selectedMeetingFiles.splice(index, 1);
            displayNewMeetingAttachments();
        }
        
        // ===== ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ =====
        function resetContactForm() {
            document.getElementById('contactForm').reset();
            document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('existingAttachments').innerHTML = '';
            document.getElementById('newAttachments').innerHTML = '';
            currentPhotoFile = null;
            selectedFiles = [];
            deletedAttachments = [];
            
            // ãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
            ['types', 'affiliations', 'wantToConnect', 'goldenEgg'].forEach(field => {
                const display = document.querySelector(`#${field}-dropdown`).previousElementSibling;
                display.innerHTML = '<span style="color: #aaaaaa;">é¸æŠã—ã¦ãã ã•ã„</span>';
            });
        }
        
        function resetMeetingForm() {
            document.getElementById('meetingForm').reset();
            document.getElementById('existingMeetingAttachments').innerHTML = '';
            document.getElementById('newMeetingAttachments').innerHTML = '';
            selectedMeetingFiles = [];
            deletedMeetingAttachments = [];
        }
        
        // ===== ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ =====
        async function exportData() {
            try {
                const exportData = {
                    version: '2.0',
                    exportDate: new Date().toISOString(),
                    contacts: contacts,
                    meetings: meetings,
                    dropdownOptions: dropdownOptions
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `meeting_data_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showNotification('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showNotification('ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }
        
        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                showLoading();
                const text = await file.text();
                const importedData = JSON.parse(text);
                
                // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
                if (!importedData.version || !importedData.contacts || !importedData.meetings) {
                    throw new Error('ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™');
                }
                
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯ã¨ãƒãƒ¼ã‚¸
                const existingContactIds = new Set(contacts.map(c => c.id));
                const existingMeetingIds = new Set(meetings.map(m => m.id));
                
                let addedContacts = 0;
                let addedMeetings = 0;
                
                // é€£çµ¡å…ˆã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                for (const contact of importedData.contacts) {
                    if (!existingContactIds.has(contact.id)) {
                        contacts.push(contact);
                        addedContacts++;
                    }
                }
                
                // ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                for (const meeting of importedData.meetings) {
                    if (!existingMeetingIds.has(meeting.id)) {
                        // é–¢é€£ã™ã‚‹é€£çµ¡å…ˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                        if (contacts.some(c => c.id === meeting.contactId)) {
                            meetings.push(meeting);
                            addedMeetings++;
                        }
                    }
                }
                
                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ãƒãƒ¼ã‚¸
                if (importedData.dropdownOptions) {
                    for (const key in importedData.dropdownOptions) {
                        if (dropdownOptions[key]) {
                            dropdownOptions[key] = [...new Set([...dropdownOptions[key], ...importedData.dropdownOptions[key]])];
                        }
                    }
                }
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                await saveData();
                
                // UIã‚’æ›´æ–°
                updateDropdownOptions();
                updateAllReferrerLinks();
                renderContactList();
                
                hideLoading();
                showNotification(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†: ${addedContacts}ä»¶ã®é€£çµ¡å…ˆã¨${addedMeetings}ä»¶ã®ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
                
                // ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
                event.target.value = '';
            } catch (error) {
                console.error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showNotification('ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                hideLoading();
                event.target.value = '';
            }
        }
        
        // ===== ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š =====
        document.addEventListener('DOMContentLoaded', () => {
            try {
                setupFileDragDrop();
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.style.display = 'none';
                        }
                    });
                });
                
                // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå…¨ä½“ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒãƒ«ãƒã‚»ãƒ¬ã‚¯ãƒˆã‚’é–‰ã˜ã‚‹ï¼‰
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.multi-select')) {
                        document.querySelectorAll('.multi-select-dropdown').forEach(dropdown => {
                            dropdown.classList.remove('show');
                        });
                    }
                });
                
                // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®ç›£è¦–
                window.addEventListener('online', () => {
                    showNotification('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒå¾©æ—§ã—ã¾ã—ãŸ', 'success');
                    const statusElement = document.getElementById('connection-status');
                    if (statusElement) {
                        statusElement.style.color = '#4c8bf5';
                    }
                });
                
                window.addEventListener('offline', () => {
                    showNotification('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ', 'error');
                    const statusElement = document.getElementById('connection-status');
                    if (statusElement) {
                        statusElement.style.color = '#d93025';
                    }
                });
                
            } catch (error) {
                console.error('ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
            }
        });
        
        // ===== ã‚»ãƒ«ãƒ•ãƒ†ã‚¹ãƒˆï¼ˆæ”¹å–„ç‰ˆï¼‰ =====
        async function runSelfTest() {
            console.log('=== 1to1 Meeting System Self-Test v4.0 ===');
            console.log('Focus: Authentication & Sharing Link Fix');
            console.log('Test Time:', new Date().toLocaleString());
            console.log('=========================================\n');
            
            // 1. Dropbox Connection Test
            console.log('1. Dropbox Connection Test:');
            if (!dropbox) {
                console.log('   âŒ Dropbox not initialized');
                console.log('   â†’ Please authenticate first\n');
                return;
            }
            console.log('   âœ… Dropbox instance created');
            
            // 2. Token Validation Test
            console.log('\n2. Token Validation Test:');
            try {
                const isValid = await validateAccessToken();
                if (isValid) {
                    console.log('   âœ… Access token is valid');
                } else {
                    console.log('   âŒ Access token is invalid');
                    return;
                }
            } catch (err) {
                console.log('   âŒ Token validation error:', err.message);
                return;
            }
            
            // 3. Permission Scope Test
            console.log('\n3. Permission Scope Test:');
            const requiredScopes = ['files.metadata.read', 'files.metadata.write', 
                                    'files.content.read', 'files.content.write', 
                                    'sharing.write', 'sharing.read'];
            console.log('   Required scopes:', requiredScopes.join(', '));
            
            // 4. Simplified Share Link Test
            console.log('\n4. Share Link Creation Test (Simplified):');
            try {
                // Create a test file
                const testContent = `Test file for share link - ${new Date().toISOString()}`;
                const testBlob = new Blob([testContent], { type: 'text/plain' });
                testBlob.name = 'share_test.txt';
                
                console.log('   ğŸ“¤ Uploading test file...');
                const testPath = `/1to1App/attachments/test_share_${Date.now()}.txt`;
                
                // Upload
                const uploadResult = await dropbox.filesUpload({
                    path: testPath,
                    contents: testBlob,
                    mode: { '.tag': 'overwrite' }
                });
                console.log('   âœ… Upload successful');
                
                // Create share link (simplified)
                console.log('   ğŸ”— Creating share link...');
                try {
                    const shareResult = await dropbox.sharingCreateSharedLinkWithSettings({
                        path: uploadResult.path_lower
                    });
                    console.log('   âœ… Share link created:', shareResult.url);
                } catch (shareError) {
                    if (shareError.status === 409) {
                        console.log('   âš ï¸  Share link already exists, retrieving...');
                        const links = await dropbox.sharingListSharedLinks({
                            path: uploadResult.path_lower
                        });
                        if (links.result.links.length > 0) {
                            console.log('   âœ… Existing share link:', links.result.links[0].url);
                        }
                    } else {
                        console.log('   âŒ Share link error:', shareError.status, shareError.error);
                    }
                }
                
            } catch (error) {
                console.log('   âŒ Share link test failed:', error.message);
                console.log('   Error details:', error);
            }
            
            // 5. Error Recovery Test
            console.log('\n5. Error Recovery Features:');
            console.log('   âœ… 401 error handling: Re-authentication prompt');
            console.log('   âœ… Token validation: Check before operations');
            console.log('   âœ… Simplified share link creation');
            console.log('   âœ… Fallback to existing links on 409');
            
            // 6. Summary
            console.log('\n=== Test Summary ===');
            console.log('âœ… Authentication: Enhanced with validation');
            console.log('âœ… Share links: Simplified API calls');
            console.log('âœ… Error handling: 401 errors trigger re-auth');
            console.log('âœ… User experience: Clear error messages');
            
            console.log('\nğŸ“ Key Fixes:');
            console.log('- Added validateAccessToken() for token checking');
            console.log('- Simplified sharingCreateSharedLinkWithSettings call');
            console.log('- Added sharing.read scope to requirements');
            console.log('- Enhanced 401 error recovery with auto-logout');
            
            console.log('\n=== Self-Test Complete ===');
            return {
                status: 'ready',
                authentication: 'enhanced',
                shareLinks: 'simplified',
                errorHandling: 'improved'
            };
        }
        
        // é–‹ç™ºç’°å¢ƒã§ã®ã¿ã‚»ãƒ«ãƒ•ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.log('ğŸ”§ Development Mode Active');
            setTimeout(() => {
                runSelfTest().then(result => {
                    console.log('Self-test result:', result);
                }).catch(err => {
                    console.error('Self-test error:', err);
                });
            }, 2000);
        }
        
        // Production readiness check
        console.log('=== 1to1 Meeting System v4.0 ===');
        console.log('âœ… Authentication: Token validation added');
        console.log('âœ… Share links: Simplified implementation');
        console.log('âœ… Error handling: 401 auto-recovery');
        console.log('âœ… Required scopes:', REQUIRED_SCOPES.join(', '));
        console.log('âœ… Key fix: force_reapprove=true for fresh auth');
    </script>
</body>
</html>