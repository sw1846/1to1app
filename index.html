<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>1to1ミーティング管理システム - PlaceOn HD</title>
    
    <!-- Google API Client Library -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #0a0a0a;
            color: #e0e0e0;
            line-height: 1.4;
            font-size: 13px;
            -webkit-tap-highlight-color: transparent;
        }

        /* レイアウト */
        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            transition: margin-right 0.3s ease;
        }

        .main-content.with-sidebar {
            margin-right: 400px;
        }

        /* コンパクトヘッダー */
        header {
            background: #141414;
            padding: 8px 16px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            align-items: center;
            gap: 16px;
            height: 48px;
            flex-shrink: 0;
        }

        .header-title {
            font-size: 16px;
            font-weight: 500;
            color: #f0f0f0;
            margin: 0;
        }

        .header-actions {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* コンパクトボタン */
        button {
            padding: 4px 12px;
            border: 1px solid #2a2a2a;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 400;
            transition: all 0.15s ease;
            background: #1a1a1a;
            color: #e0e0e0;
            height: 28px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        button:hover {
            background: #242424;
            border-color: #3a3a3a;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-icon {
            padding: 4px 8px;
            font-size: 16px;
        }

        .btn-ghost {
            background: transparent;
            border: none;
            padding: 4px;
        }

        .btn-ghost:hover {
            background: rgba(255,255,255,0.1);
        }

        /* 検索・フィルターバー */
        .search-bar {
            background: #141414;
            padding: 8px 16px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
        }

        .search-input {
            flex: 1;
            max-width: 400px;
            padding: 6px 12px;
            border: 1px solid #2a2a2a;
            border-radius: 4px;
            font-size: 12px;
            background: #0a0a0a;
            color: #e0e0e0;
            height: 32px;
        }

        .search-input:focus {
            outline: none;
            border-color: #2563eb;
        }

        .filter-chips {
            display: flex;
            gap: 6px;
            align-items: center;
            flex: 1;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .filter-chips::-webkit-scrollbar {
            display: none;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.15s ease;
        }

        .filter-chip:hover {
            background: #242424;
            border-color: #3a3a3a;
        }

        .filter-chip.active {
            background: #2563eb;
            border-color: #2563eb;
            color: white;
        }

        /* ステータスバー */
        .status-bar {
            background: #0a0a0a;
            padding: 4px 16px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 11px;
            color: #888;
            height: 28px;
            flex-shrink: 0;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #22c55e;
        }

        /* コンテンツエリア */
        .content-area {
            flex: 1;
            overflow-y: auto;
            background: #0a0a0a;
        }

        /* 高密度グリッド */
        .contact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1px;
            background: #2a2a2a;
            padding: 1px;
        }

        .contact-card {
            background: #141414;
            padding: 12px;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            display: flex;
            gap: 12px;
        }

        .contact-card:hover {
            background: #1a1a1a;
            z-index: 1;
            box-shadow: 0 0 0 1px #2563eb;
        }

        .contact-card.selected {
            background: #1a1a1a;
            box-shadow: 0 0 0 2px #2563eb;
        }

        .contact-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2a2a2a;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
            font-size: 14px;
            color: #666;
        }

        .contact-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .contact-info {
            flex: 1;
            min-width: 0;
        }

        .contact-name {
            font-weight: 500;
            font-size: 13px;
            color: #f0f0f0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .contact-company {
            font-size: 11px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .contact-meta {
            display: flex;
            gap: 8px;
            margin-top: 4px;
            font-size: 11px;
            color: #666;
        }

        .contact-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: none;
            gap: 4px;
        }

        .contact-card:hover .contact-actions {
            display: flex;
        }

        /* コンパクトテーブル表示 */
        .contact-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .contact-table th {
            background: #141414;
            padding: 6px 12px;
            text-align: left;
            font-weight: 500;
            color: #888;
            border-bottom: 1px solid #2a2a2a;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .contact-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #1a1a1a;
        }

        .contact-table tr {
            background: #0a0a0a;
            transition: background 0.15s ease;
            cursor: pointer;
        }

        .contact-table tr:hover {
            background: #141414;
        }

        .contact-table tr.selected {
            background: #1a1a1a;
        }

        /* サイドパネル */
        .side-panel {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 400px;
            background: #141414;
            border-left: 1px solid #2a2a2a;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 100;
        }

        .side-panel.open {
            transform: translateX(0);
        }

        .panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            align-items: center;
            gap: 12px;
            background: #1a1a1a;
            height: 48px;
            flex-shrink: 0;
        }

        .panel-title {
            font-size: 14px;
            font-weight: 500;
            flex: 1;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* タブ */
        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid #2a2a2a;
            margin: -16px -16px 16px;
            background: #0a0a0a;
        }

        .tab {
            padding: 8px 16px;
            cursor: pointer;
            background: transparent;
            border: none;
            color: #888;
            font-size: 12px;
            position: relative;
            transition: color 0.15s ease;
        }

        .tab:hover {
            color: #e0e0e0;
        }

        .tab.active {
            color: #2563eb;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: #2563eb;
        }

        /* 情報セクション */
        .info-section {
            margin-bottom: 20px;
        }

        .info-label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 13px;
            color: #e0e0e0;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #1a1a1a;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        /* タグ */
        .tag {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            background: #1a1a1a;
            border-radius: 10px;
            font-size: 10px;
            color: #888;
            margin: 2px;
        }

        .tag-primary {
            background: #2563eb20;
            color: #60a5fa;
        }

        /* ミーティング履歴 */
        .meeting-item {
            padding: 12px;
            background: #0a0a0a;
            border-radius: 4px;
            margin-bottom: 8px;
            border: 1px solid #1a1a1a;
        }

        .meeting-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .meeting-date {
            font-size: 12px;
            color: #2563eb;
        }

        .meeting-content {
            font-size: 12px;
            color: #aaa;
            max-height: 60px;
            overflow: hidden;
            position: relative;
        }

        .meeting-content.expanded {
            max-height: none;
        }

        .meeting-actions {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }

        /* タスク */
        .task-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 12px;
        }

        .task-checkbox {
            width: 14px;
            height: 14px;
            cursor: pointer;
        }

        .task-text {
            flex: 1;
            color: #e0e0e0;
        }

        .task-text.completed {
            text-decoration: line-through;
            color: #666;
        }

        .task-due {
            font-size: 10px;
            color: #666;
        }

        .task-due.overdue {
            color: #ef4444;
        }

        /* クイックアクション */
        .quick-actions {
            position: fixed;
            bottom: 16px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
            z-index: 90;
        }

        .fab {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #2563eb;
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s ease;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
        }

        /* モーダル（コンパクト版） */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #141414;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }

        /* フォーム（コンパクト版） */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            margin-bottom: 4px;
            font-size: 11px;
            color: #888;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #2a2a2a;
            border-radius: 4px;
            font-size: 12px;
            background: #0a0a0a;
            color: #e0e0e0;
            transition: border-color 0.15s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2563eb;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        /* ローディング */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #2a2a2a;
            border-radius: 50%;
            border-top-color: #2563eb;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* トースト通知 */
        .toast {
            position: fixed;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .toast.show {
            display: flex;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, 100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        .toast.error {
            background: #dc2626;
            color: white;
        }

        .toast.success {
            background: #16a34a;
            color: white;
        }

        /* キーボードショートカットヒント */
        .shortcut-hint {
            position: fixed;
            bottom: 16px;
            left: 16px;
            font-size: 10px;
            color: #666;
            display: flex;
            gap: 12px;
        }

        .shortcut {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .shortcut kbd {
            background: #1a1a1a;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            border: 1px solid #2a2a2a;
        }

        /* レスポンシブ */
        @media (max-width: 768px) {
            .side-panel {
                width: 100%;
            }
            
            .contact-grid {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                bottom: 8px;
                right: 8px;
            }
        }

        /* スクロールバー */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        ::-webkit-scrollbar-thumb {
            background: #2a2a2a;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #3a3a3a;
        }

        /* ドロップダウン */
        .dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 4px;
            padding: 4px;
            margin-top: 4px;
            min-width: 160px;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            display: block;
            width: 100%;
            padding: 6px 12px;
            background: transparent;
            border: none;
            text-align: left;
            font-size: 12px;
            color: #e0e0e0;
            cursor: pointer;
            border-radius: 3px;
            transition: background 0.15s ease;
        }

        .dropdown-item:hover {
            background: #2a2a2a;
        }

        .dropdown-divider {
            height: 1px;
            background: #2a2a2a;
            margin: 4px 0;
        }

        /* ビュー切り替え */
        .view-toggle {
            display: flex;
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 4px;
            padding: 2px;
        }

        .view-toggle button {
            background: transparent;
            border: none;
            padding: 4px 8px;
            font-size: 11px;
            color: #888;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.15s ease;
        }

        .view-toggle button.active {
            background: #1a1a1a;
            color: #e0e0e0;
        }

        /* 未完了タスクバッジ */
        .task-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 16px;
            height: 16px;
            padding: 0 4px;
            background: #dc2626;
            color: white;
            font-size: 10px;
            font-weight: 500;
            border-radius: 8px;
        }

        /* コンテキストメニュー */
        .context-menu {
            position: fixed;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 4px;
            padding: 4px;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }

        .context-menu.show {
            display: block;
        }

        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            font-size: 12px;
            color: #e0e0e0;
            cursor: pointer;
            border-radius: 3px;
            transition: background 0.15s ease;
        }

        .context-menu-item:hover {
            background: #2a2a2a;
        }

        /* セットアップウィザード（非表示） */
        .setup-wizard {
            display: none;
        }

        /* 認証コンテナ */
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            text-align: center;
            padding: 32px;
            background: #141414;
            border-radius: 8px;
            border: 1px solid #2a2a2a;
        }

        .auth-container h2 {
            font-size: 20px;
            margin-bottom: 16px;
            font-weight: 500;
        }

        .auth-container p {
            color: #888;
            margin-bottom: 24px;
            font-size: 13px;
        }

        .btn-google {
            background: white;
            color: #3c4043;
            border: 1px solid #dadce0;
            padding: 8px 16px;
            font-weight: 500;
        }

        .btn-google:hover {
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- セットアップウィザード（簡略化） -->
        <div id="setupWizard" class="setup-wizard"></div>

        <!-- 認証画面 -->
        <div id="authContainer" class="auth-container" style="display: none;">
            <h2>1to1ミーティング管理</h2>
            <p>Google Driveと連携してデータを管理します</p>
            <button class="btn-google" onclick="authenticateGoogle()">
                <svg width="16" height="16" viewBox="0 0 24 24" style="vertical-align: -3px; margin-right: 8px;">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Googleアカウントでログイン
            </button>
        </div>

        <!-- メインアプリ -->
        <div id="mainContainer" class="app-container" style="display: none;">
            <div class="main-content" id="mainContent">
                <!-- ヘッダー -->
                <header>
                    <h1 class="header-title">1to1 Meeting</h1>
                    <div class="header-actions">
                        <button class="btn-primary" onclick="showContactForm()">
                            <span style="font-size: 14px;">+</span> 新規登録
                        </button>
                        <div class="dropdown">
                            <button class="btn-icon btn-ghost" onclick="toggleDropdown('mainMenu')">⋮</button>
                            <div class="dropdown-menu" id="mainMenu">
                                <button class="dropdown-item" onclick="syncData()">
                                    <span>🔄</span> 同期
                                </button>
                                <button class="dropdown-item" onclick="exportData()">
                                    <span>📤</span> エクスポート
                                </button>
                                <button class="dropdown-item" onclick="document.getElementById('importInput').click()">
                                    <span>📥</span> インポート
                                </button>
                                <div class="dropdown-divider"></div>
                                <button class="dropdown-item" onclick="showSettings()">
                                    <span>⚙️</span> 設定
                                </button>
                                <button class="dropdown-item" onclick="logout()">
                                    <span>🚪</span> ログアウト
                                </button>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- 検索・フィルター -->
                <div class="search-bar">
                    <input type="text" class="search-input" id="searchInput" 
                           placeholder="検索... (⌘K)" 
                           onkeyup="filterContacts()">
                    <div class="filter-chips">
                        <div class="filter-chip" onclick="toggleFilter('type')" id="filterType">
                            種別 <span class="filter-count"></span>
                        </div>
                        <div class="filter-chip" onclick="toggleFilter('affiliation')" id="filterAffiliation">
                            所属 <span class="filter-count"></span>
                        </div>
                        <div class="filter-chip" onclick="toggleFilter('area')" id="filterArea">
                            エリア <span class="filter-count"></span>
                        </div>
                        <div class="filter-chip" onclick="toggleOutstandingTasks()" id="filterTasks">
                            未完了タスク <span class="task-badge" id="taskCount">0</span>
                        </div>
                    </div>
                    <div class="view-toggle">
                        <button class="active" onclick="setViewMode('grid')" id="viewGrid">
                            <span style="font-size: 14px;">⊞</span>
                        </button>
                        <button onclick="setViewMode('table')" id="viewTable">
                            <span style="font-size: 14px;">☰</span>
                        </button>
                    </div>
                </div>

                <!-- ステータスバー -->
                <div class="status-bar">
                    <div class="status-item">
                        <span class="status-dot"></span>
                        <span>接続済み</span>
                    </div>
                    <div class="status-item">
                        <span id="contactCount">0</span>件の連絡先
                    </div>
                    <div class="status-item">
                        <span id="lastSync">最終同期: --</span>
                    </div>
                    <div class="status-item" style="margin-left: auto;">
                        <select id="sortOrder" onchange="applySorting()" style="background: transparent; border: none; color: #888; font-size: 11px;">
                            <option value="meeting-desc">最終打合せ ↓</option>
                            <option value="meeting-asc">最終打合せ ↑</option>
                            <option value="name-asc">名前 A→Z</option>
                            <option value="name-desc">名前 Z→A</option>
                        </select>
                    </div>
                </div>

                <!-- コンテンツエリア -->
                <div class="content-area" id="contentArea">
                    <div id="contactGrid" class="contact-grid">
                        <!-- 連絡先がここに表示される -->
                    </div>
                    <table id="contactTable" class="contact-table" style="display: none;">
                        <thead>
                            <tr>
                                <th style="width: 40px;"></th>
                                <th>名前</th>
                                <th>会社</th>
                                <th>メール</th>
                                <th>最終打合せ</th>
                                <th>タグ</th>
                                <th style="width: 100px;">アクション</th>
                            </tr>
                        </thead>
                        <tbody id="contactTableBody">
                            <!-- 連絡先行がここに表示される -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- サイドパネル -->
            <div class="side-panel" id="sidePanel">
                <div class="panel-header">
                    <h2 class="panel-title" id="panelTitle">連絡先詳細</h2>
                    <button class="btn-icon btn-ghost" onclick="editCurrent()">✏️</button>
                    <button class="btn-icon btn-ghost" onclick="closeSidePanel()">✕</button>
                </div>
                <div class="panel-content" id="panelContent">
                    <!-- 詳細情報がここに表示される -->
                </div>
            </div>
        </div>

        <!-- モーダル（連絡先フォーム） -->
        <div id="contactFormModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="contactFormTitle">新規連絡先</h3>
                    <button class="btn-icon btn-ghost" onclick="closeModal('contactFormModal')">✕</button>
                </div>
                <div class="modal-body">
                    <form id="contactForm" onsubmit="saveContactForm(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>氏名 *</label>
                                <input type="text" name="name" required>
                            </div>
                            <div class="form-group">
                                <label>よみ</label>
                                <input type="text" name="yomi">
                            </div>
                            <div class="form-group">
                                <label>会社名</label>
                                <input type="text" name="company">
                            </div>
                            <div class="form-group">
                                <label>メール</label>
                                <input type="email" name="email">
                            </div>
                            <div class="form-group">
                                <label>電話番号</label>
                                <input type="tel" name="phone">
                            </div>
                            <div class="form-group">
                                <label>HP</label>
                                <input type="url" name="homepage">
                            </div>
                            <div class="form-group full-width">
                                <label>タグ（カンマ区切り）</label>
                                <input type="text" name="tags" placeholder="BNI, 東京チャプター, IT">
                            </div>
                            <div class="form-group full-width">
                                <label>メモ</label>
                                <textarea name="memo" rows="3"></textarea>
                            </div>
                        </div>
                        <div style="margin-top: 16px; display: flex; gap: 8px; justify-content: flex-end;">
                            <button type="button" onclick="closeModal('contactFormModal')">キャンセル</button>
                            <button type="submit" class="btn-primary">保存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- モーダル（ミーティングフォーム） -->
        <div id="meetingFormModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ミーティング記録</h3>
                    <button class="btn-icon btn-ghost" onclick="closeModal('meetingFormModal')">✕</button>
                </div>
                <div class="modal-body">
                    <form id="meetingForm" onsubmit="saveMeetingForm(event)">
                        <div class="form-group">
                            <label>日時 *</label>
                            <input type="datetime-local" name="datetime" required>
                        </div>
                        <div class="form-group">
                            <label>内容 *</label>
                            <textarea name="content" rows="4" required></textarea>
                        </div>
                        <div class="form-group">
                            <label>タスク</label>
                            <div id="taskList"></div>
                            <button type="button" onclick="addTask()" style="margin-top: 8px;">+ タスク追加</button>
                        </div>
                        <div style="margin-top: 16px; display: flex; gap: 8px; justify-content: flex-end;">
                            <button type="button" onclick="closeModal('meetingFormModal')">キャンセル</button>
                            <button type="submit" class="btn-primary">保存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- クイックアクション -->
        <div class="quick-actions">
            <button class="fab" onclick="showContactForm()">+</button>
        </div>

        <!-- ショートカットヒント -->
        <div class="shortcut-hint">
            <div class="shortcut">
                <kbd>⌘K</kbd> 検索
            </div>
            <div class="shortcut">
                <kbd>N</kbd> 新規
            </div>
            <div class="shortcut">
                <kbd>ESC</kbd> 閉じる
            </div>
        </div>

        <!-- トースト通知 -->
        <div id="toast" class="toast">
            <span id="toastMessage"></span>
        </div>

        <!-- コンテキストメニュー -->
        <div id="contextMenu" class="context-menu">
            <div class="context-menu-item" onclick="contextAction('edit')">
                <span>✏️</span> 編集
            </div>
            <div class="context-menu-item" onclick="contextAction('meeting')">
                <span>📅</span> ミーティング追加
            </div>
            <div class="context-menu-item" onclick="contextAction('delete')">
                <span>🗑</span> 削除
            </div>
        </div>

        <!-- 隠し要素 -->
        <input type="file" id="importInput" accept=".json" style="display: none;" onchange="importData(event)">
    </div>

    <script>
        // グローバル変数
        let CLIENT_ID = localStorage.getItem('google_client_id') || '';
        const SCOPES = 'https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/drive.file';
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
        const APP_FOLDER_NAME = '1to1MeetingManager';
        
        let tokenClient = null;
        let gapiInited = false;
        let gisInited = false;
        let accessToken = null;
        
        let contacts = [];
        let meetings = [];
        let currentEditingContactId = null;
        let currentEditingMeetingId = null;
        let currentSortOrder = 'meeting-desc';
        let viewMode = 'grid';
        let selectedContactId = null;
        let contextMenuTarget = null;
        
        // 初期化
        window.onload = function() {
            initializeApp();
            setupEventListeners();
            setupKeyboardShortcuts();
        };
        
        function initializeApp() {
            CLIENT_ID = localStorage.getItem('google_client_id') || '859340734431-nh2e0kkol4te8gn0m18hb79s2u0ofvs0.apps.googleusercontent.com';
            
            if (!CLIENT_ID) {
                showSetupWizard();
                return;
            }
            
            try {
                google.accounts.id.initialize({
                    client_id: CLIENT_ID,
                    callback: handleCredentialResponse
                });
                
                initializeGisClient();
                gapi.load('client', initializeGapiClient);
            } catch (error) {
                console.error('初期化エラー:', error);
                showAuthScreen();
            }
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: DISCOVERY_DOCS,
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function initializeGisClient() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (response) => {
                    if (response.error !== undefined) {
                        throw (response);
                    }
                    accessToken = response.access_token;
                    localStorage.setItem('google_access_token', accessToken);
                    handleAuthSuccess();
                },
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                const savedToken = localStorage.getItem('google_access_token');
                if (savedToken) {
                    gapi.client.setToken({ access_token: savedToken });
                    accessToken = savedToken;
                    validateTokenAndInitialize();
                } else {
                    showAuthScreen();
                }
            }
        }

        async function validateTokenAndInitialize() {
            try {
                await gapi.client.drive.about.get({ fields: 'user' });
                handleAuthSuccess();
            } catch (error) {
                console.error('Token validation failed:', error);
                localStorage.removeItem('google_access_token');
                showAuthScreen();
            }
        }

        function showAuthScreen() {
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('mainContainer').style.display = 'none';
        }

        function authenticateGoogle() {
            if (tokenClient) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            }
        }

        async function handleAuthSuccess() {
            try {
                showToast('読み込み中...');
                
                await ensureAppFolder();
                await loadData();
                
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'flex';
                
                renderContactList();
                updateStats();
                
                showToast('データを読み込みました', 'success');
            } catch (error) {
                console.error('初期化エラー:', error);
                showToast('エラーが発生しました', 'error');
            }
        }

        // データ管理（簡略化）
        let appFolderId = null;
        
        async function ensureAppFolder() {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${APP_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });
                
                if (response.result.files && response.result.files.length > 0) {
                    appFolderId = response.result.files[0].id;
                } else {
                    const folderResponse = await gapi.client.drive.files.create({
                        resource: {
                            name: APP_FOLDER_NAME,
                            mimeType: 'application/vnd.google-apps.folder'
                        },
                        fields: 'id'
                    });
                    appFolderId = folderResponse.result.id;
                }
            } catch (error) {
                console.error('フォルダ作成エラー:', error);
                throw error;
            }
        }

        async function loadData() {
            try {
                const contactsData = await loadJsonFile('contacts.json');
                contacts = contactsData || [];
                
                const meetingsData = await loadJsonFile('meetings.json');
                meetings = meetingsData || [];
                
                // データマイグレーション
                migrateLegacyData();
            } catch (error) {
                console.error('データ読み込みエラー:', error);
            }
        }

        async function saveData() {
            try {
                await Promise.all([
                    saveJsonFile('contacts.json', contacts),
                    saveJsonFile('meetings.json', meetings)
                ]);
                
                document.getElementById('lastSync').textContent = `最終同期: ${new Date().toLocaleTimeString()}`;
            } catch (error) {
                console.error('保存エラー:', error);
                throw error;
            }
        }

        async function loadJsonFile(fileName) {
            try {
                const searchResponse = await gapi.client.drive.files.list({
                    q: `name='${fileName}' and '${appFolderId}' in parents and trashed=false`,
                    fields: 'files(id)'
                });
                
                if (!searchResponse.result.files || searchResponse.result.files.length === 0) {
                    return null;
                }
                
                const fileId = searchResponse.result.files[0].id;
                
                const response = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });
                
                return response.result;
            } catch (error) {
                console.error('ファイル読み込みエラー:', error);
                return null;
            }
        }

        async function saveJsonFile(fileName, data) {
            const boundary = '-------314159265358979323846';
            const delimiter = "\r\n--" + boundary + "\r\n";
            const close_delim = "\r\n--" + boundary + "--";
            
            try {
                const searchResponse = await gapi.client.drive.files.list({
                    q: `name='${fileName}' and '${appFolderId}' in parents and trashed=false`,
                    fields: 'files(id)'
                });
                
                let fileId;
                let metadata;
                let multipartRequestBody;
                
                if (searchResponse.result.files && searchResponse.result.files.length > 0) {
                    fileId = searchResponse.result.files[0].id;
                    
                    metadata = {
                        name: fileName
                    };
                    
                    multipartRequestBody =
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        JSON.stringify(metadata) +
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        JSON.stringify(data, null, 2) +
                        close_delim;
                    
                    await gapi.client.request({
                        path: `/upload/drive/v3/files/${fileId}`,
                        method: 'PATCH',
                        params: { uploadType: 'multipart' },
                        headers: {
                            'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                        },
                        body: multipartRequestBody
                    });
                } else {
                    metadata = {
                        name: fileName,
                        mimeType: 'application/json',
                        parents: [appFolderId]
                    };
                    
                    multipartRequestBody =
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        JSON.stringify(metadata) +
                        delimiter +
                        'Content-Type: application/json\r\n\r\n' +
                        JSON.stringify(data, null, 2) +
                        close_delim;
                    
                    await gapi.client.request({
                        path: '/upload/drive/v3/files',
                        method: 'POST',
                        params: { uploadType: 'multipart' },
                        headers: {
                            'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                        },
                        body: multipartRequestBody
                    });
                }
            } catch (error) {
                console.error('ファイル保存エラー:', error);
                throw error;
            }
        }

        // UI関数
        function renderContactList() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            let filteredContacts = contacts.filter(contact => {
                if (!searchText) return true;
                
                const searchableFields = [
                    contact.name,
                    contact.yomi,
                    contact.company,
                    contact.email,
                    contact.phone,
                    contact.memo,
                    ...(contact.tags || [])
                ].filter(Boolean).join(' ').toLowerCase();
                
                return searchableFields.includes(searchText);
            });
            
            // ソート
            filteredContacts = sortContacts(filteredContacts);
            
            if (viewMode === 'grid') {
                renderGrid(filteredContacts);
            } else {
                renderTable(filteredContacts);
            }
            
            updateStats();
        }

        function renderGrid(contactList) {
            const grid = document.getElementById('contactGrid');
            grid.style.display = 'grid';
            document.getElementById('contactTable').style.display = 'none';
            
            grid.innerHTML = contactList.map(contact => {
                const lastMeeting = getLastMeetingDate(contact.id);
                const tags = contact.tags || [];
                
                return `
                    <div class="contact-card ${contact.id === selectedContactId ? 'selected' : ''}" 
                         onclick="selectContact('${contact.id}')"
                         oncontextmenu="showContextMenu(event, '${contact.id}')">
                        <div class="contact-photo">
                            ${contact.photoUrl ? 
                                `<img src="${contact.photoUrl}" alt="${contact.name}">` : 
                                contact.name.charAt(0)
                            }
                        </div>
                        <div class="contact-info">
                            <div class="contact-name">${escapeHtml(contact.name)}</div>
                            <div class="contact-company">${escapeHtml(contact.company || '-')}</div>
                            <div class="contact-meta">
                                <span>${lastMeeting ? formatDate(lastMeeting) : 'なし'}</span>
                                ${contact.email ? `<span>✉</span>` : ''}
                                ${contact.phone ? `<span>☎</span>` : ''}
                            </div>
                            ${tags.length > 0 ? `
                                <div style="margin-top: 4px;">
                                    ${tags.slice(0, 2).map(tag => 
                                        `<span class="tag">${escapeHtml(tag)}</span>`
                                    ).join('')}
                                    ${tags.length > 2 ? `<span class="tag">+${tags.length - 2}</span>` : ''}
                                </div>
                            ` : ''}
                        </div>
                        <div class="contact-actions">
                            <button class="btn-icon btn-ghost" onclick="editContact(event, '${contact.id}')">✏️</button>
                            <button class="btn-icon btn-ghost" onclick="addMeeting(event, '${contact.id}')">📅</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderTable(contactList) {
            document.getElementById('contactGrid').style.display = 'none';
            const table = document.getElementById('contactTable');
            table.style.display = 'table';
            
            const tbody = document.getElementById('contactTableBody');
            tbody.innerHTML = contactList.map(contact => {
                const lastMeeting = getLastMeetingDate(contact.id);
                const tags = contact.tags || [];
                
                return `
                    <tr class="${contact.id === selectedContactId ? 'selected' : ''}" 
                        onclick="selectContact('${contact.id}')"
                        oncontextmenu="showContextMenu(event, '${contact.id}')">
                        <td>
                            <div class="contact-photo" style="width: 32px; height: 32px;">
                                ${contact.photoUrl ? 
                                    `<img src="${contact.photoUrl}" alt="${contact.name}">` : 
                                    contact.name.charAt(0)
                                }
                            </div>
                        </td>
                        <td><strong>${escapeHtml(contact.name)}</strong></td>
                        <td>${escapeHtml(contact.company || '-')}</td>
                        <td>${contact.email ? `<a href="mailto:${contact.email}">${contact.email}</a>` : '-'}</td>
                        <td>${lastMeeting ? formatDate(lastMeeting) : '-'}</td>
                        <td>
                            ${tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
                        </td>
                        <td>
                            <button class="btn-icon btn-ghost" onclick="editContact(event, '${contact.id}')">✏️</button>
                            <button class="btn-icon btn-ghost" onclick="addMeeting(event, '${contact.id}')">📅</button>
                            <button class="btn-icon btn-ghost" onclick="deleteContact(event, '${contact.id}')">🗑</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function selectContact(contactId) {
            selectedContactId = contactId;
            renderContactList();
            showContactDetail(contactId);
        }

        function showContactDetail(contactId) {
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            const contactMeetings = meetings.filter(m => m.contactId === contactId)
                .sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
            
            document.getElementById('panelTitle').textContent = contact.name;
            
            let html = `
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('info')">基本情報</button>
                    <button class="tab" onclick="switchTab('meetings')">ミーティング (${contactMeetings.length})</button>
                    <button class="tab" onclick="switchTab('tasks')">タスク</button>
                </div>
                
                <div id="tab-info" class="tab-content">
                    ${contact.photoUrl ? `
                        <div style="text-align: center; margin-bottom: 16px;">
                            <img src="${contact.photoUrl}" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;">
                        </div>
                    ` : ''}
                    
                    <div class="info-section">
                        ${contact.company ? `
                            <div class="info-row">
                                <span>会社</span>
                                <span>${escapeHtml(contact.company)}</span>
                            </div>
                        ` : ''}
                        ${contact.email ? `
                            <div class="info-row">
                                <span>メール</span>
                                <a href="mailto:${contact.email}">${contact.email}</a>
                            </div>
                        ` : ''}
                        ${contact.phone ? `
                            <div class="info-row">
                                <span>電話</span>
                                <a href="tel:${contact.phone}">${contact.phone}</a>
                            </div>
                        ` : ''}
                        ${contact.homepage ? `
                            <div class="info-row">
                                <span>HP</span>
                                <a href="${contact.homepage}" target="_blank">開く</a>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${contact.tags && contact.tags.length > 0 ? `
                        <div class="info-section">
                            <div class="info-label">タグ</div>
                            <div>
                                ${contact.tags.map(tag => 
                                    `<span class="tag tag-primary">${escapeHtml(tag)}</span>`
                                ).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${contact.memo ? `
                        <div class="info-section">
                            <div class="info-label">メモ</div>
                            <div class="info-value">${escapeHtml(contact.memo).replace(/\n/g, '<br>')}</div>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 16px;">
                        <button class="btn-primary" onclick="addMeeting(null, '${contact.id}')" style="width: 100%;">
                            ミーティング記録を追加
                        </button>
                    </div>
                </div>
                
                <div id="tab-meetings" class="tab-content" style="display: none;">
                    ${contactMeetings.length > 0 ? 
                        contactMeetings.map(meeting => renderMeetingItem(meeting)).join('') :
                        '<p style="text-align: center; color: #666; margin: 32px 0;">ミーティング記録がありません</p>'
                    }
                </div>
                
                <div id="tab-tasks" class="tab-content" style="display: none;">
                    ${renderContactTasks(contactId)}
                </div>
            `;
            
            document.getElementById('panelContent').innerHTML = html;
            openSidePanel();
        }

        function renderMeetingItem(meeting) {
            const tasks = meeting.tasks || [];
            const incompleteTasks = tasks.filter(t => !t.done);
            
            return `
                <div class="meeting-item">
                    <div class="meeting-header">
                        <span class="meeting-date">${formatDateTime(meeting.datetime)}</span>
                        <div>
                            ${incompleteTasks.length > 0 ? 
                                `<span class="task-badge">${incompleteTasks.length}</span>` : ''
                            }
                            <button class="btn-icon btn-ghost" onclick="editMeeting('${meeting.id}')">✏️</button>
                            <button class="btn-icon btn-ghost" onclick="deleteMeeting('${meeting.id}')">🗑</button>
                        </div>
                    </div>
                    <div class="meeting-content" id="meeting-${meeting.id}">
                        ${escapeHtml(meeting.content).replace(/\n/g, '<br>')}
                    </div>
                    ${meeting.content.length > 150 ? `
                        <button class="btn-ghost" style="font-size: 11px; margin-top: 4px;" 
                                onclick="toggleMeetingContent('${meeting.id}')">
                            もっと見る
                        </button>
                    ` : ''}
                    ${tasks.length > 0 ? `
                        <div style="margin-top: 8px;">
                            ${tasks.map((task, idx) => renderTaskItem(task, meeting.id, idx)).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderTaskItem(task, meetingId, taskIndex) {
            const isOverdue = task.due && new Date(task.due) < new Date() && !task.done;
            
            return `
                <div class="task-item">
                    <input type="checkbox" class="task-checkbox" 
                           ${task.done ? 'checked' : ''}
                           onchange="toggleTask('${meetingId}', ${taskIndex})">
                    <span class="task-text ${task.done ? 'completed' : ''}">${escapeHtml(task.text)}</span>
                    ${task.due ? `
                        <span class="task-due ${isOverdue ? 'overdue' : ''}">
                            ${formatDate(new Date(task.due))}
                        </span>
                    ` : ''}
                </div>
            `;
        }

        function renderContactTasks(contactId) {
            const contactMeetings = meetings.filter(m => m.contactId === contactId);
            const allTasks = [];
            
            contactMeetings.forEach(meeting => {
                if (meeting.tasks) {
                    meeting.tasks.forEach((task, idx) => {
                        allTasks.push({
                            ...task,
                            meetingId: meeting.id,
                            meetingDate: meeting.datetime,
                            taskIndex: idx
                        });
                    });
                }
            });
            
            const incompleteTasks = allTasks.filter(t => !t.done);
            const completedTasks = allTasks.filter(t => t.done);
            
            let html = '';
            
            if (incompleteTasks.length > 0) {
                html += '<div class="info-section"><div class="info-label">未完了</div>';
                incompleteTasks.forEach(task => {
                    html += renderTaskItem(task, task.meetingId, task.taskIndex);
                });
                html += '</div>';
            }
            
            if (completedTasks.length > 0) {
                html += '<div class="info-section"><div class="info-label">完了済み</div>';
                completedTasks.slice(0, 5).forEach(task => {
                    html += renderTaskItem(task, task.meetingId, task.taskIndex);
                });
                html += '</div>';
            }
            
            if (allTasks.length === 0) {
                html = '<p style="text-align: center; color: #666; margin: 32px 0;">タスクがありません</p>';
            }
            
            return html;
        }

        // CRUD操作
        function showContactForm(contactId = null) {
            currentEditingContactId = contactId;
            const form = document.getElementById('contactForm');
            form.reset();
            
            if (contactId) {
                const contact = contacts.find(c => c.id === contactId);
                if (contact) {
                    document.getElementById('contactFormTitle').textContent = '連絡先編集';
                    form.name.value = contact.name || '';
                    form.yomi.value = contact.yomi || '';
                    form.company.value = contact.company || '';
                    form.email.value = contact.email || '';
                    form.phone.value = contact.phone || '';
                    form.homepage.value = contact.homepage || '';
                    form.tags.value = (contact.tags || []).join(', ');
                    form.memo.value = contact.memo || '';
                }
            } else {
                document.getElementById('contactFormTitle').textContent = '新規連絡先';
            }
            
            showModal('contactFormModal');
        }

        async function saveContactForm(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const tags = formData.get('tags').split(',').map(t => t.trim()).filter(Boolean);
            
            const contact = {
                id: currentEditingContactId || generateId(),
                name: formData.get('name'),
                yomi: formData.get('yomi'),
                company: formData.get('company'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                homepage: formData.get('homepage'),
                tags: tags,
                memo: formData.get('memo'),
                createdAt: currentEditingContactId ? 
                    contacts.find(c => c.id === currentEditingContactId)?.createdAt : 
                    new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (currentEditingContactId) {
                const index = contacts.findIndex(c => c.id === currentEditingContactId);
                if (index >= 0) {
                    contacts[index] = { ...contacts[index], ...contact };
                }
            } else {
                contacts.push(contact);
            }
            
            try {
                await saveData();
                closeModal('contactFormModal');
                renderContactList();
                showToast('保存しました', 'success');
                
                if (currentEditingContactId === selectedContactId) {
                    showContactDetail(selectedContactId);
                }
            } catch (error) {
                showToast('保存に失敗しました', 'error');
            }
        }

        function showMeetingForm(contactId, meetingId = null) {
            currentEditingContactId = contactId;
            currentEditingMeetingId = meetingId;
            
            const form = document.getElementById('meetingForm');
            form.reset();
            document.getElementById('taskList').innerHTML = '';
            
            if (meetingId) {
                const meeting = meetings.find(m => m.id === meetingId);
                if (meeting) {
                    form.datetime.value = meeting.datetime;
                    form.content.value = meeting.content;
                    
                    if (meeting.tasks) {
                        meeting.tasks.forEach(task => {
                            addTask(task);
                        });
                    }
                }
            } else {
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                form.datetime.value = now.toISOString().slice(0, 16);
            }
            
            showModal('meetingFormModal');
        }

        async function saveMeetingForm(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const taskInputs = document.querySelectorAll('#taskList .task-input');
            const tasks = [];
            
            taskInputs.forEach(input => {
                const text = input.querySelector('input[name="taskText"]').value;
                const due = input.querySelector('input[name="taskDue"]').value;
                if (text.trim()) {
                    tasks.push({
                        text: text.trim(),
                        due: due || null,
                        done: false
                    });
                }
            });
            
            const meeting = {
                id: currentEditingMeetingId || generateId(),
                contactId: currentEditingContactId,
                datetime: formData.get('datetime'),
                content: formData.get('content'),
                tasks: tasks,
                createdAt: currentEditingMeetingId ? 
                    meetings.find(m => m.id === currentEditingMeetingId)?.createdAt : 
                    new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (currentEditingMeetingId) {
                const index = meetings.findIndex(m => m.id === currentEditingMeetingId);
                if (index >= 0) {
                    // 既存のタスクの完了状態を保持
                    const existing = meetings[index];
                    if (existing.tasks) {
                        meeting.tasks.forEach((task, idx) => {
                            if (existing.tasks[idx] && existing.tasks[idx].text === task.text) {
                                task.done = existing.tasks[idx].done;
                            }
                        });
                    }
                    meetings[index] = meeting;
                }
            } else {
                meetings.push(meeting);
            }
            
            try {
                await saveData();
                closeModal('meetingFormModal');
                renderContactList();
                showToast('保存しました', 'success');
                
                if (currentEditingContactId === selectedContactId) {
                    showContactDetail(selectedContactId);
                }
            } catch (error) {
                showToast('保存に失敗しました', 'error');
            }
        }

        function addTask(existingTask = null) {
            const taskList = document.getElementById('taskList');
            const taskDiv = document.createElement('div');
            taskDiv.className = 'task-input';
            taskDiv.style.marginBottom = '8px';
            taskDiv.innerHTML = `
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="text" name="taskText" placeholder="タスク内容" 
                           value="${existingTask ? escapeHtml(existingTask.text) : ''}" 
                           style="flex: 1;">
                    <input type="date" name="taskDue" 
                           value="${existingTask && existingTask.due ? existingTask.due.slice(0, 10) : ''}">
                    <button type="button" class="btn-icon btn-ghost" onclick="this.parentElement.parentElement.remove()">✕</button>
                </div>
            `;
            taskList.appendChild(taskDiv);
        }

        async function toggleTask(meetingId, taskIndex) {
            const meeting = meetings.find(m => m.id === meetingId);
            if (meeting && meeting.tasks && meeting.tasks[taskIndex]) {
                meeting.tasks[taskIndex].done = !meeting.tasks[taskIndex].done;
                meeting.updatedAt = new Date().toISOString();
                
                try {
                    await saveData();
                    if (selectedContactId === meeting.contactId) {
                        showContactDetail(selectedContactId);
                    }
                    updateStats();
                } catch (error) {
                    showToast('更新に失敗しました', 'error');
                    meeting.tasks[taskIndex].done = !meeting.tasks[taskIndex].done;
                }
            }
        }

        async function deleteContact(event, contactId) {
            event.stopPropagation();
            
            if (!confirm('この連絡先を削除しますか？')) return;
            
            contacts = contacts.filter(c => c.id !== contactId);
            meetings = meetings.filter(m => m.contactId !== contactId);
            
            try {
                await saveData();
                renderContactList();
                if (selectedContactId === contactId) {
                    closeSidePanel();
                }
                showToast('削除しました', 'success');
            } catch (error) {
                showToast('削除に失敗しました', 'error');
            }
        }

        async function deleteMeeting(meetingId) {
            if (!confirm('このミーティング記録を削除しますか？')) return;
            
            meetings = meetings.filter(m => m.id !== meetingId);
            
            try {
                await saveData();
                showContactDetail(selectedContactId);
                renderContactList();
                showToast('削除しました', 'success');
            } catch (error) {
                showToast('削除に失敗しました', 'error');
            }
        }

        // ヘルパー関数
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(date) {
            const d = new Date(date);
            return `${d.getFullYear()}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')}`;
        }

        function formatDateTime(datetime) {
            const d = new Date(datetime);
            return `${formatDate(d)} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
        }

        function getLastMeetingDate(contactId) {
            const contactMeetings = meetings.filter(m => m.contactId === contactId);
            if (contactMeetings.length === 0) return null;
            
            return contactMeetings
                .map(m => new Date(m.datetime))
                .sort((a, b) => b - a)[0];
        }

        function sortContacts(contactList) {
            const sorted = [...contactList];
            
            switch (currentSortOrder) {
                case 'meeting-desc':
                    sorted.sort((a, b) => {
                        const dateA = getLastMeetingDate(a.id);
                        const dateB = getLastMeetingDate(b.id);
                        if (!dateA && !dateB) return 0;
                        if (!dateA) return 1;
                        if (!dateB) return -1;
                        return dateB - dateA;
                    });
                    break;
                case 'meeting-asc':
                    sorted.sort((a, b) => {
                        const dateA = getLastMeetingDate(a.id);
                        const dateB = getLastMeetingDate(b.id);
                        if (!dateA && !dateB) return 0;
                        if (!dateA) return 1;
                        if (!dateB) return -1;
                        return dateA - dateB;
                    });
                    break;
                case 'name-asc':
                    sorted.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
                    break;
                case 'name-desc':
                    sorted.sort((a, b) => b.name.localeCompare(a.name, 'ja'));
                    break;
            }
            
            return sorted;
        }

        function updateStats() {
            document.getElementById('contactCount').textContent = contacts.length;
            
            // 未完了タスク数
            let taskCount = 0;
            meetings.forEach(meeting => {
                if (meeting.tasks) {
                    taskCount += meeting.tasks.filter(t => !t.done).length;
                }
            });
            document.getElementById('taskCount').textContent = taskCount;
        }

        // UI操作
        function openSidePanel() {
            document.getElementById('sidePanel').classList.add('open');
            document.getElementById('mainContent').classList.add('with-sidebar');
        }

        function closeSidePanel() {
            document.getElementById('sidePanel').classList.remove('open');
            document.getElementById('mainContent').classList.remove('with-sidebar');
            selectedContactId = null;
            renderContactList();
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toast.className = `toast ${type}`;
            toastMessage.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function setViewMode(mode) {
            viewMode = mode;
            document.getElementById('viewGrid').classList.toggle('active', mode === 'grid');
            document.getElementById('viewTable').classList.toggle('active', mode === 'table');
            renderContactList();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).style.display = 'block';
        }

        function toggleDropdown(menuId) {
            const menu = document.getElementById(menuId);
            menu.classList.toggle('show');
        }

        function showContextMenu(event, contactId) {
            event.preventDefault();
            event.stopPropagation();
            
            contextMenuTarget = contactId;
            const menu = document.getElementById('contextMenu');
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            menu.classList.add('show');
        }

        function contextAction(action) {
            const menu = document.getElementById('contextMenu');
            menu.classList.remove('show');
            
            switch (action) {
                case 'edit':
                    editContact(null, contextMenuTarget);
                    break;
                case 'meeting':
                    addMeeting(null, contextMenuTarget);
                    break;
                case 'delete':
                    deleteContact({ stopPropagation: () => {} }, contextMenuTarget);
                    break;
            }
        }

        function editContact(event, contactId) {
            if (event) event.stopPropagation();
            showContactForm(contactId);
        }

        function addMeeting(event, contactId) {
            if (event) event.stopPropagation();
            showMeetingForm(contactId);
        }

        function editCurrent() {
            if (selectedContactId) {
                showContactForm(selectedContactId);
            }
        }

        function editMeeting(meetingId) {
            const meeting = meetings.find(m => m.id === meetingId);
            if (meeting) {
                showMeetingForm(meeting.contactId, meetingId);
            }
        }

        function applySorting() {
            currentSortOrder = document.getElementById('sortOrder').value;
            renderContactList();
        }

        function filterContacts() {
            renderContactList();
        }

        function toggleFilter(filterType) {
            // フィルター実装（簡略化）
            const chip = document.getElementById(`filter${filterType.charAt(0).toUpperCase() + filterType.slice(1)}`);
            chip.classList.toggle('active');
            renderContactList();
        }

        function toggleOutstandingTasks() {
            // 未完了タスクフィルター（簡略化）
            const chip = document.getElementById('filterTasks');
            chip.classList.toggle('active');
            renderContactList();
        }

        function toggleMeetingContent(meetingId) {
            const content = document.getElementById(`meeting-${meetingId}`);
            content.classList.toggle('expanded');
            event.target.textContent = content.classList.contains('expanded') ? '閉じる' : 'もっと見る';
        }

        async function syncData() {
            try {
                showToast('同期中...');
                await loadData();
                renderContactList();
                showToast('同期完了', 'success');
            } catch (error) {
                showToast('同期に失敗しました', 'error');
            }
        }

        async function exportData() {
            try {
                const exportData = {
                    version: '2.0',
                    exportDate: new Date().toISOString(),
                    contacts: contacts,
                    meetings: meetings
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `meeting_data_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showToast('エクスポート完了', 'success');
            } catch (error) {
                showToast('エクスポートに失敗しました', 'error');
            }
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const importedData = JSON.parse(text);
                
                if (!importedData.version || !importedData.contacts || !importedData.meetings) {
                    throw new Error('無効なデータ形式');
                }
                
                // データをマージ（簡略化）
                contacts = importedData.contacts;
                meetings = importedData.meetings;
                
                await saveData();
                renderContactList();
                showToast('インポート完了', 'success');
            } catch (error) {
                showToast('インポートに失敗しました', 'error');
            }
            
            event.target.value = '';
        }

        function logout() {
            if (tokenClient) {
                google.accounts.oauth2.revoke(accessToken, () => {
                    console.log('Token revoked');
                });
            }
            
            localStorage.removeItem('google_access_token');
            gapi.client.setToken(null);
            accessToken = null;
            
            window.location.reload();
        }

        function showSettings() {
            showToast('設定画面は準備中です', 'info');
        }

        function handleCredentialResponse(response) {
            console.log("ID token received");
        }

        // イベントリスナー設定
        function setupEventListeners() {
            // クリックでドロップダウンを閉じる
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.dropdown')) {
                    document.querySelectorAll('.dropdown-menu').forEach(menu => {
                        menu.classList.remove('show');
                    });
                }
                
                if (!e.target.closest('.context-menu')) {
                    document.getElementById('contextMenu').classList.remove('show');
                }
            });
            
            // モーダルの外側クリックで閉じる
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal.id);
                    }
                });
            });
        }

        // キーボードショートカット
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // ⌘K or Ctrl+K - 検索
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                    e.preventDefault();
                    document.getElementById('searchInput').focus();
                }
                
                // N - 新規連絡先（入力中でない場合）
                if (e.key === 'n' && !e.target.matches('input, textarea')) {
                    e.preventDefault();
                    showContactForm();
                }
                
                // ESC - パネルやモーダルを閉じる
                if (e.key === 'Escape') {
                    const openModal = document.querySelector('.modal.show');
                    if (openModal) {
                        closeModal(openModal.id);
                    } else if (document.getElementById('sidePanel').classList.contains('open')) {
                        closeSidePanel();
                    }
                }
            });
        }

        // データマイグレーション
        function migrateLegacyData() {
            // 旧バージョンからのデータ移行処理
            let needsSave = false;
            
            contacts.forEach(contact => {
                // タグフィールドの移行
                if (contact.types || contact.affiliations) {
                    contact.tags = [
                        ...(contact.types || []),
                        ...(contact.affiliations || [])
                    ];
                    delete contact.types;
                    delete contact.affiliations;
                    needsSave = true;
                }
                
                // メモフィールドの統合
                if (contact.strengths || contact.careerHistory || contact.cutout) {
                    contact.memo = [
                        contact.strengths && `【強み】\n${contact.strengths}`,
                        contact.careerHistory && `【経歴】\n${contact.careerHistory}`,
                        contact.cutout && `【切り出し方】\n${contact.cutout}`,
                        contact.memo
                    ].filter(Boolean).join('\n\n');
                    
                    delete contact.strengths;
                    delete contact.careerHistory;
                    delete contact.cutout;
                    needsSave = true;
                }
            });
            
            if (needsSave) {
                saveData().catch(error => console.error('マイグレーション保存エラー:', error));
            }
        }

        // セットアップウィザード（最小限）
        function showSetupWizard() {
            // 既存のセットアップロジックを維持（表示は簡略化）
            CLIENT_ID = prompt('Google Cloud ClientIDを入力してください:');
            if (CLIENT_ID) {
                localStorage.setItem('google_client_id', CLIENT_ID);
                window.location.reload();
            }
        }
    </script>
</body>
</html>