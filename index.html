<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>1to1„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É† - PlaceOn</title>
    
    <!-- 
    ===== IMPORTANT: Dropbox App Configuration =====
    
    ‚úÖ Dropbox App Key: 6u9kud7ntmkaicg
    
    ‚ö†Ô∏è REQUIRED PERMISSIONS (Must be enabled in Dropbox App Console):
    
    1. Go to: https://www.dropbox.com/developers/apps
    2. Select your app
    3. Go to "Permissions" tab
    4. Enable ALL of the following scopes:
    
       ‚úÖ files.metadata.read    - Read file and folder metadata
       ‚úÖ files.metadata.write   - Create folders
       ‚úÖ files.content.read     - Read file content
       ‚úÖ files.content.write    - Upload and modify files
       ‚úÖ sharing.write          - Create shared links
       ‚úÖ sharing.read           - Read shared links
    
    5. Click "Submit" to save changes
    
    ‚ö†Ô∏è Without these permissions, you will get 401 errors!
    
    ===== ‰øÆÊ≠£ÂÜÖÂÆπ v13.0 =====
    
    1. Âàá„ÇäÂá∫„ÅóÊñπ„Éï„Ç£„Éº„É´„Éâ„ÅÆËøΩÂä†
       - ÈÄ£Áµ°ÂÖà„Éï„Ç©„Éº„É†„Å´Â§öÊÆµ„ÉÜ„Ç≠„Çπ„ÉàÂÖ•Âäõ„ÇíËøΩÂä†
       - MarkdownÂØæÂøú„Åß„É¨„É≥„ÉÄ„É™„É≥„Ç∞
    
    2. ÈÅéÂéª„ÅÆÁµåÊ≠¥Êäò„Çä„Åü„Åü„ÅøÊ©üËÉΩ
       - 7Ë°å‰ª•‰∏ä„ÅÆÂ†¥Âêà„Å´Ëá™ÂãïÊäò„Çä„Åü„Åü„Åø
       - „ÄåÁ∂ö„Åç„ÇíË¶ã„Çã/Êäò„Çä„Åü„Åü„ÇÄ„Äç„É™„É≥„ÇØ„ÅßÂàá„ÇäÊõø„Åà
    
    3. „É¢„Éº„ÉÄ„É´ÊúÄ‰∏äÈÉ®„Çπ„ÇØ„É≠„Éº„É´
       - ÂêÑ„É¢„Éº„ÉÄ„É´Ë°®Á§∫ÊôÇ„Å´Ëá™ÂãïÁöÑ„Å´ÊúÄ‰∏äÈÉ®„Å∏„Çπ„ÇØ„É≠„Éº„É´
    
    4. Ê∑ª‰ªò„Éï„Ç°„Ç§„É´„ÅÆ„Éñ„É©„Ç¶„Ç∂Ë°®Á§∫
       - ÁîªÂÉè„ÄÅPDF„ÄÅ„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„ÅØÊñ∞Ë¶è„Çø„Éñ„ÅßÈñã„Åè
       - „Åù„ÅÆ‰ªñ„ÅÆ„Éï„Ç°„Ç§„É´„ÅØ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
    
    5. iPadÈ°îÂÜôÁúüË°®Á§∫ÂØæÁ≠ñÔºàÂº∑ÂåñÁâàÔºâ
       - crossOriginÂ±ûÊÄß„ÅÆËøΩÂä†„Å®ÂâäÈô§„Å´„Çà„Çã„É™„Éà„É©„Ç§
       - URLÂ§âÊèõ„Å´„Çà„ÇãËøΩÂä†„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
    
    6. „Çø„Çπ„ÇØÂçò‰Ωç„ÅÆÊúüÈôêÁÆ°ÁêÜ
       - ÂêÑ„Çø„Çπ„ÇØ„Åî„Å®„Å´ÂÄãÂà•„ÅÆÊúüÈôêË®≠ÂÆö
       - ÂãïÁöÑ„Å™„Çø„Çπ„ÇØÂÖ•Âäõ„Éï„Ç©„Éº„É†
    
    7. Êú™ÂÆå‰∫Ü„Çø„Çπ„ÇØ„ÅÆ„Ç§„É≥„É©„Ç§„É≥Á∑®ÈõÜ
       - „ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„ÅßÁ∑®ÈõÜÂèØËÉΩ
       - Enter‰øùÂ≠ò„ÄÅEscape„Ç≠„É£„É≥„Çª„É´
    
    8. Êó¢Â≠òÊ©üËÉΩ„ÅÆÂÆåÂÖ®‰∫íÊèõÊÄßÁ∂≠ÊåÅ
       - v12.0„Åæ„Åß„ÅÆÂÖ®Ê©üËÉΩ„ÇíÁ∂ôÊâø
    
    -->
    
    <script src="https://unpkg.com/dropbox@10.34.0/dist/Dropbox-sdk.min.js"></script>
    
    <script>
    // ‚òÖ ChromeÊã°ÂºµÊ©üËÉΩ„Ç®„É©„ÉºÂØæÁ≠ñ„ÇíÊúÄÂàù„Å´ÂÆüË°åÔºàÂº∑ÂåñÁâàÔºâ
    (function() {
        // „Åô„Åê„Å´„Ç®„É©„Éº„Éè„É≥„Éâ„É©„Éº„ÇíË®≠ÂÆö
        const suppressChromeError = function(e) {
            if (e && e.message && e.message.includes('chrome.runtime')) {
                e.preventDefault && e.preventDefault();
                e.stopPropagation && e.stopPropagation();
                e.stopImmediatePropagation && e.stopImmediatePropagation();
                return true;
            }
        };

        // „Ç∞„É≠„Éº„Éê„É´„Ç®„É©„Éº„Éè„É≥„Éâ„É©„ÉºÔºàÊúÄÂÑ™ÂÖàÔºâ
        window.addEventListener('error', suppressChromeError, true);
        window.addEventListener('unhandledrejection', function(e) {
            if (e.reason && e.reason.message && e.reason.message.includes('chrome.runtime')) {
                e.preventDefault();
                return true;
            }
        }, true);

        // ChromeÊã°ÂºµÊ©üËÉΩ„ÅÆruntime API„Çí„Ç™„Éº„Éê„Éº„É©„Ç§„Éâ
        if (typeof chrome !== 'undefined' && chrome.runtime) {
            // lastError„ÇíÂ∏∏„Å´null„Å´„Åô„Çã
            Object.defineProperty(chrome.runtime, 'lastError', {
                get: function() { return null; },
                set: function() { }
            });

            const noop = function() {};
            const safeWrapper = function(originalMethod) {
                return function(...args) {
                    try {
                        // „Ç≥„Éº„É´„Éê„ÉÉ„ÇØ„ÇíÊé¢„Åó„Å¶„É©„ÉÉ„Éó
                        const callback = args[args.length - 1];
                        if (typeof callback === 'function') {
                            args[args.length - 1] = function(...cbArgs) {
                                try {
                                    return callback.apply(this, cbArgs);
                                } catch (e) {
                                    console.warn('Chrome callback error (suppressed):', e);
                                }
                            };
                        }
                        
                        if (originalMethod) {
                            return originalMethod.apply(this, args);
                        }
                    } catch (error) {
                        console.warn('Chrome API error (suppressed):', error);
                    }
                };
            };

            // „Åô„Åπ„Å¶„ÅÆchrome.runtimeÈñ¢Êï∞„Çí„É©„ÉÉ„Éó
            if (chrome.runtime.sendMessage) {
                chrome.runtime.sendMessage = safeWrapper(chrome.runtime.sendMessage);
            }
            if (chrome.runtime.connect) {
                chrome.runtime.connect = safeWrapper(chrome.runtime.connect);
            }
            if (chrome.runtime.onMessage) {
                const originalAddListener = chrome.runtime.onMessage.addListener;
                chrome.runtime.onMessage.addListener = function(listener) {
                    const wrappedListener = function(...args) {
                        try {
                            return listener(...args);
                        } catch (error) {
                            console.warn('Chrome message listener error (suppressed):', error);
                        }
                    };
                    if (originalAddListener) {
                        return originalAddListener.call(this, wrappedListener);
                    }
                };
            }

            // ‰ªñ„ÅÆchrome API„ÇÇ„É©„ÉÉ„Éó
            ['tabs', 'storage', 'windows', 'browserAction'].forEach(api => {
                if (chrome[api] && chrome[api].query) {
                    chrome[api].query = safeWrapper(chrome[api].query);
                }
            });
        }

        // console„É°„ÇΩ„ÉÉ„Éâ„ÇÇ„É©„ÉÉ„Éó„Åó„Å¶chromeÈñ¢ÈÄ£„Ç®„É©„Éº„ÇíÊäëÂà∂
        const originalConsoleError = console.error;
        console.error = function(...args) {
            const errorString = args.join(' ');
            if (!errorString.includes('chrome.runtime')) {
                originalConsoleError.apply(console, args);
            }
        };
    })();
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, "Helvetica Neue", "Roboto", sans-serif;
            background-color: #1e1e1e;
            color: #f0f0f0;
            line-height: 1.6;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
        }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        header {
            background: #2a2a2a;
            padding: 24px;
            margin-bottom: 24px;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: stretch;
            }
        }

        h1 {
            font-size: 26px;
            color: #f0f0f0;
            font-weight: 300;
            margin: 0;
            letter-spacing: 0.5px;
        }

        .header-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* „Éú„Çø„É≥ */
        button {
            padding: 10px 18px;
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 400;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #333333;
            color: #f0f0f0;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        button:hover {
            border-color: #4c8bf5;
            box-shadow: 0 0 0 1px #4c8bf5;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #4c8bf5;
            color: white;
            border-color: #4c8bf5;
        }

        .btn-primary:hover {
            background: #5a96f7;
            box-shadow: 0 0 10px rgba(76, 139, 245, 0.3);
        }

        .btn-secondary {
            background: #333333;
            color: #f0f0f0;
            border: 1px solid #444444;
        }

        .btn-secondary:hover {
            background: #3a3a3a;
            border-color: #4c8bf5;
        }

        .btn-danger {
            background: #d93025;
            color: white;
            border-color: #d93025;
        }

        .btn-danger:hover {
            background: #e74c3c;
            box-shadow: 0 0 10px rgba(217, 48, 37, 0.3);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* Ê§úÁ¥¢„Éª„Éï„Ç£„É´„Çø„Éº */
        .search-filters {
            background: #2a2a2a;
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 24px;
            border: 1px solid #3a3a3a;
        }

        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .search-header h3 {
            font-weight: 300;
            font-size: 18px;
            color: #f0f0f0;
        }

        .sort-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sort-controls label {
            font-size: 14px;
            color: #aaaaaa;
            margin: 0;
        }

        .sort-controls select {
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid #444444;
            background: #333333;
            color: #f0f0f0;
        }

        .filter-row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group.search-group {
            flex: 2;
            min-width: 300px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 400;
            font-size: 14px;
            color: #aaaaaa;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #444444;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: #333333;
            color: #f0f0f0;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4c8bf5;
            box-shadow: 0 0 0 1px #4c8bf5;
        }

        input::placeholder {
            color: #666666;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* ÈÄ£Áµ°ÂÖà„Ç∞„É™„ÉÉ„Éâ */
        .contact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        @media (max-width: 768px) {
            .contact-grid {
                grid-template-columns: 1fr;
            }
        }

        .contact-card {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #3a3a3a;
        }

        .contact-card:hover {
            border-color: #4c8bf5;
            box-shadow: 0 0 20px rgba(76, 139, 245, 0.1);
        }

        .contact-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #333333;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            overflow: hidden;
            font-weight: 300;
            color: #aaaaaa;
            border: 1px solid #444444;
        }

        .contact-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .contact-name {
            font-size: 18px;
            font-weight: 400;
            margin-bottom: 8px;
            color: #f0f0f0;
        }

        .contact-info {
            font-size: 14px;
            color: #aaaaaa;
            margin-bottom: 4px;
        }

        .last-meeting-info {
            font-size: 13px;
            color: #4c8bf5;
            margin-top: 8px;
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
        }

        .tag {
            background: #333333;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
            color: #aaaaaa;
            font-weight: 400;
            border: 1px solid #444444;
        }

        /* „É¢„Éº„ÉÄ„É´ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: #2a2a2a;
            margin: 50px auto;
            max-width: 800px;
            border-radius: 8px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #3a3a3a;
        }

        @media (max-width: 768px) {
            .modal-content {
                margin: 20px;
                max-height: calc(100vh - 40px);
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-weight: 300;
            color: #f0f0f0;
        }

        .modal-body {
            padding: 20px;
        }

        .close-modal {
            font-size: 24px;
            cursor: pointer;
            color: #aaaaaa;
            transition: color 0.2s ease;
        }

        .close-modal:hover {
            color: #f0f0f0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        /* „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ */
        .file-drop-zone {
            border: 2px dashed #444444;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #333333;
            color: #aaaaaa;
        }

        .file-drop-zone:hover,
        .file-drop-zone.dragover {
            border-color: #4c8bf5;
            background: #2a2a2a;
            color: #f0f0f0;
        }

        .file-list {
            margin-top: 10px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #333333;
            border-radius: 4px;
            margin-bottom: 5px;
            border: 1px solid #444444;
        }

        .file-item-actions {
            display: flex;
            gap: 5px;
        }

        /* „Éü„Éº„ÉÜ„Ç£„É≥„Ç∞„Çø„Ç§„É†„É©„Ç§„É≥ */
        .meeting-timeline {
            margin-top: 30px;
        }

        .meeting-item {
            border-left: 3px solid #4c8bf5;
            padding-left: 20px;
            margin-bottom: 30px;
            position: relative;
        }

        .meeting-item::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 0;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4c8bf5;
            border: 2px solid #2a2a2a;
        }

        .meeting-date {
            font-weight: 400;
            color: #4c8bf5;
            margin-bottom: 10px;
        }

        /* Markdown „Ç≥„É≥„ÉÜ„É≥„ÉÑ */
        .markdown {
            font-family: 'system-ui', sans-serif;
            color: #f0f0f0;
            background-color: transparent;
            line-height: 1.6;
            font-size: 15px;
        }

        .markdown h1 {
            font-size: 1.8em;
            font-weight: bold;
            margin: 1em 0 0.5em;
            border-bottom: 1px solid #444;
            padding-bottom: 0.3em;
        }

        .markdown h2 {
            font-size: 1.4em;
            font-weight: bold;
            margin: 0.8em 0 0.4em;
            color: #e0e0e0;
        }

        .markdown h3 {
            font-size: 1.2em;
            font-weight: bold;
            margin: 0.6em 0 0.3em;
            color: #cccccc;
        }

        .markdown p {
            margin: 0.5em 0;
        }

        .markdown ul, .markdown ol {
            padding-left: 1.6em;
            margin: 0.5em 0;
        }

        .markdown li {
            margin-bottom: 0.4em;
        }

        .markdown strong {
            font-weight: bold;
            color: #ffffff;
        }

        .markdown a {
            color: #4c8bf5;
            text-decoration: underline;
        }

        .markdown code {
            background-color: #333;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.95em;
            color: #f9f9f9;
        }

        .markdown pre {
            background-color: #333;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 0.5em 0;
        }

        .markdown pre code {
            background-color: transparent;
            padding: 0;
            font-size: 0.9em;
        }

        .markdown blockquote {
            border-left: 3px solid #4c8bf5;
            padding-left: 1em;
            margin: 0.5em 0;
            color: #cccccc;
        }

        .markdown-content {
            line-height: 1.6;
            overflow: hidden;
            color: #f0f0f0;
        }

        .markdown-content.truncated {
            max-height: calc(1.6em * 7);
        }

        /* ÈÅéÂéª„ÅÆÁµåÊ≠¥Êäò„Çä„Åü„Åü„ÅøÁî®„Çπ„Çø„Ç§„É´ */
        .career-history-content {
            position: relative;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .career-history-content.collapsed {
            max-height: calc(1.6em * 7); /* 7Ë°åÂàÜ„ÅÆÈ´ò„Åï */
        }
        
        .career-history-toggle {
            color: #4c8bf5;
            cursor: pointer;
            font-size: 14px;
            margin-top: 8px;
            display: inline-block;
        }
        
        .career-history-toggle:hover {
            opacity: 0.8;
        }

        /* „Çø„Çπ„ÇØ„É™„Çπ„ÉàÁî®„Çπ„Çø„Ç§„É´ */
        .task-list {
            list-style: none;
            padding-left: 0;
            margin: 10px 0;
        }

        .task-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 8px;
            padding: 8px;
            background: #333333;
            border-radius: 4px;
            border: 1px solid #444444;
        }

        .task-item.completed {
            opacity: 0.6;
        }

        .task-item.completed .task-text {
            text-decoration: line-through;
            color: #888888;
        }

        .task-checkbox {
            margin-right: 10px;
            margin-top: 2px;
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .task-text {
            flex: 1;
            line-height: 1.5;
        }

        .task-text.editing {
            background: #444444;
            padding: 4px 8px;
            border-radius: 4px;
            outline: none;
            display: inline-block;
            min-width: 200px;
        }

        .task-due {
            font-size: 12px;
            color: #aaaaaa;
            margin-left: 10px;
        }

        .task-due.overdue {
            color: #d93025;
        }

        /* „Çø„Çπ„ÇØÊúüÈôêÂÖ•ÂäõÁî®„Çπ„Çø„Ç§„É´ */
        .task-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .task-input-row input[type="text"] {
            flex: 1;
        }
        
        .task-input-row input[type="datetime-local"] {
            width: auto;
            min-width: 200px;
        }
        
        .btn-add-task {
            margin-top: 10px;
        }

        /* „Åù„ÅÆ‰ªñ */
        .read-more {
            color: #4c8bf5;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            transition: opacity 0.2s ease;
        }

        .read-more:hover {
            opacity: 0.8;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4c8bf5;
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .error-notification {
            background: #d93025;
        }

        .multi-select {
            position: relative;
        }

        .multi-select-display {
            padding: 8px;
            border: 1px solid #444444;
            border-radius: 6px;
            cursor: pointer;
            min-height: 38px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            background: #333333;
            transition: border-color 0.2s ease;
        }

        .multi-select-display:hover {
            border-color: #4c8bf5;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #333333;
            border: 1px solid #444444;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .multi-select-dropdown.show {
            display: block;
        }

        .multi-select-option {
            padding: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background 0.2s ease;
        }

        .multi-select-option:hover {
            background: #3a3a3a;
        }

        .multi-select-option input {
            margin-right: 8px;
            width: auto;
        }

        .selected-tag {
            background: #4c8bf5;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
        }

        .selected-tag .remove {
            margin-left: 5px;
            cursor: pointer;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .referrer-selector {
            background: #333333;
            border: 1px solid #444444;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .referrer-option {
            padding: 8px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s ease;
        }

        .referrer-option:hover {
            background: #3a3a3a;
        }

        .referrer-option .info {
            font-size: 12px;
            color: #aaaaaa;
        }

        /* „É™„É≥„ÇØ */
        a {
            color: #4c8bf5;
            text-decoration: none;
            transition: opacity 0.2s ease;
        }

        a:hover {
            opacity: 0.8;
        }

        /* „É≠„Éº„Éá„Ç£„É≥„Ç∞ */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f0f0f0;
            border-radius: 50%;
            border-top-color: #4c8bf5;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .loading-content {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
        }

        /* Ë™çË®ºÁîªÈù¢ */
        .auth-container {
            max-width: 500px;
            margin: 100px auto;
            text-align: center;
            padding: 40px;
            background: #2a2a2a;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
        }

        .auth-container h2 {
            font-size: 24px;
            margin-bottom: 20px;
            font-weight: 300;
        }

        .auth-container p {
            color: #aaaaaa;
            margin-bottom: 30px;
        }

        /* „Çπ„ÇØ„É≠„Éº„É´„Éê„Éº */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #444444;
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555555;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Ë™çË®ºÁîªÈù¢ -->
        <div id="authContainer" class="auth-container" style="display: none;">
            <h2>1to1„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</h2>
            <p>Dropbox„Å®ÈÄ£Êê∫„Åó„Å¶„ÄÅÈÄ£Áµ°ÂÖà„Å®„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞Ë®òÈå≤„Çí„ÇØ„É©„Ç¶„Éâ„Å´‰øùÂ≠ò„Åó„Åæ„Åô„ÄÇ</p>
            <button class="btn-primary" onclick="authenticateDropbox()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                Dropbox„Å®ÈÄ£Êê∫
            </button>
        </div>

        <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <div id="mainContainer" class="container" style="display: none;">
            <header>
                <div class="header-content">
                    <h1>1to1„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</h1>
                    <div class="header-buttons">
                        <span id="connection-status" style="color: #4c8bf5; margin-right: 16px; font-size: 14px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle;">
                                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                            </svg>
                            DropboxÊé•Á∂öÊ∏à„Åø
                        </span>
                        <button class="btn-secondary" onclick="syncData()">
                            <span id="sync-status">üîÑ ÂêåÊúü</span>
                        </button>
                        <button class="btn-secondary" onclick="exportData()">üì§ „Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                        <button class="btn-secondary" onclick="document.getElementById('importInput').click()">üì• „Éá„Éº„Çø„Ç§„É≥„Éù„Éº„Éà</button>
                        <input type="file" id="importInput" accept=".json" style="display: none;" onchange="importData(event)">
                        <button class="btn-primary" onclick="showContactForm()">Êñ∞Ë¶èÈÄ£Áµ°ÂÖàÁôªÈå≤</button>
                        <button class="btn-secondary" onclick="logout()" style="margin-left: auto;">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                    </div>
                </div>
            </header>

            <div class="search-filters">
                <div class="search-header">
                    <h3>Ê§úÁ¥¢„Éª„Éï„Ç£„É´„Çø„Éº</h3>
                    <div class="sort-controls">
                        <label>‰∏¶„Å≥Êõø„Åà:</label>
                        <select id="sortOrder" onchange="applySorting()">
                            <option value="meeting-desc">ÊúÄÁµÇÊâìÂêà„ÅõÊó• (Êñ∞„Åó„ÅÑÈ†Ü)</option>
                            <option value="meeting-asc">ÊúÄÁµÇÊâìÂêà„ÅõÊó• (Âè§„ÅÑÈ†Ü)</option>
                            <option value="name-asc">ÂêçÂâç (A‚ÜíZ)</option>
                            <option value="name-desc">ÂêçÂâç (Z‚ÜíA)</option>
                            <option value="yomi-asc">„Çà„Åø („ÅÇ‚Üí„Çì)</option>
                            <option value="yomi-desc">„Çà„Åø („Çì‚Üí„ÅÇ)</option>
                        </select>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group search-group">
                        <label>„Éï„É™„Éº„ÉØ„Éº„ÉâÊ§úÁ¥¢</label>
                        <input type="text" id="searchName" placeholder="ÂêçÂâç„ÄÅ„Çà„Åø„ÄÅ‰ºöÁ§æ„ÄÅ„É°„Éº„É´„ÄÅ„Çø„Ç∞„ÄÅÂÜÖÂÆπ„Å™„Å©„ÇíÊ§úÁ¥¢..." onkeyup="filterContacts()">
                    </div>
                    <div class="filter-group">
                        <label>Á®ÆÂà•</label>
                        <select id="filterType" onchange="filterContacts()">
                            <option value="">„Åô„Åπ„Å¶</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>ÊâÄÂ±û„Éª„ÉÅ„É£„Éó„Çø„Éº</label>
                        <select id="filterAffiliation" onchange="filterContacts()">
                            <option value="">„Åô„Åπ„Å¶</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Áπã„Åå„Çä„Åü„ÅÑ‰∫∫„ÉªÊ•≠Á®Æ</label>
                        <select id="filterWantToConnect" onchange="filterContacts()">
                            <option value="">„Åô„Åπ„Å¶</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Èáë„ÅÆÂçµ</label>
                        <select id="filterGoldenEgg" onchange="filterContacts()">
                            <option value="">„Åô„Åπ„Å¶</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Á¥π‰ªãÂÖÉ</label>
                        <select id="filterReferredBy" onchange="filterContacts()">
                            <option value="">„Åô„Åπ„Å¶</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>„Ç®„É™„Ç¢</label>
                        <select id="filterArea" onchange="filterContacts()">
                            <option value="">„Åô„Åπ„Å¶</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Â±Ö‰ΩèÂú∞</label>
                        <select id="filterResidence" onchange="filterContacts()">
                            <option value="">„Åô„Åπ„Å¶</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Outstanding Actions Dashboard -->
            <div id="outstandingActions" class="search-filters" style="margin-bottom: 24px;">
                <div class="search-header">
                    <h3>Êú™ÂÆå‰∫Ü„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥</h3>
                    <button class="btn-small btn-secondary" onclick="toggleOutstandingActions()">
                        <span id="toggleActionsText">Ë°®Á§∫</span>
                    </button>
                </div>
                <div id="outstandingActionsList" style="display: none; margin-top: 20px;">
                    <!-- Outstanding actions will be rendered here -->
                </div>
            </div>

            <div id="contactGrid" class="contact-grid">
                <!-- ÈÄ£Áµ°ÂÖà„Ç´„Éº„Éâ„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
            </div>
        </div>
    </div>

    <!-- ÈÄ£Áµ°ÂÖàÁôªÈå≤/Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
    <div id="contactFormModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="contactFormTitle">Êñ∞Ë¶èÈÄ£Áµ°ÂÖàÁôªÈå≤</h2>
                <span class="close-modal" onclick="closeModal('contactFormModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="contactForm" onsubmit="saveContactForm(event)">
                    <div class="form-group">
                        <label>Ê∞èÂêç <span style="color: #d93025;">*</span></label>
                        <input type="text" name="name" required>
                    </div>

                    <div class="form-group">
                        <label>„Çà„Åø</label>
                        <input type="text" name="yomi" placeholder="„Å≤„Çâ„Åå„Å™„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ">
                    </div>

                    <div class="form-group">
                        <label>È°îÂÜôÁúü</label>
                        <div class="file-drop-zone" id="photoDropZone">
                            ÂÜôÁúü„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÔºà„ÇØ„É™„ÉÉ„ÇØ„Åæ„Åü„ÅØ„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„ÉóÔºâ
                        </div>
                        <input type="file" id="photoUpload" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
                        <div id="photoPreview"></div>
                    </div>

                    <div class="form-group">
                        <label>‰ºöÁ§æÂêç</label>
                        <input type="text" name="company">
                    </div>

                    <div class="form-group">
                        <label>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                        <input type="email" name="email">
                    </div>

                    <div class="form-group">
                        <label>ÈõªË©±Áï™Âè∑</label>
                        <input type="tel" name="phone">
                    </div>

                    <div class="form-group">
                        <label>„Éõ„Éº„É†„Éö„Éº„Ç∏</label>
                        <input type="url" name="homepage">
                    </div>

                    <div class="form-group">
                        <label>Á®ÆÂà•</label>
                        <div class="multi-select">
                            <div class="multi-select-display" onclick="toggleMultiSelect('types')">
                                <span style="color: #aaaaaa;">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>
                            </div>
                            <div id="types-dropdown" class="multi-select-dropdown"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ÊâÄÂ±û„Éª„ÉÅ„É£„Éó„Çø„Éº</label>
                        <div class="multi-select">
                            <div class="multi-select-display" onclick="toggleMultiSelect('affiliations')">
                                <span style="color: #aaaaaa;">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>
                            </div>
                            <div id="affiliations-dropdown" class="multi-select-dropdown"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Áπã„Åå„Çä„Åü„ÅÑ‰∫∫„ÉªÊ•≠Á®Æ</label>
                        <div class="multi-select">
                            <div class="multi-select-display" onclick="toggleMultiSelect('wantToConnect')">
                                <span style="color: #aaaaaa;">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>
                            </div>
                            <div id="wantToConnect-dropdown" class="multi-select-dropdown"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Èáë„ÅÆÂçµ</label>
                        <div class="multi-select">
                            <div class="multi-select-display" onclick="toggleMultiSelect('goldenEgg')">
                                <span style="color: #aaaaaa;">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>
                            </div>
                            <div id="goldenEgg-dropdown" class="multi-select-dropdown"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>„Ç®„É™„Ç¢</label>
                        <input type="text" name="area" placeholder="‰æã: Èñ¢Êù±„ÄÅÈñ¢Ë•ø„ÄÅ‰πùÂ∑û„Å™„Å©">
                    </div>

                    <div class="form-group">
                        <label>Â±Ö‰ΩèÂú∞</label>
                        <input type="text" name="residence" placeholder="‰æã: Êù±‰∫¨ÈÉΩÊ∏ØÂå∫">
                    </div>

                    <div class="form-group">
                        <label>Á¥π‰ªãÂÖÉ</label>
                        <input type="text" name="referredBy" placeholder="Á¥π‰ªãËÄÖ„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ">
                    </div>

                    <div class="form-group">
                        <label>Âº∑„Åø</label>
                        <textarea name="strengths" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label>ÈÅéÂéª„ÅÆÁµåÊ≠¥</label>
                        <textarea name="careerHistory" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Âàá„ÇäÂá∫„ÅóÊñπ</label>
                        <textarea name="cutout" rows="3" placeholder="MarkdownË®òÊ≥ï„Åå‰Ωø„Åà„Åæ„Åô"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Ê∑ª‰ªò„Éï„Ç°„Ç§„É´</label>
                        <div class="file-drop-zone" id="attachmentDropZone">
                            „Éï„Ç°„Ç§„É´„Çí„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó„Åæ„Åü„ÅØ„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈÅ∏Êäû
                        </div>
                        <input type="file" id="attachmentUpload" multiple style="display: none;">
                        <div id="existingAttachments" class="file-list"></div>
                        <div id="newAttachments" class="file-list"></div>
                    </div>

                    <div class="action-buttons">
                        <button type="submit" class="btn-primary">‰øùÂ≠ò</button>
                        <button type="button" class="btn-secondary" onclick="closeModal('contactFormModal')">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ÈÄ£Áµ°ÂÖàË©≥Á¥∞„É¢„Éº„ÉÄ„É´ -->
    <div id="contactDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ÈÄ£Áµ°ÂÖàË©≥Á¥∞</h2>
                <span class="close-modal" onclick="closeModal('contactDetailModal')">&times;</span>
            </div>
            <div id="contactDetailBody" class="modal-body">
                <!-- Ë©≥Á¥∞ÊÉÖÂ†±„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
            </div>
        </div>
    </div>

    <!-- „Éü„Éº„ÉÜ„Ç£„É≥„Ç∞Ë®òÈå≤„É¢„Éº„ÉÄ„É´ -->
    <div id="meetingFormModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="meetingFormTitle">„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞Ë®òÈå≤</h2>
                <span class="close-modal" onclick="closeModal('meetingFormModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="meetingForm" onsubmit="saveMeetingForm(event)">
                    <div class="form-group">
                        <label>Êó•ÊôÇ <span style="color: #d93025;">*</span></label>
                        <input type="datetime-local" name="datetime" required>
                    </div>

                    <div class="form-group">
                        <label>Êâì„Å°Âêà„Çè„ÅõÂÜÖÂÆπ <span style="color: #d93025;">*</span></label>
                        <textarea name="content" rows="5" required placeholder="MarkdownË®òÊ≥ï„Åå‰Ωø„Åà„Åæ„Åô"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Ê¨°Âõû„Ç¢„ÇØ„Ç∑„Éß„É≥</label>
                        <div id="taskInputContainer"></div>
                        <button type="button" class="btn-small btn-secondary btn-add-task" onclick="addTaskInput()">+ „Çø„Çπ„ÇØ„ÇíËøΩÂä†</button>
                    </div>

                    <div class="form-group">
                        <label>Ê∑ª‰ªò„Éï„Ç°„Ç§„É´</label>
                        <div class="file-drop-zone" id="meetingAttachmentDropZone">
                            „Éï„Ç°„Ç§„É´„Çí„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó„Åæ„Åü„ÅØ„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈÅ∏Êäû
                        </div>
                        <input type="file" id="meetingAttachmentUpload" multiple style="display: none;">
                        <div id="existingMeetingAttachments" class="file-list"></div>
                        <div id="newMeetingAttachments" class="file-list"></div>
                    </div>

                    <div class="action-buttons">
                        <button type="submit" class="btn-primary">‰øùÂ≠ò</button>
                        <button type="button" class="btn-secondary" onclick="closeModal('meetingFormModal')">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading"></div>
            <p style="margin-top: 20px;">Âá¶ÁêÜ‰∏≠...</p>
        </div>
    </div>

    <script>
        // ===== „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ =====
        const CLIENT_ID = '6u9kud7ntmkaicg'; // Dropbox App Key
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const DATA_PATH = '/1to1App'; // Dropbox„É´„Éº„Éà„Å´1to1App„Éï„Ç©„É´„ÉÄ„Çí‰ΩúÊàê
        
        // ÂøÖË¶Å„Å™„Çπ„Ç≥„Éº„ÉóÔºàsharing.read„ÇíËøΩÂä†Ôºâ
        const REQUIRED_SCOPES = [
            'files.metadata.read',
            'files.metadata.write', 
            'files.content.read',
            'files.content.write',
            'sharing.write',
            'sharing.read'
        ];
        
        let dropbox = null;
        let contacts = [];
        let meetings = [];
        let dropdownOptions = {
            types: [],
            affiliations: [],
            goldenEgg: [],
            wantToConnect: [],
            referredBy: []
        };
        let currentEditingContactId = null;
        let currentEditingMeetingId = null;
        let selectedFiles = [];
        let selectedMeetingFiles = [];
        let currentPhotoFile = null;
        let deletedAttachments = [];
        let deletedMeetingAttachments = [];
        let currentSortOrder = 'meeting-desc'; // „Éá„Éï„Ç©„É´„Éà„ÅØÊúÄÁµÇ„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞Êó•È†Ü
        
        // ÂÜçË™çË®º„Éï„É©„Ç∞
        let isReauthInProgress = false;
        let pendingOperationAfterAuth = null; // ÂÜçË™çË®ºÂæå„Å´ÂÆüË°å„Åô„ÇãÊìç‰Ωú„Çí‰øùÂ≠ò
        
        // ‚òÖ v12.0: DropboxÂÖ±Êúâ„É™„É≥„ÇØ„ÇíÁõ¥Êé•„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ„Å™ÂΩ¢Âºè„Å´Â§âÊèõ
        function toDirectLink(url) {
            if (!url) return url;
            
            // „Åô„Åß„Å´Áõ¥Êé•„É™„É≥„ÇØÂΩ¢Âºè„ÅÆÂ†¥Âêà„ÅØ„Åù„ÅÆ„Åæ„ÅæËøî„Åô
            if (url.includes('dl.dropboxusercontent.com')) {
                return url;
            }
            
            // www.dropbox.com „Çí dl.dropboxusercontent.com „Å´Â§âÊèõ
            return url
                .replace('www.dropbox.com', 'dl.dropboxusercontent.com')
                .replace('?dl=0', '')
                .replace('?raw=1', '');
        }
        
        // ‚òÖ v12.0: Êó¢Â≠ò„ÅÆÈ°îÂÜôÁúüURL„Çí„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥
        function migratePhotoUrls() {
            console.log('=== È°îÂÜôÁúüURL„ÅÆ„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥ÈñãÂßã ===');
            let migratedCount = 0;
            let needsSave = false;
            
            contacts.forEach(contact => {
                if (contact.photoUrl && contact.photoUrl.includes('www.dropbox.com')) {
                    const oldUrl = contact.photoUrl;
                    contact.photoUrl = toDirectLink(contact.photoUrl);
                    needsSave = true;
                    migratedCount++;
                    console.log(`‚úÖ URL„ÇíÂ§âÊèõ: ${contact.name}`);
                    console.log(`   Êóß: ${oldUrl}`);
                    console.log(`   Êñ∞: ${contact.photoUrl}`);
                }
            });
            
            if (needsSave) {
                console.log(`üìä ${migratedCount}‰ª∂„ÅÆÈ°îÂÜôÁúüURL„ÇíÂ§âÊèõ„Åó„Åæ„Åó„Åü`);
                // ÈùûÂêåÊúü„Åß„Éá„Éº„Çø„Çí‰øùÂ≠òÔºà„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Å¶„ÇÇ„Ç¢„Éó„É™„ÅØÁ∂ôÁ∂öÂãï‰ΩúÔºâ
                saveData().catch(error => {
                    console.error('„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥Âæå„ÅÆ‰øùÂ≠ò„Ç®„É©„Éº:', error);
                });
            } else {
                console.log('‚úÖ „Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„ÅåÂøÖË¶Å„Å™URL„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
            }
            
            console.log('=== „Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥ÂÆå‰∫Ü ===');
        }
        
        // ===== ÂàùÊúüÂåñ =====
        window.onload = async function() {
            try {
                console.log('=== „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñÈñãÂßã ===');
                
                // URL„Åã„Çâ„Ç¢„ÇØ„Çª„Çπ„Éà„Éº„ÇØ„É≥„ÇíÂèñÂæó
                const urlToken = getAccessTokenFromUrl();
                if (urlToken) {
                    console.log('URL„Åã„ÇâÊñ∞„Åó„ÅÑ„Éà„Éº„ÇØ„É≥„ÇíÊ§úÂá∫„Åó„Åæ„Åó„Åü');
                    
                    // ÂÜçË™çË®º„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
                    isReauthInProgress = false;
                    
                    // Âè§„ÅÑ„Éà„Éº„ÇØ„É≥„ÇíÂÆåÂÖ®„Å´ÂâäÈô§
                    localStorage.clear();
                    sessionStorage.clear();
                    
                    // Êñ∞„Åó„ÅÑ„Éà„Éº„ÇØ„É≥„Çí‰øùÂ≠ò
                    localStorage.setItem('dropbox_access_token', urlToken);
                    
                    // URL„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
                    window.history.replaceState({}, document.title, REDIRECT_URI);
                    
                    // „Éà„Éº„ÇØ„É≥„ÅåÁ¢∫ÂÆü„Å´‰øùÂ≠ò„Åï„Çå„Çã„Åæ„ÅßÂæÖÊ©ü
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // ÂàùÊúüÂåñ„ÇíÂÆüË°å
                    console.log('Êñ∞„Åó„ÅÑ„Éà„Éº„ÇØ„É≥„ÅßÂàùÊúüÂåñ„ÇíÈñãÂßã„Åó„Åæ„Åô');
                    await initializeDropbox(urlToken);
                    return;
                }
                
                // ‰øùÂ≠ò„Åï„Çå„Åü„Éà„Éº„ÇØ„É≥„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                const savedToken = localStorage.getItem('dropbox_access_token');
                
                if (savedToken) {
                    console.log('‰øùÂ≠ò„Åï„Çå„Åü„Éà„Éº„ÇØ„É≥„Çí‰ΩøÁî®„Åó„Å¶ÂàùÊúüÂåñ„Åó„Åæ„Åô');
                    await initializeDropbox(savedToken);
                } else {
                    console.log('„Éà„Éº„ÇØ„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇË™çË®ºÁîªÈù¢„ÇíË°®Á§∫„Åó„Åæ„Åô');
                    showAuthScreen();
                }
            } catch (error) {
                console.error('ÂàùÊúüÂåñ‰∏≠„ÅÆ„Ç®„É©„Éº:', error);
                showNotification('„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                
                // „Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØ„Éà„Éº„ÇØ„É≥„Çí„ÇØ„É™„Ç¢„Åó„Å¶Ë™çË®ºÁîªÈù¢„Å∏
                localStorage.removeItem('dropbox_access_token');
                sessionStorage.removeItem('dropbox_access_token');
                showAuthScreen();
            }
        };
        
        // ===== DropboxË™çË®º =====
        function authenticateDropbox() {
            // Âè§„ÅÑ„Éà„Éº„ÇØ„É≥„Çí„ÇØ„É™„Ç¢
            localStorage.removeItem('dropbox_access_token');
            sessionStorage.removeItem('dropbox_access_token');
            
            // „Çπ„Ç≥„Éº„Éó„Çí„Çπ„Éö„Éº„ÇπÂå∫Âàá„Çä„ÅßÁµêÂêà
            const scopeString = REQUIRED_SCOPES.join(' ');
            
            const authUrl = `https://www.dropbox.com/oauth2/authorize?` +
                `client_id=${CLIENT_ID}&` +
                `response_type=token&` +
                `redirect_uri=${encodeURIComponent(REDIRECT_URI)}&` +
                `scope=${encodeURIComponent(scopeString)}&` +
                `force_reapprove=true`;  // Â∏∏„Å´Êñ∞„Åó„ÅÑË™çË®º„ÇíË¶ÅÊ±Ç
                
            window.location.href = authUrl;
        }
        
        function getAccessTokenFromUrl() {
            const hash = window.location.hash;
            if (hash) {
                console.log('URL„Éè„ÉÉ„Ç∑„É•„ÇíÊ§úÂá∫');
                const params = new URLSearchParams(hash.substring(1));
                
                // Check for errors in OAuth response
                const error = params.get('error');
                if (error) {
                    console.error('OAuth error:', error);
                    const errorDescription = params.get('error_description');
                    if (errorDescription) {
                        showNotification(`Ë™çË®º„Ç®„É©„Éº: ${decodeURIComponent(errorDescription)}`, 'error');
                    } else {
                        showNotification('Ë™çË®º„Åå„Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åæ„Åó„Åü', 'error');
                    }
                    window.history.replaceState({}, document.title, REDIRECT_URI);
                    return null;
                }
                
                const token = params.get('access_token');
                if (token) {
                    // „Éà„Éº„ÇØ„É≥„ÅÆË©≥Á¥∞ÊÉÖÂ†±„Çí„É≠„Ç∞Âá∫Âäõ
                    console.log('=== „Ç¢„ÇØ„Çª„Çπ„Éà„Éº„ÇØ„É≥ÂèñÂæóÊàêÂäü ===');
                    console.log('„Éà„Éº„ÇØ„É≥Èï∑:', token.length);
                    console.log('„Éà„Éº„ÇØ„É≥„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ:', token.substring(0, 20) + '...');
                    
                    // „Çπ„Ç≥„Éº„Éó„ÇíÁ¢∫Ë™ç
                    const scope = params.get('scope');
                    console.log('‰ªò‰∏é„Åï„Çå„Åü„Çπ„Ç≥„Éº„Éó:', scope);
                    
                    // ÂøÖË¶Å„Å™„Çπ„Ç≥„Éº„Éó„Åå„Åô„Åπ„Å¶Âê´„Åæ„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
                    if (scope) {
                        // Dropbox returns scopes with + delimiter, not space
                        const grantedScopes = scope.split('+').map(s => s.trim());
                        const missingScopes = REQUIRED_SCOPES.filter(s => !grantedScopes.includes(s));
                        if (missingScopes.length > 0) {
                            console.error('‰∏çË∂≥„Åó„Å¶„ÅÑ„Çã„Çπ„Ç≥„Éº„Éó:', missingScopes);
                            showNotification('ÂøÖË¶Å„Å™Ê®©Èôê„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Ç¢„Éó„É™„ÅÆË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
                        } else {
                            console.log('‚úÖ „Åô„Åπ„Å¶„ÅÆÂøÖË¶Å„Å™„Çπ„Ç≥„Éº„Éó„Åå‰ªò‰∏é„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
                        }
                    }
                    
                    // ÊúâÂäπÊúüÈôê„ÇíÁ¢∫Ë™ç
                    const expiresIn = params.get('expires_in');
                    console.log('„Éà„Éº„ÇØ„É≥ÊúâÂäπÊúüÈôê:', expiresIn, 'Áßí');
                    
                    // „Ç¢„Ç´„Ç¶„É≥„ÉàÊÉÖÂ†±
                    const accountId = params.get('account_id');
                    const uid = params.get('uid');
                    console.log('„Ç¢„Ç´„Ç¶„É≥„ÉàID:', accountId);
                    console.log('„É¶„Éº„Ç∂„ÉºID:', uid);
                    console.log('=========================');
                }
                return token;
            }
            return null;
        }
        
        async function initializeDropbox(accessToken) {
            // ‰∫åÈáçÂàùÊúüÂåñ„ÇíÈò≤„Åê
            if (isReauthInProgress) {
                console.log('ÂÜçË™çË®º‰∏≠„ÅÆ„Åü„ÇÅ„ÄÅÂàùÊúüÂåñ„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô„ÄÇ');
                return;
            }
            
            try {
                showLoading();
                
                console.log('=== Dropbox SDKÂàùÊúüÂåñÈñãÂßã ===');
                console.log('„Éà„Éº„ÇØ„É≥Èï∑:', accessToken.length);
                
                // Dropbox SDK„ÇíÂàùÊúüÂåñÔºàfetch„ÇíÊ≠£„Åó„Åè„Éê„Ç§„É≥„ÉâÔºâ
                dropbox = new Dropbox.Dropbox({ 
                    accessToken: accessToken,
                    fetch: window.fetch.bind(window) // fetch„ÇíÊ≠£„Åó„Åèwindow„Å´„Éê„Ç§„É≥„Éâ
                });
                
                console.log('Dropbox SDK„Ç§„É≥„Çπ„Çø„É≥„Çπ‰ΩúÊàêÂÆå‰∫Ü');
                
                // ÂàùÊúüÂåñÁõ¥Âæå„ÅØÂæÖÊ©ü„Åó„Å™„ÅÑÔºà„Åô„Åê„Å´API„ÇíÂëº„Å≥Âá∫„ÅôÔºâ
                try {
                    // ÊúÄÂàù„ÅÆAPIÂëº„Å≥Âá∫„Åó„Åß„Éà„Éº„ÇØ„É≥„ÅÆÊúâÂäπÊÄß„ÇíÁ¢∫Ë™ç
                    console.log('„Éï„Ç©„É´„ÉÄÊßãÈÄ†„Çí‰ΩúÊàê‰∏≠...');
                    await createFolderStructure();
                    console.log('„Éï„Ç©„É´„ÉÄÊßãÈÄ†„ÅÆ‰ΩúÊàêÊàêÂäü - „Éà„Éº„ÇØ„É≥„ÅØÊúâÂäπ„Åß„Åô');
                } catch (error) {
                    if (error.message === 'AUTH_REQUIRED') {
                        console.log('„Éà„Éº„ÇØ„É≥„ÅåÁÑ°Âäπ„Åß„Åô„ÄÇÂÜçË™çË®º„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ');
                        hideLoading();
                        return;
                    }
                    // „Åù„ÅÆ‰ªñ„ÅÆ„Ç®„É©„Éº„ÅØÁ∂öË°åÔºà„Éï„Ç©„É´„ÉÄ„ÅåÊó¢„Å´Â≠òÂú®„Åô„ÇãÂ†¥Âêà„Å™„Å©Ôºâ
                    console.log('„Éï„Ç©„É´„ÉÄ‰ΩúÊàê„Ç®„É©„ÉºÔºàÁ∂öË°åÔºâ:', error.message);
                }
                
                // „Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
                console.log('„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...');
                await loadData();
                
                // ‚òÖ v12.0: È°îÂÜôÁúüURL„ÅÆ„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„ÇíÂÆüË°å
                migratePhotoUrls();
                
                // UIÂàùÊúüÂåñ
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                
                // „ÇΩ„Éº„ÉàÈ†Ü„ÇíË®≠ÂÆö
                document.getElementById('sortOrder').value = currentSortOrder;
                
                updateDropdownOptions();
                renderContactList();
                
                hideLoading();
                console.log('‚úÖ DropboxÂàùÊúüÂåñÂÆå‰∫Ü');
                
                // ÂÜçË™çË®ºÂÆå‰∫ÜÂæå„ÅÆÂá¶ÁêÜ„Åå„ÅÇ„Çå„Å∞ÂÆüË°å
                if (pendingOperationAfterAuth) {
                    const operation = pendingOperationAfterAuth;
                    pendingOperationAfterAuth = null;
                    setTimeout(() => {
                        operation();
                    }, 500);
                }
                
            } catch (error) {
                console.error('DropboxÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
                hideLoading();
                
                if (error.message === 'AUTH_REQUIRED' || error.message === 'REAUTH_IN_PROGRESS') {
                    // Ë™çË®º„Ç®„É©„Éº„ÅØÊó¢„Å´Âá¶ÁêÜÊ∏à„Åø„ÄÅÊó©Êúüreturn
                    return;
                } else if (error.message === 'MISSING_SCOPES') {
                    // „Çπ„Ç≥„Éº„Éó„Ç®„É©„Éº„ÅÆÂ†¥Âêà
                    showScopeErrorMessage();
                    localStorage.removeItem('dropbox_access_token');
                    sessionStorage.removeItem('dropbox_access_token');
                    showAuthScreen();
                } else if (error.status === 401) {
                    // 401„Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØÂÜçË™çË®º„Çí‰øÉ„Åô
                    console.log('401„Ç®„É©„Éº„ÇíÊ§úÂá∫„ÄÇÂÜçË™çË®º„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ');
                    localStorage.removeItem('dropbox_access_token');
                    sessionStorage.removeItem('dropbox_access_token');
                    dropbox = null;
                    showAuthScreen();
                    showNotification('Ë™çË®º„ÅÆÊúâÂäπÊúüÈôê„ÅåÂàá„Çå„Åæ„Åó„Åü„ÄÇÂÜçÂ∫¶„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
                } else {
                    // „Åù„ÅÆ‰ªñ„ÅÆ„Ç®„É©„Éº
                    showNotification('ÂàùÊúüÂåñ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
                    console.error('Ë©≥Á¥∞„Ç®„É©„Éº:', error);
                }
            }
        }
        
        // ===== Dropbox APIÂÆâÂÖ®Âëº„Å≥Âá∫„Åó„É©„ÉÉ„Éë„Éº =====
        async function callDropboxSafe(apiMethod, args, retryCount = 0) {
            const maxRetries = 1;
            
            // ÂÜçË™çË®º‰∏≠„ÅØÊñ∞„Åó„ÅÑAPIÂëº„Å≥Âá∫„Åó„Çí„Éñ„É≠„ÉÉ„ÇØ
            if (isReauthInProgress) {
                throw new Error('REAUTH_IN_PROGRESS');
            }
            
            try {
                // API„É°„ÇΩ„ÉÉ„ÉâÂëº„Å≥Âá∫„Åó
                const result = await apiMethod.apply(dropbox, args);
                return result;
            } catch (error) {
                // ‚òÖ v11.0: 409„Ç®„É©„Éº„ÅÆ„É≠„Ç∞Âá∫Âäõ„ÇíÊäëÂà∂
                if (error.status !== 409) {
                    console.error(`Dropbox API error (${apiMethod.name}):`, error);
                }
                
                // 401: Ë™çË®º„Ç®„É©„Éº
                if (error.status === 401) {
                    // ÂÜçË™çË®º„Éï„É©„Ç∞„ÇíÁ´ã„Å¶„Çã
                    if (!isReauthInProgress) {
                        isReauthInProgress = true;
                        console.log('Ë™çË®º„Ç®„É©„Éº„ÇíÊ§úÂá∫„ÄÇÂÜçË™çË®º„Éï„É≠„Éº„ÇíÈñãÂßã„Åó„Åæ„Åô„ÄÇ');
                        
                        // „Éà„Éº„ÇØ„É≥„ÇíÂÆåÂÖ®„Å´ÂâäÈô§
                        localStorage.removeItem('dropbox_access_token');
                        sessionStorage.removeItem('dropbox_access_token');
                        dropbox = null; // Dropbox„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÇÇÁÑ°ÂäπÂåñ
                        
                        // ÂÜçË™çË®º„Çí‰øÉ„Åô„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
                        showReauthModal();
                    }
                    throw new Error('AUTH_REQUIRED');
                }
                
                // 4xx: „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Ç®„É©„Éº
                if (error.status >= 400 && error.status < 500) {
                    const errorMessage = error.error?.error_summary || '„É™„ÇØ„Ç®„Çπ„Éà„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                    if (error.status !== 409) { // 409„Ç®„É©„Éº„ÅØÈÄöÁü•„Åó„Å™„ÅÑ
                        showNotification(errorMessage, 'error');
                    }
                    throw error;
                }
                
                // 5xx: „Çµ„Éº„Éê„Éº„Ç®„É©„ÉºÔºà1Âõû„Å†„Åë„É™„Éà„É©„Ç§Ôºâ
                if (error.status >= 500 && retryCount < maxRetries) {
                    console.log(`„Çµ„Éº„Éê„Éº„Ç®„É©„Éº„ÄÇ„É™„Éà„É©„Ç§„Åó„Åæ„Åô (${retryCount + 1}/${maxRetries})`);
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, retryCount) * 1000));
                    return callDropboxSafe(apiMethod, args, retryCount + 1);
                }
                
                // „Åù„ÅÆ‰ªñ„ÅÆ„Ç®„É©„Éº
                showNotification('‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
                throw error;
            }
        }
        
        // ===== ÂÜçË™çË®º„É¢„Éº„ÉÄ„É´Ë°®Á§∫ =====
        function showReauthModal() {
            // Êó¢Â≠ò„ÅÆ„É¢„Éº„ÉÄ„É´„Åå„ÅÇ„Çå„Å∞ÂâäÈô§
            const existingModal = document.getElementById('reauthModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // „É¢„Éº„ÉÄ„É´HTML‰ΩúÊàê
            const modalHtml = `
                <div id="reauthModal" class="modal" style="display: block; z-index: 5000;">
                    <div class="modal-content" style="max-width: 500px; margin-top: 100px;">
                        <div class="modal-header">
                            <h2>DropboxË™çË®º„ÅåÂ§±Âäπ„Åó„Åæ„Åó„Åü</h2>
                        </div>
                        <div class="modal-body" style="text-align: center;">
                            <p style="margin-bottom: 30px;">
                                „Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÅÆ„Åü„ÇÅ„ÄÅDropbox„Å∏„ÅÆÂÜç„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ<br>
                                ÂÜç„É≠„Ç∞„Ç§„É≥Âæå„ÄÅ‰ΩúÊ•≠„ÇíÁ∂öË°å„Åß„Åç„Åæ„Åô„ÄÇ
                            </p>
                            <button class="btn-primary" onclick="handleReauth()" style="margin-right: 10px;">
                                ÂÜç„É≠„Ç∞„Ç§„É≥„Åô„Çã
                            </button>
                            <button class="btn-secondary" onclick="cancelReauth()">
                                „Ç≠„É£„É≥„Çª„É´
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        // ===== ÂÜçË™çË®ºÂá¶ÁêÜ =====
        function handleReauth() {
            // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            const modal = document.getElementById('reauthModal');
            if (modal) modal.remove();
            
            // Ë™çË®ºÁîªÈù¢„ÇíË°®Á§∫
            showAuthScreen();
            
            // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâË™çË®º„ÇíÈñãÂßã
            setTimeout(() => {
                authenticateDropbox();
            }, 500);
        }
        
        // ===== ÂÜçË™çË®º„Ç≠„É£„É≥„Çª„É´ =====
        function cancelReauth() {
            const modal = document.getElementById('reauthModal');
            if (modal) modal.remove();
            isReauthInProgress = false;
            showAuthScreen();
        }
        
        // ===== „Çπ„Ç≥„Éº„Éó„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫ =====
        function showScopeErrorMessage() {
            const message = `
                <div style="background: #fff3cd; border: 1px solid #ffeeba; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3 style="color: #856404; margin-top: 0;">‚ö†Ô∏è Dropbox„Ç¢„Éó„É™„ÅÆË®≠ÂÆö„ÅåÂøÖË¶Å„Åß„Åô</h3>
                    <p style="color: #856404;">„Åì„ÅÆ„Ç¢„Éó„É™„Çí‰ΩøÁî®„Åô„Çã„Å´„ÅØ„ÄÅDropbox„Ç¢„Éó„É™„Å´‰ª•‰∏ã„ÅÆÊ®©Èôê„ÇíË®≠ÂÆö„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„ÅôÔºö</p>
                    <ol style="color: #856404;">
                        <li><strong>files.metadata.read</strong> - „Éï„Ç°„Ç§„É´ÊÉÖÂ†±„ÅÆË™≠„ÅøÂèñ„Çä</li>
                        <li><strong>files.metadata.write</strong> - „Éï„Ç°„Ç§„É´ÊÉÖÂ†±„ÅÆÊõ∏„ÅçËæº„Åø</li>
                        <li><strong>files.content.read</strong> - „Éï„Ç°„Ç§„É´ÂÜÖÂÆπ„ÅÆË™≠„ÅøÂèñ„Çä</li>
                        <li><strong>files.content.write</strong> - „Éï„Ç°„Ç§„É´ÂÜÖÂÆπ„ÅÆÊõ∏„ÅçËæº„Åø</li>
                        <li><strong>sharing.write</strong> - ÂÖ±Êúâ„É™„É≥„ÇØ„ÅÆ‰ΩúÊàê</li>
                        <li><strong>sharing.read</strong> - ÂÖ±Êúâ„É™„É≥„ÇØ„ÅÆË™≠„ÅøÂèñ„Çä</li>
                    </ol>
                    <p style="color: #856404;">
                        <a href="https://www.dropbox.com/developers/apps" target="_blank" style="color: #0366d6;">
                            Dropbox App Console
                        </a>
                        „Åß„Ç¢„Éó„É™„ÅÆË®≠ÂÆö„ÇíÊõ¥Êñ∞„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                    </p>
                    <p style="color: #856404; margin-bottom: 0;">
                        Ë®≠ÂÆöÂÆå‰∫ÜÂæå„ÄÅ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÄåDropbox„Å®ÈÄ£Êê∫„Äç„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                    </p>
                </div>
            `;
            
            // Ë™çË®ºÁîªÈù¢„Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøΩÂä†
            const authContainer = document.getElementById('authContainer');
            const existingAlert = authContainer.querySelector('.scope-alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            const alertDiv = document.createElement('div');
            alertDiv.className = 'scope-alert';
            alertDiv.innerHTML = message;
            authContainer.insertBefore(alertDiv, authContainer.querySelector('button'));
        }
        
        function showAuthScreen() {
            // ÂÜçË™çË®º„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
            isReauthInProgress = false;
            
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('mainContainer').style.display = 'none';
        }
        
        function logout() {
            // „Éà„Éº„ÇØ„É≥„ÇíÂâäÈô§
            localStorage.removeItem('dropbox_access_token');
            sessionStorage.removeItem('dropbox_access_token');
            
            // „Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ
            window.location.reload();
        }
        
        // ===== „Éï„Ç©„É´„ÉÄÊßãÈÄ†‰ΩúÊàê =====
        async function createFolderStructure() {
            const folders = [
                '/1to1App',
                '/1to1App/attachments'
            ];
            
            for (const folder of folders) {
                try {
                    // „Éï„Ç©„É´„ÉÄ‰ΩúÊàê„ÇíË©¶„Åø„Çã
                    await callDropboxSafe(dropbox.filesCreateFolderV2, [{ 
                        path: folder,
                        autorename: false
                    }]);
                    console.log(`‚úÖ „Éï„Ç©„É´„ÉÄ‰ΩúÊàêÊàêÂäü: ${folder}`);
                } catch (error) {
                    // 409„Ç®„É©„ÉºÔºàÊó¢Â≠òÔºâ„ÅØÊ≠£Â∏∏
                    if (error.status === 409) {
                        // ‚òÖ v11.0: 409„Ç®„É©„Éº„ÅÆ„Ç≥„É≥„ÇΩ„Éº„É´Âá∫Âäõ„ÇíÊÉÖÂ†±„É¨„Éô„É´„Å´Â§âÊõ¥
                        console.log(`‚úì „Éï„Ç©„É´„ÉÄ„ÅØÊó¢„Å´Â≠òÂú®: ${folder}`);
                    } 
                    // AUTH_REQUIRED„Ç®„É©„Éº„ÅØ‰∏ä‰Ωç„ÅßÂá¶ÁêÜ
                    else if (error.message === 'AUTH_REQUIRED') {
                        throw error;
                    }
                    // 400„Ç®„É©„ÉºÔºà„Çπ„Ç≥„Éº„Éó‰∏çË∂≥Ôºâ
                    else if (error.status === 400 && error.error?.error?.['.tag'] === 'missing_scope') {
                        console.error('„Çπ„Ç≥„Éº„Éó„Ç®„É©„Éº:', error.error);
                        throw new Error('MISSING_SCOPES');
                    }
                    // „Åù„ÅÆ‰ªñ„ÅÆ„Ç®„É©„Éº
                    else {
                        console.error(`„Éï„Ç©„É´„ÉÄ‰ΩúÊàê„Ç®„É©„Éº: ${folder}`, error);
                        throw error;
                    }
                }
            }
        }
        
        // ===== „Éá„Éº„ÇøË™≠„ÅøËæº„Åø =====
        async function loadData() {
            try {
                // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„ÉÅ„Çß„ÉÉ„ÇØ
                if (!navigator.onLine) {
                    throw new Error('„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                }
                
                // ÈÄ£Áµ°ÂÖà„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
                const contactsData = await loadJsonFile('/1to1App/contacts.json');
                contacts = contactsData || [];
                
                // „Éü„Éº„ÉÜ„Ç£„É≥„Ç∞„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
                const meetingsData = await loadJsonFile('/1to1App/meetings.json');
                meetings = meetingsData || [];
                
                // „Éá„Éº„ÇøÁßªË°åÂá¶ÁêÜ
                migrateMeetingsData();
                migrateContactsData();
                
                // „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„Ç™„Éó„Ç∑„Éß„É≥„ÇíË™≠„ÅøËæº„Åø
                const optionsData = await loadJsonFile('/1to1App/options.json');
                if (optionsData) {
                    dropdownOptions = optionsData;
                }
                
                // Á¥π‰ªãÂÖÉ„É™„É≥„ÇØ„ÇíÊõ¥Êñ∞
                updateAllReferrerLinks();
            } catch (error) {
                console.error('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                if (error.message === '„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„Åå„ÅÇ„Çä„Åæ„Åõ„Çì') {
                    showNotification('„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                } else {
                    showNotification('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
            }
        }
        
        // ÈÄ£Áµ°ÂÖà„Éá„Éº„Çø„ÅÆÁßªË°åÂá¶ÁêÜ
        function migrateContactsData() {
            let needsSave = false;
            
            contacts.forEach(contact => {
                // yomi„Éï„Ç£„Éº„É´„Éâ„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÂàùÊúüÂåñ
                if (!contact.hasOwnProperty('yomi')) {
                    contact.yomi = '';
                    needsSave = true;
                }
                // cutout„Éï„Ç£„Éº„É´„Éâ„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÂàùÊúüÂåñ
                if (!contact.hasOwnProperty('cutout')) {
                    contact.cutout = '';
                    needsSave = true;
                }
            });
            
            if (needsSave) {
                console.log('ÈÄ£Áµ°ÂÖà„Éá„Éº„Çø„Å´„Äå„Çà„Åø„Äç„ÄåÂàá„ÇäÂá∫„ÅóÊñπ„Äç„Éï„Ç£„Éº„É´„Éâ„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
            }
        }
        
        // „Éü„Éº„ÉÜ„Ç£„É≥„Ç∞„Éá„Éº„Çø„ÅÆÁßªË°åÂá¶ÁêÜ
        function migrateMeetingsData() {
            let needsSave = false;
            
            meetings.forEach(meeting => {
                // nextActionDoneTasks„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÂàùÊúüÂåñ
                if (!meeting.hasOwnProperty('nextActionDoneTasks')) {
                    meeting.nextActionDoneTasks = {};
                    needsSave = true;
                }
                
                // tasks„Éï„Ç£„Éº„É´„Éâ„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÄÅÊó¢Â≠ò„ÅÆnextAction„Åã„ÇâÂ§âÊèõ
                if (!meeting.hasOwnProperty('tasks')) {
                    meeting.tasks = [];
                    if (meeting.nextAction) {
                        const taskLines = meeting.nextAction.split('\n').filter(line => line.trim());
                        taskLines.forEach((taskText, index) => {
                            meeting.tasks.push({
                                text: taskText.trim(),
                                due: index === 0 ? meeting.nextActionDue : null,
                                done: meeting.nextActionDoneTasks && meeting.nextActionDoneTasks[index] || false
                            });
                        });
                    }
                    needsSave = true;
                }
                
                // Âè§„ÅÑnextActionDone„Éï„É©„Ç∞„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆÁßªË°å
                if (meeting.hasOwnProperty('nextActionDone') && meeting.nextActionDone && meeting.nextAction) {
                    // „Åô„Åπ„Å¶„ÅÆ„Çø„Çπ„ÇØ„ÇíÂÆå‰∫ÜÊ∏à„Åø„Å®„Åó„Å¶ÁßªË°å
                    const tasks = meeting.nextAction.split('\n').filter(task => task.trim());
                    tasks.forEach((task, index) => {
                        meeting.nextActionDoneTasks[index] = true;
                    });
                    delete meeting.nextActionDone;
                    needsSave = true;
                }
            });
            
            if (needsSave) {
                console.log('„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞„Éá„Éº„Çø„ÇíÊñ∞ÂΩ¢Âºè„Å´ÁßªË°å„Åó„Åæ„Åó„Åü');
            }
        }
        
        async function loadJsonFile(path) {
            try {
                const response = await callDropboxSafe(dropbox.filesDownload, [{ path }]);
                const blob = response.result.fileBlob;
                const text = await blob.text();
                return JSON.parse(text);
            } catch (error) {
                if (error.status === 409) {
                    // „Éï„Ç°„Ç§„É´„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà
                    console.log(`„Éï„Ç°„Ç§„É´„ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì: ${path}`);
                    return null;
                }
                if (error.message === 'AUTH_REQUIRED') {
                    throw error;
                }
                throw error;
            }
        }
        
        // ===== „Éá„Éº„Çø‰øùÂ≠ò =====
        async function saveData() {
            try {
                showLoading();
                
                // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„ÉÅ„Çß„ÉÉ„ÇØ
                if (!navigator.onLine) {
                    throw new Error('OFFLINE');
                }
                
                console.log('üìä „Éá„Éº„Çø‰øùÂ≠òÈñãÂßã...');
                
                // ÈÄ£Áµ°ÂÖà„Éá„Éº„Çø„Çí‰øùÂ≠ò
                await saveJsonFile('/1to1App/contacts.json', contacts);
                console.log('   ‚úÖ contacts.json ‰øùÂ≠òÂÆå‰∫Ü');
                
                // „Éü„Éº„ÉÜ„Ç£„É≥„Ç∞„Éá„Éº„Çø„Çí‰øùÂ≠ò
                await saveJsonFile('/1to1App/meetings.json', meetings);
                console.log('   ‚úÖ meetings.json ‰øùÂ≠òÂÆå‰∫Ü');
                
                // „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„Ç™„Éó„Ç∑„Éß„É≥„Çí‰øùÂ≠ò
                await saveJsonFile('/1to1App/options.json', dropdownOptions);
                console.log('   ‚úÖ options.json ‰øùÂ≠òÂÆå‰∫Ü');
                
                hideLoading();
                console.log('üìä „Éá„Éº„Çø‰øùÂ≠òÂÆå‰∫Ü');
            } catch (error) {
                console.error('„Éá„Éº„Çø‰øùÂ≠ò„Ç®„É©„Éº:', error);
                hideLoading();
                
                // „Ç®„É©„Éº„ÅÆÁ®ÆÈ°û„Å´Âøú„Åò„ÅüÂá¶ÁêÜ
                if (error.message === 'OFFLINE') {
                    showNotification('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
                } else if (error.message === 'AUTH_REQUIRED') {
                    // Ë™çË®º„Ç®„É©„Éº„ÅØ callDropboxSafe „ÅßÂá¶ÁêÜÊ∏à„Åø
                } else if (error.status === 507) {
                    showNotification('Dropbox„ÅÆÂÆπÈáè„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô', 'error');
                } else if (error.status === 429) {
                    showNotification('APIÂà∂Èôê„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
                } else if (!error.message || error.message !== 'AUTH_REQUIRED') {
                    showNotification('„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
                
                throw error;
            }
        }
        
        async function saveJsonFile(path, data) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            await callDropboxSafe(dropbox.filesUpload, [{
                path,
                contents: blob,
                mode: { '.tag': 'overwrite' }
            }]);
        }
        
        // ===== ÂêåÊúüÊ©üËÉΩ =====
        async function syncData() {
            try {
                document.getElementById('sync-status').textContent = 'üîÑ ÂêåÊúü‰∏≠...';
                await loadData();
                
                // ‚òÖ v12.0: ÂêåÊúüÊôÇ„Å´„ÇÇ„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„ÇíÂÆüË°å
                migratePhotoUrls();
                
                renderContactList();
                updateDropdownOptions();
                document.getElementById('sync-status').textContent = '‚úÖ ÂêåÊúüÂÆå‰∫Ü';
                setTimeout(() => {
                    document.getElementById('sync-status').textContent = 'üîÑ ÂêåÊúü';
                }, 2000);
            } catch (error) {
                console.error('ÂêåÊúü„Ç®„É©„Éº:', error);
                showNotification('ÂêåÊúü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                document.getElementById('sync-status').textContent = '‚ùå ÂêåÊúüÂ§±Êïó';
            }
        }
        
        // ===== „Éï„Ç°„Ç§„É´Âêç„ÅÆ„Çµ„Éã„Çø„Ç§„Ç∫ =====
        function sanitizeFileName(fileName) {
            // Dropbox„Åß‰ΩøÁî®„Åß„Åç„Å™„ÅÑÊñáÂ≠ó„ÇíÁΩÆÊèõ
            return fileName.replace(/[\/\\:?*<>|"]/g, '_');
        }
        
        // ‚òÖ v12.0: „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰øÆÊ≠£ÔºàtoDirectLink‰ΩøÁî®Ôºâ
        // ===== „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÔºàÊúÄÁµÇ‰øÆÊ≠£ÁâàÔºâ =====
        async function uploadFile(file, customName = null) {
            const fileName = sanitizeFileName(customName || file.name);
            const path = `/1to1App/attachments/${fileName}`;
            
            console.log(`üì§ „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÈñãÂßã: ${fileName}`);
            console.log(`   - „Éï„Ç°„Ç§„É´„Çø„Ç§„Éó: ${file.type}`);
            console.log(`   - „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
            console.log(`   - „Éë„Çπ: ${path}`);
            
            try {
                // „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØÔºà150MB‰ª•‰∏ãÔºâ
                if (file.size > 150 * 1024 * 1024) {
                    throw new Error('FILE_TOO_LARGE');
                }
                
                // „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„ÉÅ„Çß„ÉÉ„ÇØ
                if (!navigator.onLine) {
                    throw new Error('OFFLINE');
                }
                
                // „Çπ„ÉÜ„ÉÉ„Éó1: „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
                console.log('   üìù „Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠...');
                const uploadResponse = await callDropboxSafe(dropbox.filesUpload, [{
                    path,
                    contents: file,
                    mode: { '.tag': 'overwrite' },
                    autorename: true,
                    mute: false
                }]);
                
                console.log('   ‚úÖ „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊàêÂäü:', uploadResponse.result.path_display);
                
                // „Çπ„ÉÜ„ÉÉ„Éó2: ÂÖ±Êúâ„É™„É≥„ÇØ„ÅÆ‰ΩúÊàê„Åæ„Åü„ÅØÂèñÂæó
                let shareUrl;
                
                // ÂÖ±Êúâ„É™„É≥„ÇØ„Çí‰ΩúÊàêÔºà„Ç∑„É≥„Éó„É´„Å™ÊñπÊ≥ïÔºâ
                try {
                    console.log('   üîó ÂÖ±Êúâ„É™„É≥„ÇØ„Çí‰ΩúÊàê‰∏≠...');
                    const linkResponse = await callDropboxSafe(dropbox.sharingCreateSharedLinkWithSettings, [{
                        path: uploadResponse.result.path_lower,
                        settings: {
                            requested_visibility: { '.tag': 'public' },
                            audience: { '.tag': 'public' },
                            access: { '.tag': 'viewer' }
                        }
                    }]);
                    shareUrl = linkResponse.result.url;
                    console.log('   ‚úÖ ÂÖ±Êúâ„É™„É≥„ÇØ‰ΩúÊàêÊàêÂäü');
                } catch (linkError) {
                    // Êó¢Â≠ò„ÅÆ„É™„É≥„ÇØ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÂèñÂæó
                    if (linkError.status === 409) {
                        console.log('   üîó Êó¢Â≠ò„ÅÆÂÖ±Êúâ„É™„É≥„ÇØ„ÇíÂèñÂæó‰∏≠...');
                        try {
                            const existingLinks = await callDropboxSafe(dropbox.sharingListSharedLinks, [{ 
                                path: uploadResponse.result.path_lower 
                            }]);
                            if (existingLinks.result.links && existingLinks.result.links.length > 0) {
                                shareUrl = existingLinks.result.links[0].url;
                                console.log('   ‚úÖ Êó¢Â≠ò„ÅÆÂÖ±Êúâ„É™„É≥„ÇØ„Çí‰ΩøÁî®');
                            } else {
                                throw new Error('ÂÖ±Êúâ„É™„É≥„ÇØ„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                            }
                        } catch (listError) {
                            console.error('   ‚ùå Êó¢Â≠ò„É™„É≥„ÇØ„ÅÆÂèñÂæó„Ç®„É©„Éº:', listError);
                            throw listError;
                        }
                    } else {
                        throw linkError;
                    }
                }
                
                // ‚òÖ v12.0: „Åô„Åπ„Å¶„ÅÆURL„ÇíÁõ¥Êé•„Ç¢„ÇØ„Çª„ÇπÂΩ¢Âºè„Å´Â§âÊèõ
                shareUrl = toDirectLink(shareUrl);
                console.log('   üîó Áõ¥Êé•„Ç¢„ÇØ„Çª„ÇπURL:', shareUrl);
                
                console.log(`   ‚úÖ ÂÆå‰∫Ü: ${fileName}`);
                return { 
                    path: uploadResponse.result.path_display, 
                    url: shareUrl 
                };
                
            } catch (error) {
                console.error('‚ùå „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº:', error);
                
                // „Ç®„É©„Éº„ÅÆÁ®ÆÈ°û„Å´Âøú„Åò„ÅüÂá¶ÁêÜ
                if (error.message === 'FILE_TOO_LARGE') {
                    showNotification('„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÅåÂ§ß„Åç„Åô„Åé„Åæ„ÅôÔºàÊúÄÂ§ß150MBÔºâ', 'error');
                } else if (error.message === 'OFFLINE') {
                    showNotification('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'error');
                } else if (error.message === 'AUTH_REQUIRED') {
                    // Ë™çË®º„Ç®„É©„Éº„ÅØ callDropboxSafe „ÅßÂá¶ÁêÜÊ∏à„Åø
                } else if (error.status === 507) {
                    showNotification('Dropbox„ÅÆÂÆπÈáè„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô', 'error');
                } else if (error.status === 429) {
                    showNotification('APIÂà∂Èôê„Å´ÈÅî„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
                } else if (!error.message || error.message !== 'AUTH_REQUIRED') {
                    showNotification('„Éï„Ç°„Ç§„É´„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
                
                throw error;
            }
        }
        
        // ‚òÖ v11.0: È°îÂÜôÁúü„ÅÆ„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„ÉóÂØæÂøú
        // ===== È°îÂÜôÁúü„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ =====
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processPhotoFile(file);
            }
        }
        
        function processPhotoFile(file) {
            if (!file.type.startsWith('image/')) {
                showNotification('ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            currentPhotoFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('photoPreview').innerHTML = 
                    `<img src="${e.target.result}" style="max-width: 200px; margin-top: 10px; border-radius: 8px;">`;
            };
            reader.readAsDataURL(file);
        }
        
        // ===== ÈÄ£Áµ°ÂÖà‰øùÂ≠ò =====
        async function saveContactForm(event) {
            event.preventDefault();
            showLoading();
            
            const formData = new FormData(event.target);
            const contact = {
                id: currentEditingContactId || generateId(),
                name: formData.get('name'),
                yomi: formData.get('yomi'),
                company: formData.get('company'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                homepage: formData.get('homepage'),
                referredBy: formData.get('referredBy'),
                strengths: formData.get('strengths'),
                careerHistory: formData.get('careerHistory'),
                cutout: formData.get('cutout'), // Âàá„ÇäÂá∫„ÅóÊñπ„ÇíËøΩÂä†
                types: getSelectedValues('types'),
                affiliations: getSelectedValues('affiliations'),
                wantToConnect: getSelectedValues('wantToConnect'),
                goldenEgg: getSelectedValues('goldenEgg'),
                area: formData.get('area'),
                residence: formData.get('residence'),
                attachments: [],
                createdAt: currentEditingContactId ? 
                    contacts.find(c => c.id === currentEditingContactId)?.createdAt : 
                    new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Êó¢Â≠ò„ÅÆÈÄ£Áµ°ÂÖà„ÅÆÂ†¥Âêà„ÄÅÊó¢Â≠ò„Éá„Éº„Çø„Çí‰øùÊåÅ
            if (currentEditingContactId) {
                const existing = contacts.find(c => c.id === currentEditingContactId);
                if (existing) {
                    contact.photo = existing.photo;
                    contact.photoUrl = existing.photoUrl;
                    contact.attachments = existing.attachments || [];
                }
            }
            
            try {
                // È°îÂÜôÁúü„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
                if (currentPhotoFile) {
                    const timestamp = new Date().getTime();
                    const photoName = `${sanitizeFileName(contact.name)}_${timestamp}_photo.jpg`;
                    const photoResult = await uploadFile(currentPhotoFile, photoName);
                    contact.photo = photoResult.path;
                    contact.photoUrl = photoResult.url;
                }
                
                // Ê∑ª‰ªò„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
                for (const file of selectedFiles) {
                    const timestamp = new Date().getTime();
                    const fileName = `${sanitizeFileName(contact.name)}_${timestamp}_${sanitizeFileName(file.name)}`;
                    const fileResult = await uploadFile(file, fileName);
                    contact.attachments.push({
                        name: file.name,
                        path: fileResult.path,
                        url: fileResult.url,
                        uploadedAt: new Date().toISOString()
                    });
                }
                
                // ÂâäÈô§„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„ÇíÂá¶ÁêÜ
                contact.attachments = contact.attachments.filter(att => 
                    !deletedAttachments.includes(att.path)
                );
                
                // ÈÄ£Áµ°ÂÖà„Çí‰øùÂ≠ò
                const index = contacts.findIndex(c => c.id === contact.id);
                if (index >= 0) {
                    contacts[index] = contact;
                } else {
                    contacts.push(contact);
                }
                
                // Á¥π‰ªãÂÖÉ„É™„É≥„ÇØ„ÇíÊõ¥Êñ∞
                updateAllReferrerLinks();
                
                // „Éá„Éº„Çø„Çí‰øùÂ≠ò
                await saveData();
                
                // UI„ÇíÊõ¥Êñ∞
                renderContactList();
                updateDropdownOptions();
                closeModal('contactFormModal');
                resetContactForm();
                
                hideLoading();
                showNotification('ÈÄ£Áµ°ÂÖà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
            } catch (error) {
                console.error('ÈÄ£Áµ°ÂÖà‰øùÂ≠ò„Ç®„É©„Éº:', error);
                showNotification('ÈÄ£Áµ°ÂÖà„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                hideLoading();
            }
        }
        
        // ===== „Éü„Éº„ÉÜ„Ç£„É≥„Ç∞‰øùÂ≠ò =====
        async function saveMeetingForm(event) {
            event.preventDefault();
            showLoading();
            
            const formData = new FormData(event.target);
            const taskTexts = formData.getAll('taskText[]');
            const taskDues = formData.getAll('taskDue[]');
            
            // „Çø„Çπ„ÇØÈÖçÂàó„Çí‰ΩúÊàê
            const tasks = [];
            taskTexts.forEach((text, index) => {
                if (text.trim()) {
                    tasks.push({
                        text: text.trim(),
                        due: taskDues[index] || null,
                        done: false
                    });
                }
            });
            
            const meeting = {
                id: currentEditingMeetingId || generateId(),
                contactId: currentEditingContactId,
                datetime: formData.get('datetime'),
                content: formData.get('content'),
                tasks: tasks,
                attachments: [],
                createdAt: currentEditingMeetingId ? 
                    meetings.find(m => m.id === currentEditingMeetingId)?.createdAt : 
                    new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Êó¢Â≠ò„ÅÆ„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞„ÅÆÂ†¥Âêà„ÄÅÊó¢Â≠ò„Éá„Éº„Çø„Çí‰øùÊåÅ
            if (currentEditingMeetingId) {
                const existing = meetings.find(m => m.id === currentEditingMeetingId);
                if (existing) {
                    meeting.attachments = existing.attachments || [];
                    // Êó¢Â≠ò„Çø„Çπ„ÇØ„ÅÆÂÆå‰∫ÜÁä∂ÊÖã„Çí‰øùÊåÅ
                    if (existing.tasks) {
                        tasks.forEach((task, index) => {
                            if (existing.tasks[index] && existing.tasks[index].text === task.text) {
                                task.done = existing.tasks[index].done;
                            }
                        });
                    }
                }
            }
            
            try {
                // Ê∑ª‰ªò„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
                const contact = contacts.find(c => c.id === currentEditingContactId);
                for (const file of selectedMeetingFiles) {
                    const timestamp = new Date().getTime();
                    const fileName = `${sanitizeFileName(contact.name)}_meeting_${timestamp}_${sanitizeFileName(file.name)}`;
                    const fileResult = await uploadFile(file, fileName);
                    meeting.attachments.push({
                        name: file.name,
                        path: fileResult.path,
                        url: fileResult.url,
                        uploadedAt: new Date().toISOString()
                    });
                }
                
                // ÂâäÈô§„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„ÇíÂá¶ÁêÜ
                meeting.attachments = meeting.attachments.filter(att => 
                    !deletedMeetingAttachments.includes(att.path)
                );
                
                // „Éü„Éº„ÉÜ„Ç£„É≥„Ç∞„Çí‰øùÂ≠ò
                const index = meetings.findIndex(m => m.id === meeting.id);
                if (index >= 0) {
                    meetings[index] = meeting;
                } else {
                    meetings.push(meeting);
                }
                
                // „Éá„Éº„Çø„Çí‰øùÂ≠ò
                await saveData();
                
                // UI„ÇíÊõ¥Êñ∞
                closeModal('meetingFormModal');
                showContactDetail(currentEditingContactId);
                renderContactList();
                
                hideLoading();
                showNotification('„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞Ë®òÈå≤„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
            } catch (error) {
                console.error('„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞‰øùÂ≠ò„Ç®„É©„Éº:', error);
                showNotification('„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞Ë®òÈå≤„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                hideLoading();
            }
        }
        
        // ===== ÈÄ£Áµ°ÂÖàÂâäÈô§ =====
        async function deleteContact(contactId) {
            if (!confirm('„Åì„ÅÆÈÄ£Áµ°ÂÖà„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü\nÈñ¢ÈÄ£„Åô„Çã„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞Ë®òÈå≤„ÇÇÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ')) {
                return;
            }
            
            showLoading();
            
            try {
                // Èñ¢ÈÄ£„Åô„Çã„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞„ÇíÂâäÈô§
                meetings = meetings.filter(m => m.contactId !== contactId);
                
                // ÈÄ£Áµ°ÂÖà„ÇíÂâäÈô§
                contacts = contacts.filter(c => c.id !== contactId);
                
                // „Éá„Éº„Çø„Çí‰øùÂ≠ò
                await saveData();
                
                // UI„ÇíÊõ¥Êñ∞
                renderContactList();
                updateDropdownOptions();
                closeModal('contactDetailModal');
                
                hideLoading();
                showNotification('ÈÄ£Áµ°ÂÖà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
            } catch (error) {
                console.error('ÈÄ£Áµ°ÂÖàÂâäÈô§„Ç®„É©„Éº:', error);
                showNotification('ÈÄ£Áµ°ÂÖà„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                hideLoading();
            }
        }
        
        // ===== „Éü„Éº„ÉÜ„Ç£„É≥„Ç∞ÂâäÈô§ =====
        async function deleteMeeting(meetingId) {
            if (!confirm('„Åì„ÅÆ„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞Ë®òÈå≤„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
                return;
            }
            
            showLoading();
            
            try {
                // „Éü„Éº„ÉÜ„Ç£„É≥„Ç∞„ÇíÂâäÈô§
                meetings = meetings.filter(m => m.id !== meetingId);
                
                // „Éá„Éº„Çø„Çí‰øùÂ≠ò
                await saveData();
                
                // UI„ÇíÊõ¥Êñ∞
                showContactDetail(currentEditingContactId);
                renderContactList();
                
                hideLoading();
                showNotification('„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞Ë®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
            } catch (error) {
                console.error('„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞ÂâäÈô§„Ç®„É©„Éº:', error);
                showNotification('„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞Ë®òÈå≤„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                hideLoading();
            }
        }
        
        // ===== UIÈñ¢Êï∞ =====
        function showContactForm(contactId = null) {
            // Ë©≥Á¥∞„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            closeModal('contactDetailModal');
            
            currentEditingContactId = contactId;
            resetContactForm();
            
            if (contactId) {
                const contact = contacts.find(c => c.id === contactId);
                if (contact) {
                    document.getElementById('contactFormTitle').textContent = 'ÈÄ£Áµ°ÂÖàÁ∑®ÈõÜ';
                    const form = document.getElementById('contactForm');
                    form.name.value = contact.name || '';
                    form.yomi.value = contact.yomi || '';
                    form.company.value = contact.company || '';
                    form.email.value = contact.email || '';
                    form.phone.value = contact.phone || '';
                    form.homepage.value = contact.homepage || '';
                    form.referredBy.value = contact.referredBy || '';
                    form.strengths.value = contact.strengths || '';
                    form.careerHistory.value = contact.careerHistory || '';
                    form.cutout.value = contact.cutout || ''; // Âàá„ÇäÂá∫„ÅóÊñπ„ÇíËøΩÂä†
                    form.area.value = contact.area || '';
                    form.residence.value = contact.residence || '';
                    
                    // È°îÂÜôÁúü„Éó„É¨„Éì„É•„Éº
                    if (contact.photoUrl) {
                        document.getElementById('photoPreview').innerHTML = 
                            `<img src="${contact.photoUrl}" style="max-width: 200px; margin-top: 10px; border-radius: 8px;" crossorigin="anonymous" onerror="handleImageError(this, '${escapeHtml(contact.name)}')">`;
                    }
                    
                    // „Éû„É´„ÉÅ„Çª„É¨„ÇØ„ÉàË®≠ÂÆö
                    setSelectedValues('types', contact.types || []);
                    setSelectedValues('affiliations', contact.affiliations || []);
                    setSelectedValues('wantToConnect', contact.wantToConnect || []);
                    setSelectedValues('goldenEgg', contact.goldenEgg || []);
                    
                    // Êó¢Â≠ò„ÅÆÊ∑ª‰ªò„Éï„Ç°„Ç§„É´
                    displayExistingAttachments(contact.attachments || []);
                }
            } else {
                document.getElementById('contactFormTitle').textContent = 'Êñ∞Ë¶èÈÄ£Áµ°ÂÖàÁôªÈå≤';
            }
            
            setupMultiSelect();
            document.getElementById('contactFormModal').style.display = 'block';
            // „É¢„Éº„ÉÄ„É´„ÇíÊúÄ‰∏äÈÉ®„Å´„Çπ„ÇØ„É≠„Éº„É´
            document.querySelector('#contactFormModal .modal-content').scrollTop = 0;
        }
        
        function showContactDetail(contactId) {
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) return;
            
            const contactMeetings = meetings.filter(m => m.contactId === contactId)
                .sort((a, b) => new Date(b.datetime) - new Date(a.datetime));
            
            let html = `
                <div style="margin-bottom: 20px;">
                    ${contact.photoUrl ? 
                        `<div class="contact-photo" style="width: 120px; height: 120px; margin-bottom: 20px;">
                            <img src="${contact.photoUrl}" alt="${contact.name}" crossorigin="anonymous" onerror="handleImageError(this, '${escapeHtml(contact.name)}')">
                        </div>` : ''}
                    <h3 style="font-size: 24px; margin-bottom: 10px;">${escapeHtml(contact.name)}</h3>
                    ${contact.yomi ? `<p style="color: #aaaaaa; margin-bottom: 10px;">„Çà„Åø: ${escapeHtml(contact.yomi)}</p>` : ''}
                    ${contact.company ? `<p style="color: #aaaaaa; margin-bottom: 20px;">${escapeHtml(contact.company)}</p>` : ''}
                </div>
                
                <table style="width: 100%; margin-bottom: 20px;">
                    ${contact.email ? `<tr><td style="padding: 8px 0; color: #aaaaaa;">„É°„Éº„É´:</td><td style="padding: 8px 0;">${escapeHtml(contact.email)}</td></tr>` : ''}
                    ${contact.phone ? `<tr><td style="padding: 8px 0; color: #aaaaaa;">ÈõªË©±:</td><td style="padding: 8px 0;">${escapeHtml(contact.phone)}</td></tr>` : ''}
                    ${contact.homepage ? `<tr><td style="padding: 8px 0; color: #aaaaaa;">HP:</td><td style="padding: 8px 0;"><a href="${escapeHtml(contact.homepage)}" target="_blank">${escapeHtml(contact.homepage)}</a></td></tr>` : ''}
                    ${contact.area ? `
                        <tr><td style="padding: 8px 0; color: #aaaaaa;">„Ç®„É™„Ç¢:</td><td style="padding: 8px 0;">${escapeHtml(contact.area)}</td></tr>
                    ` : ''}
                    
                    ${contact.residence ? `
                        <tr><td style="padding: 8px 0; color: #aaaaaa;">Â±Ö‰ΩèÂú∞:</td><td style="padding: 8px 0;">${escapeHtml(contact.residence)}</td></tr>
                    ` : ''}
                    ${contact.referredBy ? `<tr><td style="padding: 8px 0; color: #aaaaaa;">Á¥π‰ªãÂÖÉ:</td><td style="padding: 8px 0;">${getReferrerDisplay(contact)}</td></tr>` : ''}
                </table>
                
                ${contact.types && contact.types.length > 0 ? `
                    <div style="margin-bottom: 15px;">
                        <strong>Á®ÆÂà•:</strong> ${contact.types.map(t => `<span class="tag">${escapeHtml(t)}</span>`).join(' ')}
                    </div>
                ` : ''}
                
                ${contact.affiliations && contact.affiliations.length > 0 ? `
                    <div style="margin-bottom: 15px;">
                        <strong>ÊâÄÂ±û„Éª„ÉÅ„É£„Éó„Çø„Éº:</strong> ${contact.affiliations.map(a => `<span class="tag">${escapeHtml(a)}</span>`).join(' ')}
                    </div>
                ` : ''}
                
                ${contact.wantToConnect && contact.wantToConnect.length > 0 ? `
                    <div style="margin-bottom: 15px;">
                        <strong>Áπã„Åå„Çä„Åü„ÅÑ‰∫∫„ÉªÊ•≠Á®Æ:</strong> ${contact.wantToConnect.map(w => `<span class="tag">${escapeHtml(w)}</span>`).join(' ')}
                    </div>
                ` : ''}
                
                ${contact.goldenEgg && contact.goldenEgg.length > 0 ? `
                    <div style="margin-bottom: 15px;">
                        <strong>Èáë„ÅÆÂçµ:</strong> ${contact.goldenEgg.map(g => `<span class="tag">${escapeHtml(g)}</span>`).join(' ')}
                    </div>
                ` : ''}
                
                ${contact.strengths ? `
                    <div style="margin-bottom: 15px;">
                        <strong>Âº∑„Åø:</strong>
                        <div class="markdown">${renderMarkdown(contact.strengths)}</div>
                    </div>
                ` : ''}
                
                ${contact.careerHistory ? `
                    <div style="margin-bottom: 15px;">
                        <strong>ÈÅéÂéª„ÅÆÁµåÊ≠¥:</strong>
                        <div class="career-history-wrapper">
                            <div class="markdown career-history-content ${contact.careerHistory.split('\n').length > 7 ? 'collapsed' : ''}" id="career-${contact.id}">
                                ${renderMarkdown(contact.careerHistory)}
                            </div>
                            ${contact.careerHistory.split('\n').length > 7 ? `
                                <a href="#" class="career-history-toggle" onclick="toggleCareerHistory('${contact.id}'); return false;">Á∂ö„Åç„ÇíË¶ã„Çã</a>
                            ` : ''}
                        </div>
                    </div>
                ` : ''}
                
                ${contact.cutout ? `
                    <div style="margin-bottom: 15px;">
                        <strong>Âàá„ÇäÂá∫„ÅóÊñπ:</strong>
                        <div class="markdown">${renderMarkdown(contact.cutout)}</div>
                    </div>
                ` : ''}
                
                ${contact.attachments && contact.attachments.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <strong>Ê∑ª‰ªò„Éï„Ç°„Ç§„É´:</strong>
                        <div class="file-list" style="margin-top: 10px;">
                            ${contact.attachments.map(att => `
                                <div class="file-item">
                                    <span>${escapeHtml(att.name)}</span>
                                    <a href="#" onclick="openFile('${att.url}', '${escapeHtml(att.name)}'); return false;" class="btn-small btn-secondary">Èñã„Åè</a>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div class="action-buttons">
                    <button class="btn-primary" onclick="showContactForm('${contact.id}')">Á∑®ÈõÜ</button>
                    <button class="btn-secondary" onclick="showMeetingForm('${contact.id}')">„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞Ë®òÈå≤ËøΩÂä†</button>
                    <button class="btn-danger" onclick="deleteContact('${contact.id}')">ÂâäÈô§</button>
                </div>
                
                <div class="meeting-timeline">
                    <h3 style="margin-bottom: 20px;">„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞Â±•Ê≠¥</h3>
                    ${contactMeetings.length > 0 ? 
                        contactMeetings.map(meeting => `
                            <div class="meeting-item">
                                <div class="meeting-date">${formatDateTime(meeting.datetime)}</div>
                                <div class="markdown-content ${meeting.content.length > 500 ? 'truncated' : ''}" id="content-${meeting.id}">
                                    ${renderMarkdown(meeting.content)}
                                </div>
                                ${meeting.content.length > 500 ? `
                                    <a href="#" class="read-more" onclick="toggleContent('${meeting.id}'); return false;">Á∂ö„Åç„ÇíË™≠„ÇÄ</a>
                                ` : ''}
                                ${meeting.tasks && meeting.tasks.length > 0 ? `
                                    <div style="margin-top: 10px;">
                                        <strong>Ê¨°Âõû„Ç¢„ÇØ„Ç∑„Éß„É≥:</strong>
                                        ${renderTaskListNew(meeting)}
                                    </div>
                                ` : ''}
                                ${meeting.attachments && meeting.attachments.length > 0 ? `
                                    <div style="margin-top: 10px;">
                                        <strong>Ê∑ª‰ªò„Éï„Ç°„Ç§„É´:</strong>
                                        ${meeting.attachments.map(att => `
                                            <a href="#" onclick="openFile('${att.url}', '${escapeHtml(att.name)}'); return false;" style="margin-left: 10px;">${escapeHtml(att.name)}</a>
                                        `).join('')}
                                    </div>
                                ` : ''}
                                <div style="margin-top: 10px;">
                                    <button class="btn-small btn-secondary" onclick="editMeeting('${meeting.id}')">Á∑®ÈõÜ</button>
                                    <button class="btn-small btn-danger" onclick="deleteMeeting('${meeting.id}')">ÂâäÈô§</button>
                                </div>
                            </div>
                        `).join('') : 
                        '<p style="color: #aaaaaa;">„Åæ„Å†„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>'
                    }
                </div>
            `;
            
            currentEditingContactId = contactId;
            document.getElementById('contactDetailBody').innerHTML = html;
            document.getElementById('contactDetailModal').style.display = 'block';
            // „É¢„Éº„ÉÄ„É´„ÇíÊúÄ‰∏äÈÉ®„Å´„Çπ„ÇØ„É≠„Éº„É´
            document.querySelector('#contactDetailModal .modal-content').scrollTop = 0;
        }
        
        // ÈÅéÂéª„ÅÆÁµåÊ≠¥„ÅÆÊäò„Çä„Åü„Åü„ÅøÂàá„ÇäÊõø„Åà
        function toggleCareerHistory(contactId) {
            const content = document.getElementById(`career-${contactId}`);
            const link = event.target;
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                link.textContent = 'Êäò„Çä„Åü„Åü„ÇÄ';
            } else {
                content.classList.add('collapsed');
                link.textContent = 'Á∂ö„Åç„ÇíË¶ã„Çã';
            }
        }
        
        // „Éï„Ç°„Ç§„É´„ÇíÈñã„ÅèÈñ¢Êï∞
        function openFile(url, filename) {
            const extension = filename.split('.').pop().toLowerCase();
            const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'];
            const pdfExtensions = ['pdf'];
            const textExtensions = ['txt', 'md', 'csv', 'log'];
            
            if (imageExtensions.includes(extension) || pdfExtensions.includes(extension) || textExtensions.includes(extension)) {
                // „Éñ„É©„Ç¶„Ç∂„ÅßÈñã„Åè
                window.open(url, '_blank');
            } else {
                // „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.target = '_blank';
                a.click();
            }
        }
        
        // Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ„É™„Çπ„ÉàË°®Á§∫Èñ¢Êï∞
        function renderTaskListNew(meeting) {
            if (!meeting.tasks || meeting.tasks.length === 0) return '';
            
            return `
                <ul class="task-list">
                    ${meeting.tasks.map((task, index) => {
                        const isOverdue = task.due && new Date(task.due) < new Date();
                        return `
                            <li class="task-item ${task.done ? 'completed' : ''}">
                                <input type="checkbox" 
                                       class="task-checkbox"
                                       ${task.done ? 'checked' : ''}
                                       onchange="toggleTaskCompleteNew('${meeting.id}', ${index})">
                                <span class="task-text" 
                                      ondblclick="startTaskEdit('${meeting.id}', ${index})"
                                      id="task-${meeting.id}-${index}">${escapeHtml(task.text)}</span>
                                ${task.due ? 
                                    `<span class="task-due ${isOverdue && !task.done ? 'overdue' : ''}">
                                        ${formatDateTime(task.due)}${isOverdue && !task.done ? ' (ÊúüÈôêÂàá„Çå)' : ''}
                                    </span>` : 
                                    ''}
                            </li>
                        `;
                    }).join('')}
                </ul>
            `;
        }
        
        // „Çø„Çπ„ÇØÁ∑®ÈõÜÈñãÂßãÈñ¢Êï∞
        function startTaskEdit(meetingId, taskIndex) {
            const meeting = meetings.find(m => m.id === meetingId);
            if (!meeting || !meeting.tasks[taskIndex] || meeting.tasks[taskIndex].done) return;
            
            const taskElement = document.getElementById(`task-${meetingId}-${taskIndex}`);
            taskElement.contentEditable = true;
            taskElement.classList.add('editing');
            taskElement.focus();
            
            // „ÉÜ„Ç≠„Çπ„ÉàÂÖ®‰Ωì„ÇíÈÅ∏Êäû
            const range = document.createRange();
            range.selectNodeContents(taskElement);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            // „Ç®„É≥„Çø„Éº„Ç≠„Éº„Åß‰øùÂ≠ò„ÄÅESC„Åß„Ç≠„É£„É≥„Çª„É´
            taskElement.onkeydown = async function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    await saveTaskEdit(meetingId, taskIndex, taskElement.textContent.trim());
                } else if (e.key === 'Escape') {
                    cancelTaskEdit(meetingId, taskIndex);
                }
            };
            
            // „Éï„Ç©„Éº„Ç´„Çπ„ÅåÂ§ñ„Çå„Åü„Çâ‰øùÂ≠ò
            taskElement.onblur = async function() {
                await saveTaskEdit(meetingId, taskIndex, taskElement.textContent.trim());
            };
        }
        
        // „Çø„Çπ„ÇØÁ∑®ÈõÜ‰øùÂ≠òÈñ¢Êï∞
        async function saveTaskEdit(meetingId, taskIndex, newText) {
            const meeting = meetings.find(m => m.id === meetingId);
            if (!meeting || !meeting.tasks[taskIndex]) return;
            
            if (newText && newText !== meeting.tasks[taskIndex].text) {
                meeting.tasks[taskIndex].text = newText;
                meeting.updatedAt = new Date().toISOString();
                
                try {
                    await saveData();
                    showNotification('„Çø„Çπ„ÇØ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
                    // Ë©≥Á¥∞„Éì„É•„Éº„ÇíÊõ¥Êñ∞
                    if (currentEditingContactId === meeting.contactId) {
                        showContactDetail(meeting.contactId);
                    }
                    renderOutstandingActions();
                } catch (error) {
                    showNotification('„Çø„Çπ„ÇØ„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                }
            } else {
                cancelTaskEdit(meetingId, taskIndex);
            }
        }
        
        // „Çø„Çπ„ÇØÁ∑®ÈõÜ„Ç≠„É£„É≥„Çª„É´Èñ¢Êï∞
        function cancelTaskEdit(meetingId, taskIndex) {
            const meeting = meetings.find(m => m.id === meetingId);
            if (!meeting || !meeting.tasks[taskIndex]) return;
            
            const taskElement = document.getElementById(`task-${meetingId}-${taskIndex}`);
            taskElement.contentEditable = false;
            taskElement.classList.remove('editing');
            taskElement.textContent = meeting.tasks[taskIndex].text;
            taskElement.onkeydown = null;
            taskElement.onblur = null;
        }
        
        // Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØÂÆå‰∫Ü„Éà„Ç∞„É´Èñ¢Êï∞
        async function toggleTaskCompleteNew(meetingId, taskIndex) {
            const meeting = meetings.find(m => m.id === meetingId);
            if (!meeting || !meeting.tasks[taskIndex]) return;
            
            meeting.tasks[taskIndex].done = !meeting.tasks[taskIndex].done;
            meeting.updatedAt = new Date().toISOString();
            
            try {
                await saveData();
                renderOutstandingActions();
                // Ë©≥Á¥∞„Éì„É•„Éº„ÇíÊõ¥Êñ∞
                if (currentEditingContactId === meeting.contactId) {
                    showContactDetail(meeting.contactId);
                }
                renderContactList();
                showNotification('„Çø„Çπ„ÇØ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
            } catch (error) {
                // „Ç®„É©„ÉºÊôÇ„ÅØÂÖÉ„Å´Êàª„Åô
                meeting.tasks[taskIndex].done = !meeting.tasks[taskIndex].done;
                showNotification('Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }
        
        function showMeetingForm(contactId, meetingId = null) {
            currentEditingContactId = contactId;
            currentEditingMeetingId = meetingId;
            resetMeetingForm();
            
            const contact = contacts.find(c => c.id === contactId);
            document.getElementById('meetingFormTitle').textContent = 
                `${contact.name}„Åï„Çì„Å®„ÅÆ„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞Ë®òÈå≤${meetingId ? 'Á∑®ÈõÜ' : ''}`;
            
            if (meetingId) {
                const meeting = meetings.find(m => m.id === meetingId);
                if (meeting) {
                    const form = document.getElementById('meetingForm');
                    form.datetime.value = meeting.datetime;
                    form.content.value = meeting.content || '';
                    
                    // „Çø„Çπ„ÇØ„É™„Çπ„Éà„ÇíË°®Á§∫
                    if (meeting.tasks && meeting.tasks.length > 0) {
                        displayTaskInputs(meeting.tasks);
                    } else if (meeting.nextAction) {
                        // ÊóßÂΩ¢Âºè„Åã„Çâ„ÅÆÁßªË°å
                        const tasks = meeting.nextAction.split('\n').filter(line => line.trim()).map((text, index) => ({
                            text: text.trim(),
                            due: index === 0 ? meeting.nextActionDue : null,
                            done: false
                        }));
                        displayTaskInputs(tasks);
                    }
                    
                    // Êó¢Â≠ò„ÅÆÊ∑ª‰ªò„Éï„Ç°„Ç§„É´
                    displayExistingMeetingAttachments(meeting.attachments || []);
                }
            } else {
                // Êñ∞Ë¶è„ÅÆÂ†¥Âêà„ÅØÁèæÂú®ÊôÇÂàª„ÇíË®≠ÂÆö
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('meetingForm').datetime.value = now.toISOString().slice(0, 16);
                // Á©∫„ÅÆ„Çø„Çπ„ÇØÂÖ•Âäõ„Çí1„Å§Ë°®Á§∫
                displayTaskInputs([]);
            }
            
            document.getElementById('meetingFormModal').style.display = 'block';
            // „É¢„Éº„ÉÄ„É´„ÇíÊúÄ‰∏äÈÉ®„Å´„Çπ„ÇØ„É≠„Éº„É´
            document.querySelector('#meetingFormModal .modal-content').scrollTop = 0;
        }
        
        // „Çø„Çπ„ÇØÂÖ•Âäõ„Éï„Ç£„Éº„É´„ÉâË°®Á§∫Èñ¢Êï∞
        function displayTaskInputs(tasks = []) {
            const container = document.getElementById('taskInputContainer');
            container.innerHTML = tasks.map((task, index) => `
                <div class="task-input-row">
                    <input type="text" name="taskText[]" value="${escapeHtml(task.text)}" placeholder="„Çø„Çπ„ÇØÂÜÖÂÆπ">
                    <input type="datetime-local" name="taskDue[]" value="${task.due ? task.due.slice(0, 16) : ''}" placeholder="ÊúüÈôê">
                    <button type="button" class="btn-small btn-danger" onclick="removeTaskInput(this)">ÂâäÈô§</button>
                </div>
            `).join('');
            
            // „Çø„Çπ„ÇØ„Åå0ÂÄã„ÅÆÂ†¥Âêà„ÅØ1„Å§ËøΩÂä†
            if (tasks.length === 0) {
                addTaskInput();
            }
        }
        
        // „Çø„Çπ„ÇØÂÖ•ÂäõËøΩÂä†Èñ¢Êï∞
        function addTaskInput() {
            const container = document.getElementById('taskInputContainer');
            const newRow = document.createElement('div');
            newRow.className = 'task-input-row';
            newRow.innerHTML = `
                <input type="text" name="taskText[]" placeholder="„Çø„Çπ„ÇØÂÜÖÂÆπ">
                <input type="datetime-local" name="taskDue[]" placeholder="ÊúüÈôê">
                <button type="button" class="btn-small btn-danger" onclick="removeTaskInput(this)">ÂâäÈô§</button>
            `;
            container.appendChild(newRow);
        }
        
        // „Çø„Çπ„ÇØÂÖ•ÂäõÂâäÈô§Èñ¢Êï∞
        function removeTaskInput(button) {
            button.closest('.task-input-row').remove();
        }
        
        function editMeeting(meetingId) {
            const meeting = meetings.find(m => m.id === meetingId);
            if (meeting) {
                showMeetingForm(meeting.contactId, meetingId);
            }
        }
        
        // ===== Ê§úÁ¥¢„Éª„Éï„Ç£„É´„Çø„Éº„Éª„ÇΩ„Éº„Éà =====
        function filterContacts() {
            const searchText = document.getElementById('searchName').value.toLowerCase();
            const typeFilter = document.getElementById('filterType').value;
            const affiliationFilter = document.getElementById('filterAffiliation').value;
            const wantToConnectFilter = document.getElementById('filterWantToConnect').value;
            const goldenEggFilter = document.getElementById('filterGoldenEgg').value;
            const referredByFilter = document.getElementById('filterReferredBy').value;
            const areaFilter = document.getElementById('filterArea').value;
            const residenceFilter = document.getElementById('filterResidence').value;

            renderContactList(contact => {
                // „Éï„É™„Éº„ÉØ„Éº„ÉâÊ§úÁ¥¢
                if (searchText) {
                    const searchableText = [
                        contact.name,
                        contact.yomi,
                        contact.company,
                        contact.email,
                        contact.phone,
                        contact.homepage,
                        contact.strengths,
                        contact.referredBy,
                        contact.careerHistory,
                        contact.cutout,
                        contact.area,
                        contact.residence,
                        ...(contact.types || []),
                        ...(contact.affiliations || []),
                        ...(contact.goldenEgg || []),
                        ...(contact.wantToConnect || [])
                    ].filter(Boolean).join(' ').toLowerCase();
                    
                    // Èñ¢ÈÄ£„Åô„Çã„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞„ÅÆÂÜÖÂÆπ„ÇÇÊ§úÁ¥¢ÂØæË±°„Å´Âê´„ÇÅ„Çã
                    const contactMeetings = meetings.filter(m => m.contactId === contact.id);
                    const meetingText = contactMeetings.map(m => {
                        const taskTexts = m.tasks ? m.tasks.map(t => t.text).join(' ') : '';
                        return [m.content, taskTexts].filter(Boolean).join(' ');
                    }).join(' ').toLowerCase();
                    
                    const fullText = searchableText + ' ' + meetingText;
                    
                    if (!fullText.includes(searchText)) return false;
                }
                
                // ÂÄãÂà•„Éï„Ç£„É´„Çø„Éº
                if (typeFilter && !(contact.types || []).includes(typeFilter)) return false;
                if (affiliationFilter && !(contact.affiliations || []).includes(affiliationFilter)) return false;
                if (wantToConnectFilter && !(contact.wantToConnect || []).includes(wantToConnectFilter)) return false;
                if (goldenEggFilter && !(contact.goldenEgg || []).includes(goldenEggFilter)) return false;
                if (referredByFilter && contact.referredBy !== referredByFilter) return false;
                if (areaFilter && contact.area !== areaFilter) return false;
                if (residenceFilter && contact.residence !== residenceFilter) return false;
                
                return true;
            });
        }
        
        function applySorting() {
            currentSortOrder = document.getElementById('sortOrder').value;
            renderContactList();
        }
        
        function getLastMeetingDate(contactId) {
            const contactMeetings = meetings.filter(m => m.contactId === contactId);
            if (contactMeetings.length === 0) return null;
            
            return contactMeetings
                .map(m => new Date(m.datetime))
                .sort((a, b) => b - a)[0];
        }
        
        function sortContacts(contactList) {
            const sorted = [...contactList];
            
            switch (currentSortOrder) {
                case 'meeting-desc':
                    sorted.sort((a, b) => {
                        const dateA = getLastMeetingDate(a.id);
                        const dateB = getLastMeetingDate(b.id);
                        if (!dateA && !dateB) return 0;
                        if (!dateA) return 1;
                        if (!dateB) return -1;
                        return dateB - dateA;
                    });
                    break;
                case 'meeting-asc':
                    sorted.sort((a, b) => {
                        const dateA = getLastMeetingDate(a.id);
                        const dateB = getLastMeetingDate(b.id);
                        if (!dateA && !dateB) return 0;
                        if (!dateA) return 1;
                        if (!dateB) return -1;
                        return dateA - dateB;
                    });
                    break;
                case 'name-asc':
                    sorted.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
                    break;
                case 'name-desc':
                    sorted.sort((a, b) => b.name.localeCompare(a.name, 'ja'));
                    break;
                case 'yomi-asc':
                    sorted.sort((a, b) => {
                        const yomiA = a.yomi || a.name;
                        const yomiB = b.yomi || b.name;
                        return yomiA.localeCompare(yomiB, 'ja');
                    });
                    break;
                case 'yomi-desc':
                    sorted.sort((a, b) => {
                        const yomiA = a.yomi || a.name;
                        const yomiB = b.yomi || b.name;
                        return yomiB.localeCompare(yomiA, 'ja');
                    });
                    break;
            }
            
            return sorted;
        }
        
        // ===== Êú™ÂÆå‰∫Ü„Ç¢„ÇØ„Ç∑„Éß„É≥ÁÆ°ÁêÜ =====
        function toggleOutstandingActions() {
            const list = document.getElementById('outstandingActionsList');
            const toggleText = document.getElementById('toggleActionsText');
            
            if (list.style.display === 'none') {
                list.style.display = 'block';
                toggleText.textContent = 'ÈùûË°®Á§∫';
                renderOutstandingActions();
            } else {
                list.style.display = 'none';
                toggleText.textContent = 'Ë°®Á§∫';
            }
        }
        
        // Êú™ÂÆå‰∫Ü„Ç¢„ÇØ„Ç∑„Éß„É≥„ÅÆ„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        function renderOutstandingActions() {
            const outstandingTasks = [];
            
            // „Åô„Åπ„Å¶„ÅÆ„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞„Åã„ÇâÊú™ÂÆå‰∫Ü„Çø„Çπ„ÇØ„ÇíÂèéÈõÜ
            meetings.forEach(meeting => {
                if (meeting.tasks && meeting.tasks.length > 0) {
                    meeting.tasks.forEach((task, index) => {
                        if (!task.done) {
                            const contact = contacts.find(c => c.id === meeting.contactId);
                            outstandingTasks.push({
                                meeting: meeting,
                                contact: contact,
                                task: task,
                                taskIndex: index,
                                isOverdue: task.due && new Date(task.due) < new Date()
                            });
                        }
                    });
                }
            });
            
            // ÊúüÈôê„Åß„ÇΩ„Éº„Éà
            outstandingTasks.sort((a, b) => {
                if (a.task.due && b.task.due) {
                    return new Date(a.task.due) - new Date(b.task.due);
                }
                if (a.task.due) return -1;
                if (b.task.due) return 1;
                return new Date(b.meeting.createdAt) - new Date(a.meeting.createdAt);
            });
            
            const container = document.getElementById('outstandingActionsList');
            
            if (outstandingTasks.length === 0) {
                container.innerHTML = '<p style="color: #aaaaaa;">Êú™ÂÆå‰∫Ü„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>';
                return;
            }
            
            const html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid #444;">
                            <th style="text-align: left; padding: 8px;">ÈÄ£Áµ°ÂÖà</th>
                            <th style="text-align: left; padding: 8px;">„Ç¢„ÇØ„Ç∑„Éß„É≥ÂÜÖÂÆπ</th>
                            <th style="text-align: left; padding: 8px;">ÊúüÈôê</th>
                            <th style="text-align: center; padding: 8px;">ÂÆå‰∫Ü</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${outstandingTasks.map(item => `
                            <tr>
                                <td style="padding: 8px;">
                                    <a href="#" onclick="showContactDetail('${item.contact.id}'); return false;">
                                        ${escapeHtml(item.contact.name)}
                                    </a>
                                </td>
                                <td style="padding: 8px; max-width: 400px;">
                                    <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                                         ondblclick="startTaskEdit('${item.meeting.id}', ${item.taskIndex})"
                                         id="task-${item.meeting.id}-${item.taskIndex}">
                                        ${escapeHtml(item.task.text)}
                                    </div>
                                </td>
                                <td style="padding: 8px; ${item.isOverdue ? 'color: #d93025;' : ''}">
                                    ${item.task.due ? formatDateTime(item.task.due) : '-'}
                                </td>
                                <td style="padding: 8px; text-align: center;">
                                    <input type="checkbox" 
                                           onchange="toggleTaskCompleteNew('${item.meeting.id}', ${item.taskIndex})"
                                           style="cursor: pointer; width: 18px; height: 18px;">
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        // Êú™ÂÆå‰∫Ü„Çø„Çπ„ÇØÊï∞„ÇíË®àÁÆó
        function getOutstandingTaskCount() {
            let count = 0;
            meetings.forEach(meeting => {
                if (meeting.tasks && meeting.tasks.length > 0) {
                    meeting.tasks.forEach(task => {
                        if (!task.done) {
                            count++;
                        }
                    });
                }
            });
            return count;
        }
        
        // ===== „É¨„É≥„ÉÄ„É™„É≥„Ç∞ =====
        function renderContactList(filterFunc = null) {
            const grid = document.getElementById('contactGrid');
            let filteredContacts = filterFunc ? contacts.filter(filterFunc) : contacts;
            
            // „ÇΩ„Éº„ÉàÈÅ©Áî®
            filteredContacts = sortContacts(filteredContacts);
            
            // Update outstanding actions count
            const outstandingCount = getOutstandingTaskCount();
            const actionsHeader = document.querySelector('#outstandingActions h3');
            if (actionsHeader) {
                actionsHeader.textContent = `Êú™ÂÆå‰∫Ü„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥${outstandingCount > 0 ? ' (' + outstandingCount + ')' : ''}`;
            }
            
            grid.innerHTML = filteredContacts.map(contact => {
                const lastMeetingDate = getLastMeetingDate(contact.id);
                const lastMeetingText = lastMeetingDate ? 
                    `ÊúÄÁµÇÊâìÂêà„Åõ: ${formatDate(lastMeetingDate)}` : 
                    '„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞Êú™ÂÆüÊñΩ';
                
                if (contact.photoUrl) {
                    console.log(`ÈÄ£Áµ°ÂÖà„Ç´„Éº„ÉâÁîªÂÉèURL (${contact.name}):`, contact.photoUrl);
                }
                
                return `
                    <div class="contact-card" onclick="showContactDetail('${contact.id}')">
                        <div class="contact-photo">
                            ${contact.photoUrl ? 
                                `<img src="${contact.photoUrl}" alt="${contact.name}" crossorigin="anonymous" onerror="handleImageError(this, '${escapeHtml(contact.name)}')">` : 
                                `<span style="font-size: 32px;">${contact.name.charAt(0)}</span>`
                            }
                        </div>
                        <div class="contact-name">${escapeHtml(contact.name)}</div>
                        ${contact.yomi ? `<div class="contact-info" style="font-size: 12px; color: #888;">Ôºà${escapeHtml(contact.yomi)}Ôºâ</div>` : ''}
                        ${contact.company ? `<div class="contact-info">‰ºöÁ§æ: ${escapeHtml(contact.company)}</div>` : ''}
                        ${contact.email ? `<div class="contact-info">üìß ${escapeHtml(contact.email)}</div>` : ''}
                        ${contact.phone ? `<div class="contact-info">üì± ${escapeHtml(contact.phone)}</div>` : ''}
                        ${contact.homepage ? `<div class="contact-info">üåê ${escapeHtml(contact.homepage)}</div>` : ''}
                        <div class="last-meeting-info">${lastMeetingText}</div>
                        <div class="tags">
                            ${(contact.types || []).map(type => `<span class="tag">${escapeHtml(type)}</span>`).join('')}
                            ${(contact.affiliations || []).map(aff => `<span class="tag">${escapeHtml(aff)}</span>`).join('')}
                            ${contact.referredBy ? `<span class="tag">Á¥π‰ªã: ${escapeHtml(contact.referredBy)}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ÁîªÂÉè„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
        function handleImageError(img, contactName) {
            console.error('ÁîªÂÉèË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', {
                url: img.src,
                name: contactName,
                error: 'ÁîªÂÉè„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'
            });
            
            // crossOrigin„ÇíÂâäÈô§„Åó„Å¶ÂÜçË©¶Ë°å
            if (img.hasAttribute('crossorigin')) {
                img.removeAttribute('crossorigin');
                const originalSrc = img.src;
                img.src = '';
                setTimeout(() => {
                    img.src = originalSrc;
                    img.onerror = () => {
                        // 2ÂõûÁõÆ„ÇÇÂ§±Êïó„Åó„Åü„Çâwww.dropbox.comÂΩ¢Âºè„ÅÆURL„Å†„Å£„ÅüÂ†¥Âêà„ÅØÂ§âÊèõ„ÇíË©¶„Åø„Çã
                        if (img.src.includes('www.dropbox.com')) {
                            const newUrl = toDirectLink(img.src);
                            console.log('URLÂ§âÊèõ„ÇíË©¶Ë°å:', newUrl);
                            img.src = newUrl;
                            
                            // 3ÂõûÁõÆ„ÅÆ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„ÅüÂ†¥Âêà„ÅØ„Ç§„Éã„Ç∑„É£„É´Ë°®Á§∫„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                            img.onerror = () => {
                                const parentDiv = img.parentElement;
                                parentDiv.innerHTML = `<span style="font-size: ${parentDiv.style.width === '120px' ? '48px' : '32px'};">${contactName.charAt(0)}</span>`;
                            };
                        } else {
                            // „Åô„Åß„Å´Â§âÊèõÊ∏à„Åø„ÅÆÂ†¥Âêà„ÅØ„Ç§„Éã„Ç∑„É£„É´Ë°®Á§∫
                            const parentDiv = img.parentElement;
                            parentDiv.innerHTML = `<span style="font-size: ${parentDiv.style.width === '120px' ? '48px' : '32px'};">${contactName.charAt(0)}</span>`;
                        }
                    };
                }, 100);
            } else {
                // crossOrigin„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÁõ¥Êé•„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                const parentDiv = img.parentElement;
                parentDiv.innerHTML = `<span style="font-size: ${parentDiv.style.width === '120px' ? '48px' : '32px'};">${contactName.charAt(0)}</span>`;
            }
        }
        
        // ===== Á¥π‰ªãÂÖÉ„É™„É≥„ÇØ =====
        function updateAllReferrerLinks() {
            for (const contact of contacts) {
                if (contact.referredBy) {
                    const referrers = contacts.filter(c => c.name === contact.referredBy && c.id !== contact.id);
                    
                    // „É™„É≥„ÇØÊÉÖÂ†±„Çí„É™„Çª„ÉÉ„Éà
                    delete contact.referredById;
                    delete contact.referredByIds;
                    
                    if (referrers.length === 1) {
                        contact.referredById = referrers[0].id;
                    } else if (referrers.length > 1) {
                        contact.referredByIds = referrers.map(r => r.id);
                    }
                }
            }
        }
        
        function getReferrerDisplay(contact) {
            if (contact.referredById) {
                const referrer = contacts.find(c => c.id === contact.referredById);
                if (referrer) {
                    return `<a href="#" onclick="showContactDetail('${referrer.id}'); return false;">${escapeHtml(referrer.name)}</a>`;
                }
            } else if (contact.referredByIds && contact.referredByIds.length > 0) {
                return `<span>${escapeHtml(contact.referredBy)} <small style="color: #d93025;">(Á¥π‰ªãÂÖÉ„ÅåË§áÊï∞„ÅÇ„Çä„Åæ„Åô)</small></span>`;
            }
            return escapeHtml(contact.referredBy);
        }
        
        // ===== „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞ =====
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDate(date) {
            const d = new Date(date);
            return `${d.getFullYear()}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')}`;
        }
        
        function formatDateTime(datetime) {
            const d = new Date(datetime);
            return `${formatDate(d)} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type === 'error' ? 'error-notification' : ''}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function toggleContent(meetingId) {
            const content = document.getElementById(`content-${meetingId}`);
            const link = event.target;
            
            if (content.classList.contains('truncated')) {
                content.classList.remove('truncated');
                link.textContent = 'Êäò„Çä„Åü„Åü„ÇÄ';
            } else {
                content.classList.add('truncated');
                link.textContent = 'Á∂ö„Åç„ÇíË™≠„ÇÄ';
            }
        }
        
        // ===== Markdown„É¨„É≥„ÉÄ„É™„É≥„Ç∞ =====
        function renderMarkdown(text) {
            if (!text) return '';
            
            // HTML „Ç®„Çπ„Ç±„Éº„ÉóÂá¶ÁêÜ
            const escapeHtml = (str) => {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            };
            
            // „Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØ„Çí‰∏ÄÊôÇÁöÑ„Å´ÁΩÆÊèõ
            const codeBlocks = [];
            let processedText = text.replace(/```([\s\S]*?)```/g, (match, code) => {
                codeBlocks.push(`<pre><code>${escapeHtml(code.trim())}</code></pre>`);
                return `__CODEBLOCK_${codeBlocks.length - 1}__`;
            });
            
            // „Ç§„É≥„É©„Ç§„É≥„Ç≥„Éº„Éâ„ÇíÂá¶ÁêÜ
            processedText = processedText.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Ë¶ãÂá∫„Åó
            processedText = processedText.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            processedText = processedText.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            processedText = processedText.replace(/^# (.+)$/gm, '<h1>$1</h1>');
            
            // Â§™Â≠ó
            processedText = processedText.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            
            // „É™„É≥„ÇØ
            processedText = processedText.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            // „É™„Çπ„ÉàÔºàÈ†ÜÂ∫è„Å™„ÅóÔºâ
            processedText = processedText.replace(/^- (.+)$/gm, '<li>$1</li>');
            processedText = processedText.replace(/(<li>.*<\/li>)/s, (match) => {
                const items = match.split('\n').filter(item => item.trim());
                return '<ul>' + items.join('\n') + '</ul>';
            });
            
            // „É™„Çπ„ÉàÔºàÈ†ÜÂ∫è„ÅÇ„ÇäÔºâ
            processedText = processedText.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
            
            // ÂºïÁî®
            processedText = processedText.replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>');
            
            // Ê∞¥Âπ≥Á∑ö
            processedText = processedText.replace(/^---$/gm, '<hr>');
            
            // ÊÆµËêΩ
            processedText = processedText.split('\n\n').map(para => {
                if (para.trim() && !para.startsWith('<')) {
                    return `<p>${para.trim()}</p>`;
                }
                return para;
            }).join('\n');
            
            // „Ç≥„Éº„Éâ„Éñ„É≠„ÉÉ„ÇØ„ÇíÂæ©ÂÖÉ
            codeBlocks.forEach((code, index) => {
                processedText = processedText.replace(`__CODEBLOCK_${index}__`, code);
            });
            
            return processedText;
        }
        
        // ===== „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„Ç™„Éó„Ç∑„Éß„É≥ÁÆ°ÁêÜ =====
        function updateDropdownOptions() {
            updateSelectOptions('filterType', dropdownOptions.types);
            updateSelectOptions('filterAffiliation', dropdownOptions.affiliations);
            updateSelectOptions('filterWantToConnect', dropdownOptions.wantToConnect);
            updateSelectOptions('filterGoldenEgg', dropdownOptions.goldenEgg);
            
            // Á¥π‰ªãÂÖÉ„Éï„Ç£„É´„Çø„Éº
            const referrers = [...new Set(contacts.map(c => c.referredBy).filter(Boolean))];
            updateSelectOptions('filterReferredBy', referrers);
            
            // „Ç®„É™„Ç¢„Éï„Ç£„É´„Çø„Éº
            const areas = [...new Set(contacts.map(c => c.area).filter(Boolean))];
            updateSelectOptions('filterArea', areas);
            
            // Â±Ö‰ΩèÂú∞„Éï„Ç£„É´„Çø„Éº
            const residences = [...new Set(contacts.map(c => c.residence).filter(Boolean))];
            updateSelectOptions('filterResidence', residences);
        }
        
        function updateSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            select.innerHTML = '<option value="">„Åô„Åπ„Å¶</option>';
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
            select.value = currentValue;
        }
        
        // ===== „Éû„É´„ÉÅ„Çª„É¨„ÇØ„Éà =====
        function setupMultiSelect() {
            ['types', 'affiliations', 'wantToConnect', 'goldenEgg'].forEach(field => {
                updateMultiSelectOptions(field, dropdownOptions[field]);
            });
        }
        
        function updateMultiSelectOptions(field, options) {
            const dropdown = document.getElementById(`${field}-dropdown`);
            const selectedValues = getSelectedValues(field);
            
            dropdown.innerHTML = options.map(option => `
                <div class="multi-select-option" onclick="toggleOption('${field}', '${escapeHtml(option)}')">
                    <input type="checkbox" ${selectedValues.includes(option) ? 'checked' : ''}>
                    <span>${escapeHtml(option)}</span>
                </div>
            `).join('') + `
                <div class="multi-select-option" onclick="addNewOption('${field}')">
                    <span style="color: #4c8bf5;">+ Êñ∞„Åó„ÅÑÈ†ÖÁõÆ„ÇíËøΩÂä†</span>
                </div>
            `;
        }
        
        function toggleMultiSelect(field) {
            const dropdown = document.getElementById(`${field}-dropdown`);
            const allDropdowns = document.querySelectorAll('.multi-select-dropdown');
            
            allDropdowns.forEach(d => {
                if (d !== dropdown) d.classList.remove('show');
            });
            
            dropdown.classList.toggle('show');
        }
        
        function toggleOption(field, value) {
            const display = event.target.closest('.multi-select').querySelector('.multi-select-display');
            const checkbox = event.target.querySelector('input[type="checkbox"]');
            
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
            }
            
            updateMultiSelectDisplay(field);
        }
        
        function getSelectedValues(field) {
            const checkboxes = document.querySelectorAll(`#${field}-dropdown input[type="checkbox"]:checked`);
            return Array.from(checkboxes).map(cb => cb.parentElement.querySelector('span').textContent);
        }
        
        function setSelectedValues(field, values) {
            const checkboxes = document.querySelectorAll(`#${field}-dropdown input[type="checkbox"]`);
            checkboxes.forEach(cb => {
                const value = cb.parentElement.querySelector('span').textContent;
                cb.checked = values.includes(value);
            });
            updateMultiSelectDisplay(field);
        }
        
        function updateMultiSelectDisplay(field) {
            const display = document.querySelector(`#${field}-dropdown`).previousElementSibling;
            const selected = getSelectedValues(field);
            
            if (selected.length === 0) {
                display.innerHTML = '<span style="color: #aaaaaa;">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>';
            } else {
                display.innerHTML = selected.map(value => 
                    `<span class="selected-tag">${escapeHtml(value)}<span class="remove" onclick="removeSelectedValue('${field}', '${escapeHtml(value)}')">&times;</span></span>`
                ).join('');
            }
        }
        
        function removeSelectedValue(field, value) {
            event.stopPropagation();
            const checkbox = Array.from(document.querySelectorAll(`#${field}-dropdown input[type="checkbox"]`))
                .find(cb => cb.parentElement.querySelector('span').textContent === value);
            if (checkbox) {
                checkbox.checked = false;
                updateMultiSelectDisplay(field);
            }
        }
        
        async function addNewOption(field) {
            event.stopPropagation();
            const newValue = prompt('Êñ∞„Åó„ÅÑÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
            if (newValue && newValue.trim()) {
                const trimmedValue = newValue.trim();
                if (!dropdownOptions[field].includes(trimmedValue)) {
                    dropdownOptions[field].push(trimmedValue);
                    dropdownOptions[field].sort();
                    updateMultiSelectOptions(field, dropdownOptions[field]);
                    updateDropdownOptions();
                    await saveData();
                }
            }
        }
        
        // ===== „Éï„Ç°„Ç§„É´„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó =====
        function setupFileDragDrop() {
            // È°îÂÜôÁúü„ÅÆ„Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó
            const photoZone = document.getElementById('photoDropZone');
            const photoInput = document.getElementById('photoUpload');
            
            photoZone.addEventListener('click', () => photoInput.click());
            photoZone.addEventListener('dragover', handleDragOver);
            photoZone.addEventListener('dragleave', handleDragLeave);
            photoZone.addEventListener('drop', (e) => handlePhotoDrop(e));
            
            // ÈÄ£Áµ°ÂÖà„ÅÆÊ∑ª‰ªò„Éï„Ç°„Ç§„É´
            const attachmentZone = document.getElementById('attachmentDropZone');
            const attachmentInput = document.getElementById('attachmentUpload');
            
            attachmentZone.addEventListener('click', () => attachmentInput.click());
            attachmentZone.addEventListener('dragover', handleDragOver);
            attachmentZone.addEventListener('dragleave', handleDragLeave);
            attachmentZone.addEventListener('drop', (e) => handleDrop(e, 'contact'));
            attachmentInput.addEventListener('change', (e) => handleFileSelect(e, 'contact'));
            
            // „Éü„Éº„ÉÜ„Ç£„É≥„Ç∞„ÅÆÊ∑ª‰ªò„Éï„Ç°„Ç§„É´
            const meetingZone = document.getElementById('meetingAttachmentDropZone');
            const meetingInput = document.getElementById('meetingAttachmentUpload');
            
            meetingZone.addEventListener('click', () => meetingInput.click());
            meetingZone.addEventListener('dragover', handleDragOver);
            meetingZone.addEventListener('dragleave', handleDragLeave);
            meetingZone.addEventListener('drop', (e) => handleDrop(e, 'meeting'));
            meetingInput.addEventListener('change', (e) => handleFileSelect(e, 'meeting'));
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }
        
        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }
        
        // È°îÂÜôÁúüÂ∞ÇÁî®„ÅÆ„Éâ„É≠„ÉÉ„Éó„Éè„É≥„Éâ„É©
        function handlePhotoDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                processPhotoFile(files[0]);
            }
        }
        
        function handleDrop(e, type) {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files);
            if (type === 'contact') {
                selectedFiles.push(...files);
                displayNewAttachments();
            } else {
                selectedMeetingFiles.push(...files);
                displayNewMeetingAttachments();
            }
        }
        
        function handleFileSelect(e, type) {
            const files = Array.from(e.target.files);
            if (type === 'contact') {
                selectedFiles.push(...files);
                displayNewAttachments();
            } else {
                selectedMeetingFiles.push(...files);
                displayNewMeetingAttachments();
            }
        }
        
        function displayExistingAttachments(attachments) {
            const container = document.getElementById('existingAttachments');
            container.innerHTML = attachments.map(att => `
                <div class="file-item">
                    <span>${escapeHtml(att.name)}</span>
                    <div class="file-item-actions">
                        <a href="#" onclick="openFile('${att.url}', '${escapeHtml(att.name)}'); return false;" class="btn-small btn-secondary">Èñã„Åè</a>
                        <button type="button" class="btn-small btn-danger" onclick="markAttachmentForDeletion('${att.path}')">ÂâäÈô§</button>
                    </div>
                </div>
            `).join('');
        }
        
        function displayExistingMeetingAttachments(attachments) {
            const container = document.getElementById('existingMeetingAttachments');
            container.innerHTML = attachments.map(att => `
                <div class="file-item">
                    <span>${escapeHtml(att.name)}</span>
                    <div class="file-item-actions">
                        <a href="#" onclick="openFile('${att.url}', '${escapeHtml(att.name)}'); return false;" class="btn-small btn-secondary">Èñã„Åè</a>
                        <button type="button" class="btn-small btn-danger" onclick="markMeetingAttachmentForDeletion('${att.path}')">ÂâäÈô§</button>
                    </div>
                </div>
            `).join('');
        }
        
        function displayNewAttachments() {
            const container = document.getElementById('newAttachments');
            container.innerHTML = selectedFiles.map((file, index) => `
                <div class="file-item">
                    <span>${escapeHtml(file.name)}</span>
                    <button type="button" class="btn-small btn-danger" onclick="removeNewAttachment(${index})">ÂâäÈô§</button>
                </div>
            `).join('');
        }
        
        function displayNewMeetingAttachments() {
            const container = document.getElementById('newMeetingAttachments');
            container.innerHTML = selectedMeetingFiles.map((file, index) => `
                <div class="file-item">
                    <span>${escapeHtml(file.name)}</span>
                    <button type="button" class="btn-small btn-danger" onclick="removeNewMeetingAttachment(${index})">ÂâäÈô§</button>
                </div>
            `).join('');
        }
        
        function markAttachmentForDeletion(path) {
            deletedAttachments.push(path);
            event.target.closest('.file-item').style.display = 'none';
        }
        
        function markMeetingAttachmentForDeletion(path) {
            deletedMeetingAttachments.push(path);
            event.target.closest('.file-item').style.display = 'none';
        }
        
        function removeNewAttachment(index) {
            selectedFiles.splice(index, 1);
            displayNewAttachments();
        }
        
        function removeNewMeetingAttachment(index) {
            selectedMeetingFiles.splice(index, 1);
            displayNewMeetingAttachments();
        }
        
        // ===== „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà =====
        function resetContactForm() {
            document.getElementById('contactForm').reset();
            document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('existingAttachments').innerHTML = '';
            document.getElementById('newAttachments').innerHTML = '';
            currentPhotoFile = null;
            selectedFiles = [];
            deletedAttachments = [];
            
            // „Éû„É´„ÉÅ„Çª„É¨„ÇØ„Éà„Çí„É™„Çª„ÉÉ„Éà
            ['types', 'affiliations', 'wantToConnect', 'goldenEgg'].forEach(field => {
                const display = document.querySelector(`#${field}-dropdown`).previousElementSibling;
                display.innerHTML = '<span style="color: #aaaaaa;">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>';
            });
        }
        
        function resetMeetingForm() {
            document.getElementById('meetingForm').reset();
            document.getElementById('existingMeetingAttachments').innerHTML = '';
            document.getElementById('newMeetingAttachments').innerHTML = '';
            document.getElementById('taskInputContainer').innerHTML = '';
            selectedMeetingFiles = [];
            deletedMeetingAttachments = [];
        }
        
        // ===== „Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà/„Ç§„É≥„Éù„Éº„Éà =====
        async function exportData() {
            try {
                const exportData = {
                    version: '2.4',  // v13.0: „Éê„Éº„Ç∏„Éß„É≥Êõ¥Êñ∞
                    exportDate: new Date().toISOString(),
                    contacts: contacts,
                    meetings: meetings,
                    dropdownOptions: dropdownOptions
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `meeting_data_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showNotification('„Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü');
            } catch (error) {
                console.error('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Ç®„É©„Éº:', error);
                showNotification('„Éá„Éº„Çø„ÅÆ„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
            }
        }
        
        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                showLoading();
                const text = await file.text();
                const importedData = JSON.parse(text);
                
                // „Éê„Éº„Ç∏„Éß„É≥„ÉÅ„Çß„ÉÉ„ÇØ
                if (!importedData.version || !importedData.contacts || !importedData.meetings) {
                    throw new Error('ÁÑ°Âäπ„Å™„Éá„Éº„ÇøÂΩ¢Âºè„Åß„Åô');
                }
                
                // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ„Å®„Éû„Éº„Ç∏
                const existingContactIds = new Set(contacts.map(c => c.id));
                const existingMeetingIds = new Set(meetings.map(m => m.id));
                
                let addedContacts = 0;
                let addedMeetings = 0;
                
                // ÈÄ£Áµ°ÂÖà„ÅÆ„Ç§„É≥„Éù„Éº„Éà
                for (const contact of importedData.contacts) {
                    if (!existingContactIds.has(contact.id)) {
                        // „Çà„Åø„Éï„Ç£„Éº„É´„Éâ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÂàùÊúüÂåñ
                        if (!contact.hasOwnProperty('yomi')) {
                            contact.yomi = '';
                        }
                        // Âàá„ÇäÂá∫„ÅóÊñπ„Éï„Ç£„Éº„É´„Éâ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÂàùÊúüÂåñ
                        if (!contact.hasOwnProperty('cutout')) {
                            contact.cutout = '';
                        }
                        // È°îÂÜôÁúüURL„ÇíÂ§âÊèõ
                        if (contact.photoUrl && contact.photoUrl.includes('www.dropbox.com')) {
                            contact.photoUrl = toDirectLink(contact.photoUrl);
                        }
                        contacts.push(contact);
                        addedContacts++;
                    }
                }
                
                // „Éü„Éº„ÉÜ„Ç£„É≥„Ç∞„ÅÆ„Ç§„É≥„Éù„Éº„Éà
                for (const meeting of importedData.meetings) {
                    if (!existingMeetingIds.has(meeting.id)) {
                        // Èñ¢ÈÄ£„Åô„ÇãÈÄ£Áµ°ÂÖà„ÅåÂ≠òÂú®„Åô„Çã„ÅãÁ¢∫Ë™ç
                        if (contacts.some(c => c.id === meeting.contactId)) {
                            meetings.push(meeting);
                            addedMeetings++;
                        }
                    }
                }
                
                // „Éá„Éº„ÇøÁßªË°å
                migrateMeetingsData();
                migrateContactsData();
                migratePhotoUrls();
                
                // „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„Ç™„Éó„Ç∑„Éß„É≥„ÅÆ„Éû„Éº„Ç∏
                if (importedData.dropdownOptions) {
                    for (const key in importedData.dropdownOptions) {
                        if (dropdownOptions[key]) {
                            dropdownOptions[key] = [...new Set([...dropdownOptions[key], ...importedData.dropdownOptions[key]])];
                        }
                    }
                }
                
                // „Éá„Éº„Çø„Çí‰øùÂ≠ò
                await saveData();
                
                // UI„ÇíÊõ¥Êñ∞
                updateDropdownOptions();
                updateAllReferrerLinks();
                renderContactList();
                
                hideLoading();
                showNotification(`„Ç§„É≥„Éù„Éº„ÉàÂÆå‰∫Ü: ${addedContacts}‰ª∂„ÅÆÈÄ£Áµ°ÂÖà„Å®${addedMeetings}‰ª∂„ÅÆ„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü`);
                
                // „Ç§„É≥„Éó„ÉÉ„Éà„Çí„É™„Çª„ÉÉ„Éà
                event.target.value = '';
            } catch (error) {
                console.error('„Ç§„É≥„Éù„Éº„Éà„Ç®„É©„Éº:', error);
                showNotification('„Éá„Éº„Çø„ÅÆ„Ç§„É≥„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                hideLoading();
                event.target.value = '';
            }
        }
        
        // ===== v13.0: Á¥çÂìÅÂìÅË≥™„ÉÜ„Çπ„ÉàÔºàÊúÄÁµÇÁâàÔºâ =====
        async function runProductionQualityTest() {
            console.log('=== Á¥çÂìÅ„É¨„Éô„É´ÂìÅË≥™„ÉÅ„Çß„ÉÉ„ÇØ v13.0 ===');
            console.log('Êñ∞Ê©üËÉΩÂÆüË£Ö:');
            console.log('1. Âàá„ÇäÂá∫„ÅóÊñπ„Éï„Ç£„Éº„É´„ÉâËøΩÂä†');
            console.log('2. ÈÅéÂéª„ÅÆÁµåÊ≠¥Êäò„Çä„Åü„Åü„ÅøÊ©üËÉΩ');
            console.log('3. „É¢„Éº„ÉÄ„É´ÊúÄ‰∏äÈÉ®„Çπ„ÇØ„É≠„Éº„É´');
            console.log('4. Ê∑ª‰ªò„Éï„Ç°„Ç§„É´„ÅÆ„Éñ„É©„Ç¶„Ç∂Ë°®Á§∫');
            console.log('5. iPadÈ°îÂÜôÁúüË°®Á§∫ÂØæÁ≠ñÔºàÂº∑ÂåñÁâàÔºâ');
            console.log('6. „Çø„Çπ„ÇØÂçò‰Ωç„ÅÆÊúüÈôêÁÆ°ÁêÜ');
            console.log('7. Êú™ÂÆå‰∫Ü„Çø„Çπ„ÇØ„ÅÆ„Ç§„É≥„É©„Ç§„É≥Á∑®ÈõÜ');
            console.log('8. Êó¢Â≠òÊ©üËÉΩ„ÅÆÂÆåÂÖ®‰∫íÊèõÊÄßÁ∂≠ÊåÅ');
            console.log('Test Time:', new Date().toLocaleString());
            console.log('=====================================\n');
            
            const testResults = {
                cutoutField: false,
                careerHistoryToggle: false,
                modalScroll: false,
                filePreview: false,
                imageHandling: false,
                taskManagement: false,
                taskInlineEdit: false,
                dataIntegrity: false
            };
            
            // 1. Âàá„ÇäÂá∫„ÅóÊñπ„Éï„Ç£„Éº„É´„Éâ„ÉÜ„Çπ„Éà
            console.log('1. Âàá„ÇäÂá∫„ÅóÊñπ„Éï„Ç£„Éº„É´„Éâ„ÉÜ„Çπ„Éà:');
            try {
                const hasField = typeof migrateContactsData === 'function' && 
                               migrateContactsData.toString().includes('cutout');
                if (hasField) {
                    console.log('   ‚úÖ PASS - Âàá„ÇäÂá∫„ÅóÊñπ„Éï„Ç£„Éº„É´„Éâ„ÅåÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
                    testResults.cutoutField = true;
                } else {
                    console.log('   ‚ùå FAIL - Âàá„ÇäÂá∫„ÅóÊñπ„Éï„Ç£„Éº„É´„Éâ„ÅåÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }
            } catch (e) {
                console.log('   ‚ùå FAIL - Âàá„ÇäÂá∫„ÅóÊñπ„Éï„Ç£„Éº„É´„Éâ„ÉÜ„Çπ„Éà„Ç®„É©„Éº:', e.message);
            }
            
            // 2. ÈÅéÂéª„ÅÆÁµåÊ≠¥Êäò„Çä„Åü„Åü„Åø„ÉÜ„Çπ„Éà
            console.log('\n2. ÈÅéÂéª„ÅÆÁµåÊ≠¥Êäò„Çä„Åü„Åü„Åø„ÉÜ„Çπ„Éà:');
            try {
                const hasToggle = typeof toggleCareerHistory === 'function';
                if (hasToggle) {
                    console.log('   ‚úÖ PASS - ÈÅéÂéª„ÅÆÁµåÊ≠¥Êäò„Çä„Åü„Åü„ÅøÊ©üËÉΩ„ÅåÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
                    testResults.careerHistoryToggle = true;
                } else {
                    console.log('   ‚ùå FAIL - ÈÅéÂéª„ÅÆÁµåÊ≠¥Êäò„Çä„Åü„Åü„ÅøÊ©üËÉΩ„ÅåÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }
            } catch (e) {
                console.log('   ‚ùå FAIL - ÈÅéÂéª„ÅÆÁµåÊ≠¥Êäò„Çä„Åü„Åü„Åø„ÉÜ„Çπ„Éà„Ç®„É©„Éº:', e.message);
            }
            
            // 3. „É¢„Éº„ÉÄ„É´„Çπ„ÇØ„É≠„Éº„É´„ÉÜ„Çπ„Éà
            console.log('\n3. „É¢„Éº„ÉÄ„É´„Çπ„ÇØ„É≠„Éº„É´„ÉÜ„Çπ„Éà:');
            try {
                const hasScroll = showContactDetail.toString().includes('scrollTop = 0');
                if (hasScroll) {
                    console.log('   ‚úÖ PASS - „É¢„Éº„ÉÄ„É´Ë°®Á§∫ÊôÇ„ÅÆÊúÄ‰∏äÈÉ®„Çπ„ÇØ„É≠„Éº„É´„ÅåÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
                    testResults.modalScroll = true;
                } else {
                    console.log('   ‚ùå FAIL - „É¢„Éº„ÉÄ„É´ÊúÄ‰∏äÈÉ®„Çπ„ÇØ„É≠„Éº„É´„ÅåÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }
            } catch (e) {
                console.log('   ‚ùå FAIL - „É¢„Éº„ÉÄ„É´„Çπ„ÇØ„É≠„Éº„É´„ÉÜ„Çπ„Éà„Ç®„É©„Éº:', e.message);
            }
            
            // 4. „Éï„Ç°„Ç§„É´„Éó„É¨„Éì„É•„Éº„ÉÜ„Çπ„Éà
            console.log('\n4. „Éï„Ç°„Ç§„É´„Éó„É¨„Éì„É•„Éº„ÉÜ„Çπ„Éà:');
            try {
                const hasPreview = typeof openFile === 'function';
                if (hasPreview) {
                    console.log('   ‚úÖ PASS - „Éï„Ç°„Ç§„É´„Éó„É¨„Éì„É•„ÉºÊ©üËÉΩ„ÅåÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
                    testResults.filePreview = true;
                } else {
                    console.log('   ‚ùå FAIL - „Éï„Ç°„Ç§„É´„Éó„É¨„Éì„É•„ÉºÊ©üËÉΩ„ÅåÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }
            } catch (e) {
                console.log('   ‚ùå FAIL - „Éï„Ç°„Ç§„É´„Éó„É¨„Éì„É•„Éº„ÉÜ„Çπ„Éà„Ç®„É©„Éº:', e.message);
            }
            
            // 5. ÁîªÂÉè„Éè„É≥„Éâ„É™„É≥„Ç∞„ÉÜ„Çπ„Éà
            console.log('\n5. ÁîªÂÉè„Éè„É≥„Éâ„É™„É≥„Ç∞„ÉÜ„Çπ„Éà:');
            try {
                const hasEnhancedHandling = handleImageError.toString().includes('crossorigin');
                if (hasEnhancedHandling) {
                    console.log('   ‚úÖ PASS - iPadÂØæÂøú„ÅÆÁîªÂÉè„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„ÅåÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
                    testResults.imageHandling = true;
                } else {
                    console.log('   ‚ùå FAIL - iPadÂØæÂøú„ÅÆÁîªÂÉè„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„Åå‰∏çÂÆåÂÖ®„Åß„Åô');
                }
            } catch (e) {
                console.log('   ‚ùå FAIL - ÁîªÂÉè„Éè„É≥„Éâ„É™„É≥„Ç∞„ÉÜ„Çπ„Éà„Ç®„É©„Éº:', e.message);
            }
            
            // 6. „Çø„Çπ„ÇØÁÆ°ÁêÜ„ÉÜ„Çπ„Éà
            console.log('\n6. „Çø„Çπ„ÇØÁÆ°ÁêÜ„ÉÜ„Çπ„Éà:');
            try {
                const hasTaskManagement = typeof displayTaskInputs === 'function' && 
                                        typeof addTaskInput === 'function';
                if (hasTaskManagement) {
                    console.log('   ‚úÖ PASS - „Çø„Çπ„ÇØÂçò‰Ωç„ÅÆÊúüÈôêÁÆ°ÁêÜ„ÅåÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
                    testResults.taskManagement = true;
                } else {
                    console.log('   ‚ùå FAIL - „Çø„Çπ„ÇØÂçò‰Ωç„ÅÆÊúüÈôêÁÆ°ÁêÜ„ÅåÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }
            } catch (e) {
                console.log('   ‚ùå FAIL - „Çø„Çπ„ÇØÁÆ°ÁêÜ„ÉÜ„Çπ„Éà„Ç®„É©„Éº:', e.message);
            }
            
            // 7. „Çø„Çπ„ÇØ„Ç§„É≥„É©„Ç§„É≥Á∑®ÈõÜ„ÉÜ„Çπ„Éà
            console.log('\n7. „Çø„Çπ„ÇØ„Ç§„É≥„É©„Ç§„É≥Á∑®ÈõÜ„ÉÜ„Çπ„Éà:');
            try {
                const hasInlineEdit = typeof startTaskEdit === 'function' && 
                                    typeof saveTaskEdit === 'function';
                if (hasInlineEdit) {
                    console.log('   ‚úÖ PASS - „Çø„Çπ„ÇØ„ÅÆ„Ç§„É≥„É©„Ç§„É≥Á∑®ÈõÜ„ÅåÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
                    testResults.taskInlineEdit = true;
                } else {
                    console.log('   ‚ùå FAIL - „Çø„Çπ„ÇØ„ÅÆ„Ç§„É≥„É©„Ç§„É≥Á∑®ÈõÜ„ÅåÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                }
            } catch (e) {
                console.log('   ‚ùå FAIL - „Çø„Çπ„ÇØ„Ç§„É≥„É©„Ç§„É≥Á∑®ÈõÜ„ÉÜ„Çπ„Éà„Ç®„É©„Éº:', e.message);
            }
            
            // 8. „Éá„Éº„ÇøÊï¥ÂêàÊÄß„ÉÜ„Çπ„Éà
            console.log('\n8. „Éá„Éº„ÇøÊï¥ÂêàÊÄß„ÉÜ„Çπ„Éà:');
            try {
                const criticalFunctions = [
                    'saveData', 'loadData', 'uploadFile', 'filterContacts',
                    'exportData', 'importData', 'renderContactList', 'showContactDetail',
                    'migrateMeetingsData', 'migrateContactsData', 'getOutstandingTaskCount',
                    'handlePhotoDrop', 'processPhotoFile', 'toDirectLink', 'migratePhotoUrls',
                    'toggleCareerHistory', 'openFile', 'renderTaskListNew', 'startTaskEdit',
                    'saveTaskEdit', 'toggleTaskCompleteNew', 'displayTaskInputs', 'addTaskInput'
                ];
                
                const allFunctionsExist = criticalFunctions.every(fn => typeof window[fn] === 'function');
                
                if (allFunctionsExist) {
                    console.log('   ‚úÖ PASS - „Åô„Åπ„Å¶„ÅÆÊ©üËÉΩ„ÅåÊ≠£Â∏∏„Å´ÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
                    testResults.dataIntegrity = true;
                } else {
                    console.log('   ‚ùå FAIL - ‰∏ÄÈÉ®„ÅÆÊ©üËÉΩ„ÅåÊ¨†ËêΩ„Åó„Å¶„ÅÑ„Åæ„Åô');
                }
            } catch (e) {
                console.log('   ‚ùå FAIL - „Éá„Éº„ÇøÊï¥ÂêàÊÄß„ÉÜ„Çπ„Éà„Ç®„É©„Éº:', e.message);
            }
            
            // „Çµ„Éû„É™„Éº
            console.log('\n=== QA „Çµ„Éû„É™„Éº„ÉÜ„Éº„Éñ„É´ ===');
            console.log('| „ÉÜ„Çπ„ÉàÈ†ÖÁõÆ | ÁµêÊûú |');
            console.log('|-----------|--------|');
            console.log(`| Âàá„ÇäÂá∫„ÅóÊñπ„Éï„Ç£„Éº„É´„Éâ | ${testResults.cutoutField ? '‚úÖ PASS' : '‚ùå FAIL'} |`);
            console.log(`| ÈÅéÂéª„ÅÆÁµåÊ≠¥Êäò„Çä„Åü„Åü„Åø | ${testResults.careerHistoryToggle ? '‚úÖ PASS' : '‚ùå FAIL'} |`);
            console.log(`| „É¢„Éº„ÉÄ„É´ÊúÄ‰∏äÈÉ®„Çπ„ÇØ„É≠„Éº„É´ | ${testResults.modalScroll ? '‚úÖ PASS' : '‚ùå FAIL'} |`);
            console.log(`| „Éï„Ç°„Ç§„É´„Éó„É¨„Éì„É•„Éº | ${testResults.filePreview ? '‚úÖ PASS' : '‚ùå FAIL'} |`);
            console.log(`| iPadÁîªÂÉèË°®Á§∫ÂØæÁ≠ñ | ${testResults.imageHandling ? '‚úÖ PASS' : '‚ùå FAIL'} |`);
            console.log(`| „Çø„Çπ„ÇØÊúüÈôêÁÆ°ÁêÜ | ${testResults.taskManagement ? '‚úÖ PASS' : '‚ùå FAIL'} |`);
            console.log(`| „Çø„Çπ„ÇØ„Ç§„É≥„É©„Ç§„É≥Á∑®ÈõÜ | ${testResults.taskInlineEdit ? '‚úÖ PASS' : '‚ùå FAIL'} |`);
            console.log(`| „Éá„Éº„ÇøÊï¥ÂêàÊÄß | ${testResults.dataIntegrity ? '‚úÖ PASS' : '‚ùå FAIL'} |`);
            
            const allPassed = Object.values(testResults).every(v => v);
            console.log(`\nÁ∑èÂêàÂà§ÂÆö: ${allPassed ? '‚úÖ „Åô„Åπ„Å¶„ÅÆ„ÉÜ„Çπ„Éà„Å´ÂêàÊ†º!' : '‚ùå ‰∏ÄÈÉ®„ÅÆ„ÉÜ„Çπ„Éà„ÅåÂ§±Êïó'}`);
            
            if (allPassed) {
                console.log('\n‚úÖ v13.0 Á¥çÂìÅÂìÅË≥™Âü∫Ê∫ñ„ÇíÊ∫Ä„Åü„Åó„Å¶„ÅÑ„Åæ„Åô');
                console.log('‚úÖ „Åô„Åπ„Å¶„ÅÆÊñ∞Ê©üËÉΩ„ÅåÊ≠£Â∏∏„Å´ÂÆüË£Ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô');
                console.log('‚úÖ Êó¢Â≠òÊ©üËÉΩ„Å®„ÅÆ‰∫íÊèõÊÄß„ÇÇ‰øù„Åü„Çå„Å¶„ÅÑ„Åæ„Åô');
                console.log('‚úÖ Á¥çÂìÅÊ∫ñÂÇôÂÆå‰∫Ü');
            }
            
            return testResults;
        }
        
        // ===== „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö =====
        document.addEventListener('DOMContentLoaded', () => {
            try {
                setupFileDragDrop();
                
                // „É¢„Éº„ÉÄ„É´„ÅÆÂ§ñÂÅ¥„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.style.display = 'none';
                        }
                    });
                });
                
                // „Éâ„Ç≠„É•„É°„É≥„ÉàÂÖ®‰Ωì„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„ÉàÔºà„Éû„É´„ÉÅ„Çª„É¨„ÇØ„Éà„ÇíÈñâ„Åò„ÇãÔºâ
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.multi-select')) {
                        document.querySelectorAll('.multi-select-dropdown').forEach(dropdown => {
                            dropdown.classList.remove('show');
                        });
                    }
                });
                
                // „Éâ„Ç≠„É•„É°„É≥„ÉàÂÖ®‰Ωì„ÅÆ„Éâ„É©„ÉÉ„Ç∞„Ç™„Éº„Éê„Éº„ÇíÈò≤Ê≠¢Ôºà„Éñ„É©„Ç¶„Ç∂„Åß„Éï„Ç°„Ç§„É´„ÅåÈñã„Åè„ÅÆ„ÇíÈò≤„ÅêÔºâ
                document.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                document.addEventListener('drop', (e) => {
                    e.preventDefault();
                });
                
                // „Ç™„É≥„É©„Ç§„É≥/„Ç™„Éï„É©„Ç§„É≥Áä∂ÊÖã„ÅÆÁõ£Ë¶ñ
                window.addEventListener('online', () => {
                    showNotification('„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„ÅåÂæ©Êóß„Åó„Åæ„Åó„Åü', 'success');
                    const statusElement = document.getElementById('connection-status');
                    if (statusElement) {
                        statusElement.style.color = '#4c8bf5';
                    }
                });
                
                window.addEventListener('offline', () => {
                    showNotification('„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„ÅåÂàáÊñ≠„Åï„Çå„Åæ„Åó„Åü', 'error');
                    const statusElement = document.getElementById('connection-status');
                    if (statusElement) {
                        statusElement.style.color = '#d93025';
                    }
                });
                
            } catch (error) {
                console.error('„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö„Ç®„É©„Éº:', error);
            }
        });
        
        // Á¥çÂìÅÁâà„Åß„ÅØËá™Âãï„ÉÜ„Çπ„Éà„ÇíÂÆüË°å
        window.onload = async function() {
            try {
                // Êó¢Â≠ò„ÅÆÂàùÊúüÂåñÂá¶ÁêÜ
                console.log('=== „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñÈñãÂßã ===');
                
                // URL„Åã„Çâ„Ç¢„ÇØ„Çª„Çπ„Éà„Éº„ÇØ„É≥„ÇíÂèñÂæó
                const urlToken = getAccessTokenFromUrl();
                if (urlToken) {
                    console.log('URL„Åã„ÇâÊñ∞„Åó„ÅÑ„Éà„Éº„ÇØ„É≥„ÇíÊ§úÂá∫„Åó„Åæ„Åó„Åü');
                    
                    // ÂÜçË™çË®º„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
                    isReauthInProgress = false;
                    
                    // Âè§„ÅÑ„Éà„Éº„ÇØ„É≥„ÇíÂÆåÂÖ®„Å´ÂâäÈô§
                    localStorage.clear();
                    sessionStorage.clear();
                    
                    // Êñ∞„Åó„ÅÑ„Éà„Éº„ÇØ„É≥„Çí‰øùÂ≠ò
                    localStorage.setItem('dropbox_access_token', urlToken);
                    
                    // URL„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
                    window.history.replaceState({}, document.title, REDIRECT_URI);
                    
                    // „Éà„Éº„ÇØ„É≥„ÅåÁ¢∫ÂÆü„Å´‰øùÂ≠ò„Åï„Çå„Çã„Åæ„ÅßÂæÖÊ©ü
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // ÂàùÊúüÂåñ„ÇíÂÆüË°å
                    console.log('Êñ∞„Åó„ÅÑ„Éà„Éº„ÇØ„É≥„ÅßÂàùÊúüÂåñ„ÇíÈñãÂßã„Åó„Åæ„Åô');
                    await initializeDropbox(urlToken);
                    
                    // Á¥çÂìÅÂìÅË≥™„ÉÜ„Çπ„Éà„ÇíÂÆüË°å
                    console.log('\nüîß Á¥çÂìÅÂìÅË≥™„ÉÜ„Çπ„Éà„Çí5ÁßíÂæå„Å´ÂÆüË°å„Åó„Åæ„Åô...');
                    setTimeout(async () => {
                        try {
                            const results = await runProductionQualityTest();
                            if (Object.values(results).every(v => v)) {
                                console.log('\n‚úÖ Á¥çÂìÅÁâà v13.0 - „Åô„Åπ„Å¶„ÅÆ„ÉÜ„Çπ„Éà„Å´ÂêàÊ†º„Åó„Åæ„Åó„Åü');
                            }
                        } catch (err) {
                            console.error('„ÉÜ„Çπ„Éà„Ç®„É©„Éº:', err);
                        }
                    }, 5000);
                    
                    return;
                }
                
                // ‰øùÂ≠ò„Åï„Çå„Åü„Éà„Éº„ÇØ„É≥„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                const savedToken = localStorage.getItem('dropbox_access_token');
                
                if (savedToken) {
                    console.log('‰øùÂ≠ò„Åï„Çå„Åü„Éà„Éº„ÇØ„É≥„Çí‰ΩøÁî®„Åó„Å¶ÂàùÊúüÂåñ„Åó„Åæ„Åô');
                    await initializeDropbox(savedToken);
                    
                    // Á¥çÂìÅÂìÅË≥™„ÉÜ„Çπ„Éà„ÇíÂÆüË°å
                    console.log('\nüîß Á¥çÂìÅÂìÅË≥™„ÉÜ„Çπ„Éà„Çí5ÁßíÂæå„Å´ÂÆüË°å„Åó„Åæ„Åô...');
                    setTimeout(async () => {
                        try {
                            const results = await runProductionQualityTest();
                            if (Object.values(results).every(v => v)) {
                                console.log('\n‚úÖ Á¥çÂìÅÁâà v13.0 - „Åô„Åπ„Å¶„ÅÆ„ÉÜ„Çπ„Éà„Å´ÂêàÊ†º„Åó„Åæ„Åó„Åü');
                            }
                        } catch (err) {
                            console.error('„ÉÜ„Çπ„Éà„Ç®„É©„Éº:', err);
                        }
                    }, 5000);
                } else {
                    console.log('„Éà„Éº„ÇØ„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇË™çË®ºÁîªÈù¢„ÇíË°®Á§∫„Åó„Åæ„Åô');
                    showAuthScreen();
                }
            } catch (error) {
                console.error('ÂàùÊúüÂåñ‰∏≠„ÅÆ„Ç®„É©„Éº:', error);
                showNotification('„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                
                // „Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØ„Éà„Éº„ÇØ„É≥„Çí„ÇØ„É™„Ç¢„Åó„Å¶Ë™çË®ºÁîªÈù¢„Å∏
                localStorage.removeItem('dropbox_access_token');
                sessionStorage.removeItem('dropbox_access_token');
                showAuthScreen();
            }
        };
        
        // Production readiness
        console.log('=== 1to1 Meeting System v13.0 (Á¥çÂìÅÁâà) ===');
        console.log('‚úÖ Âàá„ÇäÂá∫„ÅóÊñπ„Éï„Ç£„Éº„É´„Éâ: MarkdownÂØæÂøú„ÅßÂÆüË£Ö');
        console.log('‚úÖ ÈÅéÂéª„ÅÆÁµåÊ≠¥Êäò„Çä„Åü„Åü„Åø: 7Ë°å‰ª•‰∏ä„ÅßËá™ÂãïÊäò„Çä„Åü„Åü„Åø');
        console.log('‚úÖ „É¢„Éº„ÉÄ„É´ÊúÄ‰∏äÈÉ®„Çπ„ÇØ„É≠„Éº„É´: ÂÖ®„É¢„Éº„ÉÄ„É´„ÅßÂÆüË£Ö');
        console.log('‚úÖ Ê∑ª‰ªò„Éï„Ç°„Ç§„É´„Éñ„É©„Ç¶„Ç∂Ë°®Á§∫: ÁîªÂÉè/PDF/„ÉÜ„Ç≠„Çπ„ÉàÂØæÂøú');
        console.log('‚úÖ iPadÈ°îÂÜôÁúüË°®Á§∫: crossOriginÂ±ûÊÄß„Å®„É™„Éà„É©„Ç§Ê©üËÉΩ');
        console.log('‚úÖ „Çø„Çπ„ÇØÊúüÈôêÁÆ°ÁêÜ: ÂÄãÂà•ÊúüÈôêË®≠ÂÆö„Å®ÂãïÁöÑ„Éï„Ç©„Éº„É†');
        console.log('‚úÖ „Çø„Çπ„ÇØ„Ç§„É≥„É©„Ç§„É≥Á∑®ÈõÜ: „ÉÄ„Éñ„É´„ÇØ„É™„ÉÉ„ÇØ„ÅßÁ∑®ÈõÜ');
        console.log('‚úÖ Êó¢Â≠òÊ©üËÉΩ‰∫íÊèõÊÄß: ÂÆåÂÖ®Á∂≠ÊåÅ');
        console.log('================================');
        console.log('üìã Á¥çÂìÅÊ∫ñÂÇôÂÆå‰∫Ü - v13.0');
    </script>
</body>
</html>