# セキュリティ改善更新内容

## 更新日: 2025/01/10

### 主な変更点

#### 1. **Google APIスコープの制限** (config.js)
- `drive` スコープから `drive.file` スコープに変更
- アプリが作成したファイルのみにアクセスを制限

#### 2. **アクセストークンの管理改善** (google-auth.js)
- localStorageからsessionStorageに変更（ブラウザを閉じると自動削除）
- トークン有効期限の管理を追加
- 自動更新機能の実装

#### 3. **フォルダ名の匿名化** (google-drive.js)
- 連絡先の実名からIDベースのフォルダ名に変更
  - 変更前: `attachments/田中太郎/`
  - 変更後: `attachments/contact_abc123xyz/`
- 画像の公開共有設定を削除（認証が必要なアクセスのみ）

#### 4. **XSS対策の強化** (tasks.js, utils.js)
- contentEditableを入力フィールドに変更
- より堅牢なHTMLエスケープ関数の実装
- Markdown処理のセキュリティ強化

#### 5. **画像URL処理の改善** (contacts.js, ui-common.js)
- 公開URLを保存せず、都度認証付きURLを生成
- 非同期画像読み込みの実装

### 更新が必要なファイル

1. **config.js** - SCOPESの変更
2. **google-auth.js** - トークン管理の改善
3. **google-drive.js** - フォルダ構造とファイルアップロード処理
4. **tasks.js** - XSS対策
5. **utils.js** - セキュリティ関数の強化
6. **contacts.js** - 画像アップロード処理（一部）
7. **ui-common.js** - 画像表示処理（一部）

### 移行時の注意事項

1. **既存データの移行**
   - 既存のフォルダ構造（実名フォルダ）は手動で移行が必要
   - 設定画面の「フォルダ間データ移行」機能を使用してください

2. **再認証が必要**
   - スコープ変更のため、すべてのユーザーは再度Google認証が必要です

3. **画像の再読み込み**
   - 画像URLの処理方法が変更されたため、初回表示時に読み込み時間がかかる場合があります

### セキュリティ向上のポイント

- ✅ 最小権限の原則（drive.fileスコープ）
- ✅ セッション管理の強化
- ✅ 個人情報の匿名化（フォルダ名）
- ✅ XSS対策の徹底
- ✅ 認証付きファイルアクセス

### 今後の推奨事項

1. Content Security Policy (CSP) の適切な設定
2. HTTPS環境での運用
3. 定期的なセキュリティアップデート
4. アクセスログの監視

---

更新作業は慎重に行い、必ずバックアップを取ってから実施してください。