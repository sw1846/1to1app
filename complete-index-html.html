<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>1to1ミーティング管理システム - PlaceOn</title>
    
    <!-- Google API Client Library -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, "Helvetica Neue", "Roboto", sans-serif;
            background-color: #1e1e1e;
            color: #f0f0f0;
            line-height: 1.6;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
        }

        /* セットアップウィザード */
        .setup-wizard {
            max-width: 800px;
            margin: 50px auto;
            background: #2a2a2a;
            border-radius: 8px;
            padding: 40px;
            border: 1px solid #3a3a3a;
        }

        .setup-step {
            display: none;
        }

        .setup-step.active {
            display: block;
        }

        .setup-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .setup-header h1 {
            font-size: 32px;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .setup-header p {
            color: #aaaaaa;
            font-size: 16px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            gap: 20px;
        }

        .step-dot {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #333333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            border: 2px solid #444444;
            transition: all 0.3s ease;
        }

        .step-dot.active {
            background: #4c8bf5;
            border-color: #4c8bf5;
            color: white;
        }

        .step-dot.completed {
            background: #34a853;
            border-color: #34a853;
            color: white;
        }

        .setup-content {
            margin-bottom: 40px;
        }

        .setup-content h2 {
            font-size: 24px;
            font-weight: 400;
            margin-bottom: 20px;
        }

        .setup-content p {
            color: #aaaaaa;
            margin-bottom: 20px;
            line-height: 1.8;
        }

        .code-block {
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            overflow-x: auto;
            position: relative;
        }

        .code-block code {
            color: #f0f0f0;
            font-size: 14px;
        }

        .copy-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4c8bf5;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .copy-button:hover {
            background: #5a96f7;
        }

        /* ヘッダー */
        header {
            background: #2a2a2a;
            padding: 24px;
            margin-bottom: 24px;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: stretch;
            }
        }

        h1 {
            font-size: 26px;
            color: #f0f0f0;
            font-weight: 300;
            margin: 0;
            letter-spacing: 0.5px;
        }

        .header-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* ボタン */
        button {
            padding: 10px 18px;
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 400;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #333333;
            color: #f0f0f0;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        button:hover {
            border-color: #4c8bf5;
            box-shadow: 0 0 0 1px #4c8bf5;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #4c8bf5;
            color: white;
            border-color: #4c8bf5;
        }

        .btn-primary:hover {
            background: #5a96f7;
            box-shadow: 0 0 10px rgba(76, 139, 245, 0.3);
        }

        .btn-secondary {
            background: #333333;
            color: #f0f0f0;
            border: 1px solid #444444;
        }

        .btn-secondary:hover {
            background: #3a3a3a;
            border-color: #4c8bf5;
        }

        .btn-google {
            background: white;
            color: #3c4043;
            border: 1px solid #dadce0;
            font-weight: 500;
        }

        .btn-google:hover {
            background: #f8f9fa;
            border-color: #dadce0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .btn-danger {
            background: #d93025;
            color: white;
            border-color: #d93025;
        }

        .btn-danger:hover {
            background: #e74c3c;
            box-shadow: 0 0 10px rgba(217, 48, 37, 0.3);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* フリーワード検索を常時表示 */
        .search-bar {
            background: #2a2a2a;
            padding: 20px 24px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid #3a3a3a;
        }

        /* 表示コントロールバー */
        .view-controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 16px;
        }

        @media (max-width: 768px) {
            .view-controls {
                justify-content: center;
            }
        }

        /* 並び替えとビュー切り替えを横並びに */
        .view-sort-wrapper {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        /* モバイル時のアップロード説明文簡略化 */
        @media (max-width: 768px) {
            .upload-hint {
                display: none;
            }
        }

        /* ミーティングカードスタイル */
        .meeting-card {
            background: #333333;
            border: 1px solid #444444;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .meeting-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #444444;
        }

        .meeting-card-date {
            font-size: 16px;
            font-weight: 500;
            color: #4c8bf5;
        }

        .meeting-card-actions {
            display: flex;
            gap: 8px;
        }

        /* タスクリストを右寄せ */
        .meeting-tasks {
            margin-left: 20px;
            padding: 12px;
            background: #2a2a2a;
            border-radius: 6px;
            border-left: 3px solid #4c8bf5;
        }

        /* リンククリック可能に */
        .contact-list-item a,
        .contact-card a {
            pointer-events: auto;
            z-index: 10;
            position: relative;
        }

        /* 強み・経歴の折りたたみ */
        .collapsible-content {
            position: relative;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.collapsed {
            max-height: calc(1.6em * 7);
            overflow: hidden;
        }

        .toggle-link {
            color: #4c8bf5;
            cursor: pointer;
            font-size: 14px;
            margin-top: 8px;
            display: inline-block;
        }

        .toggle-link:hover {
            opacity: 0.8;
        }

        /* 新規連絡先での初回ミーティングセクション */
        .first-meeting-new {
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
        }

        /* 検索・フィルター */
        .search-filters {
            background: #2a2a2a;
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 24px;
            border: 1px solid #3a3a3a;
        }

        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .search-header h3 {
            font-weight: 300;
            font-size: 18px;
            color: #f0f0f0;
        }

        .sort-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sort-controls select {
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid #444444;
            background: #333333;
            color: #f0f0f0;
        }

        .filter-row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group.search-group {
            flex: 2;
            min-width: 300px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 400;
            font-size: 14px;
            color: #aaaaaa;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #444444;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: #333333;
            color: #f0f0f0;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4c8bf5;
            box-shadow: 0 0 0 1px #4c8bf5;
        }

        input::placeholder {
            color: #666666;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* インクリメンタルサーチ付きセレクト - PC版のドロップダウンの高さ修正 */
        .searchable-select {
            position: relative;
        }

        .searchable-select-input {
            width: 100%;
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid #444444;
            background: #333333;
            color: #f0f0f0;
            cursor: pointer;
        }

        .searchable-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #333333;
            border: 1px solid #444444;
            border-radius: 6px;
            max-height: 400px; /* 200pxから400pxに増加 */
            overflow-y: auto;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .searchable-select-dropdown.show {
            display: block;
        }

        .searchable-select-search {
            padding: 8px;
            border-bottom: 1px solid #444444;
            position: sticky;
            top: 0;
            background: #333333;
            z-index: 1; /* 検索バーを最前面に */
        }

        .searchable-select-search input {
            width: 100%;
            padding: 6px 10px;
            font-size: 13px;
            border: 1px solid #444444;
            border-radius: 4px;
            background: #2a2a2a;
        }

        .searchable-select-option {
            padding: 10px 12px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .searchable-select-option:hover {
            background: #3a3a3a;
        }

        .searchable-select-option.selected {
            background: #4c8bf5;
            color: white;
        }

        /* 連絡先グリッド */
        .contact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        @media (max-width: 768px) {
            .contact-grid {
                grid-template-columns: 1fr;
            }
        }

        .contact-card {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #3a3a3a;
        }

        .contact-card:hover {
            border-color: #4c8bf5;
            box-shadow: 0 0 20px rgba(76, 139, 245, 0.1);
        }

        .contact-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #333333;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            overflow: hidden;
            font-weight: 300;
            color: #aaaaaa;
            border: 1px solid #444444;
        }

        .contact-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .contact-name {
            font-size: 18px;
            font-weight: 400;
            margin-bottom: 8px;
            color: #f0f0f0;
        }

        .contact-info {
            font-size: 14px;
            color: #aaaaaa;
            margin-bottom: 4px;
        }

        .last-meeting-info {
            font-size: 13px;
            color: #4c8bf5;
            margin-top: 8px;
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
        }

        .tag {
            background: #333333;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
            color: #aaaaaa;
            font-weight: 400;
            border: 1px solid #444444;
        }

        /* モーダル */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: #2a2a2a;
            margin: 50px auto;
            max-width: 800px;
            border-radius: 8px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #3a3a3a;
        }

        @media (max-width: 768px) {
            .modal-content {
                margin: 20px;
                max-height: calc(100vh - 40px);
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-weight: 300;
            color: #f0f0f0;
        }

        .modal-body {
            padding: 20px;
        }

        .close-modal {
            font-size: 24px;
            cursor: pointer;
            color: #aaaaaa;
            transition: color 0.2s ease;
        }

        .close-modal:hover {
            color: #f0f0f0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        /* 複数入力用スタイル */
        .multi-input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .multi-input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .multi-input-row input,
        .multi-input-row select {
            flex: 1;
        }

        .add-input-button {
            margin-top: 5px;
        }

        .related-contact-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .related-contact-row select {
            flex: 1;
        }

        /* ファイルアップロード */
        .file-drop-zone {
            border: 2px dashed #444444;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #333333;
            color: #aaaaaa;
        }

        .file-drop-zone:hover,
        .file-drop-zone.dragover {
            border-color: #4c8bf5;
            background: #2a2a2a;
            color: #f0f0f0;
        }

        .file-list {
            margin-top: 10px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #333333;
            border-radius: 4px;
            margin-bottom: 5px;
            border: 1px solid #444444;
        }

        .file-item-actions {
            display: flex;
            gap: 5px;
        }

        /* ミーティングタイムライン */
        .meeting-timeline {
            margin-top: 30px;
        }

        .meeting-item {
            border-left: 3px solid #4c8bf5;
            padding-left: 20px;
            margin-bottom: 30px;
            position: relative;
        }

        .meeting-item::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 0;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4c8bf5;
            border: 2px solid #2a2a2a;
        }

        .meeting-date {
            font-weight: 400;
            color: #4c8bf5;
            margin-bottom: 10px;
        }

        /* Markdown コンテンツ */
        .markdown {
            font-family: 'system-ui', sans-serif;
            color: #f0f0f0;
            background-color: transparent;
            line-height: 1.6;
            font-size: 15px;
        }

        .markdown h1 {
            font-size: 1.8em;
            font-weight: bold;
            margin: 1em 0 0.5em;
            border-bottom: 1px solid #444;
            padding-bottom: 0.3em;
        }

        .markdown h2 {
            font-size: 1.4em;
            font-weight: bold;
            margin: 0.8em 0 0.4em;
            color: #e0e0e0;
        }

        .markdown h3 {
            font-size: 1.2em;
            font-weight: bold;
            margin: 0.6em 0 0.3em;
            color: #cccccc;
        }

        .markdown p {
            margin: 0.5em 0;
        }

        .markdown ul, .markdown ol {
            padding-left: 1.6em;
            margin: 0.5em 0;
        }

        .markdown li {
            margin-bottom: 0.4em;
        }

        .markdown strong {
            font-weight: bold;
            color: #ffffff;
        }

        .markdown a {
            color: #4c8bf5;
            text-decoration: underline;
        }

        .markdown code {
            background-color: #333;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.95em;
            color: #f9f9f9;
        }

        .markdown pre {
            background-color: #333;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 0.5em 0;
        }

        .markdown pre code {
            background-color: transparent;
            padding: 0;
            font-size: 0.9em;
        }

        .markdown blockquote {
            border-left: 3px solid #4c8bf5;
            padding-left: 1em;
            margin: 0.5em 0;
            color: #cccccc;
        }

        .markdown-content {
            line-height: 1.6;
            overflow: hidden;
            color: #f0f0f0;
        }

        .markdown-content.truncated {
            max-height: calc(1.6em * 7);
        }

        /* 過去の経歴折りたたみ用スタイル */
        .career-history-content {
            position: relative;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .career-history-content.collapsed {
            max-height: calc(1.6em * 7);
        }
        
        .career-history-toggle {
            color: #4c8bf5;
            cursor: pointer;
            font-size: 14px;
            margin-top: 8px;
            display: inline-block;
        }
        
        .career-history-toggle:hover {
            opacity: 0.8;
        }

        /* タスクリスト用スタイル */
        .task-list {
            list-style: none;
            padding-left: 0;
            margin: 10px 0;
        }

        .task-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 8px;
            padding: 8px;
            background: #333333;
            border-radius: 4px;
            border: 1px solid #444444;
        }

        .task-item.completed {
            opacity: 0.6;
        }

        .task-item.completed .task-text {
            text-decoration: line-through;
            color: #888888;
        }

        .task-checkbox {
            margin-right: 10px;
            margin-top: 2px;
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .task-text {
            flex: 1;
            line-height: 1.5;
        }

        .task-text.editing {
            background: #444444;
            padding: 4px 8px;
            border-radius: 4px;
            outline: none;
            display: inline-block;
            min-width: 200px;
        }

        .task-due {
            font-size: 12px;
            color: #aaaaaa;
            margin-left: 10px;
        }

        .task-due.overdue {
            color: #d93025;
        }

        /* タスク期限入力用スタイル */
        .task-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .task-input-row input[type="text"] {
            flex: 1;
        }
        
        .task-input-row input[type="datetime-local"] {
            width: auto;
            min-width: 200px;
        }
        
        .btn-add-task {
            margin-top: 10px;
        }

        /* その他 */
        .read-more {
            color: #4c8bf5;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            transition: opacity 0.2s ease;
        }

        .read-more:hover {
            opacity: 0.8;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4c8bf5;
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 2000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .error-notification {
            background: #d93025;
        }

        .multi-select {
            position: relative;
        }

        .multi-select-display {
            padding: 8px;
            border: 1px solid #444444;
            border-radius: 6px;
            cursor: pointer;
            min-height: 38px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            background: #333333;
            transition: border-color 0.2s ease;
        }

        .multi-select-display:hover {
            border-color: #4c8bf5;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #333333;
            border: 1px solid #444444;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .multi-select-dropdown.show {
            display: block;
        }

        .multi-select-option {
            padding: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background 0.2s ease;
        }

        .multi-select-option:hover {
            background: #3a3a3a;
        }

        .multi-select-option input {
            margin-right: 8px;
            width: auto;
        }

        .selected-tag {
            background: #4c8bf5;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
        }

        .selected-tag .remove {
            margin-left: 5px;
            cursor: pointer;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .referrer-selector {
            background: #333333;
            border: 1px solid #444444;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .referrer-option {
            padding: 8px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s ease;
        }

        .referrer-option:hover {
            background: #3a3a3a;
        }

        .referrer-option .info {
            font-size: 12px;
            color: #aaaaaa;
        }

        /* リンク */
        a {
            color: #4c8bf5;
            text-decoration: none;
            transition: opacity 0.2s ease;
        }

        a:hover {
            opacity: 0.8;
        }

        /* ローディング */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f0f0f0;
            border-radius: 50%;
            border-top-color: #4c8bf5;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .loading-content {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
        }

        /* 認証画面 */
        .auth-container {
            max-width: 500px;
            margin: 100px auto;
            text-align: center;
            padding: 40px;
            background: #2a2a2a;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
        }

        .auth-container h2 {
            font-size: 24px;
            margin-bottom: 20px;
            font-weight: 300;
        }

        .auth-container p {
            color: #aaaaaa;
            margin-bottom: 30px;
        }

        /* スクロールバー */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #444444;
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555555;
        }

        /* ドラフト保存インジケーター */
        .draft-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #333333;
            color: #aaaaaa;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .draft-status.show {
            display: block;
            opacity: 1;
        }

        .token-refresh-indicator {
            background: #4c8bf5;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2001;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            align-items: center;
            gap: 10px;
        }

        .token-refresh-indicator.show {
            display: flex;
        }

        .token-refresh-indicator .loading {
            width: 16px;
            height: 16px;
            border-width: 2px;
        }

        /* 表示モード切り替えボタン */
        .view-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #333333;
            border-radius: 6px;
            padding: 4px;
            border: 1px solid #444444;
        }

        .view-toggle button {
            padding: 6px 12px;
            background: transparent;
            border: none;
            color: #aaaaaa;
            font-size: 13px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .view-toggle button.active {
            background: #4c8bf5;
            color: white;
        }

        .view-toggle button:hover:not(.active) {
            background: #3a3a3a;
        }

        /* リスト表示スタイル */
        .contact-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .contact-list-item {
            display: flex;
            align-items: center;
            gap: 16px;
            background: #2a2a2a;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #3a3a3a;
        }

        .contact-list-item:hover {
            border-color: #4c8bf5;
            box-shadow: 0 0 20px rgba(76, 139, 245, 0.1);
        }

        .contact-list-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #333333;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
            font-weight: 300;
            color: #aaaaaa;
            border: 1px solid #444444;
        }

        .contact-list-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .contact-list-info {
            flex: 1;
            min-width: 0;
        }

        .contact-list-name {
            font-size: 16px;
            font-weight: 400;
            color: #f0f0f0;
            margin-bottom: 4px;
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .contact-list-company {
            font-size: 14px;
            color: #aaaaaa;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .contact-list-meeting {
            font-size: 13px;
            color: #4c8bf5;
            white-space: nowrap;
        }

        /* 設定アイコン・接続状態 */
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: auto;
        }

        .connection-indicator {
            position: relative;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .connection-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        .connection-dot.connected {
            background-color: #34a853;
            box-shadow: 0 0 8px rgba(52, 168, 83, 0.5);
        }

        .connection-dot.disconnected {
            background-color: #d93025;
            box-shadow: 0 0 8px rgba(217, 48, 37, 0.5);
        }

        .connection-tooltip {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333333;
            color: #f0f0f0;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            border: 1px solid #444444;
        }

        .connection-indicator:hover .connection-tooltip {
            opacity: 1;
        }

        .settings-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #333333;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #444444;
        }

        .settings-icon:hover {
            background: #3a3a3a;
            border-color: #4c8bf5;
        }

        /* 設定モーダル */
        .settings-modal .modal-content {
            max-width: 500px;
        }

        .settings-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .settings-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: #333333;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #444444;
        }

        .settings-item:hover {
            background: #3a3a3a;
            border-color: #4c8bf5;
        }

        .settings-item-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .settings-item-content {
            flex: 1;
        }

        .settings-item-title {
            font-size: 16px;
            color: #f0f0f0;
            margin-bottom: 4px;
        }

        .settings-item-description {
            font-size: 13px;
            color: #aaaaaa;
        }

        /* 検索フィルターのトグル */
        .search-filters.collapsed {
            max-height: 60px;
            overflow: hidden;
        }

        .filter-toggle {
            cursor: pointer;
            user-select: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: #4c8bf5;
            font-size: 14px;
        }

        .filter-toggle:hover {
            opacity: 0.8;
        }

        /* 改修1: プルダウンが切れないようにする修正 */
        .filter-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .filter-content.show {
            max-height: 500px;
            overflow: visible; /* visible に変更して、プルダウンが表示されるようにする */
        }

        /* 名刺画像アップロード */
        .card-image-zone {
            border: 2px dashed #444444;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #333333;
            color: #aaaaaa;
            margin-top: 10px;
        }

        .card-image-zone:hover,
        .card-image-zone.dragover {
            border-color: #4c8bf5;
            background: #2a2a2a;
            color: #f0f0f0;
        }

        .camera-button {
            margin-top: 10px;
            display: none;
        }

        .camera-supported .camera-button {
            display: inline-block;
        }

        /* 連絡先詳細のタブ表示 */
        .detail-tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid #444444;
            margin-bottom: 20px;
        }

        .detail-tab {
            padding: 12px 20px;
            cursor: pointer;
            background: transparent;
            border: none;
            color: #aaaaaa;
            font-size: 14px;
            position: relative;
            transition: all 0.2s ease;
        }

        .detail-tab:hover {
            color: #f0f0f0;
        }

        .detail-tab.active {
            color: #4c8bf5;
        }

        .detail-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: #4c8bf5;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .tab-panel {
            padding: 20px 0;
        }

        /* 過去の経歴入力表示制御 */
        .career-history-section {
            display: none;
        }

        .career-history-section.show {
            display: block;
        }

        /* 連絡先フォーム2段組レイアウト */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-grid .form-group {
            margin-bottom: 0;
        }

        .form-grid .form-group.full-width {
            grid-column: 1 / -1;
        }

        @media (max-width: 600px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 初回ミーティングセクション */
        .first-meeting-section {
            background: #333333;
            border: 1px solid #444444;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .first-meeting-section h4 {
            margin: 0 0 20px 0;
            color: #4c8bf5;
            font-weight: 400;
        }

        /* テンプレート編集モーダル */
        .template-editor {
            display: none;
        }

        .template-editor textarea {
            min-height: 300px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        .template-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* セットアップ画面の戻るボタン */
        .back-to-main {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #333333;
            border: 1px solid #444444;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            color: #f0f0f0;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .back-to-main:hover {
            background: #3a3a3a;
            border-color: #4c8bf5;
        }

        /* 改修3: 連絡先件数表示 */
        .contact-count-info {
            background: #2a2a2a;
            padding: 16px 24px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid #3a3a3a;
            font-size: 16px;
            color: #f0f0f0;
        }

        /* エラー画面用スタイル */
        .error-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1e1e1e;
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .error-content {
            max-width: 600px;
            padding: 40px;
            background: #2a2a2a;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
            text-align: center;
        }

        .error-content h1 {
            color: #d93025;
            margin-bottom: 20px;
        }

        .error-content p {
            color: #aaaaaa;
            margin-bottom: 30px;
        }

        .error-details {
            background: #333333;
            padding: 20px;
            border-radius: 6px;
            margin: 20px 0;
            text-align: left;
            font-family: monospace;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
            color: #f0f0f0;
        }

        /* 未完了アクションのスタイル（追加） */
        .outstanding-group {
            margin-bottom: 25px;
            padding: 15px;
            background: #333333;
            border-radius: 6px;
            border: 1px solid #444444;
        }
        
        .outstanding-group.overdue {
            border-left: 3px solid #d93025;
        }
        
        .outstanding-group.today {
            border-left: 3px solid #ff9800;
        }
        
        .outstanding-group.thisweek {
            border-left: 3px solid #4c8bf5;
        }
        
        .outstanding-group.later {
            border-left: 3px solid #34a853;
        }
        
        .outstanding-group.nodue {
            border-left: 3px solid #aaaaaa;
        }
        
        .outstanding-tasks {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .outstanding-task-item {
            background: #2a2a2a;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #3a3a3a;
            transition: all 0.2s ease;
        }
        
        .outstanding-task-item:hover {
            border-color: #4c8bf5;
            background: #2d2d2d;
        }
        
        .overdue {
            color: #d93025 !important;
            font-weight: 500;
        }

        /* マルチセレクトの検索機能用スタイル（追加） */
        .multi-select-search {
            padding: 8px;
            border-bottom: 1px solid #444444;
            position: sticky;
            top: 0;
            background: #333333;
            z-index: 1;
        }
        
        .multi-select-search input {
            width: 100%;
            padding: 6px 10px;
            font-size: 13px;
            border: 1px solid #444444;
            border-radius: 4px;
            background: #2a2a2a;
            color: #f0f0f0;
        }
        
        .multi-select-options-list {
            max-height: 250px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- エラー表示用コンテナ -->
    <div id="errorContainer" class="error-container">
        <div class="error-content">
            <h1>エラーが発生しました</h1>
            <p>システムの初期化中にエラーが発生しました。</p>
            <div id="errorDetails" class="error-details"></div>
            <button class="btn-primary" onclick="location.reload()">ページを再読み込み</button>
        </div>
    </div>

    <div id="app">
        <!-- セットアップウィザード -->
        <div id="setupWizard" class="setup-wizard" style="display: none;">
            <!-- 設定画面から来た場合の戻るボタン -->
            <button class="back-to-main" id="backToMainBtn" style="display: none;" onclick="closeSetupAndReturn()">
                ✕ 閉じる
            </button>
            
            <div class="setup-header">
                <h1>1to1ミーティング管理システム</h1>
                <p>Google Driveと連携して、安全にデータを管理します</p>
            </div>
            
            <div class="step-indicator">
                <div class="step-dot active" id="step1Dot">1</div>
                <div class="step-dot" id="step2Dot">2</div>
                <div class="step-dot" id="step3Dot">3</div>
                <div class="step-dot" id="step4Dot">4</div>
            </div>
            
            <!-- ステップ1: ようこそ -->
            <div class="setup-step active" id="step1">
                <div class="setup-content">
                    <h2>セットアップを開始します</h2>
                    <p>このセットアップウィザードでは、Google Driveとの連携設定を行います。</p>
                    <p style="margin-top: 20px;">必要なもの：</p>
                    <ul style="color: #aaaaaa; margin-left: 20px;">
                        <li>Googleアカウント</li>
                        <li>Google Cloud Console へのアクセス（無料）</li>
                        <li>約10分の設定時間</li>
                    </ul>
                    
                    <div style="background: #333; border: 1px solid #444; border-radius: 6px; padding: 20px; margin-top: 20px;">
                        <p style="color: #ff9800; margin: 0;">
                            <strong>⚠️ 重要：ローカルファイルの制限</strong><br>
                            このHTMLファイルを直接ブラウザで開いている場合（file://）、<br>
                            Google認証は機能しません。以下のいずれかの方法で実行してください：
                        </p>
                        <ol style="margin-top: 10px; margin-left: 20px; color: #aaaaaa;">
                            <li>Pythonがインストールされている場合：<br>
                                <code style="background: #222; padding: 2px 6px; border-radius: 3px;">python -m http.server 8000</code><br>
                                その後、ブラウザで <code>http://localhost:8000</code> を開く
                            </li>
                            <li>Node.jsがインストールされている場合：<br>
                                <code style="background: #222; padding: 2px 6px; border-radius: 3px;">npx http-server -p 8000</code><br>
                                その後、ブラウザで <code>http://localhost:8000</code> を開く
                            </li>
                            <li>Webサーバーにアップロードして実行</li>
                        </ol>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-primary" onclick="nextStep()">開始する</button>
                </div>
            </div>
            
            <!-- ステップ2: Google Cloud Project 作成 -->
            <div class="setup-step" id="step2">
                <div class="setup-content">
                    <h2>Google Cloud プロジェクトの作成</h2>
                    <p>以下の手順でGoogle Cloud プロジェクトを作成し、Drive APIを有効化します：</p>
                    
                    <ol style="color: #aaaaaa; margin-left: 20px; line-height: 2;">
                        <li><a href="https://console.cloud.google.com/projectcreate" target="_blank">Google Cloud Console</a> を開く</li>
                        <li>プロジェクト名に「1to1 Meeting Manager」と入力</li>
                        <li>「作成」をクリック</li>
                        <li>プロジェクトが作成されたら、<a href="https://console.cloud.google.com/apis/library/drive.googleapis.com" target="_blank">Google Drive API</a> を開く</li>
                        <li>「有効にする」をクリック</li>
                    </ol>
                    
                    <div class="code-block">
                        <button class="copy-button" onclick="copyToClipboard('project-name')">コピー</button>
                        <code id="project-name">1to1 Meeting Manager</code>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-secondary" onclick="previousStep()">戻る</button>
                    <button class="btn-primary" onclick="nextStep()">次へ</button>
                </div>
            </div>
            
            <!-- ステップ3: OAuth設定 -->
            <div class="setup-step" id="step3">
                <div class="setup-content">
                    <h2>認証情報の作成</h2>
                    <p>OAuth 2.0 クライアントIDを作成します：</p>
                    
                    <ol style="color: #aaaaaa; margin-left: 20px; line-height: 2;">
                        <li><a href="https://console.cloud.google.com/apis/credentials" target="_blank">認証情報ページ</a> を開く</li>
                        <li>「認証情報を作成」→「OAuth クライアント ID」をクリック</li>
                        <li>「同意画面を構成」が表示された場合：
                            <ul style="margin-left: 20px; margin-top: 10px;">
                                <li>ユーザータイプ：「外部」を選択</li>
                                <li>アプリ名：「1to1 Meeting Manager」</li>
                                <li>サポートメール：あなたのメールアドレス</li>
                                <li>承認済みドメイン：空欄でOK</li>
                            </ul>
                        </li>
                        <li>アプリケーションの種類：「ウェブアプリケーション」を選択</li>
                        <li>名前：「1to1 Meeting Web Client」</li>
                        <li>承認済みのJavaScript生成元：以下の値をコピーして貼り付け</li>
                    </ol>
                    
                    <div class="code-block">
                        <button class="copy-button" onclick="copyToClipboard('origin-url')">コピー</button>
                        <code id="origin-url"></code>
                    </div>
                    
                    <div style="background: #333; border: 1px solid #444; border-radius: 6px; padding: 15px; margin-top: 10px;">
                        <p style="color: #4c8bf5; margin: 0; font-size: 14px;">
                            💡 <strong>ヒント：</strong>複数の環境で使用する場合は、以下のURLをすべて追加してください：
                        </p>
                        <ul style="margin-top: 8px; margin-left: 20px; color: #aaaaaa; font-size: 13px;">
                            <li>http://localhost:8000 （ローカル開発用）</li>
                            <li>http://localhost:3000 （別のポート）</li>
                            <li>https://あなたのドメイン.com （本番環境）</li>
                        </ul>
                    </div>
                    
                    <p style="margin-top: 20px;">作成後、クライアントIDをコピーして下に貼り付けてください：</p>
                    <div class="form-group">
                        <input type="text" id="clientIdInput" placeholder="クライアントIDを貼り付け（例：123456789-abcdef.apps.googleusercontent.com）">
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn-secondary" onclick="previousStep()">戻る</button>
                    <button class="btn-primary" onclick="validateAndProceed()">次へ</button>
                </div>
            </div>
            
            <!-- ステップ4: 完了 -->
            <div class="setup-step" id="step4">
                <div class="setup-content">
                    <h2>セットアップ完了！</h2>
                    <p>設定が完了しました。以下の情報は大切に保管してください：</p>
                    
                    <div class="code-block">
                        <button class="copy-button" onclick="copyToClipboard('final-config')">コピー</button>
                        <code id="final-config"></code>
                    </div>
                    
                    <p style="margin-top: 20px;">この設定は自動的に保存され、次回からは自動的に読み込まれます。</p>
                </div>
                <div class="action-buttons">
                    <button class="btn-primary" onclick="completeSetup()">アプリを開始</button>
                </div>
            </div>
        </div>

        <!-- 認証画面 -->
        <div id="authContainer" class="auth-container" style="display: none;">
            <h2>1to1ミーティング管理システム</h2>
            <p>Google Driveと連携して、連絡先とミーティング記録をクラウドに保存します。</p>
            <button class="btn-google" onclick="authenticateGoogle()">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Googleアカウントでログイン
            </button>
            <p style="margin-top: 20px; font-size: 12px;">
                <a href="#" onclick="showSetupWizard(); return false;">セットアップが必要な場合はこちら</a>
            </p>
        </div>

        <!-- メインコンテンツ -->
        <div id="mainContainer" class="container" style="display: none;">
            <header>
                <div class="header-content">
                    <h1>1to1ミーティング管理システム</h1>
                    <div class="header-right">
                        <div class="connection-indicator">
                            <div class="connection-dot" id="connectionDot"></div>
                            <div class="connection-tooltip" id="connectionTooltip">未接続</div>
                        </div>
                        <div class="settings-icon" onclick="showSettingsModal()">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5a3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97c0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1c0 .33.03.65.07.97l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66Z"/>
                            </svg>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="showContactForm()">新規連絡先登録</button>
                </div>
            </header>

            <!-- 検索バー -->
            <div class="search-bar">
                <label>フリーワード検索</label>
                <input type="text" id="searchName" placeholder="名前、よみ、会社、メール、タグ、内容などを検索..." onkeyup="filterContacts()">
            </div>

            <!-- 検索フィルター -->
            <div class="search-filters" id="searchFilters">
                <div class="search-header">
                    <h3>
                        <span class="filter-toggle" onclick="toggleFilters()">
                            <span id="filterToggleIcon">▶</span>
                            詳細フィルター
                        </span>
                    </h3>
                </div>
                <div class="filter-content" id="filterContent">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>種別</label>
                            <div class="searchable-select" id="filterTypeWrapper"></div>
                        </div>
                        <div class="filter-group">
                            <label>所属・チャプター</label>
                            <div class="searchable-select" id="filterAffiliationWrapper"></div>
                        </div>
                        <div class="filter-group">
                            <label>繋がりたい人・業種</label>
                            <div class="searchable-select" id="filterWantToConnectWrapper"></div>
                        </div>
                        <div class="filter-group">
                            <label>金の卵</label>
                            <div class="searchable-select" id="filterGoldenEggWrapper"></div>
                        </div>
                        <div class="filter-group">
                            <label>紹介元</label>
                            <div class="searchable-select" id="filterReferredByWrapper"></div>
                        </div>
                        <div class="filter-group">
                            <label>エリア</label>
                            <div class="searchable-select" id="filterAreaWrapper"></div>
                        </div>
                        <div class="filter-group">
                            <label>居住地</label>
                            <div class="searchable-select" id="filterResidenceWrapper"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Outstanding Actions Dashboard -->
            <div id="outstandingActions" class="search-filters" style="margin-bottom: 24px;">
                <div class="search-header">
                    <h3>未完了のアクション</h3>
                    <button class="btn-small btn-secondary" onclick="toggleOutstandingActions()">
                        <span id="toggleActionsText">表示</span>
                    </button>
                </div>
                <div id="outstandingActionsList" style="display: none; margin-top: 20px;">
                    <!-- Outstanding actions will be rendered here -->
                </div>
            </div>

            <!-- 改修3: 連絡先件数表示 -->
            <div id="contactCountInfo" class="contact-count-info">
                登録済み連絡先：<span id="contactCount">0</span>件
            </div>

            <!-- 表示コントロールバー（位置変更） -->
            <div class="view-controls">
                <div class="view-sort-wrapper">
                    <div class="sort-controls">
                        <select id="sortOrder" onchange="applySorting()">
                            <option value="meeting-desc">最終打合せ日 (新しい順)</option>
                            <option value="meeting-asc">最終打合せ日 (古い順)</option>
                            <option value="name-asc">名前 (A→Z)</option>
                            <option value="name-desc">名前 (Z→A)</option>
                            <option value="yomi-asc">よみ (あ→ん)</option>
                            <option value="yomi-desc">よみ (ん→あ)</option>
                        </select>
                    </div>
                    <div class="view-toggle">
                        <button id="cardViewBtn" class="active" onclick="setViewMode('card')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M3 3h8v8H3V3m10 0h8v8h-8V3M3 13h8v8H3v-8m10 0h8v8h-8v-8Z"/>
                            </svg>
                            カード表示
                        </button>
                        <button id="listViewBtn" onclick="setViewMode('list')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M3 4h18v2H3V4m0 7h18v2H3v-2m0 7h18v2H3v-2Z"/>
                            </svg>
                            リスト表示
                        </button>
                    </div>
                </div>
            </div>

            <div id="contactGrid" class="contact-grid">
                <!-- 連絡先カードがここに表示される -->
            </div>
        </div>
    </div>

    <!-- 連絡先登録/編集モーダル -->
    <div id="contactFormModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="contactFormTitle">新規連絡先登録</h2>
                <span class="close-modal" onclick="closeModal('contactFormModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="contactForm" onsubmit="saveContactForm(event)">
                    <!-- 基本情報（2段組） -->
                    <div class="form-grid">
                        <div class="form-group">
                            <label>氏名 <span style="color: #d93025;">*</span></label>
                            <input type="text" name="name" required>
                        </div>

                        <div class="form-group">
                            <label>よみ</label>
                            <input type="text" name="yomi" placeholder="ひらがなで入力してください">
                        </div>

                        <div class="form-group">
                            <label>会社名</label>
                            <input type="text" name="company">
                        </div>

                        <div class="form-group">
                            <label>ホームページ</label>
                            <input type="url" name="homepage">
                        </div>

                        <div class="form-group">
                            <label>種別</label>
                            <div class="multi-select">
                                <div class="multi-select-display" onclick="toggleMultiSelect('types')">
                                    <span style="color: #aaaaaa;">選択してください</span>
                                </div>
                                <div id="types-dropdown" class="multi-select-dropdown"></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>所属・チャプター</label>
                            <div class="multi-select">
                                <div class="multi-select-display" onclick="toggleMultiSelect('affiliations')">
                                    <span style="color: #aaaaaa;">選択してください</span>
                                </div>
                                <div id="affiliations-dropdown" class="multi-select-dropdown"></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>繋がりたい人・業種</label>
                            <div class="multi-select">
                                <div class="multi-select-display" onclick="toggleMultiSelect('wantToConnect')">
                                    <span style="color: #aaaaaa;">選択してください</span>
                                </div>
                                <div id="wantToConnect-dropdown" class="multi-select-dropdown"></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>金の卵</label>
                            <div class="multi-select">
                                <div class="multi-select-display" onclick="toggleMultiSelect('goldenEgg')">
                                    <span style="color: #aaaaaa;">選択してください</span>
                                </div>
                                <div id="goldenEgg-dropdown" class="multi-select-dropdown"></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>エリア</label>
                            <input type="text" name="area" placeholder="例: 関東、関西、九州など">
                        </div>

                        <div class="form-group">
                            <label>居住地</label>
                            <input type="text" name="residence" placeholder="例: 東京都港区">
                        </div>

                        <div class="form-group">
                            <label>紹介元</label>
                            <input type="text" name="referredBy" placeholder="紹介者の名前を入力">
                        </div>
                    </div>

                    <!-- 複数メールアドレス -->
                    <div class="form-group">
                        <label>メールアドレス</label>
                        <div id="emailContainer" class="multi-input-container"></div>
                        <button type="button" class="btn-small btn-secondary add-input-button" onclick="addEmailInput()">+ メールアドレスを追加</button>
                    </div>

                    <!-- 複数電話番号 -->
                    <div class="form-group">
                        <label>電話番号</label>
                        <div id="phoneContainer" class="multi-input-container"></div>
                        <button type="button" class="btn-small btn-secondary add-input-button" onclick="addPhoneInput()">+ 電話番号を追加</button>
                    </div>

                    <!-- 関係者 -->
                    <div class="form-group">
                        <label>関係者</label>
                        <div id="relatedContactsContainer"></div>
                        <button type="button" class="btn-small btn-secondary add-input-button" onclick="addRelatedContact()">+ 関係者を追加</button>
                    </div>

                    <!-- 全幅項目 -->
                    <div class="form-group">
                        <label>顔写真</label>
                        <div class="file-drop-zone" id="photoDropZone">
                            写真をアップロード<span class="upload-hint">（クリックまたはドラッグ＆ドロップ）</span>
                        </div>
                        <input type="file" id="photoUpload" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
                        <div id="photoPreview"></div>
                    </div>

                    <div class="form-group">
                        <label>名刺画像</label>
                        <div class="file-drop-zone card-image-zone" id="cardImageDropZone">
                            名刺画像をアップロード<span class="upload-hint">（クリックまたはドラッグ＆ドロップ）</span>
                        </div>
                        <input type="file" id="cardImageUpload" accept="image/*" style="display: none;" onchange="handleCardImageUpload(event)">
                        <div id="cardImagePreview"></div>
                    </div>

                    <div class="form-group">
                        <label>強み</label>
                        <textarea name="strengths" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label>過去の経歴</label>
                        <textarea name="careerHistory" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label>切り出し方</label>
                        <textarea name="cutout" rows="3" placeholder="Markdown記法が使えます"></textarea>
                    </div>

                    <div class="form-group">
                        <label>添付ファイル</label>
                        <div class="file-drop-zone" id="attachmentDropZone">
                            ファイルをドラッグ＆ドロップまたはクリックして選択
                        </div>
                        <input type="file" id="attachmentUpload" multiple style="display: none;">
                        <div id="existingAttachments" class="file-list"></div>
                        <div id="newAttachments" class="file-list"></div>
                    </div>

                    <!-- 初回ミーティングセクション（編集時のみ表示） -->
                    <div class="first-meeting-section" id="firstMeetingSection" style="display: none;">
                        <h4>初回ミーティング情報</h4>
                        <div class="form-group">
                            <label>日時</label>
                            <input type="datetime-local" name="firstMeetingDatetime">
                        </div>
                        <div class="form-group">
                            <label>打ち合わせ内容</label>
                            <textarea name="firstMeetingContent" rows="5" placeholder="Markdown記法が使えます"></textarea>
                        </div>
                        <div class="form-group">
                            <label>次回アクション</label>
                            <div id="firstMeetingTaskContainer"></div>
                            <button type="button" class="btn-small btn-secondary" onclick="addFirstMeetingTask()">+ タスクを追加</button>
                        </div>
                        <div class="form-group">
                            <label>添付ファイル</label>
                            <div class="file-drop-zone" id="firstMeetingAttachmentDropZone">
                                ファイルをドラッグ＆ドロップまたはクリックして選択
                            </div>
                            <input type="file" id="firstMeetingAttachmentUpload" multiple style="display: none;">
                            <div id="firstMeetingAttachments" class="file-list"></div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button type="submit" class="btn-primary">保存</button>
                        <button type="button" class="btn-secondary" onclick="closeModal('contactFormModal')">キャンセル</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 連絡先詳細モーダル -->
    <div id="contactDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>連絡先詳細</h2>
                <span class="close-modal" onclick="closeModal('contactDetailModal')">&times;</span>
            </div>
            <div class="modal-body" id="contactDetailBody">
                <!-- 詳細内容がここに動的に挿入される -->
            </div>
        </div>
    </div>

    <!-- ミーティング記録モーダル -->
    <div id="meetingFormModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="meetingFormTitle">ミーティング記録</h2>
                <span class="close-modal" onclick="closeModal('meetingFormModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="meetingForm" onsubmit="saveMeetingForm(event)">
                    <div class="form-group">
                        <label>日時 <span style="color: #d93025;">*</span></label>
                        <input type="datetime-local" name="datetime" required>
                    </div>

                    <div class="form-group">
                        <label>打ち合わせ内容 <span style="color: #d93025;">*</span></label>
                        <textarea name="content" rows="10" required placeholder="Markdown記法が使えます"></textarea>
                    </div>

                    <div class="form-group">
                        <label>次回アクション</label>
                        <div id="taskInputContainer"></div>
                        <button type="button" class="btn-small btn-secondary btn-add-task" onclick="addTaskInput()">+ タスクを追加</button>
                    </div>

                    <div class="form-group">
                        <label>添付ファイル</label>
                        <div class="file-drop-zone" id="meetingAttachmentDropZone">
                            ファイルをドラッグ＆ドロップまたはクリックして選択
                        </div>
                        <input type="file" id="meetingAttachmentUpload" multiple style="display: none;">
                        <div id="existingMeetingAttachments" class="file-list"></div>
                        <div id="newMeetingAttachments" class="file-list"></div>
                    </div>

                    <div class="action-buttons">
                        <button type="submit" class="btn-primary">保存</button>
                        <button type="button" class="btn-secondary" onclick="closeModal('meetingFormModal')">キャンセル</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 設定モーダル -->
    <div id="settingsModal" class="modal settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>設定</h2>
                <span class="close-modal" onclick="closeModal('settingsModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="settings-list">
                    <div class="settings-item" onclick="exportData()">
                        <div class="settings-item-icon">💾</div>
                        <div class="settings-item-content">
                            <div class="settings-item-title">データエクスポート</div>
                            <div class="settings-item-description">すべてのデータをJSONファイルとしてダウンロード</div>
                        </div>
                    </div>
                    
                    <div class="settings-item" onclick="document.getElementById('importFile').click()">
                        <div class="settings-item-icon">📥</div>
                        <div class="settings-item-content">
                            <div class="settings-item-title">データインポート</div>
                            <div class="settings-item-description">JSONファイルからデータを追加</div>
                        </div>
                    </div>
                    
                    <div class="settings-item" onclick="showTemplateEditor()">
                        <div class="settings-item-icon">📝</div>
                        <div class="settings-item-content">
                            <div class="settings-item-title">テンプレート設定</div>
                            <div class="settings-item-description">ミーティング記録のテンプレートを編集</div>
                        </div>
                    </div>
                    
                    <div class="settings-item" onclick="syncData()">
                        <div class="settings-item-icon">🔄</div>
                        <div class="settings-item-content">
                            <div class="settings-item-title">同期</div>
                            <div class="settings-item-description">Google Driveと手動で同期</div>
                        </div>
                    </div>
                    
                    <div class="settings-item" onclick="showSetupWizard(true)">
                        <div class="settings-item-icon">⚙️</div>
                        <div class="settings-item-content">
                            <div class="settings-item-title">セットアップ</div>
                            <div class="settings-item-description">Google API設定を確認・変更</div>
                        </div>
                    </div>
                    
                    <div class="settings-item" onclick="logout()">
                        <div class="settings-item-icon">🚪</div>
                        <div class="settings-item-content">
                            <div class="settings-item-title">ログアウト</div>
                            <div class="settings-item-description">Googleアカウントからログアウト</div>
                        </div>
                    </div>
                </div>
                
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
            </div>
        </div>
    </div>

    <!-- テンプレート編集モーダル -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>テンプレート設定</h2>
                <span class="close-modal" onclick="closeModal('templateModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="template-editor" style="display: block;">
                    <label>ミーティング記録テンプレート</label>
                    <textarea id="templateContent" placeholder="ミーティング記録のデフォルトテンプレートを入力してください。&#10;&#10;例：&#10;## 相談内容&#10;&#10;## 次回アクション&#10;- [ ] &#10;&#10;## メモ"></textarea>
                    <div class="template-actions">
                        <button class="btn-primary" onclick="saveTemplate()">保存</button>
                        <button class="btn-secondary" onclick="loadTemplate()">リセット</button>
                        <button class="btn-secondary" onclick="closeModal('templateModal')">キャンセル</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ローディングオーバーレイ -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading"></div>
            <p style="margin-top: 20px;">処理中...</p>
        </div>
    </div>

    <!-- ドラフト保存インジケーター -->
    <div id="draftStatus" class="draft-status">
        下書きを保存しました
    </div>

    <!-- トークンリフレッシュインジケーター -->
    <div id="tokenRefreshIndicator" class="token-refresh-indicator">
        <div class="loading"></div>
        <span>認証を更新中...</span>
    </div>

    <!-- JavaScript -->
    <script>
        // グローバル変数
        let contacts = [];
        let meetings = [];
        let dropdownOptions = {
            types: [],
            affiliations: [],
            wantToConnect: [],
            goldenEgg: []
        };
        let userSettings = {};
        let currentEditingContactId = null;
        let currentEditingMeetingId = null;
        let currentPhotoFile = null;
        let currentCardImageFile = null;
        let selectedFiles = [];
        let selectedMeetingFiles = [];
        let selectedFirstMeetingFiles = [];
        let deletedAttachments = [];
        let deletedMeetingAttachments = [];
        let hasUnsavedDraft = false;
        let draftSaveTimer = null;
        let hasFirstMeeting = {};
        let gapiInited = false;
        let gisInited = false;
        let tokenClient = null;
        let accessToken = null;
        let tokenExpiresAt = null;
        let APP_FOLDER_ID = null;
        let CLIENT_ID = localStorage.getItem('googleClientId');
        let viewMode = 'card';
        let filterVisible = false;
        let currentStep = 1;
        let outstandingActionsVisible = false;
        let searchableSelects = {};
        let currentFilters = {
            searchName: '',
            type: '',
            affiliation: '',
            wantToConnect: '',
            goldenEgg: '',
            referredBy: '',
            area: '',
            residence: ''
        };

        // Google API設定
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];

        // エラーハンドリング設定
        window.addEventListener('error', function(event) {
            console.error('JavaScript Error:', event.error);
            showError(event.error.message || 'Unknown error occurred');
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled Promise Rejection:', event.reason);
            showError(event.reason.message || 'Unhandled promise rejection');
        });

        // エラー表示関数
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            const errorDetails = document.getElementById('errorDetails');
            
            if (errorContainer && errorDetails) {
                errorDetails.textContent = message;
                errorContainer.style.display = 'flex';
            }
        }

        // 初期化時にクライアントIDをチェック
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('DOM Content Loaded - 初期化開始');
                
                if (!CLIENT_ID) {
                    console.log('CLIENT_IDが未設定 - セットアップウィザードを表示');
                    document.getElementById('setupWizard').style.display = 'block';
                } else {
                    console.log('CLIENT_IDが設定済み - Google APIを初期化');
                    // Google APIの初期化
                    gapiLoaded();
                    gisLoaded();
                }
            } catch (error) {
                console.error('初期化エラー:', error);
                showError('システムの初期化に失敗しました: ' + error.message);
            }
        });
    </script>

    <!-- 各種JSファイルを統合 -->
    <script src="js/setup-wizard.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/google-auth.js"></script>
    <script src="js/google-drive.js"></script>
    <script src="js/data-manager.js"></script>
    <script src="js/file-upload.js"></script>
    <script src="js/ui-modals.js"></script>
    <script src="js/ui-render.js"></script>
    <script src="js/contacts.js"></script>
    <script src="js/meetings.js"></script>
    <script src="js/search-filter.js"></script>
    <script src="js/outstanding-actions.js"></script>

    <script>
        // すべての必須関数を定義
        
        // セットアップウィザード関数
        function showSetupWizard(fromSettings = false) {
            try {
                document.getElementById('setupWizard').style.display = 'block';
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'none';
                document.getElementById('backToMainBtn').style.display = fromSettings ? 'block' : 'none';
                
                // 現在のURLを表示
                updateOriginUrl();
            } catch (error) {
                console.error('セットアップウィザード表示エラー:', error);
                showError('セットアップウィザードの表示に失敗しました: ' + error.message);
            }
        }

        function updateOriginUrl() {
            let origin = window.location.origin;
            if (!origin || origin === 'null' || origin === 'file://') {
                origin = 'http://localhost:8000';
            }
            const urlElement = document.getElementById('origin-url');
            if (urlElement) {
                urlElement.textContent = origin;
            }
        }

        function nextStep() {
            try {
                if (currentStep < 4) {
                    document.getElementById(`step${currentStep}`).classList.remove('active');
                    document.getElementById(`step${currentStep}Dot`).classList.remove('active');
                    document.getElementById(`step${currentStep}Dot`).classList.add('completed');
                    
                    currentStep++;
                    
                    document.getElementById(`step${currentStep}`).classList.add('active');
                    document.getElementById(`step${currentStep}Dot`).classList.add('active');
                    
                    if (currentStep === 3) {
                        updateOriginUrl();
                    }
                }
            } catch (error) {
                console.error('ステップ移動エラー:', error);
                showError('ステップの移動に失敗しました: ' + error.message);
            }
        }

        function previousStep() {
            try {
                if (currentStep > 1) {
                    document.getElementById(`step${currentStep}`).classList.remove('active');
                    document.getElementById(`step${currentStep}Dot`).classList.remove('active');
                    
                    currentStep--;
                    
                    document.getElementById(`step${currentStep}Dot`).classList.remove('completed');
                    document.getElementById(`step${currentStep}Dot`).classList.add('active');
                    document.getElementById(`step${currentStep}`).classList.add('active');
                }
            } catch (error) {
                console.error('ステップ戻りエラー:', error);
                showError('ステップの移動に失敗しました: ' + error.message);
            }
        }

        function validateAndProceed() {
            try {
                const clientId = document.getElementById('clientIdInput').value.trim();
                
                if (!clientId) {
                    showNotification('クライアントIDを入力してください', 'error');
                    return;
                }
                
                if (!clientId.includes('.apps.googleusercontent.com')) {
                    showNotification('正しいクライアントIDを入力してください', 'error');
                    return;
                }
                
                CLIENT_ID = clientId;
                localStorage.setItem('googleClientId', CLIENT_ID);
                
                const config = `クライアントID: ${CLIENT_ID}`;
                document.getElementById('final-config').textContent = config;
                
                nextStep();
            } catch (error) {
                console.error('検証エラー:', error);
                showError('入力の検証に失敗しました: ' + error.message);
            }
        }

        function completeSetup() {
            try {
                console.log('セットアップ完了処理開始');
                localStorage.setItem('setup_completed', 'true');
                
                // セットアップウィザードを非表示
                document.getElementById('setupWizard').style.display = 'none';
                
                // 認証画面を表示
                console.log('認証画面を表示');
                document.getElementById('authContainer').style.display = 'block';
                
                // Google API初期化
                console.log('Google API初期化開始');
                gapiLoaded();
                gisLoaded();
                
            } catch (error) {
                console.error('セットアップ完了エラー:', error);
                showError('セットアップの完了に失敗しました: ' + error.message);
            }
        }

        function closeSetupAndReturn() {
            try {
                document.getElementById('setupWizard').style.display = 'none';
                if (CLIENT_ID) {
                    document.getElementById('mainContainer').style.display = 'block';
                }
            } catch (error) {
                console.error('画面遷移エラー:', error);
                showError('画面の切り替えに失敗しました: ' + error.message);
            }
        }

        // Google API読み込み完了時のコールバック
        function gapiLoaded() {
            try {
                console.log('gapiLoaded called');
                if (typeof gapi !== 'undefined') {
                    gapi.load('client', initializeGapiClient);
                } else {
                    console.error('gapi is not defined');
                }
            } catch (error) {
                console.error('GAPI読み込みエラー:', error);
                showError('Google APIの読み込みに失敗しました: ' + error.message);
            }
        }

        // Google Identity Services読み込み完了時のコールバック
        function gisLoaded() {
            try {
                console.log('gisLoaded called');
                if (CLIENT_ID && typeof google !== 'undefined' && google.accounts) {
                    initializeGisClient();
                } else {
                    console.error('Google Identity Services not loaded or CLIENT_ID not set');
                }
            } catch (error) {
                console.error('GIS読み込みエラー:', error);
                showError('Google認証サービスの読み込みに失敗しました: ' + error.message);
            }
        }

        // 基本的な関数の定義
        function showNotification(message, type = 'success') {
            console.log(`[${type}] ${message}`);
            const notification = document.createElement('div');
            notification.className = `notification ${type === 'error' ? 'error-notification' : ''}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function copyToClipboard(id) {
            const text = document.getElementById(id).textContent;
            navigator.clipboard.writeText(text).then(() => {
                showNotification('コピーしました');
            }).catch(() => {
                // フォールバック
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification('コピーしました');
            });
        }

        // UI関連の基本関数
        function showSettingsModal() {
            const modal = document.getElementById('settingsModal');
            if (modal) modal.style.display = 'block';
        }
        
        function showContactForm() {
            // この関数はcontacts.jsで定義されるが、エラー防止のためスタブを用意
            console.log('showContactForm called');
        }
        
        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.style.display = 'none';
        }
        
        function showTemplateEditor() {
            document.getElementById('templateModal').style.display = 'block';
            loadTemplate();
        }
        
        function saveTemplate() {
            const content = document.getElementById('templateContent').value;
            localStorage.setItem('meetingTemplate', content);
            if (userSettings) {
                userSettings.meetingTemplate = content;
            }
            closeModal('templateModal');
            showNotification('テンプレートを保存しました');
        }
        
        function loadTemplate() {
            const template = localStorage.getItem('meetingTemplate') || '';
            document.getElementById('templateContent').value = template;
        }

        // 認証関連の基本関数
        function authenticateGoogle() {
            console.log('Google認証開始');
            
            if (!CLIENT_ID) {
                showNotification('先にセットアップを完了してください', 'error');
                showSetupWizard();
                return;
            }
            
            if (tokenClient) {
                // promptを空にして、可能な限りサイレント認証を試みる
                tokenClient.requestAccessToken({ prompt: '' });
            } else {
                showNotification('認証の初期化に失敗しました。ページを再読み込みしてください。', 'error');
            }
        }

        // データ管理関連の基本関数
        function exportData() {
            // この関数はdata-manager.jsで定義されるが、エラー防止のためスタブを用意
            console.log('exportData called');
        }

        function importData(event) {
            // この関数はdata-manager.jsで定義されるが、エラー防止のためスタブを用意
            console.log('importData called');
        }

        function syncData() {
            // この関数はdata-manager.jsで定義されるが、エラー防止のためスタブを用意
            console.log('syncData called');
        }

        function logout() {
            // この関数はgoogle-auth.jsで定義されるが、エラー防止のためスタブを用意
            console.log('logout called');
        }

        // フィルター関連の基本関数
        function filterContacts() {
            // この関数はsearch-filter.jsで定義されるが、エラー防止のためスタブを用意
            console.log('filterContacts called');
        }

        function toggleFilters() {
            filterVisible = !filterVisible;
            const filterContent = document.getElementById('filterContent');
            const filterToggleIcon = document.getElementById('filterToggleIcon');
            
            if (filterContent.classList.contains('show')) {
                filterContent.classList.remove('show');
                filterToggleIcon.textContent = '▶';
            } else {
                filterContent.classList.add('show');
                filterToggleIcon.textContent = '▼';
            }
        }

        function applySorting() {
            // この関数はsearch-filter.jsで定義されるが、エラー防止のためスタブを用意
            console.log('applySorting called');
        }

        function setViewMode(mode) {
            viewMode = mode;
            localStorage.setItem('viewMode', mode);
            const cardBtn = document.getElementById('cardViewBtn');
            const listBtn = document.getElementById('listViewBtn');
            
            if (mode === 'card') {
                cardBtn.classList.add('active');
                listBtn.classList.remove('active');
            } else {
                cardBtn.classList.remove('active');
                listBtn.classList.add('active');
            }
            
            // renderContactListが定義されていれば呼び出す
            if (typeof renderContactList === 'function') {
                renderContactList();
            }
        }

        // 未完了アクション関連の基本関数
        function toggleOutstandingActions() {
            // この関数はoutstanding-actions.jsで定義されるが、エラー防止のためスタブを用意
            console.log('toggleOutstandingActions called');
        }

        // SearchableSelectクラスの定義（ui-modals.jsより前に必要）
        class SearchableSelect {
            constructor(wrapper, options, value = '', onChange = null) {
                this.wrapper = typeof wrapper === 'string' ? document.getElementById(wrapper) : wrapper;
                this.options = options;
                this.value = value;
                this.onChange = onChange;
                this.filteredOptions = [...options];
                this.init();
            }

            init() {
                this.wrapper.innerHTML = `
                    <div class="searchable-select-input" onclick="event.stopPropagation()">
                        ${this.value || 'すべて'}
                    </div>
                    <div class="searchable-select-dropdown">
                        <div class="searchable-select-search">
                            <input type="text" placeholder="検索..." onclick="event.stopPropagation()">
                        </div>
                        <div class="searchable-select-options"></div>
                    </div>
                `;

                this.input = this.wrapper.querySelector('.searchable-select-input');
                this.dropdown = this.wrapper.querySelector('.searchable-select-dropdown');
                this.searchInput = this.wrapper.querySelector('.searchable-select-search input');
                this.optionsContainer = this.wrapper.querySelector('.searchable-select-options');

                this.input.addEventListener('click', () => this.toggle());
                this.searchInput.addEventListener('input', (e) => this.filter(e.target.value));
                
                document.addEventListener('click', (e) => {
                    if (!this.wrapper.contains(e.target)) {
                        this.close();
                    }
                });

                this.renderOptions();
            }

            toggle() {
                if (this.dropdown.classList.contains('show')) {
                    this.close();
                } else {
                    this.open();
                }
            }

            open() {
                this.dropdown.classList.add('show');
                this.searchInput.focus();
                this.searchInput.value = '';
                this.filter('');
            }

            close() {
                this.dropdown.classList.remove('show');
            }

            filter(query) {
                this.filteredOptions = this.options.filter(option => 
                    option.toLowerCase().includes(query.toLowerCase())
                );
                this.renderOptions();
            }

            renderOptions() {
                const sortedOptions = [...this.filteredOptions].sort((a, b) => a.localeCompare(b, 'ja'));
                
                this.optionsContainer.innerHTML = `
                    <div class="searchable-select-option ${!this.value ? 'selected' : ''}" data-value="">
                        すべて
                    </div>
                    ${sortedOptions.map(option => `
                        <div class="searchable-select-option ${this.value === option ? 'selected' : ''}" data-value="${this.escapeHtml(option)}">
                            ${this.escapeHtml(option)}
                        </div>
                    `).join('')}
                `;

                this.optionsContainer.querySelectorAll('.searchable-select-option').forEach(option => {
                    option.addEventListener('click', () => {
                        this.setValue(option.dataset.value);
                        this.close();
                    });
                });
            }

            setValue(value) {
                this.value = value;
                this.input.textContent = value || 'すべて';
                if (this.onChange) {
                    this.onChange(value);
                }
            }

            getValue() {
                return this.value;
            }

            escapeHtml(text) {
                const escapeMap = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                };
                return text.replace(/[&<>"']/g, (char) => escapeMap[char]);
            }
        }

        // SearchableSelectの拡張メソッド
        SearchableSelect.prototype.getValue = function() {
            return this.value;
        };

        SearchableSelect.prototype.setValue = function(value) {
            this.value = value;
            this.input.textContent = value || 'すべて';
            if (this.onChange) {
                this.onChange(value);
            }
        };
    </script>
</body>
</html>